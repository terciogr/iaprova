// Estado da aplica√ß√£o
let currentUser = null;
let currentStep = 'login';
let interviewData = {};
let disciplinasDisponiveis = [];
let currentTheme = localStorage.getItem('theme') || 'light';
let customColors = JSON.parse(localStorage.getItem('customColors') || '{"primary": "#8b5cf6", "secondary": "#ec4899", "accent": "#3b82f6"}');

// Temas dispon√≠veis
const themes = {
  light: {
    bg: 'bg-gray-50',
    card: 'bg-white',
    text: 'text-gray-800',
    textSecondary: 'text-gray-600',
    border: 'border-gray-200'
  },
  dark: {
    bg: 'bg-gray-900',
    card: 'bg-gray-800',
    text: 'text-gray-100',
    textSecondary: 'text-gray-300',
    border: 'border-gray-700'
  },
  rgb: {
    bg: 'bg-gradient-to-br from-purple-900 via-pink-900 to-blue-900',
    card: 'bg-gradient-to-r from-purple-800/50 to-pink-800/50 backdrop-blur-sm',
    text: 'text-white',
    textSecondary: 'text-gray-200',
    border: 'border-purple-500'
  },
  custom: {
    bg: 'bg-gradient-to-br from-purple-900 via-pink-900 to-blue-900',
    card: 'bg-gradient-to-r from-purple-800/50 to-pink-800/50 backdrop-blur-sm',
    text: 'text-white',
    textSecondary: 'text-gray-200',
    border: 'border-purple-500'
  }
};

// Aplicar tema
function applyTheme(theme) {
  currentTheme = theme;
  localStorage.setItem('theme', theme);
  
  // Aplicar ao body
  document.body.className = themes[theme].bg;
  
  // Aplicar classe dark ao HTML se tema escuro
  if (theme === 'dark' || theme === 'rgb' || theme === 'custom') {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
  
  // Se tema custom, aplicar cores CSS customizadas
  if (theme === 'custom') {
    document.documentElement.style.setProperty('--color-primary', customColors.primary);
    document.documentElement.style.setProperty('--color-secondary', customColors.secondary);
    document.documentElement.style.setProperty('--color-accent', customColors.accent);
    
    // Converter hex para RGB para gradientes
    const primary = hexToRgb(customColors.primary);
    const secondary = hexToRgb(customColors.secondary);
    const accent = hexToRgb(customColors.accent);
    
    // Aplicar gradiente customizado ao body
    document.body.style.background = `linear-gradient(to bottom right, 
      rgba(${primary.r}, ${primary.g}, ${primary.b}, 0.9), 
      rgba(${secondary.r}, ${secondary.g}, ${secondary.b}, 0.9), 
      rgba(${accent.r}, ${accent.g}, ${accent.b}, 0.9))`;
    document.body.style.minHeight = '100vh';
  } else {
    // Resetar estilos customizados
    document.body.style.background = '';
    document.body.style.minHeight = '';
  }
}

// Converter hex para RGB
function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : { r: 139, g: 92, b: 246 }; // fallback purple
}

// Inicializar aplica√ß√£o
document.addEventListener('DOMContentLoaded', () => {
  applyTheme(currentTheme);
  checkUser();
});

function checkUser() {
  const userId = localStorage.getItem('userId');
  if (userId) {
    currentUser = { id: parseInt(userId) };
    verificarEntrevista();
  } else {
    renderLogin();
  }
}

// ============== TELA DE LOGIN ==============
function renderLogin() {
  let isLoginMode = true;

  const render = () => {
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
          <div class="text-center mb-8">
            <i class="fas fa-graduation-cap text-6xl text-blue-600 mb-4"></i>
            <h1 class="text-4xl font-bold text-gray-800">
              <span class="text-blue-600">IA</span><span class="text-purple-600">prova</span>
            </h1>
            <p class="text-gray-600 mt-2">Prepara√ß√£o Inteligente para Concursos P√∫blicos</p>
          </div>
          
          <!-- Bot√µes de altern√¢ncia -->
          <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
            <button id="btnLogin" onclick="toggleMode(true)" 
              class="${isLoginMode ? 'bg-white shadow' : ''} flex-1 py-2 rounded-md font-semibold transition">
              Login
            </button>
            <button id="btnCadastro" onclick="toggleMode(false)" 
              class="${!isLoginMode ? 'bg-white shadow' : ''} flex-1 py-2 rounded-md font-semibold transition">
              Cadastro
            </button>
          </div>
          
          <form id="authForm" class="space-y-4">
            ${!isLoginMode ? `
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                <input type="text" id="userName" required 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Seu nome completo">
              </div>
            ` : ''}
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
              <input type="email" id="userEmail" required 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="seu@email.com">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
              <input type="password" id="userPassword" required minlength="4"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="M√≠nimo 4 caracteres">
            </div>
            
            <button type="submit" 
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
              ${isLoginMode ? 'üîì Entrar' : 'üöÄ Criar Conta'}
            </button>
          </form>
          
          <div class="mt-6 text-center text-sm text-gray-600">
            ${isLoginMode ? 
              'Primeira vez aqui? Use o Cadastro acima.' : 
              'J√° tem conta? Use o Login acima.'}
          </div>
        </div>
      </div>
    `;

    window.toggleMode = (loginMode) => {
      isLoginMode = loginMode;
      render();
    };

    document.getElementById('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;

      try {
        if (isLoginMode) {
          // Login
          const response = await axios.post('/api/login', { email, password });
          currentUser = response.data;
          localStorage.setItem('userId', currentUser.id);
          verificarEntrevista();
        } else {
          // Cadastro
          const name = document.getElementById('userName').value;
          const response = await axios.post('/api/users', { name, email, password });
          
          if (response.data.id) {
            alert('‚úÖ Cadastro realizado com sucesso! Fa√ßa login agora.');
            isLoginMode = true;
            render();
          }
        }
      } catch (error) {
        const errorMsg = error.response?.data?.error || 'Erro na opera√ß√£o';
        alert('‚ùå ' + errorMsg);
      }
    });
  };

  render();
}

// ============== ENTREVISTA INICIAL ==============
async function iniciarEntrevista() {
  // Carregar disciplinas
  const response = await axios.get('/api/disciplinas');
  disciplinasDisponiveis = response.data;
  
  interviewData = {
    user_id: currentUser.id,
    objetivo_tipo: '',
    tempo_disponivel_dia: 0,
    experiencia: '',
    ja_estudou_antes: false,
    reprovacoes: 0,
    disciplinas: []
  };
  
  renderEntrevistaStep1();
}

function renderEntrevistaStep1() {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-800">Entrevista Inicial</h2>
              <span class="text-sm text-gray-500">Passo 1 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 25%"></div>
            </div>
          </div>

          <h3 class="text-xl font-semibold mb-6">Qual √© seu objetivo?</h3>

          <div class="space-y-4">
            <button onclick="selecionarObjetivo('concurso_especifico')" 
              class="w-full p-6 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition text-left">
              <div class="flex items-center">
                <i class="fas fa-bullseye text-3xl text-blue-600 mr-4"></i>
                <div>
                  <h4 class="font-semibold text-lg">Concurso Espec√≠fico</h4>
                  <p class="text-gray-600">Tenho um concurso espec√≠fico em mente</p>
                </div>
              </div>
            </button>

            <button onclick="selecionarObjetivo('area_geral')" 
              class="w-full p-6 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition text-left">
              <div class="flex items-center">
                <i class="fas fa-th-large text-3xl text-purple-600 mr-4"></i>
                <div>
                  <h4 class="font-semibold text-lg">√Årea Geral</h4>
                  <p class="text-gray-600">Quero estudar para uma √°rea espec√≠fica</p>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function selecionarObjetivo(tipo) {
  interviewData.objetivo_tipo = tipo;
  
  if (tipo === 'concurso_especifico') {
    renderConcursoEspecifico();
  } else {
    renderAreaGeral();
  }
}

function renderConcursoEspecifico() {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-800">Qual concurso?</h2>
              <span class="text-sm text-gray-500">Passo 1 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 25%"></div>
            </div>
          </div>

          <form id="concursoForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Concurso/√ìrg√£o</label>
              <input type="text" id="concursoNome" required placeholder="Ex: Receita Federal, Pol√≠cia Federal, TRT-SP"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Cargo pretendido</label>
              <input type="text" id="cargo" required placeholder="Ex: Auditor Fiscal, Agente, Analista Judici√°rio"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <p class="text-xs text-gray-500 mt-1">O conte√∫do ser√° personalizado para este cargo espec√≠fico</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Prazo at√© a prova (opcional)</label>
              <input type="date" id="prazoProva"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex space-x-4">
              <button type="button" onclick="renderEntrevistaStep1()" 
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                Voltar
              </button>
              <button type="submit" 
                class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                Continuar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  document.getElementById('concursoForm').addEventListener('submit', (e) => {
    e.preventDefault();
    interviewData.concurso_nome = document.getElementById('concursoNome').value;
    interviewData.cargo = document.getElementById('cargo').value;
    interviewData.prazo_prova = document.getElementById('prazoProva').value || null;
    renderEntrevistaStep2();
  });
}

function renderAreaGeral() {
  const areas = [
    { id: 'fiscal', nome: 'Fiscal', icon: 'fa-calculator' },
    { id: 'policial', nome: 'Policial', icon: 'fa-shield-alt' },
    { id: 'tribunais', nome: 'Tribunais', icon: 'fa-gavel' },
    { id: 'administrativo', nome: 'Administrativo', icon: 'fa-building' }
  ];

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-800">Escolha a √°rea</h2>
              <span class="text-sm text-gray-500">Passo 1 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 25%"></div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            ${areas.map(area => `
              <button onclick="selecionarArea('${area.id}')" 
                class="p-6 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                <i class="fas ${area.icon} text-4xl text-blue-600 mb-3"></i>
                <h4 class="font-semibold">${area.nome}</h4>
              </button>
            `).join('')}
          </div>

          <button onclick="renderEntrevistaStep1()" 
            class="mt-6 px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Voltar
          </button>
        </div>
      </div>
    </div>
  `;
}

function selecionarArea(area) {
  interviewData.area_geral = area;
  renderEntrevistaStep2();
}

function renderEntrevistaStep2() {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-800">Seu Perfil</h2>
              <span class="text-sm text-gray-500">Passo 2 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 50%"></div>
            </div>
          </div>

          <form id="perfilForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">Tempo dispon√≠vel por dia</label>
              <div class="grid grid-cols-3 gap-3">
                ${[
                  { val: 120, label: '2 horas' },
                  { val: 240, label: '4 horas' },
                  { val: 360, label: '6+ horas' }
                ].map(t => `
                  <label class="cursor-pointer">
                    <input type="radio" name="tempo" value="${t.val}" required class="hidden peer">
                    <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blue-300 transition">
                      <p class="font-semibold">${t.label}</p>
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">Experi√™ncia em concursos</label>
              <div class="grid grid-cols-3 gap-3">
                ${[
                  { val: 'iniciante', label: 'Iniciante', icon: 'fa-seedling' },
                  { val: 'intermediario', label: 'Intermedi√°rio', icon: 'fa-chart-line' },
                  { val: 'avancado', label: 'Avan√ßado', icon: 'fa-trophy' }
                ].map(e => `
                  <label class="cursor-pointer">
                    <input type="radio" name="experiencia" value="${e.val}" required class="hidden peer">
                    <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blue-300 transition">
                      <i class="fas ${e.icon} text-2xl text-blue-600 mb-2"></i>
                      <p class="font-semibold text-sm">${e.label}</p>
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">J√° estudou para concursos antes?</label>
              <div class="grid grid-cols-2 gap-3">
                <label class="cursor-pointer">
                  <input type="radio" name="jaEstudou" value="true" required class="hidden peer">
                  <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blue-300 transition">
                    <p class="font-semibold">Sim</p>
                  </div>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" name="jaEstudou" value="false" required class="hidden peer">
                  <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blue-300 transition">
                    <p class="font-semibold">N√£o</p>
                  </div>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Quantas vezes reprovou?</label>
              <input type="number" name="reprovacoes" min="0" value="0"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex space-x-4">
              <button type="button" onclick="voltarStep1()" 
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                Voltar
              </button>
              <button type="submit" 
                class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                Continuar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  document.getElementById('perfilForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    interviewData.tempo_disponivel_dia = parseInt(formData.get('tempo'));
    interviewData.experiencia = formData.get('experiencia');
    interviewData.ja_estudou_antes = formData.get('jaEstudou') === 'true';
    interviewData.reprovacoes = parseInt(formData.get('reprovacoes'));
    renderEntrevistaStep3();
  });
}

function voltarStep1() {
  if (interviewData.objetivo_tipo === 'concurso_especifico') {
    renderConcursoEspecifico();
  } else {
    renderAreaGeral();
  }
}

async function renderEntrevistaStep3() {
  // Filtrar disciplinas pela √°rea escolhida
  let disciplinasFiltradas = disciplinasDisponiveis;
  
  if (interviewData.area_geral) {
    disciplinasFiltradas = disciplinasDisponiveis.filter(
      d => d.area === interviewData.area_geral || d.area === 'geral'
    );
  }

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-800">N√≠vel por Disciplina</h2>
              <span class="text-sm text-gray-500">Passo 3 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 75%"></div>
            </div>
          </div>

          <p class="text-gray-600 mb-4">Para cada disciplina, indique se j√° estudou e seu n√≠vel de dom√≠nio (0-10)</p>
          
          <div class="mb-6 flex gap-3">
            <button type="button" onclick="selecionarTodasDisciplinas()" 
              class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm">
              ‚úì Marcar todas como estudadas
            </button>
            <button type="button" onclick="limparTodasDisciplinas()" 
              class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
              ‚úó Limpar sele√ß√£o
            </button>
          </div>

          <form id="disciplinasForm" class="space-y-4">
            ${disciplinasFiltradas.map(disc => `
              <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h4 class="font-semibold">${disc.nome}</h4>
                    <p class="text-sm text-gray-500">${disc.descricao || ''}</p>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="flex items-center cursor-pointer">
                      <input type="checkbox" id="estudou_${disc.id}" 
                        onchange="toggleNivel(${disc.id})"
                        class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                      <span class="ml-2 text-sm">J√° estudei esta mat√©ria</span>
                    </label>
                  </div>

                  <div id="nivel_container_${disc.id}" class="hidden">
                    <label class="block text-sm text-gray-700 mb-1">N√≠vel atual (0-10)</label>
                    <input type="number" id="nivel_${disc.id}" min="0" max="10" value="5"
                      class="w-full px-3 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                  </div>
                </div>

                <div class="mt-3">
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="dificuldade_${disc.id}"
                      class="w-4 h-4 text-red-600 rounded focus:ring-red-500">
                    <span class="ml-2 text-sm text-red-600">Tenho dificuldade hist√≥rica nesta mat√©ria</span>
                  </label>
                </div>
              </div>
            `).join('')}

            <div class="flex space-x-4 pt-4">
              <button type="button" onclick="renderEntrevistaStep2()" 
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                Voltar
              </button>
              <button type="submit" 
                class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                Finalizar Entrevista
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  window.toggleNivel = (discId) => {
    const checkbox = document.getElementById(`estudou_${discId}`);
    const container = document.getElementById(`nivel_container_${discId}`);
    container.classList.toggle('hidden', !checkbox.checked);
  };
  
  window.selecionarTodasDisciplinas = () => {
    disciplinasFiltradas.forEach(disc => {
      const checkbox = document.getElementById(`estudou_${disc.id}`);
      const container = document.getElementById(`nivel_container_${disc.id}`);
      const nivelInput = document.getElementById(`nivel_${disc.id}`);
      
      checkbox.checked = true;
      container.classList.remove('hidden');
      if (!nivelInput.value || nivelInput.value == 0) {
        nivelInput.value = 5; // N√≠vel intermedi√°rio por padr√£o
      }
    });
  };
  
  window.limparTodasDisciplinas = () => {
    disciplinasFiltradas.forEach(disc => {
      const checkbox = document.getElementById(`estudou_${disc.id}`);
      const container = document.getElementById(`nivel_container_${disc.id}`);
      const dificuldadeCheckbox = document.getElementById(`dificuldade_${disc.id}`);
      
      checkbox.checked = false;
      container.classList.add('hidden');
      dificuldadeCheckbox.checked = false;
    });
  };

  document.getElementById('disciplinasForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Mapear apenas disciplinas selecionadas (j√° estudou marcado OU tem dificuldade)
    interviewData.disciplinas = disciplinasFiltradas
      .filter(disc => {
        const jaEstudou = document.getElementById(`estudou_${disc.id}`).checked;
        const temDificuldade = document.getElementById(`dificuldade_${disc.id}`).checked;
        return jaEstudou || temDificuldade; // Incluir se marcou qualquer op√ß√£o
      })
      .map(disc => ({
        disciplina_id: disc.id,
        ja_estudou: document.getElementById(`estudou_${disc.id}`).checked,
        nivel_atual: document.getElementById(`estudou_${disc.id}`).checked 
          ? parseInt(document.getElementById(`nivel_${disc.id}`).value) 
          : 0,
        dificuldade: document.getElementById(`dificuldade_${disc.id}`).checked
      }));
    
    // Validar que pelo menos 1 disciplina foi selecionada
    if (interviewData.disciplinas.length === 0) {
      alert('Selecione pelo menos uma disciplina (marque "J√° estudei" ou "Tenho dificuldade")');
      return;
    }

    await finalizarEntrevista();
  });
}

async function finalizarEntrevista() {
  try {
    // Valida√ß√£o final
    if (!interviewData.disciplinas || interviewData.disciplinas.length === 0) {
      alert('‚ö†Ô∏è Por favor, selecione pelo menos uma disciplina antes de continuar.\n\nMarque "J√° estudei" ou "Tenho dificuldade" em ao menos uma mat√©ria.');
      return;
    }

    // Salvar entrevista e gerar diagn√≥stico
    const response = await axios.post('/api/interviews', interviewData);
    const { interview_id, diagnostico } = response.data;

    // Gerar plano de estudos
    const planoResponse = await axios.post('/api/planos', {
      user_id: currentUser.id,
      interview_id
    });

    // Mostrar resultado
    renderResultadoEntrevista(diagnostico, planoResponse.data);
  } catch (error) {
    console.error('Erro ao finalizar entrevista:', error);
    
    // Mensagem amig√°vel baseada no erro
    const errorMsg = error.response?.data?.error || 'Erro ao processar entrevista';
    
    if (error.response?.data?.code === 'NO_DISCIPLINES') {
      alert('‚ö†Ô∏è Nenhuma disciplina selecionada!\n\nVolte e marque pelo menos uma disciplina antes de finalizar.');
    } else if (errorMsg.includes('FOREIGN KEY')) {
      alert('‚ö†Ô∏è Erro de valida√ß√£o!\n\nVerifique se voc√™ selecionou pelo menos uma disciplina v√°lida.');
    } else {
      alert('‚ùå ' + errorMsg + '\n\nTente novamente ou recarregue a p√°gina.');
    }
  }
}

function renderResultadoEntrevista(diagnostico, plano) {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-4xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <div class="text-center mb-8">
            <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">An√°lise Conclu√≠da!</h2>
            <p class="text-gray-600">Seu plano de estudos personalizado est√° pronto</p>
          </div>

          <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
              <h3 class="font-semibold text-lg mb-2 flex items-center">
                <i class="fas fa-user-graduate mr-2 text-blue-600"></i>
                Seu N√≠vel Atual
              </h3>
              <p class="text-2xl font-bold text-blue-600">${diagnostico.nivel_geral}</p>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
              <h3 class="font-semibold text-lg mb-3 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i>
                Prioridades de Estudo
              </h3>
              <ul class="space-y-2">
                ${diagnostico.prioridades.slice(0, 5).map(p => `
                  <li class="flex items-start">
                    <i class="fas fa-arrow-right text-yellow-600 mr-2 mt-1"></i>
                    <div>
                      <span class="font-semibold">${p.nome}</span>
                      <span class="text-sm text-gray-600 ml-2">(${p.razao})</span>
                    </div>
                  </li>
                `).join('')}
              </ul>
            </div>

            ${diagnostico.lacunas.length > 0 ? `
              <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                <h3 class="font-semibold text-lg mb-3 flex items-center">
                  <i class="fas fa-info-circle mr-2 text-red-600"></i>
                  Conte√∫dos Nunca Estudados
                </h3>
                <div class="flex flex-wrap gap-2">
                  ${diagnostico.lacunas.map(l => `
                    <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm">${l}</span>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
              <h3 class="font-semibold text-lg mb-2 flex items-center">
                <i class="fas fa-lightbulb mr-2 text-green-600"></i>
                Recomenda√ß√£o Personalizada
              </h3>
              <p class="text-gray-700">${diagnostico.recomendacao}</p>
            </div>
          </div>

          <button onclick="irParaDashboard()" 
            class="w-full mt-8 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
            Ir para o Dashboard
          </button>
        </div>
      </div>
    </div>
  `;
}

// ============== DASHBOARD ==============
async function verificarEntrevista() {
  try {
    const response = await axios.get(`/api/interviews/user/${currentUser.id}`);
    if (response.data && response.data.length > 0) {
      renderDashboard();
    } else {
      iniciarEntrevista();
    }
  } catch (error) {
    iniciarEntrevista();
  }
}

function irParaDashboard() {
  renderDashboard();
}

async function renderDashboard() {
  try {
    // Buscar dados do plano
    const planoResponse = await axios.get(`/api/planos/user/${currentUser.id}`);
    const plano = planoResponse.data;

    // Buscar metas do dia
    const metasResponse = await axios.get(`/api/metas/hoje/${currentUser.id}`);
    const metas = metasResponse.data;

    // Buscar desempenho
    const desempenhoResponse = await axios.get(`/api/desempenho/user/${currentUser.id}`);
    const desempenho = desempenhoResponse.data;

    // Buscar calend√°rio e estat√≠sticas
    const hoje = new Date();
    const mes = hoje.getMonth() + 1;
    const ano = hoje.getFullYear();
    
    const [calendarioRes, estatisticasRes] = await Promise.all([
      axios.get(`/api/calendario/${currentUser.id}?mes=${mes}&ano=${ano}`),
      axios.get(`/api/estatisticas/${currentUser.id}`)
    ]);

    renderDashboardUI(plano, metas, desempenho, calendarioRes.data, estatisticasRes.data);
  } catch (error) {
    console.error('Erro ao carregar dashboard:', error);
    // Se n√£o houver plano, criar um
    iniciarEntrevista();
  }
}

function renderDashboardUI(plano, metas, desempenho, historico, stats) {
  const metasConcluidas = metas.filter(m => m.concluida).length;
  const progressoDia = metas.length > 0 ? Math.round((metasConcluidas / metas.length) * 100) : 0;
  
  // Calcular m√©dia di√°ria
  const mediaDiaria = stats.dias_estudados > 0 
    ? Math.round((stats.horas_totais * 60) / stats.dias_estudados) 
    : 0;

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg}">
      <!-- Header -->
      <header class="${themes[currentTheme].card} shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <button onclick="renderDashboard()" class="flex items-center hover:opacity-80 transition">
            <i class="fas fa-brain text-3xl text-blue-600 mr-3"></i>
            <h1 class="text-2xl font-bold ${themes[currentTheme].text}">
              <span class="text-blue-600">IA</span>prova
            </h1>
          </button>
          <div class="flex items-center gap-4">
            <!-- Seletor de Tema -->
            <div class="flex gap-2">
              <button onclick="changeTheme('light')" 
                class="w-8 h-8 rounded-full bg-white border-2 ${currentTheme === 'light' ? 'border-blue-600' : 'border-gray-300'} hover:border-blue-400 transition"
                title="Tema Claro">
                <i class="fas fa-sun text-yellow-500"></i>
              </button>
              <button onclick="changeTheme('dark')" 
                class="w-8 h-8 rounded-full bg-gray-900 border-2 ${currentTheme === 'dark' ? 'border-blue-600' : 'border-gray-600'} hover:border-blue-400 transition"
                title="Tema Escuro">
                <i class="fas fa-moon text-blue-300"></i>
              </button>
              <button onclick="changeTheme('rgb')" 
                class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 border-2 ${currentTheme === 'rgb' ? 'border-white' : 'border-gray-300'} hover:border-white transition"
                title="Tema RGB Padr√£o">
                <i class="fas fa-palette text-white"></i>
              </button>
              <button onclick="openCustomThemeModal()" 
                class="w-8 h-8 rounded-full border-2 ${currentTheme === 'custom' ? 'border-white' : 'border-gray-300'} hover:border-white transition"
                style="background: linear-gradient(135deg, ${customColors.primary}, ${customColors.secondary}, ${customColors.accent})"
                title="Tema Personalizado (RGB Custom)">
                <i class="fas fa-paint-brush text-white text-xs"></i>
              </button>
            </div>
            <button onclick="logout()" class="${themes[currentTheme].textSecondary} hover:${themes[currentTheme].text}">
              <i class="fas fa-sign-out-alt mr-2"></i>Sair
            </button>
          </div>
        </div>
      </header>

      <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- KPIs Principais -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div class="${currentTheme === 'light' ? 'bg-gradient-to-br from-orange-400 to-orange-600' : currentTheme === 'dark' ? 'bg-gradient-to-br from-orange-600 to-orange-800' : 'bg-gradient-to-br from-orange-500/80 to-orange-700/80 backdrop-blur-sm'} rounded-lg shadow-lg p-4 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm opacity-90">Streak üî•</p>
                <p class="text-3xl font-bold">${stats.streak_atual}</p>
                <p class="text-xs opacity-75">dias</p>
              </div>
              <i class="fas fa-fire text-4xl opacity-30"></i>
            </div>
          </div>

          <div class="${currentTheme === 'light' ? 'bg-gradient-to-br from-blue-400 to-blue-600' : currentTheme === 'dark' ? 'bg-gradient-to-br from-blue-600 to-blue-800' : 'bg-gradient-to-br from-blue-500/80 to-blue-700/80 backdrop-blur-sm'} rounded-lg shadow-lg p-4 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm opacity-90">Dias Estudados</p>
                <p class="text-3xl font-bold">${stats.dias_estudados}</p>
                <p class="text-xs opacity-75">total</p>
              </div>
              <i class="fas fa-calendar-check text-4xl opacity-30"></i>
            </div>
          </div>

          <div class="${currentTheme === 'light' ? 'bg-gradient-to-br from-purple-400 to-purple-600' : currentTheme === 'dark' ? 'bg-gradient-to-br from-purple-600 to-purple-800' : 'bg-gradient-to-br from-purple-500/80 to-purple-700/80 backdrop-blur-sm'} rounded-lg shadow-lg p-4 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm opacity-90">Total de Horas</p>
                <p class="text-3xl font-bold">${stats.horas_totais}</p>
                <p class="text-xs opacity-75">horas</p>
              </div>
              <i class="fas fa-clock text-4xl opacity-30"></i>
            </div>
          </div>

          <div class="${currentTheme === 'light' ? 'bg-gradient-to-br from-green-400 to-green-600' : currentTheme === 'dark' ? 'bg-gradient-to-br from-green-600 to-green-800' : 'bg-gradient-to-br from-green-500/80 to-green-700/80 backdrop-blur-sm'} rounded-lg shadow-lg p-4 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm opacity-90">M√©dia Di√°ria</p>
                <p class="text-3xl font-bold">${mediaDiaria}</p>
                <p class="text-xs opacity-75">minutos/dia</p>
              </div>
              <i class="fas fa-chart-bar text-4xl opacity-30"></i>
            </div>
          </div>

          <div class="${currentTheme === 'light' ? 'bg-gradient-to-br from-teal-400 to-teal-600' : currentTheme === 'dark' ? 'bg-gradient-to-br from-teal-600 to-teal-800' : 'bg-gradient-to-br from-teal-500/80 to-teal-700/80 backdrop-blur-sm'} rounded-lg shadow-lg p-4 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm opacity-90">Conclus√£o</p>
                <p class="text-3xl font-bold">${stats.media_conclusao}%</p>
                <p class="text-xs opacity-75">m√©dia</p>
              </div>
              <i class="fas fa-percentage text-4xl opacity-30"></i>
            </div>
          </div>
        </div>

        <!-- Progresso do Dia -->
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-6 mb-6">
          <h2 class="text-xl font-bold ${themes[currentTheme].text} mb-4">üìÖ Hoje</h2>
          <div class="mb-4">
            <div class="flex justify-between mb-2">
              <span class="text-sm font-medium ${themes[currentTheme].text}">Progresso do dia</span>
              <span class="text-sm font-medium ${themes[currentTheme].text}">${progressoDia}%</span>
            </div>
            <div class="w-full ${currentTheme === 'light' ? 'bg-gray-200' : 'bg-gray-700'} rounded-full h-3">
              <div class="bg-green-500 h-3 rounded-full transition-all" style="width: ${progressoDia}%"></div>
            </div>
          </div>
          <p class="${themes[currentTheme].textSecondary}">${metasConcluidas} de ${metas.length} metas conclu√≠das</p>
        </div>

        <!-- Metas do Dia -->
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-6 mb-6">
          <h2 class="text-xl font-bold ${themes[currentTheme].text} mb-4">üéØ Metas de Hoje</h2>
          ${metas.length === 0 ? `
            <p class="${themes[currentTheme].textSecondary}">Nenhuma meta programada para hoje. 
              <button onclick="gerarMetasDia()" class="text-blue-600 hover:underline">Gerar metas</button>
            </p>
          ` : `
            <div class="space-y-3">
              ${metas.map(meta => `
                <div class="p-4 border rounded-lg ${meta.concluida ? 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-700' : themes[currentTheme].card + ' ' + themes[currentTheme].border}">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center flex-1">
                      <input type="checkbox" 
                        id="check-${meta.id}"
                        ${meta.concluida ? 'checked disabled' : ''} 
                        onchange="mostrarInputTempo(${meta.id}, ${meta.tempo_minutos})"
                        class="w-5 h-5 text-blue-600 rounded mr-3 cursor-pointer">
                      <div class="flex-1">
                        <h4 class="font-semibold">${meta.disciplina_nome}</h4>
                        <p class="text-sm text-gray-600">
                          ${meta.tipo === 'teoria' ? 'üìñ Teoria' : meta.tipo === 'exercicios' ? '‚úèÔ∏è Exerc√≠cios' : 'üîÑ Revis√£o'}
                          ‚Ä¢ Meta: ${meta.tempo_minutos} min ${meta.concluida && meta.tempo_real_minutos ? `‚Ä¢ Realizado: ${meta.tempo_real_minutos} min` : ''}
                        </p>
                        <!-- Input de tempo (oculto por padr√£o) -->
                        <div id="tempo-input-${meta.id}" class="mt-2 hidden">
                          <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-700">Tempo estudado (min):</label>
                            <input type="number" 
                              id="tempo-real-${meta.id}"
                              value="${meta.tempo_minutos}"
                              min="1"
                              max="240"
                              class="w-20 px-2 py-1 border rounded text-sm">
                            <button onclick="concluirMetaComTempo(${meta.id})" 
                              class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                              <i class="fas fa-check mr-1"></i>Confirmar
                            </button>
                            <button onclick="cancelarConclusao(${meta.id})" 
                              class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400">
                              Cancelar
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    ${meta.concluida ? `
                      <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                    ` : `
                      <button onclick="gerarConteudoMetaPorId(${meta.id})" 
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm whitespace-nowrap">
                        <i class="fas fa-magic mr-2"></i>Gerar Conte√∫do
                      </button>
                    `}
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>

        <!-- Calend√°rio Compacto -->
        ${gerarCalendarioCompacto(historico)}

        <!-- Cards de Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">Disciplinas</p>
                <p class="text-3xl font-bold text-blue-600">${plano.diagnostico.total_disciplinas}</p>
              </div>
              <i class="fas fa-book text-4xl ${currentTheme === 'light' ? 'text-blue-200' : 'text-blue-400'}"></i>
            </div>
          </div>

          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">Nunca Estudadas</p>
                <p class="text-3xl font-bold text-yellow-600">${plano.diagnostico.nunca_estudadas}</p>
              </div>
              <i class="fas fa-exclamation-triangle text-4xl ${currentTheme === 'light' ? 'text-yellow-200' : 'text-yellow-400'}"></i>
            </div>
          </div>

          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">N√≠vel M√©dio</p>
                <p class="text-3xl font-bold text-green-600">${plano.diagnostico.nivel_medio}/10</p>
              </div>
              <i class="fas fa-chart-line text-4xl ${currentTheme === 'light' ? 'text-green-200' : 'text-green-400'}"></i>
            </div>
          </div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <button onclick="renderCalendario()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-calendar-check text-4xl text-orange-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Calend√°rio</p>
          </button>

          <button onclick="renderMateriais()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-file-pdf text-4xl text-red-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Materiais</p>
          </button>

          <button onclick="renderDesempenho()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-chart-bar text-4xl text-purple-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Desempenho</p>
          </button>

          <button onclick="renderRevisoes()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-sync text-4xl text-blue-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Revis√µes</p>
          </button>
        </div>
      </div>
    </div>
  `;
}

function gerarCalendarioCompacto(historico) {
  const hoje = new Date();
  const mes = hoje.getMonth() + 1;
  const ano = hoje.getFullYear();
  const mesesNomes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  
  const primeiroDia = new Date(ano, mes - 1, 1);
  const ultimoDia = new Date(ano, mes, 0);
  const diasNoMes = ultimoDia.getDate();
  const diaSemanaInicio = primeiroDia.getDay();

  // Criar mapa de hist√≥rico por dia
  const historicoMap = {};
  historico.forEach(h => {
    const dia = new Date(h.data + 'T00:00:00').getDate();
    historicoMap[dia] = h;
  });

  // Gerar grade de dias
  let diasHTML = '';
  
  // Dias em branco antes do in√≠cio do m√™s
  for (let i = 0; i < diaSemanaInicio; i++) {
    diasHTML += '<div class=""></div>';
  }

  // Dias do m√™s
  for (let dia = 1; dia <= diasNoMes; dia++) {
    const hist = historicoMap[dia];
    let corClasse = 'bg-gray-200';
    let titulo = 'N√£o estudou';

    if (hist) {
      if (hist.status === 'completo') {
        corClasse = 'bg-green-500';
        titulo = `‚úÖ ${hist.percentual_conclusao}% - ${Math.round(hist.tempo_estudado_minutos / 60 * 10) / 10}h`;
      } else if (hist.status === 'parcial') {
        corClasse = 'bg-yellow-400';
        titulo = `‚ö†Ô∏è ${hist.percentual_conclusao}% - ${Math.round(hist.tempo_estudado_minutos / 60 * 10) / 10}h`;
      } else {
        corClasse = 'bg-red-300';
        titulo = '‚ùå N√£o estudou';
      }
    }

    // Marcar dia atual
    if (dia === hoje.getDate()) {
      diasHTML += `
        <div class="w-8 h-8 ${corClasse} rounded flex items-center justify-center text-xs font-bold ring-2 ring-blue-500 cursor-pointer hover:scale-110 transition"
             title="${titulo}">
          ${dia}
        </div>
      `;
    } else {
      diasHTML += `
        <div class="w-8 h-8 ${corClasse} rounded flex items-center justify-center text-xs cursor-pointer hover:scale-110 transition"
             title="${titulo}">
          ${dia}
        </div>
      `;
    }
  }

  return `
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">üìÖ Calend√°rio de Estudos - ${mesesNomes[mes - 1]}/${ano}</h2>
        <button onclick="renderCalendario()" class="text-sm text-blue-600 hover:underline">
          Ver completo ‚Üí
        </button>
      </div>

      <!-- Legenda -->
      <div class="flex justify-center space-x-4 mb-4 text-xs">
        <div class="flex items-center">
          <div class="w-3 h-3 bg-green-500 rounded mr-1"></div>
          <span>Completo</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 bg-yellow-400 rounded mr-1"></div>
          <span>Parcial</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 bg-red-300 rounded mr-1"></div>
          <span>N√£o estudou</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 bg-gray-200 rounded mr-1"></div>
          <span>Sem dados</span>
        </div>
      </div>

      <!-- Grade do calend√°rio -->
      <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-semibold text-gray-600">
        <div>D</div>
        <div>S</div>
        <div>T</div>
        <div>Q</div>
        <div>Q</div>
        <div>S</div>
        <div>S</div>
      </div>

      <div class="grid grid-cols-7 gap-1 justify-items-center">
        ${diasHTML}
      </div>
    </div>
  `;
}

// Mostrar input de tempo quando checkbox √© marcado
function mostrarInputTempo(metaId, tempoMeta) {
  const checkbox = document.getElementById(`check-${metaId}`);
  const inputContainer = document.getElementById(`tempo-input-${metaId}`);
  
  if (checkbox.checked) {
    // Mostrar input de tempo
    inputContainer.classList.remove('hidden');
    // Focar no input
    document.getElementById(`tempo-real-${metaId}`).focus();
  } else {
    // Ocultar input
    inputContainer.classList.add('hidden');
  }
}

// Confirmar conclus√£o com tempo informado
async function concluirMetaComTempo(metaId) {
  const tempoInput = document.getElementById(`tempo-real-${metaId}`);
  const tempoReal = parseInt(tempoInput.value);
  
  if (!tempoReal || tempoReal < 1) {
    alert('‚ö†Ô∏è Por favor, informe um tempo v√°lido (m√≠nimo 1 minuto)');
    return;
  }
  
  if (tempoReal > 240) {
    alert('‚ö†Ô∏è Tempo m√°ximo: 240 minutos (4 horas)');
    return;
  }
  
  try {
    await axios.post('/api/metas/concluir', {
      meta_id: metaId,
      tempo_real_minutos: tempoReal
    });
    
    // Feedback visual
    const checkbox = document.getElementById(`check-${metaId}`);
    checkbox.disabled = true;
    
    // Recarregar dashboard
    renderDashboard();
  } catch (error) {
    console.error('Erro ao concluir meta:', error);
    alert('Erro ao salvar. Tente novamente.');
  }
}

// Cancelar conclus√£o
function cancelarConclusao(metaId) {
  const checkbox = document.getElementById(`check-${metaId}`);
  const inputContainer = document.getElementById(`tempo-input-${metaId}`);
  
  // Desmarcar checkbox
  checkbox.checked = false;
  
  // Ocultar input
  inputContainer.classList.add('hidden');
}

// Manter fun√ß√£o antiga para compatibilidade (se existir c√≥digo que a use)
async function toggleMeta(metaId) {
  mostrarInputTempo(metaId, 30);
}

function renderMateriais() {
  alert('M√≥dulo de Materiais em desenvolvimento');
}

function renderDesempenho() {
  alert('M√≥dulo de Desempenho em desenvolvimento');
}

function renderRevisoes() {
  alert('M√≥dulo de Revis√µes em desenvolvimento');
}

function renderPlano() {
  alert('M√≥dulo de Plano Semanal em desenvolvimento');
}

function logout() {
  localStorage.removeItem('userId');
  currentUser = null;
  renderLogin();
}

window.changeTheme = (theme) => {
  applyTheme(theme);
  renderDashboard(); // Recarregar dashboard com novo tema
};

window.openCustomThemeModal = () => {
  const modal = document.createElement('div');
  modal.id = 'customThemeModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
          <i class="fas fa-paint-brush mr-2"></i>
          Tema Personalizado
        </h2>
        <button onclick="closeCustomThemeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
        Escolha 3 cores para criar seu tema personalizado em gradiente
      </p>
      
      <div class="space-y-4 mb-6">
        <!-- Cor Prim√°ria -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-circle mr-2" style="color: ${customColors.primary}"></i>
            Cor Prim√°ria
          </label>
          <div class="flex gap-3">
            <input type="color" id="colorPrimary" value="${customColors.primary}" 
              class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer">
            <input type="text" id="colorPrimaryHex" value="${customColors.primary}" 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
              placeholder="#8b5cf6">
          </div>
        </div>
        
        <!-- Cor Secund√°ria -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-circle mr-2" style="color: ${customColors.secondary}"></i>
            Cor Secund√°ria
          </label>
          <div class="flex gap-3">
            <input type="color" id="colorSecondary" value="${customColors.secondary}" 
              class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer">
            <input type="text" id="colorSecondaryHex" value="${customColors.secondary}" 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
              placeholder="#ec4899">
          </div>
        </div>
        
        <!-- Cor de Destaque -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-circle mr-2" style="color: ${customColors.accent}"></i>
            Cor de Destaque
          </label>
          <div class="flex gap-3">
            <input type="color" id="colorAccent" value="${customColors.accent}" 
              class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer">
            <input type="text" id="colorAccentHex" value="${customColors.accent}" 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
              placeholder="#3b82f6">
          </div>
        </div>
      </div>
      
      <!-- Preview -->
      <div class="mb-6 p-4 rounded-lg" id="themePreview" 
        style="background: linear-gradient(135deg, ${customColors.primary}, ${customColors.secondary}, ${customColors.accent})">
        <p class="text-white font-semibold text-center">Preview do Tema</p>
      </div>
      
      <!-- Presets R√°pidos -->
      <div class="mb-6">
        <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Presets R√°pidos:</p>
        <div class="grid grid-cols-4 gap-2">
          <button onclick="applyPreset('#8b5cf6', '#ec4899', '#3b82f6')" 
            class="h-10 rounded border-2 border-gray-300 hover:border-white transition"
            style="background: linear-gradient(135deg, #8b5cf6, #ec4899, #3b82f6)"
            title="Roxo + Rosa + Azul"></button>
          <button onclick="applyPreset('#f59e0b', '#ef4444', '#dc2626')" 
            class="h-10 rounded border-2 border-gray-300 hover:border-white transition"
            style="background: linear-gradient(135deg, #f59e0b, #ef4444, #dc2626)"
            title="Laranja + Vermelho"></button>
          <button onclick="applyPreset('#10b981', '#3b82f6', '#8b5cf6')" 
            class="h-10 rounded border-2 border-gray-300 hover:border-white transition"
            style="background: linear-gradient(135deg, #10b981, #3b82f6, #8b5cf6)"
            title="Verde + Azul + Roxo"></button>
          <button onclick="applyPreset('#f472b6', '#a855f7', '#6366f1')" 
            class="h-10 rounded border-2 border-gray-300 hover:border-white transition"
            style="background: linear-gradient(135deg, #f472b6, #a855f7, #6366f1)"
            title="Rosa + Roxo + Indigo"></button>
        </div>
      </div>
      
      <div class="flex gap-3">
        <button onclick="closeCustomThemeModal()" 
          class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-semibold transition">
          Cancelar
        </button>
        <button onclick="saveCustomTheme()" 
          class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition">
          <i class="fas fa-check mr-2"></i>
          Aplicar
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Sincronizar inputs
  ['Primary', 'Secondary', 'Accent'].forEach(type => {
    const colorPicker = document.getElementById(`color${type}`);
    const hexInput = document.getElementById(`color${type}Hex`);
    
    colorPicker.addEventListener('input', (e) => {
      hexInput.value = e.target.value;
      updatePreview();
    });
    
    hexInput.addEventListener('input', (e) => {
      if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
        colorPicker.value = e.target.value;
        updatePreview();
      }
    });
  });
  
  function updatePreview() {
    const primary = document.getElementById('colorPrimary').value;
    const secondary = document.getElementById('colorSecondary').value;
    const accent = document.getElementById('colorAccent').value;
    const preview = document.getElementById('themePreview');
    preview.style.background = `linear-gradient(135deg, ${primary}, ${secondary}, ${accent})`;
  }
};

window.closeCustomThemeModal = () => {
  const modal = document.getElementById('customThemeModal');
  if (modal) modal.remove();
};

window.applyPreset = (primary, secondary, accent) => {
  document.getElementById('colorPrimary').value = primary;
  document.getElementById('colorPrimaryHex').value = primary;
  document.getElementById('colorSecondary').value = secondary;
  document.getElementById('colorSecondaryHex').value = secondary;
  document.getElementById('colorAccent').value = accent;
  document.getElementById('colorAccentHex').value = accent;
  
  const preview = document.getElementById('themePreview');
  preview.style.background = `linear-gradient(135deg, ${primary}, ${secondary}, ${accent})`;
};

window.saveCustomTheme = () => {
  customColors = {
    primary: document.getElementById('colorPrimary').value,
    secondary: document.getElementById('colorSecondary').value,
    accent: document.getElementById('colorAccent').value
  };
  
  localStorage.setItem('customColors', JSON.stringify(customColors));
  closeCustomThemeModal();
  changeTheme('custom');
};

// ============== GERA√á√ÉO AUTOM√ÅTICA DE METAS ==============
async function gerarMetasDia() {
  try {
    const response = await axios.post(`/api/metas/gerar/${currentUser.id}`);
    if (response.data.success) {
      alert(`‚úÖ ${response.data.metas_criadas} metas geradas para hoje!`);
      renderDashboard();
    } else {
      alert(response.data.message || 'Metas j√° existem para hoje');
    }
  } catch (error) {
    console.error('Erro ao gerar metas:', error);
    alert('Erro ao gerar metas do dia');
  }
}

// ============== CALEND√ÅRIO DE ESTUDOS ==============
async function renderCalendario() {
  const hoje = new Date();
  const mes = hoje.getMonth() + 1;
  const ano = hoje.getFullYear();

  try {
    const [calendarioRes, estatisticasRes] = await Promise.all([
      axios.get(`/api/calendario/${currentUser.id}?mes=${mes}&ano=${ano}`),
      axios.get(`/api/estatisticas/${currentUser.id}`)
    ]);

    const historico = calendarioRes.data;
    const stats = estatisticasRes.data;

    renderCalendarioUI(historico, stats, mes, ano);
  } catch (error) {
    console.error('Erro ao carregar calend√°rio:', error);
    alert('Erro ao carregar calend√°rio');
  }
}

function renderCalendarioUI(historico, stats, mes, ano) {
  const mesesNomes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  
  const primeiroDia = new Date(ano, mes - 1, 1);
  const ultimoDia = new Date(ano, mes, 0);
  const diasNoMes = ultimoDia.getDate();
  const diaSemanaInicio = primeiroDia.getDay();

  // Criar mapa de hist√≥rico por dia
  const historicoMap = {};
  historico.forEach(h => {
    const dia = new Date(h.data + 'T00:00:00').getDate();
    historicoMap[dia] = h;
  });

  // Gerar grade de dias
  let diasHTML = '';
  
  // Dias em branco antes do in√≠cio do m√™s
  for (let i = 0; i < diaSemanaInicio; i++) {
    diasHTML += '<div class="p-2"></div>';
  }

  // Dias do m√™s
  for (let dia = 1; dia <= diasNoMes; dia++) {
    const hist = historicoMap[dia];
    let corClasse = 'bg-gray-100 border-gray-200';
    let icone = '';
    let titulo = 'N√£o estudou';

    if (hist) {
      if (hist.status === 'completo') {
        corClasse = 'bg-green-100 border-green-400';
        icone = '<i class="fas fa-check text-green-600"></i>';
        titulo = `${hist.percentual_conclusao}% - ${Math.round(hist.tempo_estudado_minutos / 60 * 10) / 10}h`;
      } else if (hist.status === 'parcial') {
        corClasse = 'bg-yellow-100 border-yellow-400';
        icone = '<i class="fas fa-clock text-yellow-600"></i>';
        titulo = `${hist.percentual_conclusao}% - ${Math.round(hist.tempo_estudado_minutos / 60 * 10) / 10}h`;
      } else {
        corClasse = 'bg-red-100 border-red-300';
        icone = '<i class="fas fa-times text-red-500"></i>';
        titulo = 'N√£o estudou';
      }
    }

    diasHTML += `
      <div class="p-3 border-2 rounded-lg ${corClasse} text-center cursor-pointer hover:shadow-md transition"
           title="${titulo}">
        <div class="text-sm font-semibold mb-1">${dia}</div>
        ${icone}
      </div>
    `;
  }

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <button onclick="renderDashboard()" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
          </button>
          <h1 class="text-2xl font-bold text-gray-800">üìÖ Calend√°rio de Estudos</h1>
          <div></div>
        </div>
      </header>

      <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-sm">Streak Atual</p>
                <p class="text-3xl font-bold text-orange-600">${stats.streak_atual} üî•</p>
              </div>
              <i class="fas fa-fire text-4xl text-orange-200"></i>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-sm">Dias Estudados</p>
                <p class="text-3xl font-bold text-blue-600">${stats.dias_estudados}</p>
              </div>
              <i class="fas fa-calendar-check text-4xl text-blue-200"></i>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-sm">Horas Totais</p>
                <p class="text-3xl font-bold text-purple-600">${stats.horas_totais}h</p>
              </div>
              <i class="fas fa-clock text-4xl text-purple-200"></i>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-sm">M√©dia de Conclus√£o</p>
                <p class="text-3xl font-bold text-green-600">${stats.media_conclusao}%</p>
              </div>
              <i class="fas fa-chart-line text-4xl text-green-200"></i>
            </div>
          </div>
        </div>

        <!-- Calend√°rio -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold mb-6 text-center">${mesesNomes[mes - 1]} ${ano}</h2>

          <!-- Legenda -->
          <div class="flex justify-center space-x-6 mb-6 text-sm">
            <div class="flex items-center">
              <div class="w-4 h-4 bg-green-100 border-2 border-green-400 rounded mr-2"></div>
              <span>Completo</span>
            </div>
            <div class="flex items-center">
              <div class="w-4 h-4 bg-yellow-100 border-2 border-yellow-400 rounded mr-2"></div>
              <span>Parcial</span>
            </div>
            <div class="flex items-center">
              <div class="w-4 h-4 bg-red-100 border-2 border-red-300 rounded mr-2"></div>
              <span>N√£o estudou</span>
            </div>
            <div class="flex items-center">
              <div class="w-4 h-4 bg-gray-100 border-2 border-gray-200 rounded mr-2"></div>
              <span>Sem dados</span>
            </div>
          </div>

          <!-- Grade do calend√°rio -->
          <div class="grid grid-cols-7 gap-2 mb-4">
            <div class="text-center font-semibold text-gray-600 p-2">Dom</div>
            <div class="text-center font-semibold text-gray-600 p-2">Seg</div>
            <div class="text-center font-semibold text-gray-600 p-2">Ter</div>
            <div class="text-center font-semibold text-gray-600 p-2">Qua</div>
            <div class="text-center font-semibold text-gray-600 p-2">Qui</div>
            <div class="text-center font-semibold text-gray-600 p-2">Sex</div>
            <div class="text-center font-semibold text-gray-600 p-2">S√°b</div>
          </div>

          <div class="grid grid-cols-7 gap-2">
            ${diasHTML}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============== CONTE√öDO DE ESTUDO GERADO POR IA ==============
async function gerarConteudoMetaPorId(metaId) {
  try {
    // Buscar dados da meta
    const metasHoje = await axios.get(`/api/metas/hoje/${currentUser.id}`);
    const meta = metasHoje.data.find(m => m.id === metaId);
    
    if (!meta) {
      alert('Meta n√£o encontrada');
      return;
    }
    
    await gerarConteudoMeta(meta);
  } catch (error) {
    console.error('Erro ao buscar meta:', error);
    alert('Erro ao buscar informa√ß√µes da meta');
  }
}

async function gerarConteudoMeta(meta) {
  try {
    console.log('üéØ Iniciando gera√ß√£o de conte√∫do para meta:', meta);
    
    // Verificar se j√° existe conte√∫do gerado
    const conteudoExistente = await axios.get(`/api/conteudo/${meta.id}`).catch(() => null);
    
    if (conteudoExistente?.data) {
      console.log('‚úÖ Conte√∫do j√° existe, exibindo...');
      visualizarConteudo(conteudoExistente.data, meta);
      return;
    }

    console.log('üìù Conte√∫do n√£o existe, gerando novo...');

    // Mostrar loading
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-conteudo';
    loadingDiv.innerHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg text-center shadow-2xl max-w-md">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p class="text-lg font-semibold text-gray-800">Gerando conte√∫do...</p>
          <p class="text-sm text-gray-600 mt-2">A IA est√° criando seu material de estudo personalizado</p>
          <p class="text-xs text-gray-500 mt-3">üìö ${meta.disciplina_nome}</p>
          <p class="text-xs text-gray-500">‚è±Ô∏è ${meta.tempo_minutos} minutos | ${meta.tipo}</p>
        </div>
      </div>
    `;
    document.body.appendChild(loadingDiv);
    
    // Gerar conte√∫do
    console.log('üì° Enviando requisi√ß√£o para API /api/conteudo/gerar...');
    const response = await axios.post('/api/conteudo/gerar', {
      meta_id: meta.id,
      user_id: currentUser.id,
      disciplina_id: meta.disciplina_id,
      tipo: meta.tipo,
      tempo_minutos: meta.tempo_minutos
    });

    console.log('‚úÖ Resposta da API recebida:', response.data);
    console.log('üìö T√≥picos gerados:', response.data.topicos);
    console.log('üìù N√∫mero de se√ß√µes:', response.data.conteudo?.secoes?.length || 0);
    
    // Contar quest√µes
    const totalQuestoes = (response.data.conteudo?.secoes || [])
      .reduce((sum, s) => sum + (s.conteudo?.questoes?.length || 0), 0);
    console.log('‚ùì Total de quest√µes geradas:', totalQuestoes);

    const loadingEl = document.getElementById('loading-conteudo');
    if (loadingEl) document.body.removeChild(loadingEl);
    
    console.log('üíª Chamando visualizarConteudo...');
    
    // TENTAR com try/catch dentro do visualizarConteudo
    try {
      visualizarConteudo(response.data, meta);
      console.log('‚úÖ visualizarConteudo executado sem erros aparentes');
    } catch (vizError) {
      console.error('‚ùå ERRO DENTRO DE visualizarConteudo:', vizError);
      console.error('Stack trace:', vizError.stack);
      alert('‚ùå Erro ao exibir conte√∫do:\n\n' + vizError.message + '\n\nVeja o console para detalhes.');
      renderDashboard();
    }
  } catch (error) {
    console.error('‚ùå Erro ao gerar conte√∫do:', error);
    console.error('Detalhes do erro:', error.response?.data);
    const loadingEl = document.getElementById('loading-conteudo');
    if (loadingEl) document.body.removeChild(loadingEl);
    alert('‚ùå Erro ao gerar conte√∫do de estudo:\n\n' + (error.response?.data?.error || error.message) + '\n\nAbra o console (F12) para mais detalhes.');
  }
}

function visualizarConteudo(conteudo, meta = null) {
  console.log('üì∫ visualizarConteudo chamada com:', { conteudo, meta });
  console.log('üîç Tipo de conteudo:', typeof conteudo);
  console.log('üîç Chaves do conteudo:', Object.keys(conteudo || {}));
  console.log('üîç conteudo.conteudo existe?', !!conteudo?.conteudo);
  console.log('üîç Estrutura completa do conteudo:', JSON.stringify(conteudo, null, 2).substring(0, 500));
  
  // Validar estrutura do conte√∫do
  if (!conteudo || !conteudo.conteudo) {
    console.error('‚ùå Conte√∫do inv√°lido:', conteudo);
    
    // DEBUG: Mostrar JSON completo em um alert para debug
    const jsonPreview = JSON.stringify(conteudo, null, 2).substring(0, 300);
    alert('‚ùå Erro de estrutura do conte√∫do:\n\nEstrutura recebida:\n' + jsonPreview + '\n\n...veja o console para mais detalhes');
    renderDashboard();
    return;
  }

  const { conteudo: detalhes, topicos = [], tipo, disciplina_id } = conteudo;
  const nomeDisciplina = meta?.disciplina_nome || 'Disciplina';
  const secoesValidas = Array.isArray(detalhes?.secoes) ? detalhes.secoes : [];
  
  console.log('‚úÖ Estrutura v√°lida!');
  console.log('üìö T√≥picos:', topicos);
  console.log('üìù Se√ß√µes v√°lidas:', secoesValidas.length);
  console.log('üìñ Disciplina:', nomeDisciplina);

  // Estado do simulado
  window.respostasSimulado = {};
  window.simuladoFinalizado = false;

  // Coletar todas as teorias em um √∫nico bloco
  const todasTeorias = secoesValidas
    .map(secao => secao.conteudo?.teoria_completa || '')
    .filter(t => t.length > 0)
    .join('\n\n---\n\n');
  
  // Contar quest√µes
  const totalQuestoes = secoesValidas
    .reduce((sum, s) => sum + (s.conteudo?.questoes?.length || 0), 0);
  
  console.log('üìÑ Total de caracteres da teoria:', todasTeorias.length);
  console.log('‚ùì Total de quest√µes encontradas:', totalQuestoes);
  console.log('üéØ Tipo de conte√∫do:', tipo);
  
  // Verifica√ß√£o: para tipo "exercicios", teoria √© opcional
  const isExercicios = tipo === 'exercicios';
  const isRevisao = tipo === 'revisao';
  
  if (!isExercicios && !isRevisao && todasTeorias.length === 0) {
    console.error('‚ùå ERRO: Conte√∫do tipo "teoria" deve ter teoria_completa!');
    console.log('üîç Estrutura completa do conte√∫do:', JSON.stringify(conteudo, null, 2));
    alert('‚ö†Ô∏è Erro: O material de estudo n√£o foi gerado corretamente.\n\nTente gerar novamente ou recarregue a p√°gina.');
    renderDashboard();
    return;
  }
  
  if (totalQuestoes === 0 && isExercicios) {
    console.error('‚ùå ERRO: Conte√∫do tipo "exercicios" deve ter quest√µes!');
    alert('‚ö†Ô∏è Erro: Nenhuma quest√£o foi gerada.\n\nTente gerar novamente.');
    renderDashboard();
    return;
  }
  
  if (totalQuestoes === 0) {
    console.warn('‚ö†Ô∏è ATEN√á√ÉO: Nenhuma quest√£o foi encontrada nas se√ß√µes!');
    console.log('üîç Conte√∫do das se√ß√µes:', secoesValidas.map(s => ({
      titulo: s.titulo,
      temQuestoes: !!s.conteudo?.questoes,
      numQuestoes: s.conteudo?.questoes?.length || 0,
      temTeoria: !!s.conteudo?.teoria_completa
    })));
  }

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg}">
      <header class="${themes[currentTheme].card} shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <button onclick="renderDashboard()" class="${themes[currentTheme].textSecondary} hover:${themes[currentTheme].text} flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <i class="fas fa-arrow-left"></i>
            <span>Voltar</span>
          </button>
          <h1 class="text-2xl font-bold ${themes[currentTheme].text} flex items-center gap-2">
            <i class="fas fa-book-open text-blue-500"></i>
            ${nomeDisciplina}
          </h1>
          <div class="w-24"></div>
        </div>
      </header>

      <div class="max-w-5xl mx-auto px-4 py-8">
        ${tipo === 'exercicios' && todasTeorias.length === 0 ? `
        <!-- ALERTA: EXERC√çCIOS SEM TEORIA -->
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-6 mb-6 rounded-lg">
          <div class="flex items-start gap-3">
            <i class="fas fa-info-circle text-yellow-500 text-2xl mt-1"></i>
            <div>
              <h3 class="font-bold text-yellow-800 dark:text-yellow-300 mb-2">Sess√£o de Exerc√≠cios</h3>
              <p class="text-yellow-700 dark:text-yellow-400 text-sm">
                Esta √© uma sess√£o pr√°tica de <strong>resolu√ß√£o de quest√µes</strong>. 
                ${detalhes.introducao || 'Teste seus conhecimentos e identifique pontos de melhoria.'}
              </p>
            </div>
          </div>
        </div>
        ` : ''}
        
        ${todasTeorias.length > 0 ? `
        <!-- CARD √öNICO: TEORIA COMPLETA -->
        <div class="${themes[currentTheme].card} rounded-xl shadow-lg p-8 mb-6 border-l-4 border-blue-500">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold ${themes[currentTheme].text} flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                <i class="fas fa-book text-white"></i>
              </div>
              <span>Material de Estudo</span>
            </h2>
            <div class="text-sm ${themes[currentTheme].textSecondary}">
              <i class="far fa-clock mr-1"></i>
              ${meta?.tempo_minutos || 0} minutos
            </div>
          </div>
          
          <div class="teoria-content ${themes[currentTheme].text} leading-relaxed" style="text-align: justify; white-space: pre-wrap; line-height: 1.8;">
            ${todasTeorias.split('\n').map(line => {
              // Processar markdown b√°sico
              const trimmed = line.trim();
              
              if (trimmed.startsWith('## ')) {
                return `<h2 style="font-size: 1.8em; font-weight: bold; margin-top: 1.5em; margin-bottom: 0.5em; color: #2563eb;">${trimmed.substring(3)}</h2>`;
              } else if (trimmed.startsWith('### ')) {
                return `<h3 style="font-size: 1.4em; font-weight: 600; margin-top: 1em; margin-bottom: 0.5em; color: #3b82f6;">${trimmed.substring(4)}</h3>`;
              } else if (trimmed.match(/^\d+\.\s+\*\*/)) {
                // Lista numerada com negrito
                const text = trimmed.replace(/\*\*/g, '<strong>').replace(/\*\*/g, '</strong>');
                return `<p style="margin-left: 1.5em; margin-top: 0.5em;">${text}</p>`;
              } else if (trimmed.startsWith('**') && trimmed.includes(':**')) {
                // T√≠tulo em negrito
                const text = trimmed.replace(/\*\*/g, '<strong>').replace(/\*\*/g, '</strong>');
                return `<p style="margin-top: 1em; font-weight: 600;">${text}</p>`;
              } else if (trimmed.startsWith('-')) {
                return `<p style="margin-left: 1.5em; margin-top: 0.3em;">${trimmed}</p>`;
              } else if (trimmed === '---') {
                return `<hr style="margin: 2em 0; border-top: 2px solid #e5e7eb;" />`;
              } else if (trimmed) {
                return `<p style="margin-top: 0.8em;">${trimmed}</p>`;
              }
              return '';
            }).join('')}
          </div>
        </div>
        ` : ''}

        <!-- CARD DE SIMULADO -->
        ${secoesValidas.some(s => s.conteudo?.questoes && s.conteudo.questoes.length > 0) ? `
          <div id="simuladoCard" class="${themes[currentTheme].card} rounded-xl shadow-lg p-8 mb-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold ${themes[currentTheme].text} flex items-center gap-3">
                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                  <i class="fas fa-clipboard-check text-white"></i>
                </div>
                <span>Simulado - Teste seus conhecimentos</span>
              </h2>
            </div>
            
            <div id="questoesContainer">
              ${secoesValidas.map((secao, secIdx) => {
                const questoes = secao.conteudo?.questoes || [];
                return questoes.map((q, qIdx) => `
                  <div class="questao-card bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border-l-4 border-gray-300">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">
                        ${qIdx + 1}
                      </div>
                      <h3 class="font-bold ${themes[currentTheme].text} text-lg">
                        Quest√£o ${qIdx + 1}
                      </h3>
                    </div>
                    <p class="${themes[currentTheme].text} mb-4 leading-relaxed whitespace-pre-line">${q.enunciado}</p>
                    
                    <div class="space-y-3">
                      ${q.alternativas.map((alt, altIdx) => `
                        <label class="flex items-start p-3 rounded-lg cursor-pointer hover:bg-opacity-10 hover:bg-blue-500 transition">
                          <input type="radio" 
                            name="questao_${secIdx}_${qIdx}" 
                            value="${altIdx}"
                            onchange="salvarResposta(${secIdx}, ${qIdx}, ${altIdx})"
                            class="mt-1 mr-3">
                          <span class="${themes[currentTheme].text}">
                            <strong>${String.fromCharCode(65 + altIdx)})</strong> ${alt.replace(/^[A-E]\)\s*/, '')}
                          </span>
                        </label>
                      `).join('')}
                    </div>
                    
                    <div id="explicacao_${secIdx}_${qIdx}" class="hidden mt-4 p-4 rounded-lg bg-blue-50">
                      <p class="text-sm text-gray-800"><strong>Gabarito:</strong> ${String.fromCharCode(65 + q.gabarito)}</p>
                      <p class="text-sm text-gray-700 mt-2">${q.explicacao}</p>
                    </div>
                  </div>
                `).join('');
              }).join('')}
            </div>
            
            <div class="flex items-center justify-between mt-6">
              <button onclick="finalizarSimulado()" 
                class="bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-green-700 transform hover:scale-105 transition">
                <i class="fas fa-check-circle mr-2"></i>
                Finalizar e Ver Resultado
              </button>
            </div>
          </div>
          
          <!-- CARD DE RESULTADO (inicialmente oculto) -->
          <div id="resultadoCard" class="hidden ${themes[currentTheme].card} rounded-xl shadow-lg p-8 border-l-4 border-yellow-500">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center">
                <i class="fas fa-trophy text-white text-xl"></i>
              </div>
              <h2 class="text-2xl font-bold ${themes[currentTheme].text}">
                Resultado do Simulado
              </h2>
            </div>
            <div id="resultadoConteudo"></div>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  // Fun√ß√µes do simulado
  window.salvarResposta = (secIdx, qIdx, altIdx) => {
    if (!window.respostasSimulado) window.respostasSimulado = {};
    window.respostasSimulado[`${secIdx}_${qIdx}`] = altIdx;
  };
  
  window.finalizarSimulado = () => {
    if (window.simuladoFinalizado) {
      alert('Simulado j√° finalizado!');
      return;
    }
    
    // Coletar todas as quest√µes
    const todasQuestoes = [];
    secoesValidas.forEach((secao, secIdx) => {
      const questoes = secao.conteudo?.questoes || [];
      questoes.forEach((q, qIdx) => {
        todasQuestoes.push({ secIdx, qIdx, questao: q });
      });
    });
    
    if (todasQuestoes.length === 0) return;
    
    // Calcular acertos
    let acertos = 0;
    todasQuestoes.forEach(({ secIdx, qIdx, questao }) => {
      const respostaUsuario = window.respostasSimulado[`${secIdx}_${qIdx}`];
      if (respostaUsuario === questao.gabarito) {
        acertos++;
      }
      // Mostrar explica√ß√£o
      const explicacaoDiv = document.getElementById(`explicacao_${secIdx}_${qIdx}`);
      if (explicacaoDiv) {
        explicacaoDiv.classList.remove('hidden');
        if (respostaUsuario === questao.gabarito) {
          explicacaoDiv.classList.add('bg-green-50');
          explicacaoDiv.classList.remove('bg-blue-50');
        } else {
          explicacaoDiv.classList.add('bg-red-50');
          explicacaoDiv.classList.remove('bg-blue-50');
        }
      }
    });
    
    const total = todasQuestoes.length;
    const percentual = Math.round((acertos / total) * 100);
    const nota = (acertos / total) * 10;
    
    // Determinar emoji e mensagem
    let emoji = 'üòê';
    let mensagem = 'Continue estudando!';
    let cor = 'text-yellow-600';
    
    if (percentual >= 90) {
      emoji = 'üèÜ';
      mensagem = 'Excelente! Voc√™ domina o conte√∫do!';
      cor = 'text-green-600';
    } else if (percentual >= 70) {
      emoji = 'üòä';
      mensagem = 'Muito bom! Continue assim!';
      cor = 'text-blue-600';
    } else if (percentual >= 50) {
      emoji = 'üòê';
      mensagem = 'Razo√°vel. Revise os pontos fracos.';
      cor = 'text-yellow-600';
    } else {
      emoji = 'üòï';
      mensagem = 'Estude mais este conte√∫do.';
      cor = 'text-red-600';
    }
    
    // Mostrar resultado
    const resultadoCard = document.getElementById('resultadoCard');
    const resultadoConteudo = document.getElementById('resultadoConteudo');
    
    resultadoConteudo.innerHTML = `
      <div class="text-center mb-8">
        <div class="text-8xl mb-4">${emoji}</div>
        <h3 class="text-4xl font-bold ${cor} mb-2">${percentual}%</h3>
        <p class="text-xl ${themes[currentTheme].text} mb-2">Nota: ${nota.toFixed(1)}/10</p>
        <p class="${themes[currentTheme].textSecondary}">${mensagem}</p>
      </div>
      
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-green-100 rounded-lg p-4 text-center">
          <p class="text-3xl font-bold text-green-600">${acertos}</p>
          <p class="text-sm text-gray-600">Acertos</p>
        </div>
        <div class="bg-red-100 rounded-lg p-4 text-center">
          <p class="text-3xl font-bold text-red-600">${total - acertos}</p>
          <p class="text-sm text-gray-600">Erros</p>
        </div>
        <div class="bg-blue-100 rounded-lg p-4 text-center">
          <p class="text-3xl font-bold text-blue-600">${total}</p>
          <p class="text-sm text-gray-600">Total</p>
        </div>
      </div>
      
      <div class="bg-gray-100 rounded-lg p-4">
        <h4 class="font-bold text-gray-800 mb-2">üìä An√°lise de Desempenho</h4>
        <div class="w-full bg-gray-300 rounded-full h-4 mb-2">
          <div class="bg-gradient-to-r from-green-500 to-green-600 h-4 rounded-full transition-all duration-1000" style="width: ${percentual}%"></div>
        </div>
        <p class="text-sm text-gray-600">
          ${percentual >= 70 ? 
            'Voc√™ est√° preparado para quest√µes deste n√≠vel. Continue praticando para manter o desempenho!' : 
            'Recomendamos revisar a teoria acima e refazer este simulado ap√≥s o estudo.'}
        </p>
      </div>
    `;
    
    resultadoCard.classList.remove('hidden');
    resultadoCard.scrollIntoView({ behavior: 'smooth' });
    window.simuladoFinalizado = true;
  };
}

function renderSecaoConteudo(conteudo, tipo) {
  if (!conteudo) return '<p class="text-gray-500">Conte√∫do n√£o dispon√≠vel</p>';
  
  if (tipo === 'teoria') {
    const textoIntro = conteudo.texto_introducao || '';
    const pontosChave = Array.isArray(conteudo.pontos_chave) ? conteudo.pontos_chave : [];
    const desenvolvimento = Array.isArray(conteudo.desenvolvimento) ? conteudo.desenvolvimento : [];
    const exemplos = Array.isArray(conteudo.exemplos) ? conteudo.exemplos : [];
    const dicas = Array.isArray(conteudo.dicas) ? conteudo.dicas : [];
    
    return `
      <div class="space-y-6">
        ${textoIntro ? `
          <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
            <p class="text-gray-800 leading-relaxed">${textoIntro}</p>
          </div>
        ` : ''}
        
        ${pontosChave.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-blue-700">üìö Conceitos Fundamentais</h4>
            <div class="space-y-3">
              ${pontosChave.map(p => `
                <div class="bg-white p-3 rounded border-l-4 border-blue-400">
                  <p class="text-gray-800 leading-relaxed">${p}</p>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${desenvolvimento.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-gray-800">üìñ Desenvolvimento do Conte√∫do</h4>
            <div class="prose max-w-none space-y-4">
              ${desenvolvimento.map(paragrafo => `
                <p class="text-gray-700 leading-relaxed text-justify">${paragrafo}</p>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${exemplos.length > 0 ? `
          <div class="bg-green-50 p-4 rounded-lg">
            <h4 class="font-bold text-lg mb-3 text-green-700">üí° Exemplos Pr√°ticos</h4>
            <div class="space-y-3">
              ${exemplos.map(e => `
                <div class="bg-white p-3 rounded">
                  <p class="text-gray-800 leading-relaxed">${e}</p>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${dicas.length > 0 ? `
          <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
            <h4 class="font-bold text-lg mb-3 text-yellow-700">‚ö° Dicas Importantes</h4>
            <ul class="space-y-2">
              ${dicas.map(d => `
                <li class="flex items-start">
                  <i class="fas fa-star text-yellow-500 mr-2 mt-1"></i>
                  <span class="text-gray-800">${d}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
    `;
  } else if (tipo === 'exercicios') {
    const questoes = conteudo.questoes_sugeridas || '';
    const orientacao = conteudo.orientacao_resolucao || '';
    const estrategia = Array.isArray(conteudo.estrategia) ? conteudo.estrategia : [];
    const tipoQuestoes = Array.isArray(conteudo.tipo_questoes) ? conteudo.tipo_questoes : [];
    const fontes = Array.isArray(conteudo.fontes) ? conteudo.fontes : [];
    const posResolucao = conteudo.pos_resolucao || '';
    
    return `
      <div class="space-y-6">
        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
          <p class="font-bold text-lg text-purple-700 mb-2">${questoes}</p>
          ${orientacao ? `<p class="text-gray-700 mt-2">${orientacao}</p>` : ''}
        </div>
        
        ${estrategia.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-blue-700">üéØ Estrat√©gia de Resolu√ß√£o</h4>
            <ol class="space-y-2">
              ${estrategia.map(e => `
                <li class="flex items-start">
                  <span class="font-semibold text-blue-600 mr-2">${e.split(':')[0]}:</span>
                  <span class="text-gray-800">${e.split(':').slice(1).join(':')}</span>
                </li>
              `).join('')}
            </ol>
          </div>
        ` : ''}
        
        ${tipoQuestoes.length > 0 ? `
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-bold text-lg mb-3 text-blue-700">üìù Tipo de Quest√µes</h4>
            <ul class="space-y-2">
              ${tipoQuestoes.map(t => `<li class="text-gray-800">${t}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${fontes.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-purple-700">üìö Fontes Recomendadas</h4>
            <ul class="space-y-2">
              ${fontes.map(f => `
                <li class="flex items-start">
                  <i class="fas fa-book text-purple-600 mr-2 mt-1"></i>
                  <span class="text-gray-800">${f}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${posResolucao ? `
          <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
            <h4 class="font-bold text-lg mb-2 text-green-700">‚úÖ P√≥s-Resolu√ß√£o</h4>
            <p class="text-gray-800 leading-relaxed">${posResolucao}</p>
          </div>
        ` : ''}
      </div>
    `;
  } else { // revisao
    const metodo = conteudo.metodo || '';
    const introducao = conteudo.introducao_revisao || '';
    const atividades = Array.isArray(conteudo.atividades) ? conteudo.atividades : [];
    const foco = Array.isArray(conteudo.foco) ? conteudo.foco : [];
    const tecnicas = Array.isArray(conteudo.tecnicas) ? conteudo.tecnicas : [];
    const objetivo = conteudo.objetivo_revisao || '';
    
    return `
      <div class="space-y-6">
        <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500">
          <p class="font-bold text-lg text-indigo-700 mb-2">${metodo}</p>
          ${introducao ? `<p class="text-gray-700 mt-2">${introducao}</p>` : ''}
        </div>
        
        ${atividades.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-blue-700">üìã Roteiro de Revis√£o</h4>
            <ol class="space-y-3">
              ${atividades.map(a => `
                <li class="bg-white p-3 rounded border-l-4 border-blue-400">
                  <p class="text-gray-800 leading-relaxed">${a}</p>
                </li>
              `).join('')}
            </ol>
          </div>
        ` : ''}
        
        ${foco.length > 0 ? `
          <div class="bg-green-50 p-4 rounded-lg">
            <h4 class="font-bold text-lg mb-3 text-green-700">üéØ Pontos de Foco</h4>
            <ul class="space-y-2">
              ${foco.map(f => `
                <li class="flex items-start">
                  <i class="fas fa-bullseye text-green-600 mr-2 mt-1"></i>
                  <span class="text-gray-800">${f}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${tecnicas.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-purple-700">üß† T√©cnicas de Memoriza√ß√£o</h4>
            <ul class="space-y-2">
              ${tecnicas.map(t => `
                <li class="text-gray-800">${t}</li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${objetivo ? `
          <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
            <h4 class="font-bold text-lg mb-2 text-yellow-700">üèÜ Objetivo Final</h4>
            <p class="text-gray-800 leading-relaxed">${objetivo}</p>
          </div>
        ` : ''}
      </div>
    `;
  }
}
