// Estado da aplica√ß√£o
let currentUser = null;
let currentStep = 'login';
let interviewData = {};
let disciplinasDisponiveis = [];
let currentTheme = localStorage.getItem('theme') || 'light';
let customColors = JSON.parse(localStorage.getItem('customColors') || '{"primary": "#8b5cf6", "secondary": "#ec4899", "accent": "#3b82f6"}');
let rgbColors = JSON.parse(localStorage.getItem('rgbColors') || '{"primary": "#8b5cf6", "secondary": "#ec4899", "accent": "#3b82f6"}');

// Temas dispon√≠veis - EXPANDIDO COM MAIS VARIA√á√ïES
const themes = {
  light: {
    // Backgrounds
    bg: 'bg-gray-50',
    bgAlt: 'bg-gray-100',
    card: 'bg-white',
    cardHover: 'hover:bg-gray-50',
    
    // Textos
    text: 'text-gray-800',
    textSecondary: 'text-gray-600',
    textMuted: 'text-gray-500',
    textDark: 'text-gray-900',
    
    // Bordas
    border: '${themes[currentTheme].border}',
    borderHover: 'hover:border-gray-300',
    
    // Inputs
    input: 'bg-white border-gray-300 text-gray-900',
    inputFocus: 'focus:border-blue-500 focus:ring-blue-500',
    
    // Buttons secund√°rios
    btnSecondary: 'bg-gray-100 text-gray-700 hover:bg-gray-200',
    btnDanger: 'bg-blue-100 text-blue-700 hover:bg-blue-200',
    
    // Alertas e notifica√ß√µes
    alert: 'bg-blue-50 border-blue-200 text-blue-800',
    success: 'bg-blue-50 border-blue-200 text-blue-800',
    warning: 'bg-blue-50 border-blue-200 text-blue-700',
    error: 'bg-blue-50 border-blue-200 text-blue-800',
    
    // Outros
    shadow: 'shadow-md',
    divider: '${themes[currentTheme].border}'
  },
  dark: {
    // Backgrounds
    bg: 'bg-gray-900',
    bgAlt: 'bg-gray-800',
    card: 'bg-gray-800',
    cardHover: 'hover:bg-gray-750',
    
    // Textos
    text: 'text-gray-100',
    textSecondary: 'text-gray-300',
    textMuted: 'text-gray-400',
    textDark: 'text-white',
    
    // Bordas
    border: 'border-gray-700',
    borderHover: 'hover:border-gray-600',
    
    // Inputs
    input: 'bg-gray-700 border-gray-600 text-gray-100',
    inputFocus: 'focus:border-blue-400 focus:ring-blue-400',
    
    // Buttons secund√°rios
    btnSecondary: 'bg-gray-700 text-gray-100 hover:bg-gray-600',
    btnDanger: 'bg-blue-900 text-blue-100 hover:bg-blue-800',
    
    // Alertas e notifica√ß√µes
    alert: 'bg-blue-900/30 border-blue-700 text-blue-200',
    success: 'bg-blue-900/30 border-blue-700 text-blue-200',
    warning: 'bg-blue-900/30 border-blue-700 text-blue-300',
    error: 'bg-blue-900/30 border-blue-700 text-blue-200',
    
    // Outros
    shadow: 'shadow-2xl shadow-black/50',
    divider: 'border-gray-700'
  }
};

// Paleta monocrom√°tica azul - tons profissionais de azul
const colorPalette = {
  light: {
    // Tons monocrom√°ticos azuis sutis
    primary: {
      gradient: 'from-blue-600 to-blue-700',
      text: 'text-blue-700',
      bg: 'bg-blue-50',
      border: 'border-blue-200',
      icon: 'text-blue-600'
    },
    secondary: {
      gradient: 'from-blue-500 to-blue-600',
      text: 'text-blue-600',
      bg: 'bg-blue-50',
      border: 'border-blue-200',
      icon: 'text-blue-500'
    },
    success: {
      gradient: 'from-blue-500 to-blue-600',
      text: 'text-blue-600',
      bg: 'bg-blue-50',
      border: 'border-blue-200',
      icon: 'text-blue-500'
    },
    warning: {
      gradient: 'from-blue-500 to-blue-600',
      text: 'text-blue-600',
      bg: 'bg-blue-50',
      border: 'border-blue-200',
      icon: 'text-blue-500'
    },
    info: {
      gradient: 'from-blue-500 to-blue-600',
      text: 'text-blue-600',
      bg: 'bg-blue-50',
      border: 'border-blue-200',
      icon: 'text-blue-500'
    },
    accent: {
      gradient: 'from-blue-600 to-blue-700',
      text: 'text-blue-700',
      bg: 'bg-blue-50',
      border: 'border-blue-200',
      icon: 'text-blue-600'
    }
  },
  dark: {
    // Tons monocrom√°ticos azuis para dark mode
    primary: {
      gradient: 'from-blue-600 to-blue-700',
      text: 'text-blue-300',
      bg: 'bg-blue-900/30',
      border: 'border-blue-700',
      icon: 'text-blue-400'
    },
    secondary: {
      gradient: 'from-blue-600 to-blue-700',
      text: 'text-blue-300',
      bg: 'bg-blue-900/30',
      border: 'border-blue-700',
      icon: 'text-blue-400'
    },
    success: {
      gradient: 'from-blue-600 to-blue-700',
      text: 'text-blue-300',
      bg: 'bg-blue-900/30',
      border: 'border-blue-700',
      icon: 'text-blue-400'
    },
    warning: {
      gradient: 'from-blue-600 to-blue-700',
      text: 'text-blue-300',
      bg: 'bg-blue-900/30',
      border: 'border-blue-700',
      icon: 'text-blue-400'
    },
    info: {
      gradient: 'from-blue-600 to-blue-700',
      text: 'text-blue-300',
      bg: 'bg-blue-900/30',
      border: 'border-blue-700',
      icon: 'text-blue-400'
    },
    accent: {
      gradient: 'from-blue-600 to-blue-700',
      text: 'text-blue-300',
      bg: 'bg-blue-900/30',
      border: 'border-blue-700',
      icon: 'text-blue-400'
    }
  }
};

// Helper para acessar paleta atual
const c = (type = 'primary') => colorPalette[currentTheme][type] || colorPalette[currentTheme].primary;

// Helper para acessar tema atual
const t = () => themes[currentTheme];

// Aplicar tema
function applyTheme(theme) {
  currentTheme = theme;
  localStorage.setItem('theme', theme);
  
  // Aplicar ao body E ao container principal
  document.body.className = themes[theme].bg;
  const mainDiv = document.getElementById('app');
  if (mainDiv) {
    mainDiv.className = themes[theme].bg + ' min-h-screen transition-colors duration-300';
  }
  
  // Aplicar classe dark ao HTML se tema escuro
  if (theme === 'dark') {
    document.documentElement.classList.add('dark');
    document.body.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
    document.body.classList.remove('dark');
  }
}

// Converter hex para RGB
function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : { r: 139, g: 92, b: 246 }; // fallback purple
}

// Inicializar aplica√ß√£o
document.addEventListener('DOMContentLoaded', () => {
  // Se tema RGB ou custom, resetar para light
  if (currentTheme === 'rgb' || currentTheme === 'custom') {
    currentTheme = 'light';
    localStorage.setItem('theme', 'light');
  }
  applyTheme(currentTheme);
  checkUser();
  
  // Adicionar bot√£o de emerg√™ncia "Voltar ao Login"
  addEmergencyBackButton();
});

// ============== BOT√ÉO DE EMERG√äNCIA ==============
function addEmergencyBackButton() {
  // Criar bot√£o fixo no canto inferior direito
  const emergencyBtn = document.createElement('button');
  emergencyBtn.id = 'emergency-back-btn';
  emergencyBtn.innerHTML = `
    <i class="fas fa-home mr-2"></i>
    Voltar ao Login
  `;
  emergencyBtn.className = `
    fixed bottom-4 right-4 z-50
    bg-red-600 hover:bg-red-700 text-white
    px-4 py-3 rounded-lg shadow-lg
    font-semibold text-sm
    transition-all duration-300
    hover:scale-105
    flex items-center gap-2
    opacity-0 hover:opacity-100
  `;
  emergencyBtn.style.cssText = `
    transition: opacity 0.3s ease;
  `;
  
  // Ao clicar: limpar tudo e voltar ao login
  emergencyBtn.onclick = () => {
    if (confirm('‚ö†Ô∏è Deseja limpar a sess√£o atual e voltar ao login?\n\nIsso vai fazer logout da conta atual.')) {
      localStorage.clear();
      window.location.reload();
    }
  };
  
  document.body.appendChild(emergencyBtn);
  
  // Mostrar bot√£o quando mouse est√° pr√≥ximo do canto inferior direito
  document.addEventListener('mousemove', (e) => {
    const distanceFromBottomRight = Math.sqrt(
      Math.pow(window.innerWidth - e.clientX, 2) + 
      Math.pow(window.innerHeight - e.clientY, 2)
    );
    
    if (distanceFromBottomRight < 150) {
      emergencyBtn.style.opacity = '1';
    } else {
      emergencyBtn.style.opacity = '0.3';
    }
  });
  
  // Sempre mostrar se houver erro na p√°gina
  window.addEventListener('error', () => {
    emergencyBtn.style.opacity = '1';
    emergencyBtn.classList.add('animate-pulse');
  });
}

function checkUser() {
  const userId = localStorage.getItem('userId');
  const userEmail = localStorage.getItem('userEmail');
  
  // SEMPRE mostrar login se n√£o tiver email salvo (sess√£o expirada ou logout)
  if (!userId || !userEmail) {
    renderLogin();
    return;
  }
  
  // Se tem userId E email, est√° autenticado
  currentUser = { id: parseInt(userId), email: userEmail };
  verificarEntrevista();
}

// ============== TELA DE LOGIN ==============
function renderLogin() {
  let isLoginMode = true;

  const render = () => {
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen flex items-center justify-center bg-gradient-to-br ${c('primary').gradient}">
        <div class="${themes[currentTheme].card} p-8 rounded-lg shadow-2xl w-full max-w-md">
          <div class="text-center mb-8">
            <i class="fas fa-brain text-6xl ${c('primary').icon} mb-4"></i>
            <h1 class="text-4xl font-bold ${themes[currentTheme].text}">
              <span class="${c('primary').text}">IA</span><span class="${c('secondary').text}">prova</span>
            </h1>
            <p class="${themes[currentTheme].textSecondary} mt-2">Prepara√ß√£o Inteligente para Concursos P√∫blicos</p>
          </div>
          
          <!-- Bot√µes de altern√¢ncia -->
          <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
            <button id="btnLogin" onclick="toggleMode(true)" 
              class="${isLoginMode ? 'bg-white shadow' : ''} flex-1 py-2 rounded-md font-semibold transition">
              Login
            </button>
            <button id="btnCadastro" onclick="toggleMode(false)" 
              class="${!isLoginMode ? 'bg-white shadow' : ''} flex-1 py-2 rounded-md font-semibold transition">
              Cadastro
            </button>
          </div>
          
          <form id="authForm" class="space-y-4">
            ${!isLoginMode ? `
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                <input type="text" id="userName" required 
                  class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Seu nome completo">
              </div>
            ` : ''}
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
              <input type="email" id="userEmail" required 
                class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="seu@email.com">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
              <input type="password" id="userPassword" required minlength="4"
                class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="M√≠nimo 4 caracteres">
            </div>
            
            <button type="submit" 
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
              ${isLoginMode ? 'üîì Entrar' : 'üöÄ Criar Conta'}
            </button>
          </form>
          
          <div class="mt-6 text-center text-sm text-gray-600">
            ${isLoginMode ? 
              'Primeira vez aqui? Use o Cadastro acima.' : 
              'J√° tem conta? Use o Login acima.'}
          </div>
        </div>
      </div>
    `;

    window.toggleMode = (loginMode) => {
      isLoginMode = loginMode;
      render();
    };

    document.getElementById('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;

      try {
        if (isLoginMode) {
          // Login
          const response = await axios.post('/api/login', { email, password });
          currentUser = response.data;
          
          // Salvar dados da sess√£o
          localStorage.setItem('userId', currentUser.id);
          localStorage.setItem('userEmail', email);
          localStorage.setItem('userName', currentUser.name || '');
          
          verificarEntrevista();
        } else {
          // Cadastro
          const name = document.getElementById('userName').value;
          const response = await axios.post('/api/users', { name, email, password });
          
          if (response.data.id) {
            alert('‚úÖ Cadastro realizado com sucesso! Fa√ßa login agora.');
            isLoginMode = true;
            render();
          }
        }
      } catch (error) {
        const errorMsg = error.response?.data?.error || 'Erro na opera√ß√£o';
        alert('‚ùå ' + errorMsg);
      }
    });
  };

  render();
}

// ============== ENTREVISTA INICIAL ==============
async function iniciarEntrevista() {
  // ‚úÖ CORRE√á√ÉO: N√ÉO carregar disciplinas padr√£o aqui
  // Elas ser√£o carregadas apenas se n√£o houver edital
  
  interviewData = {
    user_id: currentUser.id,
    objetivo_tipo: '',
    tempo_disponivel_dia: 0,
    experiencia: '',
    ja_estudou_antes: false,
    reprovacoes: 0,
    disciplinas: [],
    disciplinas_do_edital: [] // Novo campo
  };
  
  renderEntrevistaStep1();
}

function renderEntrevistaStep1() {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg} py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold ${themes[currentTheme].text}">Entrevista Inicial</h2>
              <span class="text-sm text-gray-500">Passo 1 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 25%"></div>
            </div>
          </div>

          <h3 class="text-xl font-semibold mb-6">Qual √© seu objetivo?</h3>

          <div class="space-y-4">
            <button onclick="selecionarObjetivo('concurso_especifico')" 
              class="w-full p-6 border-2 ${themes[currentTheme].border} rounded-lg hover:border-blue-500 hover:bg-blue-50 transition text-left">
              <div class="flex items-center">
                <i class="fas fa-bullseye text-3xl ${c('primary').icon} mr-4"></i>
                <div>
                  <h4 class="font-semibold text-lg">Concurso Espec√≠fico</h4>
                  <p class="${themes[currentTheme].textSecondary}">Tenho um concurso espec√≠fico em mente</p>
                </div>
              </div>
            </button>

            <button onclick="selecionarObjetivo('area_geral')" 
              class="w-full p-6 border-2 ${themes[currentTheme].border} rounded-lg hover:border-blue-500 hover:bg-blue-50 transition text-left">
              <div class="flex items-center">
                <i class="fas fa-th-large text-3xl ${c('secondary').icon} mr-4"></i>
                <div>
                  <h4 class="font-semibold text-lg">√Årea Geral</h4>
                  <p class="${themes[currentTheme].textSecondary}">Quero estudar para uma √°rea espec√≠fica</p>
                </div>
              </div>
            </button>
          </div>

          <!-- Bot√£o Voltar ao Login -->
          <div class="mt-8 pt-6 border-t ${themes[currentTheme].border}">
            <button onclick="voltarAoLogin()" 
              class="w-full py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition flex items-center justify-center gap-2">
              <i class="fas fa-arrow-left"></i>
              Voltar ao Login
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Fun√ß√£o para voltar ao login
function voltarAoLogin() {
  if (confirm('‚ö†Ô∏è Deseja sair da entrevista e voltar ao login?\n\nOs dados da entrevista atual n√£o ser√£o salvos.')) {
    localStorage.clear();
    window.location.reload();
  }
}

// Mapeamento de cargos para √°reas espec√≠ficas
function detectarAreaPorCargo(cargo) {
  const cargoLower = cargo.toLowerCase();
  
  // Sa√∫de
  if (cargoLower.includes('enferm') || cargoLower.includes('m√©dico') || 
      cargoLower.includes('farmac') || cargoLower.includes('fisio') ||
      cargoLower.includes('psic√≥logo') || cargoLower.includes('nutricionista') ||
      cargoLower.includes('sa√∫de') || cargoLower.includes('sus')) {
    return 'saude';
  }
  
  // Educa√ß√£o
  if (cargoLower.includes('professor') || cargoLower.includes('pedagog') ||
      cargoLower.includes('educador') || cargoLower.includes('docent')) {
    return 'educacao';
  }
  
  // Fiscal
  if (cargoLower.includes('auditor') || cargoLower.includes('fiscal') ||
      cargoLower.includes('receita') || cargoLower.includes('tribut')) {
    return 'fiscal';
  }
  
  // Policial
  if (cargoLower.includes('policial') || cargoLower.includes('agente') ||
      cargoLower.includes('delegado') || cargoLower.includes('investigador') ||
      cargoLower.includes('penitenci√°rio')) {
    return 'policial';
  }
  
  // Tribunais
  if (cargoLower.includes('tribunal') || cargoLower.includes('judici√°rio') ||
      cargoLower.includes('analista judic')) {
    return 'tribunais';
  }
  
  return null; // N√£o detectado, usu√°rio escolher√° manualmente
}

function selecionarObjetivo(tipo) {
  interviewData.objetivo_tipo = tipo;
  
  if (tipo === 'concurso_especifico') {
    renderConcursoEspecifico();
  } else {
    renderAreaGeral();
  }
}

function renderConcursoEspecifico() {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg} py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold ${themes[currentTheme].text}">Qual concurso?</h2>
              <span class="text-sm text-gray-500">Passo 1 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 25%"></div>
            </div>
          </div>

          <form id="concursoForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Concurso/√ìrg√£o</label>
              <input type="text" id="concursoNome" required placeholder="Ex: Receita Federal, Pol√≠cia Federal, TRT-SP"
                class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Cargo pretendido</label>
              <input type="text" id="cargo" required placeholder="Ex: Auditor Fiscal, Agente, Analista Judici√°rio"
                class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
              <p class="text-xs text-gray-500 mt-1">O conte√∫do ser√° personalizado para este cargo espec√≠fico</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Peso da Prova (opcional)</label>
              <input type="number" id="pesoProva" min="1" max="10" placeholder="Ex: 5"
                class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
              <p class="text-xs text-gray-500 mt-1">De 1 a 10, sendo 10 o mais importante. Isso ajudar√° a priorizar esta prova no seu plano de estudos</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Prazo at√© a prova (opcional)</label>
              <input type="date" id="prazoProva"
                class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border-2 border-blue-200">
              <label class="block text-sm font-semibold text-gray-800 mb-3">
                <i class="fas fa-file-upload mr-2 text-blue-600"></i>
                Anexar Edital ou Cronograma (opcional, mas recomendado)
              </label>
              
              <!-- Explica√ß√£o clara de O QUE enviar -->
              <div class="bg-white rounded-lg p-3 mb-3 border border-blue-200">
                <p class="text-sm font-semibold text-gray-800 mb-2">
                  <i class="fas fa-question-circle mr-1 text-blue-500"></i>
                  O que enviar?
                </p>
                <div class="space-y-2 text-xs text-gray-700">
                  <div class="flex items-start">
                    <i class="fas fa-file-pdf text-red-500 mr-2 mt-0.5"></i>
                    <div>
                      <strong>PDF do Edital:</strong> Arquivo oficial do concurso (extrai disciplinas e t√≥picos automaticamente)
                    </div>
                  </div>
                  <div class="flex items-start">
                    <i class="fas fa-file-alt text-gray-500 mr-2 mt-0.5"></i>
                    <div>
                      <strong>TXT do Edital:</strong> Se voc√™ j√° converteu o PDF para texto (processamento mais r√°pido)
                    </div>
                  </div>
                  <div class="flex items-start">
                    <i class="fas fa-file-excel text-green-600 mr-2 mt-0.5"></i>
                    <div>
                      <strong>XLSX de Cronograma:</strong> Sua planilha de estudos com disciplinas e t√≥picos organizados
                      <span class="block text-purple-600 mt-1">‚ú® RECOMENDADO: mais preciso e organizado!</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Input de upload -->
              <input type="file" id="editaisUpload" multiple accept=".pdf,.txt,.xlsx"
                class="w-full px-4 py-2 bg-white rounded-lg focus:ring-2 focus:ring-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300">
              
              <!-- Dicas de processamento -->
              <div class="mt-3 space-y-1.5">
                <p class="text-xs text-blue-600 flex items-start">
                  <i class="fas fa-clock mr-1.5 mt-0.5"></i>
                  <span><strong>PDF:</strong> Convers√£o autom√°tica em 10-30s com IA (Gemini)</span>
                </p>
                <p class="text-xs text-green-600 flex items-start">
                  <i class="fas fa-bolt mr-1.5 mt-0.5"></i>
                  <span><strong>XLSX:</strong> Importa√ß√£o instant√¢nea de disciplinas e t√≥picos organizados</span>
                </p>
                <p class="text-xs text-purple-600 flex items-start">
                  <i class="fas fa-lightbulb mr-1.5 mt-0.5"></i>
                  <span><strong>Dica:</strong> Se tiver cronograma Excel, envie-o para melhor precis√£o!</span>
                </p>
              </div>
              
              <div id="editaisPreview" class="mt-3 space-y-1"></div>
            </div>

            <div class="flex space-x-4">
              <button type="button" onclick="renderEntrevistaStep1()" 
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                Voltar
              </button>
              <button type="submit" 
                class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                Continuar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  // Preview de editais
  document.getElementById('editaisUpload').addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    const preview = document.getElementById('editaisPreview');
    
    if (files.length === 0) {
      preview.innerHTML = '';
      return;
    }
    
    preview.innerHTML = files.map((file, idx) => `
      <div class="flex items-center justify-between bg-blue-50 px-3 py-2 rounded text-sm">
        <div class="flex items-center gap-2">
          <i class="fas fa-file-${file.name.endsWith('.pdf') ? 'pdf text-red-500' : 'alt text-blue-500'}"></i>
          <span class="text-gray-700">${file.name}</span>
          <span class="text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span>
        </div>
        <button type="button" onclick="removerEdital(${idx})" class="text-red-500 hover:text-red-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `).join('');
  });

  document.getElementById('concursoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    interviewData.concurso_nome = document.getElementById('concursoNome').value;
    interviewData.cargo = document.getElementById('cargo').value;
    interviewData.peso_prova = parseInt(document.getElementById('pesoProva').value) || null;
    interviewData.prazo_prova = document.getElementById('prazoProva').value || null;
    
    // Salvar arquivos de editais
    const editaisFiles = document.getElementById('editaisUpload').files;
    interviewData.editais_arquivos = Array.from(editaisFiles);
    
    // ‚úÖ Informar sobre PDFs (mas n√£o bloquear)
    const arquivosPDF = Array.from(editaisFiles).filter(f => f.name.endsWith('.pdf'));
    if (arquivosPDF.length > 0) {
      console.log(`üìÑ ${arquivosPDF.length} PDF(s) detectado(s). Gemini AI ir√° extrair o texto automaticamente.`);
    }
    
    console.log(`üìÑ ${editaisFiles.length} edital(is) anexado(s)`);
    
    // Detectar √°rea automaticamente baseado no cargo
    const areaDetectada = detectarAreaPorCargo(interviewData.cargo);
    if (areaDetectada) {
      interviewData.area_geral = areaDetectada;
      console.log(`√Årea detectada automaticamente: ${areaDetectada} para cargo: ${interviewData.cargo}`);
    }
    
    // ‚úÖ NOVO: Processar edital ANTES de ir para Step2
    if (editaisFiles.length > 0) {
      await processarEditalAntesDeStep2();
    } else {
      renderEntrevistaStep2();
    }
  });
}

// ‚úÖ NOVA FUN√á√ÉO: Processar edital ANTES de mostrar disciplinas
async function processarEditalAntesDeStep2() {
  // Detectar se tem PDFs
  const temPDF = interviewData.editais_arquivos.some(f => f.name.endsWith('.pdf'));
  const tempoEstimado = temPDF ? '30-60 segundos' : '10-30 segundos';
  
  // Mostrar loading
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg} flex items-center justify-center">
      <div class="${themes[currentTheme].card} rounded-lg p-8 max-w-md mx-4 text-center">
        <i class="fas fa-spinner fa-spin text-6xl text-blue-600 mb-4"></i>
        <h3 class="text-2xl font-bold ${themes[currentTheme].text} mb-2">Processando Edital...</h3>
        <p class="${themes[currentTheme].textSecondary} mb-3">
          ${temPDF ? 'üìÑ Extraindo texto do PDF via Gemini AI...<br>' : ''}
          ü§ñ Analisando disciplinas e t√≥picos...<br>
          Aguarde ${tempoEstimado}
        </p>
        <div class="mt-4 bg-blue-50 border border-blue-200 rounded p-3">
          <p class="text-sm text-blue-700">
            <i class="fas fa-robot mr-1"></i>
            ${temPDF ? 'PDFs levam mais tempo (extra√ß√£o + an√°lise)' : 'Processamento via IA em andamento'}
          </p>
        </div>
        <div class="mt-4 space-y-2">
          <div class="flex items-center justify-center gap-2 text-sm ${themes[currentTheme].textSecondary}">
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
            <span>Etapa 1: ${temPDF ? 'Extraindo texto do PDF...' : 'Enviando arquivo...'}</span>
          </div>
          <div class="flex items-center justify-center gap-2 text-sm ${themes[currentTheme].textSecondary}">
            <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
            <span>Etapa 2: Extraindo disciplinas via IA...</span>
          </div>
          <div class="flex items-center justify-center gap-2 text-sm ${themes[currentTheme].textSecondary}">
            <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
            <span>Etapa 3: Salvando no banco de dados...</span>
          </div>
        </div>
      </div>
    </div>
  `;

  try {
    // 1Ô∏è‚É£ Upload de arquivos
    const formData = new FormData();
    formData.append('user_id', currentUser.id);
    formData.append('nome_concurso', interviewData.concurso_nome || 'Concurso');
    
    for (const file of interviewData.editais_arquivos) {
      formData.append('arquivos', file);
    }

    console.log('üì§ Enviando edital para backend...');
    const uploadRes = await axios.post('/api/editais/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });

    console.log('‚úÖ Upload conclu√≠do:', uploadRes.data);

    // 2Ô∏è‚É£ Processar cada edital via IA (APENAS SE N√ÉO FOR XLSX)
    for (const edital of uploadRes.data.editais) {
      // ‚úÖ NOVO: Se foi XLSX, j√° est√° processado automaticamente
      if (edital.processado_automaticamente) {
        console.log(`üìä XLSX ${edital.id} j√° processado automaticamente (${edital.disciplinas_extraidas} disciplinas)`);
        interviewData.edital_id = edital.id;
        continue; // Pular processamento via IA
      }
      
      console.log(`üß† Processando edital ID ${edital.id} com IA Gemini...`);
      
      try {
        const processRes = await axios.post(`/api/editais/processar/${edital.id}`);
        console.log(`‚úÖ Edital processado:`, processRes.data);
        
        // Salvar ID do edital processado
        interviewData.edital_id = edital.id;
      } catch (procError) {
        console.error(`‚ùå Erro ao processar edital ${edital.id}:`, procError);
        console.error(`‚ùå Resposta do servidor:`, procError?.response?.data);
        console.error(`‚ùå Status:`, procError?.response?.status);
        
        // Se for erro 400 ou 404, pode ser que j√° foi processado
        if (procError?.response?.status === 404) {
          console.warn(`‚ö†Ô∏è Edital ${edital.id} n√£o encontrado ou j√° processado`);
          interviewData.edital_id = edital.id;
          continue;
        }
        
        // Se for erro 400, mostrar mensagem espec√≠fica
        if (procError?.response?.status === 400) {
          const errorMsg = procError?.response?.data?.error || 'Erro desconhecido';
          throw new Error(`Processamento falhou: ${errorMsg}`);
        }
        
        throw procError; // Re-lan√ßar para ser capturado pelo catch externo
      }
    }

    // 3Ô∏è‚É£ Buscar disciplinas do edital processado (usar o ID salvo)
    if (interviewData.edital_id) {
      console.log(`‚úÖ Usando edital ID: ${interviewData.edital_id}`);
      
      try {
        const disciplinasRes = await axios.get(`/api/editais/${interviewData.edital_id}/disciplinas`);
        interviewData.disciplinas_do_edital = disciplinasRes.data;
        
        console.log(`üìö ${disciplinasRes.data.length} disciplinas extra√≠das do edital`);
        console.log('üìã Disciplinas:', disciplinasRes.data.map(d => d.nome).join(', '));
      } catch (discError) {
        console.error('‚ùå Erro ao buscar disciplinas do edital:', discError);
        interviewData.disciplinas_do_edital = [];
      }
    } else {
      console.warn('‚ö†Ô∏è Nenhum edital ID dispon√≠vel');
      interviewData.disciplinas_do_edital = [];
    }

    // Sucesso! Ir para Step2
    renderEntrevistaStep2();
    
  } catch (error) {
    // Log completo do erro para debug
    console.error('‚ùå Erro ao processar edital (COMPLETO):', error);
    console.error('‚ùå Tipo do erro:', typeof error);
    console.error('‚ùå Error.message:', error?.message);
    console.error('‚ùå Error.response:', error?.response);
    console.error('‚ùå Error.response.data:', error?.response?.data);
    console.error('‚ùå JSON do erro:', JSON.stringify(error, null, 2));
    
    // Fallback: continuar sem edital
    let errorMsg = '‚ö†Ô∏è N√£o foi poss√≠vel processar o edital automaticamente.\n\n';
    
    if (error.response) {
      // Erro HTTP do backend
      const backendError = error.response.data?.error || 'Erro desconhecido';
      errorMsg += `Erro: ${backendError}\n\n`;
      
      if (backendError.includes('Texto do edital vazio')) {
        errorMsg += 'üí° Dica: Converta o PDF para TXT antes de anexar.';
      } else if (backendError.includes('Gemini API')) {
        errorMsg += 'üí° Dica: O servi√ßo de IA pode estar temporariamente indispon√≠vel.';
      }
    } else if (error.message) {
      errorMsg += `Erro: ${error.message}\n\n`;
    } else {
      // Se n√£o for um objeto Error padr√£o, mostrar o que √©
      errorMsg += `Erro: ${String(error)}\n\n`;
    }
    
    errorMsg += '\nVoc√™ pode continuar selecionando disciplinas manualmente.';
    
    alert(errorMsg);
    
    renderEntrevistaStep2();
  }
}

function renderAreaGeral() {
  const areas = [
    { id: 'fiscal', nome: 'Fiscal', icon: 'fa-calculator' },
    { id: 'policial', nome: 'Policial', icon: 'fa-shield-alt' },
    { id: 'tribunais', nome: 'Tribunais', icon: 'fa-gavel' },
    { id: 'administrativo', nome: 'Administrativo', icon: 'fa-building' },
    { id: 'saude', nome: 'Sa√∫de', icon: 'fa-heartbeat' },
    { id: 'educacao', nome: 'Educa√ß√£o', icon: 'fa-graduation-cap' }
  ];

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg} py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold ${themes[currentTheme].text}">Escolha a √°rea</h2>
              <span class="text-sm text-gray-500">Passo 1 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 25%"></div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            ${areas.map(area => `
              <button onclick="selecionarArea('${area.id}')" 
                class="p-6 border-2 ${themes[currentTheme].border} rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                <i class="fas ${area.icon} text-4xl ${c('primary').icon} mb-3"></i>
                <h4 class="font-semibold">${area.nome}</h4>
              </button>
            `).join('')}
          </div>

          <button onclick="renderEntrevistaStep1()" 
            class="mt-6 px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Voltar
          </button>
        </div>
      </div>
    </div>
  `;
}

function selecionarArea(area) {
  interviewData.area_geral = area;
  renderEntrevistaStep2();
}

function renderEntrevistaStep2() {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg} py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold ${themes[currentTheme].text}">Seu Perfil</h2>
              <span class="text-sm text-gray-500">Passo 2 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 50%"></div>
            </div>
          </div>

          <form id="perfilForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium ${themes[currentTheme].text} mb-3">Tempo dispon√≠vel por dia</label>
              <div class="grid grid-cols-3 gap-3">
                ${[
                  { val: 120, label: '2 horas' },
                  { val: 240, label: '4 horas' },
                  { val: 360, label: '6+ horas' }
                ].map(t => `
                  <label class="cursor-pointer">
                    <input type="radio" name="tempo" value="${t.val}" required class="hidden peer">
                    <div class="p-4 border-2 ${themes[currentTheme].border} rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/30 hover:border-blue-300 transition">
                      <p class="font-semibold ${themes[currentTheme].text}">${t.label}</p>
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium ${themes[currentTheme].text} mb-3">Experi√™ncia em concursos</label>
              <div class="grid grid-cols-3 gap-3">
                ${[
                  { val: 'iniciante', label: 'Iniciante', icon: 'fa-seedling', desc: 'Nunca estudei ou estou come√ßando agora' },
                  { val: 'intermediario', label: 'Intermedi√°rio', icon: 'fa-chart-line', desc: 'J√° estudei por alguns meses, conhe√ßo o b√°sico' },
                  { val: 'avancado', label: 'Avan√ßado', icon: 'fa-trophy', desc: 'Estudo h√° mais de 1 ano, j√° fiz v√°rias provas' }
                ].map(e => `
                  <label class="cursor-pointer" title="${e.desc}">
                    <input type="radio" name="experiencia" value="${e.val}" required class="hidden peer">
                    <div class="p-4 border-2 ${themes[currentTheme].border} rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/30 hover:border-blue-300 transition">
                      <i class="fas ${e.icon} text-2xl ${c('primary').icon} mb-2"></i>
                      <p class="font-semibold text-sm ${themes[currentTheme].text}">${e.label}</p>
                      <p class="text-[10px] ${themes[currentTheme].textSecondary} mt-1">${e.desc}</p>
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium ${themes[currentTheme].text} mb-3">J√° estudou para concursos antes?</label>
              <div class="grid grid-cols-2 gap-3">
                <label class="cursor-pointer">
                  <input type="radio" name="jaEstudou" value="true" required class="hidden peer">
                  <div class="p-4 border-2 ${themes[currentTheme].border} rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/30 hover:border-blue-300 transition">
                    <p class="font-semibold ${themes[currentTheme].text}">Sim</p>
                  </div>
                </label>
                <label class="cursor-pointer">
                  <input type="radio" name="jaEstudou" value="false" required class="hidden peer">
                  <div class="p-4 border-2 ${themes[currentTheme].border} rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/30 hover:border-blue-300 transition">
                    <p class="font-semibold ${themes[currentTheme].text}">N√£o</p>
                  </div>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium ${themes[currentTheme].text} mb-2">Quantos concursos j√° prestou?</label>
              <input type="number" name="concursos_prestados" min="0" value="0"
                class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
              <p class="text-xs ${themes[currentTheme].textSecondary} mt-1">Informe o n√∫mero de concursos que voc√™ j√° fez (aprovado ou n√£o)</p>
            </div>

            <div>
              <label class="block text-sm font-medium ${themes[currentTheme].text} mb-2">Deseja compartilhar suas experi√™ncias? (Opcional)</label>
              <textarea name="experiencias_detalhadas" rows="4" 
                placeholder="Ex: Fui aprovado no concurso X mas n√£o fui chamado. Tenho dificuldade em Direito Penal. Fui bem em Portugu√™s mas mal em Racioc√≠nio L√≥gico..."
                class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
              <p class="text-xs ${themes[currentTheme].textSecondary} mt-1">Essas informa√ß√µes ajudar√£o a personalizar seu plano de estudos</p>
            </div>

            <div class="flex space-x-4">
              <button type="button" onclick="voltarStep1()" 
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                Voltar
              </button>
              <button type="submit" 
                class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                Continuar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  document.getElementById('perfilForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    interviewData.tempo_disponivel_dia = parseInt(formData.get('tempo'));
    interviewData.experiencia = formData.get('experiencia');
    interviewData.ja_estudou_antes = formData.get('jaEstudou') === 'true';
    interviewData.concursos_prestados = parseInt(formData.get('concursos_prestados')) || 0;
    interviewData.experiencias_detalhadas = formData.get('experiencias_detalhadas') || '';
    renderEntrevistaStep3();
  });
}

function voltarStep1() {
  if (interviewData.objetivo_tipo === 'concurso_especifico') {
    renderConcursoEspecifico();
  } else {
    renderAreaGeral();
  }
}

async function renderEntrevistaStep3() {
  let disciplinasFiltradas = [];
  
  // üêõ DEBUG: Mostrar estado do interviewData
  console.log('üîç DEBUG interviewData:', {
    edital_id: interviewData.edital_id,
    disciplinas_do_edital: interviewData.disciplinas_do_edital?.length || 0,
    tem_disciplinas: !!(interviewData.disciplinas_do_edital && interviewData.disciplinas_do_edital.length > 0)
  });
  
  // ‚úÖ NOVA L√ìGICA: Usar disciplinas do EDITAL se dispon√≠vel
  if (interviewData.disciplinas_do_edital && interviewData.disciplinas_do_edital.length > 0) {
    // üéØ USAR DISCIPLINAS DO EDITAL
    console.log(`üìÑ Usando ${interviewData.disciplinas_do_edital.length} disciplinas do edital processado`);
    console.log('üìã Disciplinas:', interviewData.disciplinas_do_edital.map(d => d.nome).join(', '));
    
    // Mapear para formato esperado
    disciplinasFiltradas = interviewData.disciplinas_do_edital.map(d => ({
      id: d.id || 0,
      nome: d.nome,
      descricao: `Disciplina extra√≠da do edital (${d.total_topicos || 0} t√≥picos)`,
      area: 'edital' // Flag especial
    }));
    
  } else {
    // üîÑ FALLBACK: Carregar disciplinas padr√£o se n√£o houver edital
    console.log('üìö Nenhum edital processado. Carregando disciplinas padr√£o...');
    
    // Carregar disciplinas padr√£o agora
    const response = await axios.get('/api/disciplinas');
    disciplinasDisponiveis = response.data;
    
    // Filtrar disciplinas: B√ÅSICAS + GERAIS + ESPEC√çFICAS DA √ÅREA
    const disciplinasBasicas = disciplinasDisponiveis.filter(d => d.area === 'basico');
    const disciplinasGerais = disciplinasDisponiveis.filter(d => d.area === 'geral');
    
    let disciplinasArea = [];
    if (interviewData.area_geral) {
      disciplinasArea = disciplinasDisponiveis.filter(d => d.area === interviewData.area_geral);
    } else if (interviewData.cargo) {
      const areaDetectada = detectarAreaPorCargo(interviewData.cargo);
      if (areaDetectada) {
        interviewData.area_geral = areaDetectada;
        disciplinasArea = disciplinasDisponiveis.filter(d => d.area === areaDetectada);
      }
    }
    
    disciplinasFiltradas = [...disciplinasBasicas, ...disciplinasGerais, ...disciplinasArea];
  }

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg} py-8">
      <div class="max-w-4xl mx-auto px-4">
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-8">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold ${themes[currentTheme].text}">N√≠vel por Disciplina</h2>
              <span class="text-sm text-gray-500">Passo 3 de 4</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: 75%"></div>
            </div>
          </div>

          <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-5 mb-6">
            <div class="flex items-start">
              <i class="fas fa-lightbulb text-blue-600 text-2xl mt-1 mr-4"></i>
              <div>
                <h4 class="font-bold text-blue-900 mb-2 text-lg">üìã Como funciona esta etapa?</h4>
                <div class="text-sm text-gray-700 space-y-2">
                  <p>
                    <strong class="text-blue-800">Passo 1:</strong> 
                    <span class="text-gray-600">Marque as disciplinas que voc√™ quer incluir no seu plano de estudos</span>
                  </p>
                  <p>
                    <strong class="text-blue-800">Passo 2:</strong> 
                    <span class="text-gray-600">Para cada disciplina selecionada, indique se j√° estudou e seu n√≠vel atual</span>
                  </p>
                  <p class="bg-white rounded px-3 py-2 border border-blue-200 mt-3">
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    <strong>Dica:</strong> Selecione apenas as disciplinas do seu edital/concurso. 
                    O ideal √© <strong class="text-blue-800">8 a 15 disciplinas</strong> para um estudo eficiente e focado!
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <p class="${themes[currentTheme].textSecondary} mb-4 text-center text-lg">
            <strong class="text-blue-700">${disciplinasFiltradas.length} disciplinas dispon√≠veis</strong> 
            <span class="text-gray-600">‚Üí</span> 
            <strong class="text-green-700">Selecione as que voc√™ vai estudar</strong>
          </p>
          
          <div class="mb-6 flex gap-3">
            <button type="button" onclick="selecionarTodasDisciplinas()" 
              class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm">
              ‚úì Selecionar as mais importantes (at√© 15)
            </button>
            <button type="button" onclick="limparTodasDisciplinas()" 
              class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
              ‚úó Limpar sele√ß√£o
            </button>
          </div>
          
          <div id="contador-disciplinas" class="mb-4 text-center">
            <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg font-semibold">
              <span id="num-selecionadas">0</span> disciplinas selecionadas
            </span>
          </div>

          <form id="disciplinasForm" class="space-y-3">
            ${disciplinasFiltradas.map(disc => `
              <div id="card_${disc.id}" class="border-2 ${themes[currentTheme].border} rounded-lg p-4 transition-all duration-200 hover:shadow-md" 
                   data-selected="false">
                <!-- PASSO 1: SELE√á√ÉO DA DISCIPLINA -->
                <div class="flex items-start gap-4">
                  <label class="flex items-center cursor-pointer min-w-fit">
                    <input type="checkbox" id="select_${disc.id}" 
                      onchange="toggleDisciplinaSelection(${disc.id})"
                      class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                  </label>
                  
                  <div class="flex-1">
                    <h4 class="font-semibold text-gray-900">${disc.nome}</h4>
                    <p class="text-xs text-gray-500 mt-0.5">${disc.descricao || ''}</p>
                  </div>
                </div>

                <!-- PASSO 2: AVALIA√á√ÉO (aparece apenas se selecionada) -->
                <div id="avaliacao_${disc.id}" class="mt-4 pt-4 border-t border-gray-200 hidden">
                  <p class="text-sm font-medium text-blue-700 mb-3 bg-blue-100 rounded-lg p-2">
                    <i class="fas fa-clipboard-check text-blue-600 mr-2"></i>
                    ‚úÖ Disciplina selecionada! Agora avalie seu conhecimento:
                  </p>
                  
                  <div class="space-y-3">
                    <!-- Pergunta: J√° estudou? -->
                    <div class="bg-blue-50 rounded-lg p-3">
                      <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="estudou_${disc.id}" 
                          onchange="toggleNivel(${disc.id})"
                          class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="ml-3 text-sm font-medium text-gray-800">J√° estudei esta mat√©ria antes</span>
                      </label>
                    </div>

                    <!-- N√≠vel (aparece apenas se j√° estudou) -->
                    <div id="nivel_container_${disc.id}" class="hidden bg-green-50 rounded-lg p-3">
                      <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-chart-line text-green-600 mr-2"></i>
                        Qual seu n√≠vel atual? (0-10)
                      </label>
                      <input type="number" id="nivel_${disc.id}" min="0" max="10" value="5"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                      <p class="text-xs text-gray-500 mt-1">
                        0 = Iniciante | 5 = Intermedi√°rio | 10 = Avan√ßado
                      </p>
                    </div>

                    <!-- Dificuldade hist√≥rica -->
                    <div class="bg-amber-50 rounded-lg p-3">
                      <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="dificuldade_${disc.id}"
                          class="w-4 h-4 text-amber-600 rounded focus:ring-amber-500">
                        <span class="ml-3 text-sm font-medium text-amber-800">
                          <i class="fas fa-exclamation-triangle mr-1"></i>
                          Tenho dificuldade hist√≥rica nesta mat√©ria
                        </span>
                      </label>
                    </div>

                    <!-- Peso da disciplina (se concurso espec√≠fico) -->
                    ${interviewData.objetivo_tipo === 'concurso_especifico' ? `
                      <div class="bg-purple-50 rounded-lg p-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          <i class="fas fa-balance-scale text-purple-600 mr-2"></i>
                          Peso desta disciplina no ${interviewData.concurso_nome || 'concurso'}
                        </label>
                        <input type="number" id="peso_${disc.id}" 
                          min="1" max="10" placeholder="Ex: 3 (facultativo)"
                          value="${disc.peso || ''}"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <p class="text-xs text-gray-500 mt-1">
                          üí° Se souber o peso da disciplina no edital, informe aqui (1 a 10).
                          <br>Deixe em branco se n√£o souber - o sistema distribuir√° o tempo igualmente.
                        </p>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            `).join('')}
            
            <!-- Se√ß√£o de Disciplinas Personalizadas -->
            <div class="${themes[currentTheme].alert} border-2 rounded-lg p-6 mt-8">
              <h4 class="font-semibold text-blue-900 mb-2 flex items-center">
                <i class="fas fa-plus-circle mr-2"></i>
                üìö Adicionar Disciplinas Personalizadas
              </h4>
              <p class="text-sm text-blue-700 mb-4">
                Seu concurso/edital tem disciplinas espec√≠ficas que n√£o est√£o listadas acima? 
                <br>Adicione-as aqui (ex: "Conhecimentos sobre o Piau√≠", "Legisla√ß√£o Municipal", "Estatuto do Servidor")
              </p>
              
              <div class="flex gap-2 mb-4">
                <input 
                  type="text" 
                  id="nova-disciplina-input"
                  placeholder="Nome da disciplina personalizada..."
                  class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();adicionarDisciplinaCustom();}"
                >
                <button 
                  type="button"
                  onclick="adicionarDisciplinaCustom()"
                  class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-medium flex items-center"
                >
                  <i class="fas fa-plus mr-2"></i> Adicionar
                </button>
              </div>
              
              <!-- Lista de disciplinas personalizadas -->
              <div id="disciplinas-custom-list" class="space-y-2"></div>
            </div>

            <div class="flex space-x-4 pt-6">
              <button type="button" onclick="renderEntrevistaStep2()" 
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                Voltar
              </button>
              <button type="submit" 
                class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                Finalizar Entrevista
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  // Nova fun√ß√£o: controlar sele√ß√£o de disciplina
  window.toggleDisciplinaSelection = (discId) => {
    console.log(`üîç toggleDisciplinaSelection chamado para ID: ${discId}`);
    
    const checkbox = document.getElementById(`select_${discId}`);
    const card = document.getElementById(`card_${discId}`);
    const avaliacaoDiv = document.getElementById(`avaliacao_${discId}`);
    
    console.log(`  - Checkbox encontrado: ${!!checkbox}`);
    console.log(`  - Card encontrado: ${!!card}`);
    console.log(`  - Avaliacao div encontrado: ${!!avaliacaoDiv}`);
    
    if (!checkbox || !card || !avaliacaoDiv) {
      console.error(`‚ùå ERRO: Elementos n√£o encontrados para ID ${discId}`);
      return;
    }
    
    const isSelected = checkbox.checked;
    console.log(`  - Checkbox marcado: ${isSelected}`);
    
    // Atualizar visual do card
    if (isSelected) {
      card.classList.add('border-blue-500', 'bg-blue-50');
      card.classList.remove('border-gray-300');
      card.setAttribute('data-selected', 'true');
      avaliacaoDiv.classList.remove('hidden');
    } else {
      card.classList.remove('border-blue-500', 'bg-blue-50');
      card.classList.add('border-gray-300');
      card.setAttribute('data-selected', 'false');
      avaliacaoDiv.classList.add('hidden');
      
      // Limpar valores quando desmarca
      const estudouCheckbox = document.getElementById(`estudou_${discId}`);
      const dificuldadeCheckbox = document.getElementById(`dificuldade_${discId}`);
      if (estudouCheckbox) estudouCheckbox.checked = false;
      if (dificuldadeCheckbox) dificuldadeCheckbox.checked = false;
      toggleNivel(discId); // Esconder n√≠vel
    }
    
    atualizarContador();
  };
  
  window.toggleNivel = (discId) => {
    const checkbox = document.getElementById(`estudou_${discId}`);
    const container = document.getElementById(`nivel_container_${discId}`);
    if (container) {
      container.classList.toggle('hidden', !checkbox.checked);
    }
  };
  
  window.atualizarContador = () => {
    const selecionadas = disciplinasFiltradas.filter(disc => {
      const selectCheckbox = document.getElementById(`select_${disc.id}`);
      return selectCheckbox && selectCheckbox.checked;
    }).length;
    
    const numSpan = document.getElementById('num-selecionadas');
    const contador = document.getElementById('contador-disciplinas');
    
    if (numSpan) numSpan.textContent = selecionadas;
    
    // Mudar cor baseado na quantidade
    if (contador) {
      const span = contador.querySelector('span');
      if (selecionadas === 0) {
        span.className = 'px-4 py-2 bg-gray-100 text-gray-600 rounded-lg font-semibold';
      } else if (selecionadas <= 15) {
        span.className = 'px-4 py-2 bg-green-100 text-green-800 rounded-lg font-semibold';
      } else if (selecionadas <= 25) {
        span.className = 'px-4 py-2 bg-amber-100 text-amber-800 rounded-lg font-semibold';
      } else {
        span.className = 'px-4 py-2 bg-red-100 text-red-800 rounded-lg font-semibold';
      }
    }
  };
  
  window.selecionarTodasDisciplinas = () => {
    const LIMITE_RECOMENDADO = 15;
    
    // Ordenar disciplinas por relev√¢ncia (disciplinas espec√≠ficas primeiro, depois gerais)
    const disciplinasOrdenadas = [...disciplinasFiltradas].sort((a, b) => {
      if (a.area === 'geral' && b.area !== 'geral') return 1;
      if (a.area !== 'geral' && b.area === 'geral') return -1;
      return 0;
    });
    
    // Selecionar apenas as primeiras N disciplinas (marcar checkbox de sele√ß√£o)
    let contSelecionadas = 0;
    disciplinasOrdenadas.forEach(disc => {
      const selectCheckbox = document.getElementById(`select_${disc.id}`);
      
      if (contSelecionadas < LIMITE_RECOMENDADO) {
        if (selectCheckbox) {
          selectCheckbox.checked = true;
          toggleDisciplinaSelection(disc.id); // Mostrar avalia√ß√£o
        }
        contSelecionadas++;
      }
    });
    
    atualizarContador();
    
    if (contSelecionadas === LIMITE_RECOMENDADO) {
      alert(`‚úÖ Selecionadas as ${LIMITE_RECOMENDADO} disciplinas mais relevantes para sua √°rea.\n\nAgora avalie seu conhecimento em cada uma delas.`);
    }
  };
  
  window.limparTodasDisciplinas = () => {
    disciplinasFiltradas.forEach(disc => {
      const selectCheckbox = document.getElementById(`select_${disc.id}`);
      
      if (selectCheckbox && selectCheckbox.checked) {
        selectCheckbox.checked = false;
        toggleDisciplinaSelection(disc.id); // Esconder avalia√ß√£o e limpar
      }
    });
    atualizarContador();
  };
  
  // Adicionar listener para atualizar contador quando checkboxes mudarem
  disciplinasFiltradas.forEach(disc => {
    const checkbox = document.getElementById(`estudou_${disc.id}`);
    if (checkbox) {
      checkbox.addEventListener('change', atualizarContador);
    }
  });
  
  // Atualizar contador inicial
  atualizarContador();
  
  // Array para armazenar disciplinas personalizadas
  window.disciplinasCustom = [];
  
  // Fun√ß√£o para adicionar disciplina personalizada
  window.adicionarDisciplinaCustom = () => {
    const input = document.getElementById('nova-disciplina-input');
    const nome = input.value.trim();
    
    if (!nome) {
      showToast('Digite o nome da disciplina', 'warning');
      return;
    }
    
    // Verificar se j√° existe
    if (window.disciplinasCustom.some(d => d.nome.toLowerCase() === nome.toLowerCase())) {
      showToast('Essa disciplina j√° foi adicionada!', 'warning');
      return;
    }
    
    // Adicionar √† lista tempor√°ria
    window.disciplinasCustom.push({
      nome: nome,
      custom: true,
      area: interviewData.area_geral || 'especifica',
      ja_estudou: false,
      nivel_atual: 0,
      dificuldade: 0
    });
    
    renderDisciplinasCustomList();
    input.value = '';
    showToast('Disciplina adicionada!', 'success');
  };
  
  // Fun√ß√£o para renderizar lista de disciplinas personalizadas
  window.renderDisciplinasCustomList = () => {
    const container = document.getElementById('disciplinas-custom-list');
    
    if (window.disciplinasCustom.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-500 italic">Nenhuma disciplina personalizada adicionada ainda.</p>';
      return;
    }
    
    container.innerHTML = window.disciplinasCustom.map((d, idx) => `
      <div class="flex items-center justify-between bg-white border-2 border-blue-200 p-3 rounded-lg">
        <div class="flex items-center flex-1">
          <i class="fas fa-book ${c('primary').icon} mr-3"></i>
          <span class="text-sm font-medium text-gray-800">${d.nome}</span>
          <span class="ml-2 text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">Personalizada</span>
        </div>
        <button 
          type="button"
          onclick="removerDisciplinaCustom(${idx})"
          class="text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-1 hover:bg-blue-50 rounded"
        >
          <i class="fas fa-trash mr-1"></i> Remover
        </button>
      </div>
    `).join('');
  };
  
  // Fun√ß√£o para remover disciplina personalizada
  window.removerDisciplinaCustom = (idx) => {
    window.disciplinasCustom.splice(idx, 1);
    renderDisciplinasCustomList();
    showToast('Disciplina removida', 'info');
  };
  
  // Inicializar lista vazia
  renderDisciplinasCustomList();

  document.getElementById('disciplinasForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // ‚úÖ NOVA L√ìGICA: Mapear apenas disciplinas com checkbox "select_" marcado
    console.log('üîç DEBUG - disciplinasFiltradas:', disciplinasFiltradas.map(d => `${d.nome} (ID: ${d.id})`));
    
    interviewData.disciplinas = disciplinasFiltradas
      .filter(disc => {
        const isSelected = document.getElementById(`select_${disc.id}`)?.checked;
        console.log(`  - ${disc.nome}: selecionado = ${isSelected}, ID = ${disc.id}`);
        return isSelected; // Incluir apenas se foi selecionada
      })
      .map(disc => {
        // ‚úÖ CORRE√á√ÉO v20.9: Validar que disc.id existe e n√£o √© null/undefined
        if (!disc.id || disc.id === 0) {
          console.error(`‚ùå ERRO: Disciplina "${disc.nome}" sem ID v√°lido:`, disc);
          return null; // Ser√° filtrado depois
        }
        
        return {
          disciplina_id: disc.id,
          ja_estudou: document.getElementById(`estudou_${disc.id}`)?.checked || false,
          nivel_atual: document.getElementById(`estudou_${disc.id}`)?.checked 
            ? parseInt(document.getElementById(`nivel_${disc.id}`)?.value || 0) 
            : 0,
          dificuldade: document.getElementById(`dificuldade_${disc.id}`)?.checked || false,
          peso: document.getElementById(`peso_${disc.id}`) 
            ? (parseInt(document.getElementById(`peso_${disc.id}`)?.value) || null)
            : (disc.peso || null)
        };
      })
      .filter(d => d !== null); // Remover disciplinas com ID inv√°lido
    
    // Adicionar disciplinas personalizadas (todas s√£o selecionadas automaticamente)
    interviewData.disciplinasCustom = window.disciplinasCustom.map(disc => ({
      nome: disc.nome,
      area: disc.area,
      custom: true,
      ja_estudou: false,  // Disciplina nova, nunca estudou
      nivel_atual: 0,
      dificuldade: false
    }));
    
    // ‚úÖ LOG DEBUG: Mostrar disciplinas que ser√£o enviadas
    console.log('üìã FRONTEND - Disciplinas selecionadas:', interviewData.disciplinas.map(d => `ID ${d.disciplina_id}`).join(', '));
    console.log('üìä FRONTEND - Total de disciplinas:', interviewData.disciplinas.length);
    
    // Validar que pelo menos 1 disciplina foi selecionada (padr√£o OU personalizada)
    const totalDisciplinas = interviewData.disciplinas.length + interviewData.disciplinasCustom.length;
    if (totalDisciplinas === 0) {
      alert('‚ö†Ô∏è Selecione pelo menos uma disciplina!\n\nMarque as disciplinas que voc√™ quer estudar e depois avalie seu conhecimento nelas.');
      return;
    }
    
    // Avisar se selecionou muitas disciplinas (contar padr√£o + personalizadas)
    const totalDisciplinasReais = interviewData.disciplinas.length + interviewData.disciplinasCustom.length;
    if (totalDisciplinasReais > 25) {
      const confirmar = confirm(
        `‚ö†Ô∏è Voc√™ selecionou ${totalDisciplinasReais} disciplinas (${interviewData.disciplinas.length} padr√£o + ${interviewData.disciplinasCustom.length} personalizadas).\n\n` +
        `Isso √© um n√∫mero muito alto e pode prejudicar seu foco e personaliza√ß√£o do conte√∫do.\n\n` +
        `Recomendamos entre 8 e 15 disciplinas para melhor resultado.\n\n` +
        `Deseja continuar mesmo assim?`
      );
      if (!confirmar) return;
    } else if (totalDisciplinasReais > 15) {
      const avisar = confirm(
        `Voc√™ selecionou ${totalDisciplinasReais} disciplinas (${interviewData.disciplinas.length} padr√£o + ${interviewData.disciplinasCustom.length} personalizadas).\n\n` +
        `Para um estudo mais eficiente, recomendamos focar em 8 a 15 disciplinas.\n\n` +
        `Continuar com ${totalDisciplinasReais} disciplinas?`
      );
      if (!avisar) return;
    }

    await finalizarEntrevista();
  });
}

async function finalizarEntrevista() {
  try {
    // Valida√ß√£o final
    if (!interviewData.disciplinas || interviewData.disciplinas.length === 0) {
      alert('‚ö†Ô∏è Por favor, selecione pelo menos uma disciplina antes de continuar.\n\nMarque "J√° estudei" ou "Tenho dificuldade" em ao menos uma mat√©ria.');
      return;
    }

    // Salvar entrevista (o backend j√° cria o plano automaticamente)
    const response = await axios.post('/api/interviews', interviewData);
    const { interview_id, plano_id, diagnostico } = response.data;

    console.log('‚úÖ Entrevista e plano criados:', { interview_id, plano_id });

    // ‚úÖ CORRE√á√ÉO: Edital J√Å foi processado ANTES (em processarEditalAntesDeStep2)
    // N√£o precisa processar novamente aqui

    // Mostrar resultado
    renderResultadoEntrevista(diagnostico, { plano_id, interview_id });
  } catch (error) {
    console.error('Erro ao finalizar entrevista:', error);
    
    // Mensagem amig√°vel baseada no erro
    const errorMsg = error.response?.data?.error || 'Erro ao processar entrevista';
    const errorCode = error.response?.data?.code;
    
    if (errorCode === 'NO_DISCIPLINES') {
      alert('‚ö†Ô∏è Nenhuma disciplina selecionada!\n\nVolte e marque pelo menos uma disciplina antes de finalizar.');
    } else if (errorCode === 'USER_NOT_FOUND') {
      alert('‚ö†Ô∏è Sess√£o expirada!\n\nSua sess√£o expirou. Fa√ßa login novamente.');
      logout();
    } else if (errorMsg.includes('FOREIGN KEY') || errorMsg.includes('constraint')) {
      alert('‚ö†Ô∏è Erro ao salvar entrevista!\n\nPor favor, fa√ßa logout e login novamente.');
      setTimeout(() => logout(), 2000);
    } else {
      alert('‚ùå ' + errorMsg + '\n\nTente novamente ou recarregue a p√°gina.');
    }
  }
}

function renderResultadoEntrevista(diagnostico, plano) {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg} py-8">
      <div class="max-w-4xl mx-auto px-4">
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-8">
          <div class="text-center mb-8">
            <i class="fas fa-check-circle text-6xl text-blue-500 mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">An√°lise Conclu√≠da!</h2>
            <p class="${themes[currentTheme].textSecondary}">Seu plano de estudos personalizado est√° pronto</p>
          </div>

          <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
              <h3 class="font-semibold text-lg mb-2 flex items-center">
                <i class="fas fa-user-graduate mr-2 ${c('primary').icon}"></i>
                Seu N√≠vel Atual
              </h3>
              <p class="text-2xl font-bold ${c('primary').text}">${diagnostico.nivel_geral}</p>
            </div>

            <div class="${themes[currentTheme].warning} border rounded-lg p-6">
              <h3 class="font-semibold text-lg mb-3 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2 text-blue-600"></i>
                Prioridades de Estudo
              </h3>
              <ul class="space-y-2">
                ${(diagnostico.prioridades && diagnostico.prioridades.length > 0) 
                  ? diagnostico.prioridades.slice(0, 5).map(p => `
                      <li class="flex items-start">
                        <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1"></i>
                        <div>
                          <span class="font-semibold">${p.nome}</span>
                          <span class="text-sm text-gray-600 ml-2">(${p.razao})</span>
                        </div>
                      </li>
                    `).join('')
                  : '<li class="text-gray-500">Nenhuma prioridade identificada</li>'
                }
              </ul>
            </div>

            ${(diagnostico.lacunas && diagnostico.lacunas.length > 0) ? `
              <div class="${themes[currentTheme].error} border rounded-lg p-6">
                <h3 class="font-semibold text-lg mb-3 flex items-center">
                  <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                  Conte√∫dos Nunca Estudados
                </h3>
                <div class="flex flex-wrap gap-2">
                  ${diagnostico.lacunas.map(l => `
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">${l}</span>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <div class="${themes[currentTheme].success} border rounded-lg p-6">
              <h3 class="font-semibold text-lg mb-2 flex items-center">
                <i class="fas fa-lightbulb mr-2 ${c('success').icon}"></i>
                Recomenda√ß√£o Personalizada
              </h3>
              <p class="${themes[currentTheme].text}">${diagnostico.recomendacao}</p>
            </div>
          </div>

          <button onclick="irParaDashboard()" 
            class="w-full mt-8 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
            Ir para o Dashboard
          </button>
        </div>
      </div>
    </div>
  `;
}

// ============== DASHBOARD ==============
async function verificarEntrevista() {
  try {
    const response = await axios.get(`/api/interviews/user/${currentUser.id}`);
    if (response.data && response.data.length > 0) {
      renderDashboard();
    } else {
      iniciarEntrevista();
    }
  } catch (error) {
    iniciarEntrevista();
  }
}

function irParaDashboard() {
  renderDashboard();
}

async function renderDashboard() {
  try {
    // Buscar dados do plano
    const planoResponse = await axios.get(`/api/planos/user/${currentUser.id}`);
    const plano = planoResponse.data;

    // ‚úÖ VALIDA√á√ÉO: Verificar se plano est√° OK antes de continuar
    if (!plano || !plano.id || !plano.nome) {
      console.warn('‚ö†Ô∏è Plano n√£o encontrado ou incompleto');
      throw new Error('Plano n√£o dispon√≠vel');
    }

    // ‚úÖ NOVO: Buscar dados da entrevista para exibir concurso/cargo
    let entrevista = null;
    try {
      const entrevistaResponse = await axios.get(`/api/interviews/user/${currentUser.id}`);
      entrevista = entrevistaResponse.data[0]; // Pegar a √∫ltima entrevista
      console.log('‚úÖ Entrevista carregada:', entrevista);
    } catch (err) {
      console.warn('‚ö†Ô∏è Entrevista n√£o encontrada');
    }

    // Buscar metas do dia
    const metasResponse = await axios.get(`/api/metas/hoje/${currentUser.id}`);
    const metas = metasResponse.data;

    // Validar metas
    if (!Array.isArray(metas)) {
      console.warn('‚ö†Ô∏è Metas inv√°lidas');
      throw new Error('Metas n√£o dispon√≠veis');
    }

    // Buscar desempenho
    const desempenhoResponse = await axios.get(`/api/desempenho/user/${currentUser.id}`);
    const desempenho = desempenhoResponse.data;

    // Buscar calend√°rio e estat√≠sticas
    const hoje = new Date();
    const mes = hoje.getMonth() + 1;
    const ano = hoje.getFullYear();
    
    const [calendarioRes, estatisticasRes] = await Promise.all([
      axios.get(`/api/calendario/${currentUser.id}?mes=${mes}&ano=${ano}`),
      axios.get(`/api/estatisticas/${currentUser.id}`)
    ]);

    console.log('‚úÖ Todos os dados carregados com sucesso');
    renderDashboardUI(plano, metas, desempenho, calendarioRes.data, estatisticasRes.data, entrevista);
  } catch (error) {
    console.error('‚ùå Erro ao carregar dashboard:', error);
    console.log('C√≥digo de erro:', error.response?.status);
    console.log('Mensagem:', error.response?.data || error.message);
    
    // Se n√£o houver plano ou dados estiverem incompletos, iniciar entrevista
    if (error.response?.status === 404 || error.message.includes('n√£o dispon√≠vel')) {
      console.log('üéØ Iniciando processo de cria√ß√£o de plano...');
      iniciarEntrevista();
    } else {
      // Outro erro, mostrar mensagem amig√°vel
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen ${themes[currentTheme].bg} flex items-center justify-center p-4">
          <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-8 max-w-md w-full text-center">
            <i class="fas fa-exclamation-triangle text-blue-500 text-6xl mb-4"></i>
            <h2 class="text-2xl font-bold ${themes[currentTheme].text} mb-4">Erro ao Carregar Dados</h2>
            <p class="${themes[currentTheme].textSecondary} mb-6">Ocorreu um erro ao carregar seu plano de estudos.</p>
            <button 
              onclick="iniciarEntrevista()" 
              class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition w-full mb-3"
            >
              <i class="fas fa-redo mr-2"></i>
              Criar Novo Plano
            </button>
            <button 
              onclick="renderDashboard()" 
              class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition w-full"
            >
              <i class="fas fa-sync-alt mr-2"></i>
              Tentar Novamente
            </button>
          </div>
        </div>
      `;
    }
  }
}

async function renderDashboardUI(plano, metas, desempenho, historico, stats, entrevista) {
  const metasConcluidas = metas.filter(m => m.concluida).length;
  const progressoDia = metas.length > 0 ? Math.round((metasConcluidas / metas.length) * 100) : 0;
  
  // Calcular m√©dia di√°ria
  const mediaDiaria = stats.dias_estudados > 0 
    ? Math.round((stats.horas_totais * 60) / stats.dias_estudados) 
    : 0;

  // ‚úÖ NOVO: Preparar informa√ß√µes do concurso/cargo baseado na entrevista
  let concursoInfo = {
    titulo: 'N√£o especificado',
    subtitulo: '√Årea geral',
    icone: 'fas fa-briefcase'
  };

  if (entrevista) {
    if (entrevista.objetivo_tipo === 'concurso_especifico') {
      concursoInfo.titulo = entrevista.concurso_nome || 'Concurso n√£o especificado';
      concursoInfo.subtitulo = entrevista.cargo || 'Cargo n√£o especificado';
      concursoInfo.icone = 'fas fa-graduation-cap';
    } else if (entrevista.objetivo_tipo === 'area_geral') {
      const areasNomes = {
        'saude': '√Årea da Sa√∫de',
        'educacao': '√Årea da Educa√ß√£o',
        'fiscal': '√Årea Fiscal',
        'policial': '√Årea Policial',
        'tribunais': '√Årea de Tribunais',
        'administrativo': '√Årea Administrativa'
      };
      concursoInfo.titulo = areasNomes[entrevista.area_geral] || '√Årea Geral';
      concursoInfo.subtitulo = 'Prepara√ß√£o geral para a √°rea';
      concursoInfo.icone = 'fas fa-th-large';
    }
  }

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg}">
      <!-- Header -->
      <header class="${themes[currentTheme].card} shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <button onclick="renderDashboard()" class="flex items-center hover:opacity-80 transition">
            <i class="fas fa-brain text-3xl ${c('primary').icon} mr-3"></i>
            <h1 class="text-2xl font-bold ${themes[currentTheme].text}">
              <span class="${c('primary').text}">IA</span>prova
            </h1>
          </button>
          <div class="flex items-center gap-4">
            <!-- Informa√ß√µes do Usu√°rio com Menu Dropdown -->
            <div class="relative">
              <button 
                onclick="toggleUserMenu()" 
                class="flex items-center gap-3 px-4 py-2 ${themes[currentTheme].card} rounded-lg border ${themes[currentTheme].border} shadow-sm hover:shadow-md transition cursor-pointer"
              >
                <div class="w-10 h-10 rounded-full bg-gradient-to-br ${c('primary').gradient} flex items-center justify-center text-white font-bold text-lg shadow-lg">
                  ${currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U'}
                </div>
                <div class="flex flex-col">
                  <span class="font-semibold ${themes[currentTheme].text} text-sm">${currentUser.name || 'Usu√°rio'}</span>
                  <span class="text-xs ${themes[currentTheme].textSecondary}">${currentUser.email}</span>
                </div>
                <i class="fas fa-chevron-down text-xs ${themes[currentTheme].textSecondary}"></i>
              </button>
              
              <!-- Dropdown Menu -->
              <div 
                id="userMenu" 
                class="hidden absolute right-0 mt-2 w-64 ${themes[currentTheme].card} rounded-lg shadow-xl border ${themes[currentTheme].border} z-50"
              >
                <div class="p-3 border-b ${themes[currentTheme].border}">
                  <p class="font-semibold ${themes[currentTheme].text} text-sm">${currentUser.name || 'Usu√°rio'}</p>
                  <p class="text-xs ${themes[currentTheme].textSecondary}">${currentUser.email}</p>
                  <p class="text-xs ${themes[currentTheme].textSecondary} mt-1">
                    <i class="fas fa-calendar-alt mr-1"></i>
                    Membro desde ${currentUser.created_at ? new Date(currentUser.created_at).toLocaleDateString('pt-BR') : 'N/A'}
                  </p>
                </div>
                <div class="py-2">
                  <button 
                    onclick="abrirModalEditarPerfil()" 
                    class="w-full px-4 py-2 text-left ${themes[currentTheme].text} hover:bg-blue-50 dark:hover:bg-blue-900/30 transition flex items-center gap-3"
                  >
                    <i class="fas fa-user-edit w-5"></i>
                    <span>Editar Perfil</span>
                  </button>
                  <button 
                    onclick="renderPortfolioDisciplinas()" 
                    class="w-full px-4 py-2 text-left ${themes[currentTheme].text} hover:bg-blue-50 dark:hover:bg-blue-900/30 transition flex items-center gap-3"
                  >
                    <i class="fas fa-book w-5"></i>
                    <span>Minhas Disciplinas</span>
                  </button>
                  <button 
                    onclick="iniciarEntrevista()" 
                    class="w-full px-4 py-2 text-left ${themes[currentTheme].text} hover:bg-blue-50 dark:hover:bg-blue-900/30 transition flex items-center gap-3"
                  >
                    <i class="fas fa-plus-circle w-5"></i>
                    <span>Novo Plano</span>
                  </button>
                  <div class="border-t ${themes[currentTheme].border} my-2"></div>
                  <button 
                    onclick="logout()" 
                    class="w-full px-4 py-2 text-left text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition flex items-center gap-3"
                  >
                    <i class="fas fa-sign-out-alt w-5"></i>
                    <span>Sair</span>
                  </button>
                </div>
              </div>
            </div>
            <!-- Seletor de Tema -->
            <div class="flex gap-2">
              <!-- Tema Claro -->
              <button onclick="changeTheme('light')" 
                class="w-10 h-10 rounded-full bg-white border-2 ${currentTheme === 'light' ? 'border-blue-600 ring-2 ring-blue-300' : 'border-gray-300'} hover:border-blue-400 transition shadow-sm"
                title="Tema Claro">
                <i class="fas fa-sun text-blue-500"></i>
              </button>
              
              <!-- Tema Escuro -->
              <button onclick="changeTheme('dark')" 
                class="w-10 h-10 rounded-full bg-gray-900 border-2 ${currentTheme === 'dark' ? 'border-blue-600 ring-2 ring-blue-300' : 'border-gray-600'} hover:border-blue-400 transition shadow-sm"
                title="Tema Escuro">
                <i class="fas fa-moon text-blue-300"></i>
              </button>
            </div>
          </div>
        </div>
      </header>

      <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- KPIs Principais - Design Minimalista Inspirado no Calend√°rio -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 md:gap-3 mb-4">
          <!-- Streak Card -->
          <div class="${themes[currentTheme].card} rounded-xl border ${themes[currentTheme].border} p-3 md:p-4 hover:shadow-md transition-shadow">
            <div class="flex flex-col">
              <div class="flex items-center justify-between mb-1 md:mb-2">
                <span class="text-[10px] md:text-xs font-medium ${themes[currentTheme].textSecondary} uppercase tracking-wide">Streak</span>
                <i class="fas fa-fire text-orange-500 text-xs md:text-sm"></i>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-2xl md:text-3xl font-bold ${themes[currentTheme].text}">${stats.streak_atual}</span>
                <span class="text-xs md:text-sm ${themes[currentTheme].textSecondary}">dias</span>
              </div>
            </div>
          </div>

          <!-- Dias Estudados Card -->
          <div class="${themes[currentTheme].card} rounded-xl border ${themes[currentTheme].border} p-3 md:p-4 hover:shadow-md transition-shadow">
            <div class="flex flex-col">
              <div class="flex items-center justify-between mb-1 md:mb-2">
                <span class="text-[10px] md:text-xs font-medium ${themes[currentTheme].textSecondary} uppercase tracking-wide">Dias</span>
                <i class="fas fa-calendar-check text-blue-500 text-xs md:text-sm"></i>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-2xl md:text-3xl font-bold ${themes[currentTheme].text}">${stats.dias_estudados}</span>
                <span class="text-xs md:text-sm ${themes[currentTheme].textSecondary}">total</span>
              </div>
            </div>
          </div>

          <!-- Total de Horas Card -->
          <div class="${themes[currentTheme].card} rounded-xl border ${themes[currentTheme].border} p-3 md:p-4 hover:shadow-md transition-shadow">
            <div class="flex flex-col">
              <div class="flex items-center justify-between mb-1 md:mb-2">
                <span class="text-[10px] md:text-xs font-medium ${themes[currentTheme].textSecondary} uppercase tracking-wide">Horas</span>
                <i class="fas fa-clock text-blue-500 text-xs md:text-sm"></i>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-2xl md:text-3xl font-bold ${themes[currentTheme].text}">${stats.horas_totais}</span>
                <span class="text-xs md:text-sm ${themes[currentTheme].textSecondary}">h</span>
              </div>
            </div>
          </div>

          <!-- M√©dia Di√°ria Card -->
          <div class="${themes[currentTheme].card} rounded-xl border ${themes[currentTheme].border} p-3 md:p-4 hover:shadow-md transition-shadow">
            <div class="flex flex-col">
              <div class="flex items-center justify-between mb-1 md:mb-2">
                <span class="text-[10px] md:text-xs font-medium ${themes[currentTheme].textSecondary} uppercase tracking-wide">M√©dia</span>
                <i class="fas fa-chart-line text-blue-500 text-xs md:text-sm"></i>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-2xl md:text-3xl font-bold ${themes[currentTheme].text}">${mediaDiaria}</span>
                <span class="text-xs md:text-sm ${themes[currentTheme].textSecondary}">min</span>
              </div>
            </div>
          </div>

          <!-- Conclus√£o Card -->
          <div class="${themes[currentTheme].card} rounded-xl border ${themes[currentTheme].border} p-3 md:p-4 hover:shadow-md transition-shadow">
            <div class="flex flex-col">
              <div class="flex items-center justify-between mb-1 md:mb-2">
                <span class="text-[10px] md:text-xs font-medium ${themes[currentTheme].textSecondary} uppercase tracking-wide">Meta</span>
                <i class="fas fa-target text-blue-500 text-xs md:text-sm"></i>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-2xl md:text-3xl font-bold ${themes[currentTheme].text}">${stats.media_conclusao}</span>
                <span class="text-xs md:text-sm ${themes[currentTheme].textSecondary}">%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Informa√ß√µes do Perfil e Plano -->
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-6 mb-4 border-l-4 border-blue-500">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                  ${currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U'}
                </div>
                <div>
                  <h2 class="text-2xl font-bold ${themes[currentTheme].text}">
                    Ol√°, ${currentUser.name ? currentUser.name.split(' ')[0] : 'Estudante'}! üëã
                  </h2>
                  <p class="text-sm ${themes[currentTheme].textSecondary}">${currentUser.email}</p>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <!-- Plano de Estudos -->
                <div class="flex items-start gap-3 p-3 rounded-lg ${currentTheme === 'light' ? 'bg-blue-50' : 'bg-blue-900/30'}">
                  <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-trophy text-white"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-xs ${themes[currentTheme].textSecondary} uppercase tracking-wide">Plano Ativo</p>
                    <p class="font-semibold ${themes[currentTheme].text} truncate" title="${plano.nome}">${plano.nome}</p>
                    <p class="text-xs ${themes[currentTheme].textSecondary} mt-1">
                      <i class="fas fa-calendar-alt mr-1"></i>
                      Criado em ${plano.created_at ? new Date(plano.created_at).toLocaleDateString('pt-BR') : 'N/A'}
                    </p>
                  </div>
                </div>

                <!-- Concurso/Cargo -->
                <div class="flex items-start gap-3 p-3 rounded-lg ${currentTheme === 'light' ? 'bg-blue-50' : 'bg-blue-900/30'}">
                  <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center flex-shrink-0">
                    <i class="${concursoInfo.icone} text-white"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-xs ${themes[currentTheme].textSecondary} uppercase tracking-wide">${entrevista?.objetivo_tipo === 'concurso_especifico' ? 'Concurso' : 'Objetivo'}</p>
                    <p class="font-semibold ${themes[currentTheme].text} truncate" title="${concursoInfo.titulo}">${concursoInfo.titulo}</p>
                    <p class="text-xs ${themes[currentTheme].textSecondary} mt-1">
                      <i class="fas fa-${entrevista?.objetivo_tipo === 'concurso_especifico' ? 'user-tie' : 'map-marker-alt'} mr-1"></i>
                      ${concursoInfo.subtitulo}
                    </p>
                  </div>
                </div>

                <!-- Membro desde -->
                <div class="flex items-start gap-3 p-3 rounded-lg ${currentTheme === 'light' ? 'bg-blue-50' : 'bg-blue-900/30'}">
                  <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-user-check text-white"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-xs ${themes[currentTheme].textSecondary} uppercase tracking-wide">Membro desde</p>
                    <p class="font-semibold ${themes[currentTheme].text}">${currentUser.created_at ? new Date(currentUser.created_at).toLocaleDateString('pt-BR') : 'N/A'}</p>
                    <p class="text-xs ${themes[currentTheme].textSecondary} mt-1">
                      <i class="fas fa-clock mr-1"></i>
                      ${currentUser.created_at ? Math.floor((new Date() - new Date(currentUser.created_at)) / (1000 * 60 * 60 * 24)) : 0} dias conosco
                    </p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Menu de a√ß√µes r√°pidas -->
            <div class="ml-4 flex flex-col gap-2">
              <button 
                onclick="iniciarEntrevista()" 
                class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition text-sm whitespace-nowrap"
                title="Criar novo plano de estudos"
              >
                <i class="fas fa-plus-circle mr-2"></i>Novo Plano
              </button>
              <button 
                onclick="renderPortfolioDisciplinas()" 
                class="px-4 py-2 ${themes[currentTheme].card} border ${themes[currentTheme].border} ${themes[currentTheme].text} rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition text-sm whitespace-nowrap"
                title="Ver suas disciplinas"
              >
                <i class="fas fa-book mr-2"></i>Disciplinas
              </button>
            </div>
          </div>
        </div>

        <!-- Hero Section: Gerar Metas da Semana -->
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-6 border-2 border-blue-500">
          <div class="flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex-1 text-center md:text-left">
              <h2 class="text-3xl font-bold ${themes[currentTheme].text} mb-2 flex items-center justify-center md:justify-start gap-3">
                <i class="fas fa-calendar-week text-blue-600 dark:text-blue-400"></i>
                Metas Semanais
              </h2>
              <p class="${themes[currentTheme].textSecondary} text-lg">
                Organize seu estudo com metas distribu√≠das de segunda a domingo
              </p>
            </div>
            <button 
              onclick="gerarMetasSemana()" 
              class="px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-105 flex items-center gap-3"
            >
              <i class="fas fa-magic text-2xl"></i>
              <span>Gerar Metas da Semana</span>
            </button>
          </div>
        </div>

        <!-- Calend√°rio Semanal (√öNICA visualiza√ß√£o de metas) -->
        <div id="calendario-semanal" class="mb-4"></div>

        <!-- Container para modais -->
        <div id="modal-container" class="hidden"></div>

        <!-- Calend√°rio Compacto -->
        ${gerarCalendarioCompacto(historico)}

        <!-- Cards de Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">Disciplinas</p>
                <p class="text-3xl font-bold text-blue-600">${plano.diagnostico.total_disciplinas}</p>
              </div>
              <i class="fas fa-book text-4xl ${currentTheme === 'light' ? 'text-blue-200' : 'text-blue-400'}"></i>
            </div>
          </div>

          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">Nunca Estudadas</p>
                <p class="text-3xl font-bold text-blue-600">${plano.diagnostico.nunca_estudadas}</p>
              </div>
              <i class="fas fa-exclamation-triangle text-4xl ${currentTheme === 'light' ? 'text-blue-200' : 'text-blue-400'}"></i>
            </div>
          </div>

          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">N√≠vel M√©dio</p>
                <p class="text-3xl font-bold text-green-600">${plano.diagnostico.nivel_medio}/10</p>
              </div>
              <i class="fas fa-chart-line text-4xl ${currentTheme === 'light' ? 'text-green-200' : 'text-green-400'}"></i>
            </div>
          </div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <button onclick="renderPortfolioDisciplinas()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-book-open text-4xl text-blue-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Minhas Disciplinas</p>
          </button>

          <button onclick="renderCalendario()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-calendar-check text-4xl text-orange-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Calend√°rio</p>
          </button>

          <button onclick="renderMateriais()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-file-pdf text-4xl text-blue-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Materiais</p>
          </button>

          <button onclick="renderDesempenho()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-chart-bar text-4xl text-purple-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Desempenho</p>
          </button>

          <button onclick="renderRevisoes()" 
            class="${themes[currentTheme].card} p-6 rounded-lg shadow hover:shadow-lg transition text-center">
            <i class="fas fa-sync text-4xl text-blue-500 mb-2"></i>
            <p class="font-semibold ${themes[currentTheme].text}">Revis√µes</p>
          </button>
        </div>

        <!-- Gest√£o de Planos -->
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-6 mt-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                <i class="fas fa-layer-group text-white text-xl"></i>
              </div>
              <h2 class="text-xl font-bold ${themes[currentTheme].text}">Meus Planos de Estudo</h2>
            </div>
            <button onclick="iniciarEntrevista()" 
              class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2 rounded-lg hover:from-blue-700 hover:to-blue-800 transition flex items-center gap-2">
              <i class="fas fa-plus"></i>
              <span>Novo Plano</span>
            </button>
          </div>
          <div id="planos-list" class="space-y-3">
            <p class="${themes[currentTheme].textSecondary} text-center py-4">Carregando planos...</p>
          </div>
        </div>
      </div>
      </div>
    </div>
  `;
  
  // Verificar quais metas j√° t√™m conte√∫do gerado
  setTimeout(() => {
    metas.forEach(meta => {
      if (!meta.concluida) {
        verificarConteudoGerado(meta.id);
      }
    });
    // Carregar lista de planos
    carregarPlanos();
    // Carregar semana ativa para calend√°rio semanal
    carregarSemanaAtiva();
  }, 500);
}

function gerarCalendarioCompacto(historico) {
  const hoje = new Date();
  const mes = hoje.getMonth() + 1;
  const ano = hoje.getFullYear();
  const mesesNomes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  
  const primeiroDia = new Date(ano, mes - 1, 1);
  const ultimoDia = new Date(ano, mes, 0);
  const diasNoMes = ultimoDia.getDate();
  const diaSemanaInicio = primeiroDia.getDay();

  // Criar mapa de hist√≥rico por dia
  const historicoMap = {};
  historico.forEach(h => {
    const dia = new Date(h.data + 'T00:00:00').getDate();
    historicoMap[dia] = h;
  });

  // Gerar grade de dias
  let diasHTML = '';
  
  // Dias em branco antes do in√≠cio do m√™s
  for (let i = 0; i < diaSemanaInicio; i++) {
    diasHTML += '<div class=""></div>';
  }

  // Dias do m√™s
  for (let dia = 1; dia <= diasNoMes; dia++) {
    const hist = historicoMap[dia];
    let corClasse = 'bg-gray-200';
    let titulo = 'N√£o estudou';

    if (hist) {
      if (hist.status === 'completo') {
        corClasse = 'bg-blue-500';
        titulo = `‚úÖ ${hist.percentual_conclusao}% - ${Math.round(hist.tempo_estudado_minutos / 60 * 10) / 10}h`;
      } else if (hist.status === 'parcial') {
        corClasse = 'bg-blue-400';
        titulo = `‚ö†Ô∏è ${hist.percentual_conclusao}% - ${Math.round(hist.tempo_estudado_minutos / 60 * 10) / 10}h`;
      } else {
        corClasse = 'bg-red-300';
        titulo = '‚ùå N√£o estudou';
      }
    }

    // Marcar dia atual
    if (dia === hoje.getDate()) {
      diasHTML += `
        <div class="w-8 h-8 ${corClasse} rounded flex items-center justify-center text-xs font-bold ring-2 ring-blue-500 cursor-pointer hover:scale-110 transition"
             title="${titulo}">
          ${dia}
        </div>
      `;
    } else {
      diasHTML += `
        <div class="w-8 h-8 ${corClasse} rounded flex items-center justify-center text-xs cursor-pointer hover:scale-110 transition"
             title="${titulo}">
          ${dia}
        </div>
      `;
    }
  }

  return `
    <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">üìÖ Calend√°rio de Estudos - ${mesesNomes[mes - 1]}/${ano}</h2>
        <button onclick="renderCalendario()" class="text-sm text-blue-600 hover:underline">
          Ver completo ‚Üí
        </button>
      </div>

      <!-- Legenda -->
      <div class="flex justify-center space-x-4 mb-4 text-xs">
        <div class="flex items-center">
          <div class="w-3 h-3 bg-blue-500 rounded mr-1"></div>
          <span>Completo</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 bg-blue-400 rounded mr-1"></div>
          <span>Parcial</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 bg-red-300 rounded mr-1"></div>
          <span>N√£o estudou</span>
        </div>
        <div class="flex items-center">
          <div class="w-3 h-3 bg-gray-200 rounded mr-1"></div>
          <span>Sem dados</span>
        </div>
      </div>

      <!-- Grade do calend√°rio -->
      <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-semibold text-gray-600">
        <div>D</div>
        <div>S</div>
        <div>T</div>
        <div>Q</div>
        <div>Q</div>
        <div>S</div>
        <div>S</div>
      </div>

      <div class="grid grid-cols-7 gap-1 justify-items-center">
        ${diasHTML}
      </div>
    </div>
  `;
}

// Mostrar input de tempo quando checkbox √© marcado
function mostrarInputTempo(metaId, tempoMeta) {
  const checkbox = document.getElementById(`check-${metaId}`);
  const inputContainer = document.getElementById(`tempo-input-${metaId}`);
  
  if (checkbox.checked) {
    // Mostrar input de tempo
    inputContainer.classList.remove('hidden');
    // Focar no input
    document.getElementById(`tempo-real-${metaId}`).focus();
  } else {
    // Ocultar input
    inputContainer.classList.add('hidden');
  }
}

// Confirmar conclus√£o com tempo informado
async function concluirMetaComTempo(metaId) {
  const tempoInput = document.getElementById(`tempo-real-${metaId}`);
  const tempoReal = parseInt(tempoInput.value);
  
  if (!tempoReal || tempoReal < 1) {
    alert('‚ö†Ô∏è Por favor, informe um tempo v√°lido (m√≠nimo 1 minuto)');
    return;
  }
  
  if (tempoReal > 240) {
    alert('‚ö†Ô∏è Tempo m√°ximo: 240 minutos (4 horas)');
    return;
  }
  
  try {
    await axios.post('/api/metas/concluir', {
      meta_id: metaId,
      tempo_real_minutos: tempoReal
    });
    
    // Feedback visual
    const checkbox = document.getElementById(`check-${metaId}`);
    checkbox.disabled = true;
    
    // Recarregar dashboard
    renderDashboard();
  } catch (error) {
    console.error('Erro ao concluir meta:', error);
    alert('Erro ao salvar. Tente novamente.');
  }
}

// Cancelar conclus√£o
function cancelarConclusao(metaId) {
  const checkbox = document.getElementById(`check-${metaId}`);
  const inputContainer = document.getElementById(`tempo-input-${metaId}`);
  
  // Desmarcar checkbox
  checkbox.checked = false;
  
  // Ocultar input
  inputContainer.classList.add('hidden');
}

// Manter fun√ß√£o antiga para compatibilidade (se existir c√≥digo que a use)
async function toggleMeta(metaId) {
  mostrarInputTempo(metaId, 30);
}

// ============== PORTF√ìLIO DE DISCIPLINAS ==============
async function renderPortfolioDisciplinas() {
  try {
    // Mostrar loading
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen ${themes[currentTheme].bg} flex items-center justify-center">
        <div class="text-center">
          <i class="fas fa-spinner fa-spin text-6xl ${themes[currentTheme].text} mb-4"></i>
          <p class="${themes[currentTheme].text} text-xl">Carregando disciplinas...</p>
        </div>
      </div>
    `;
    
    // üÜï Buscar plano ativo para filtrar disciplinas
    console.log('Buscando plano ativo...');
    const planoRes = await axios.get(`/api/planos/user/${currentUser.id}`);
    const plano = planoRes.data;
    
    // Extrair IDs de disciplinas √öNICAS do plano atual (dos ciclos)
    const disciplinasIdPlano = [...new Set(plano.ciclos.map(c => c.disciplina_id))];
    console.log('Disciplinas no plano ativo:', disciplinasIdPlano.length);
    
    // Buscar APENAS as disciplinas do plano ativo
    console.log('Buscando disciplinas do usu√°rio:', currentUser.id);
    const disciplinasRes = await axios.get(`/api/user-disciplinas/${currentUser.id}`);
    const todasDisciplinas = disciplinasRes.data;
    
    // üÜï FILTRAR apenas disciplinas que est√£o no plano ativo
    const disciplinas = todasDisciplinas.filter(d => disciplinasIdPlano.includes(d.disciplina_id));
    console.log(`Disciplinas filtradas: ${disciplinas.length} de ${todasDisciplinas.length} (apenas do plano ativo)`);
    
    if (!disciplinas || disciplinas.length === 0) {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen ${themes[currentTheme].bg} flex items-center justify-center">
          <div class="text-center">
            <i class="fas fa-exclamation-triangle text-6xl text-blue-500 mb-4"></i>
            <p class="${themes[currentTheme].text} text-xl mb-4">Nenhuma disciplina no plano ativo</p>
            <button onclick="renderDashboard()" class="bg-blue-700 text-white px-6 py-2 rounded-lg hover:bg-blue-800">
              Voltar ao Dashboard
            </button>
          </div>
        </div>
      `;
      return;
    }
    
    // Buscar conte√∫dos gerados para cada disciplina
    console.log('Buscando conte√∫dos...');
    let conteudos = [];
    try {
      const conteudosRes = await axios.get(`/api/conteudos/usuario/${currentUser.id}`);
      
      // Backend pode retornar { conteudos: [...] } ou array direto
      if (conteudosRes.data && conteudosRes.data.conteudos) {
        conteudos = conteudosRes.data.conteudos; // Formato: { conteudos: [...], total: N }
      } else if (Array.isArray(conteudosRes.data)) {
        conteudos = conteudosRes.data; // Formato: [...]
      } else {
        console.warn('‚ö†Ô∏è Formato inesperado de resposta:', conteudosRes.data);
        conteudos = [];
      }
      
      console.log('Conte√∫dos encontrados:', conteudos.length);
    } catch (conteudoError) {
      console.warn('‚ö†Ô∏è Erro ao buscar conte√∫dos (continuando sem conte√∫dos):', conteudoError.message);
      conteudos = [];
    }
    
    renderPortfolioDisciplinasUI(disciplinas, conteudos);
  } catch (error) {
    console.error('‚ùå Erro ao carregar portf√≥lio:', error);
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen ${themes[currentTheme].bg} flex items-center justify-center">
        <div class="text-center">
          <i class="fas fa-times-circle text-6xl text-blue-500 mb-4"></i>
          <p class="${themes[currentTheme].text} text-xl mb-4">Erro ao carregar disciplinas</p>
          <p class="${themes[currentTheme].textSecondary} mb-4">${error.response?.data?.error || error.message}</p>
          <button onclick="renderDashboard()" class="bg-blue-500 text-white px-6 py-2 rounded-lg">
            Voltar ao Dashboard
          </button>
        </div>
      </div>
    `;
  }
}

function renderPortfolioDisciplinasUI(disciplinas, conteudos) {
  console.log('üé® Renderizando UI do portf√≥lio...', { disciplinas: disciplinas.length, conteudos: conteudos?.length || 0 });
  const app = document.getElementById('app');
  
  if (!app) {
    console.error('‚ùå Elemento #app n√£o encontrado!');
    return;
  }
  
  // Garantir que conteudos √© um array
  if (!Array.isArray(conteudos)) {
    console.warn('‚ö†Ô∏è conteudos n√£o √© um array, inicializando como array vazio:', conteudos);
    conteudos = [];
  }
  
  // Organizar conte√∫dos por disciplina
  const conteudosPorDisciplina = {};
  conteudos.forEach(conteudo => {
    const discId = conteudo.disciplina_id;
    if (!conteudosPorDisciplina[discId]) {
      conteudosPorDisciplina[discId] = [];
    }
    conteudosPorDisciplina[discId].push(conteudo);
  });
  console.log('üìä Conte√∫dos organizados por disciplina');
  
  // Calcular estat√≠sticas por disciplina
  const estatisticas = disciplinas.map(disc => {
    const conteudosDisc = conteudosPorDisciplina[disc.disciplina_id] || [];
    const totalConteudos = conteudosDisc.length;
    const teoria = conteudosDisc.filter(c => c.tipo === 'teoria').length;
    const exercicios = conteudosDisc.filter(c => c.tipo === 'exercicios').length;
    const revisao = conteudosDisc.filter(c => c.tipo === 'revisao').length;
    
    return {
      ...disc,
      totalConteudos,
      teoria,
      exercicios,
      revisao,
      conteudos: conteudosDisc
    };
  });
  
  app.innerHTML = `
    <div class="${themes[currentTheme].bg} min-h-screen p-8">
      <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
          <div>
            <h1 class="text-3xl font-bold ${themes[currentTheme].text} mb-2">
              <i class="fas fa-book-open mr-3 text-blue-500"></i>
              Minhas Disciplinas
            </h1>
            <p class="${themes[currentTheme].textSecondary}">
              Todo o conte√∫do organizado por disciplina
            </p>
          </div>
          <button onclick="renderDashboard()" 
            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
          </button>
        </div>

        <!-- Estat√≠sticas Gerais -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="${themes[currentTheme].card} p-6 rounded-lg shadow-md border ${themes[currentTheme].border} hover:shadow-lg transition">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">Total de Disciplinas</p>
                <p class="text-3xl font-bold ${c('primary').text}">${disciplinas.length}</p>
              </div>
              <div class="w-14 h-14 rounded-full ${c('primary').bg} flex items-center justify-center">
                <i class="fas fa-book text-2xl ${c('primary').icon}"></i>
              </div>
            </div>
          </div>
          
          <div class="${themes[currentTheme].card} p-6 rounded-lg shadow-md border ${themes[currentTheme].border} hover:shadow-lg transition">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">Conte√∫dos Gerados</p>
                <p class="text-3xl font-bold ${currentTheme === 'light' ? 'text-indigo-600' : 'text-indigo-400'}">${conteudos.length}</p>
              </div>
              <div class="w-14 h-14 rounded-full ${currentTheme === 'light' ? 'bg-indigo-100' : 'bg-indigo-900/30'} flex items-center justify-center">
                <i class="fas fa-file-alt text-2xl ${currentTheme === 'light' ? 'text-indigo-600' : 'text-indigo-400'}"></i>
              </div>
            </div>
          </div>
          
          <div class="${themes[currentTheme].card} p-6 rounded-lg shadow-md border ${themes[currentTheme].border} hover:shadow-lg transition">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">Teoria</p>
                <p class="text-3xl font-bold ${c('secondary').text}">${conteudos.filter(c => c.tipo === 'teoria').length}</p>
              </div>
              <div class="w-14 h-14 rounded-full ${c('secondary').bg} flex items-center justify-center">
                <i class="fas fa-graduation-cap text-2xl ${c('secondary').icon}"></i>
              </div>
            </div>
          </div>
          
          <div class="${themes[currentTheme].card} p-6 rounded-lg shadow-md border ${themes[currentTheme].border} hover:shadow-lg transition">
            <div class="flex items-center justify-between">
              <div>
                <p class="${themes[currentTheme].textSecondary} text-sm">Exerc√≠cios</p>
                <p class="text-3xl font-bold ${c('success').text}">${conteudos.filter(c => c.tipo === 'exercicios').length}</p>
              </div>
              <div class="w-14 h-14 rounded-full ${c('success').bg} flex items-center justify-center">
                <i class="fas fa-tasks text-2xl ${c('success').icon}"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de Disciplinas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          ${estatisticas.map(disc => `
            <div class="${themes[currentTheme].card} rounded-lg shadow-lg hover:shadow-xl transition overflow-hidden border ${themes[currentTheme].border}">
              <!-- Header da Disciplina -->
              <div class="${currentTheme === 'light' ? 'bg-gradient-to-r from-blue-50 to-blue-100 border-b border-blue-200' : 'bg-gradient-to-r from-blue-800/30 to-blue-900/30 border-b border-blue-700'} p-6">
                <h3 class="text-xl font-bold mb-2 ${currentTheme === 'light' ? 'text-blue-900' : 'text-blue-100'}">${disc.nome}</h3>
                <div class="flex items-center gap-2 text-sm ${currentTheme === 'light' ? 'text-blue-700' : 'text-blue-300'}">
                  <span><i class="fas fa-signal mr-1"></i>N√≠vel ${disc.nivel_atual || 5}/10</span>
                  <span>‚Ä¢</span>
                  <span><i class="fas fa-file mr-1"></i>${disc.totalConteudos} conte√∫dos</span>
                </div>
              </div>
              
              <!-- Estat√≠sticas da Disciplina -->
              <div class="p-6">
                <div class="grid grid-cols-3 gap-4 mb-4">
                  <div class="text-center p-3 rounded-lg ${c('primary').bg}">
                    <div class="text-2xl font-bold ${c('primary').text}">${disc.teoria}</div>
                    <div class="${themes[currentTheme].textSecondary} text-xs mt-1">Teoria</div>
                  </div>
                  <div class="text-center p-3 rounded-lg ${c('success').bg}">
                    <div class="text-2xl font-bold ${c('success').text}">${disc.exercicios}</div>
                    <div class="${themes[currentTheme].textSecondary} text-xs mt-1">Exerc√≠cios</div>
                  </div>
                  <div class="text-center p-3 rounded-lg ${c('secondary').bg}">
                    <div class="text-2xl font-bold ${c('secondary').text}">${disc.revisao}</div>
                    <div class="${themes[currentTheme].textSecondary} text-xs mt-1">Revis√£o</div>
                  </div>
                </div>
                
                <!-- Bot√£o Ver Detalhes -->
                <button 
                  onclick="verDetalhesDisciplina(${disc.disciplina_id}, '${disc.nome.replace(/'/g, "\\'")}')"
                  class="w-full ${currentTheme === 'light' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-600 hover:bg-blue-500'} text-white py-3 rounded-lg transition font-semibold shadow-md hover:shadow-lg">
                  <i class="fas fa-eye mr-2"></i>Ver Conte√∫dos
                </button>
              </div>
            </div>
          `).join('')}
        </div>
        
        ${disciplinas.length === 0 ? `
          <div class="${themes[currentTheme].card} p-12 rounded-lg text-center">
            <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-bold ${themes[currentTheme].text} mb-2">Nenhuma disciplina cadastrada</h3>
            <p class="${themes[currentTheme].textSecondary} mb-4">Complete a entrevista inicial para come√ßar</p>
            <button onclick="renderDashboard()" class="bg-blue-700 text-white px-6 py-3 rounded-lg hover:bg-blue-800">
              Voltar ao Dashboard
            </button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

async function verDetalhesDisciplina(disciplinaId, disciplinaNome) {
  try {
    // Buscar todos os conte√∫dos do usu√°rio
    const conteudosRes = await axios.get(`/api/conteudos/usuario/${currentUser.id}`);
    
    // Backend pode retornar { conteudos: [...] } ou array direto
    let todosConteudos = [];
    if (conteudosRes.data && conteudosRes.data.conteudos) {
      todosConteudos = conteudosRes.data.conteudos;
    } else if (Array.isArray(conteudosRes.data)) {
      todosConteudos = conteudosRes.data;
    }
    
    // Filtrar apenas conte√∫dos desta disciplina
    const conteudos = todosConteudos.filter(c => c.disciplina_id === disciplinaId);
    
    await renderDetalheDisciplina(disciplinaId, disciplinaNome, conteudos);
  } catch (error) {
    console.error('Erro ao carregar detalhes:', error);
    alert('Erro ao carregar conte√∫dos da disciplina: ' + (error.response?.data?.error || error.message));
  }
}

async function renderDetalheDisciplina(disciplinaId, disciplinaNome, conteudos) {
  const app = document.getElementById('app');
  
  // Buscar t√≥picos do edital e progresso
  let topicos = [];
  try {
    const topicosRes = await axios.get(`/api/user-topicos/${currentUser.id}/${disciplinaId}`);
    topicos = topicosRes.data;
  } catch (error) {
    console.error('Erro ao buscar t√≥picos:', error);
  }
  
  // Organizar conte√∫dos por tipo e data
  const conteudosOrganizados = {
    teoria: conteudos.filter(c => c.tipo === 'teoria').sort((a, b) => new Date(b.created_at) - new Date(a.created_at)),
    exercicios: conteudos.filter(c => c.tipo === 'exercicios').sort((a, b) => new Date(b.created_at) - new Date(a.created_at)),
    revisao: conteudos.filter(c => c.tipo === 'revisao').sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
  };
  
  app.innerHTML = `
    <div class="${themes[currentTheme].bg} min-h-screen p-8">
      <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
          <div>
            <h1 class="text-3xl font-bold ${themes[currentTheme].text} mb-2">
              <i class="fas fa-book mr-3 text-blue-500"></i>
              ${disciplinaNome}
            </h1>
            <p class="${themes[currentTheme].textSecondary}">
              ${conteudos.length} conte√∫do(s) gerado(s)
            </p>
          </div>
          <button onclick="renderPortfolioDisciplinas()" 
            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
          </button>
        </div>

        <!-- Tabs -->
        <div class="mb-6 flex gap-2 border-b ${themes[currentTheme].text === 'text-white' ? 'border-gray-700' : '${themes[currentTheme].border}'}">
          <button onclick="switchTabDisciplina('topicos')" id="tab-topicos"
            class="px-6 py-3 font-semibold transition border-b-2 border-blue-500 text-blue-600">
            <i class="fas fa-list-check mr-2"></i>T√≥picos do Edital (${topicos.length})
          </button>
          <button onclick="switchTabDisciplina('teoria')" id="tab-teoria"
            class="px-6 py-3 font-semibold transition border-b-2 border-transparent ${themes[currentTheme].textSecondary} hover:${themes[currentTheme].text}">
            <i class="fas fa-graduation-cap mr-2"></i>Teoria (${conteudosOrganizados.teoria.length})
          </button>
          <button onclick="switchTabDisciplina('exercicios')" id="tab-exercicios"
            class="px-6 py-3 font-semibold transition border-b-2 border-transparent ${themes[currentTheme].textSecondary} hover:${themes[currentTheme].text}">
            <i class="fas fa-tasks mr-2"></i>Exerc√≠cios (${conteudosOrganizados.exercicios.length})
          </button>
          <button onclick="switchTabDisciplina('revisao')" id="tab-revisao"
            class="px-6 py-3 font-semibold transition border-b-2 border-transparent ${themes[currentTheme].textSecondary} hover:${themes[currentTheme].text}">
            <i class="fas fa-sync mr-2"></i>Revis√£o (${conteudosOrganizados.revisao.length})
          </button>
        </div>

        <!-- Conte√∫do da Tab -->
        <div id="conteudo-tab">
          ${renderTabTopicos(topicos)}
        </div>
      </div>
    </div>
  `;
  
  // Salvar dados globalmente para as tabs
  window.currentDisciplinaConteudos = conteudosOrganizados;
  window.currentDisciplinaTopicos = topicos;
}

function switchTabDisciplina(tipo) {
  // Atualizar estilo das tabs
  ['topicos', 'teoria', 'exercicios', 'revisao'].forEach(t => {
    const tab = document.getElementById(`tab-${t}`);
    if (t === tipo) {
      const cor = t === 'topicos' ? 'blue' : t === 'teoria' ? 'purple' : t === 'exercicios' ? 'orange' : 'blue';
      tab.className = `px-6 py-3 font-semibold transition border-b-2 border-${cor}-500 text-${cor}-600`;
    } else {
      tab.className = `px-6 py-3 font-semibold transition border-b-2 border-transparent ${themes[currentTheme].textSecondary} hover:${themes[currentTheme].text}`;
    }
  });
  
  // Atualizar conte√∫do
  const conteudoTab = document.getElementById('conteudo-tab');
  if (tipo === 'topicos') {
    conteudoTab.innerHTML = renderTabTopicos(window.currentDisciplinaTopicos);
  } else {
    conteudoTab.innerHTML = renderTabConteudo(tipo, window.currentDisciplinaConteudos[tipo]);
  }
}

function renderTabTopicos(topicos) {
  if (topicos.length === 0) {
    return `
      <div class="${themes[currentTheme].card} p-12 rounded-lg text-center">
        <i class="fas fa-list text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-bold ${themes[currentTheme].text} mb-2">Nenhum t√≥pico cadastrado</h3>
        <p class="${themes[currentTheme].textSecondary}">Os t√≥picos do edital ser√£o adicionados em breve</p>
      </div>
    `;
  }
  
  // Agrupar por categoria
  const categorias = {};
  topicos.forEach(topico => {
    const cat = topico.categoria || 'Outros';
    if (!categorias[cat]) {
      categorias[cat] = [];
    }
    categorias[cat].push(topico);
  });
  
  // Calcular estat√≠sticas gerais
  const totalTopicos = topicos.length;
  const estudados = topicos.filter(t => t.vezes_estudado > 0).length;
  const percentualConclusao = totalTopicos > 0 ? Math.round((estudados / totalTopicos) * 100) : 0;
  const nivelMedio = totalTopicos > 0 ? topicos.reduce((sum, t) => sum + t.nivel_dominio, 0) / totalTopicos : 0;
  
  console.log(`üìä Estat√≠sticas: ${estudados}/${totalTopicos} estudados (${percentualConclusao}%), n√≠vel m√©dio: ${nivelMedio.toFixed(1)}`);
  
  return `
    <!-- Estat√≠sticas do Edital -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="${themes[currentTheme].card} p-4 rounded-lg shadow">
        <div class="text-center">
          <div class="text-3xl font-bold ${c('primary').text}">${totalTopicos}</div>
          <div class="${themes[currentTheme].textSecondary} text-sm">T√≥picos Total</div>
        </div>
      </div>
      <div class="${themes[currentTheme].card} p-4 rounded-lg shadow">
        <div class="text-center">
          <div class="text-3xl font-bold ${c('success').text}">${estudados}</div>
          <div class="${themes[currentTheme].textSecondary} text-sm">J√° Estudados</div>
        </div>
      </div>
      <div class="${themes[currentTheme].card} p-4 rounded-lg shadow">
        <div class="text-center">
          <div class="text-3xl font-bold ${c('secondary').text}">${percentualConclusao}%</div>
          <div class="${themes[currentTheme].textSecondary} text-sm">Conclus√£o</div>
        </div>
      </div>
      <div class="${themes[currentTheme].card} p-4 rounded-lg shadow">
        <div class="text-center">
          <div class="text-3xl font-bold ${c('warning').text}">${nivelMedio.toFixed(1)}/10</div>
          <div class="${themes[currentTheme].textSecondary} text-sm">Dom√≠nio M√©dio</div>
        </div>
      </div>
    </div>
    
    <!-- Barra de Progresso Geral -->
    <div class="${themes[currentTheme].card} p-6 rounded-lg shadow mb-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold ${themes[currentTheme].text}">Progresso Geral do Edital</h3>
        <span class="text-sm ${themes[currentTheme].textSecondary}">${estudados}/${totalTopicos} t√≥picos</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 h-4 rounded-full transition-all duration-500" 
          style="width: ${percentualConclusao}%"></div>
      </div>
    </div>
    
    <!-- T√≥picos por Categoria -->
    <div class="space-y-6">
      ${Object.keys(categorias).map(categoria => `
        <div class="${themes[currentTheme].card} rounded-lg shadow overflow-hidden">
          <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-4">
            <h3 class="text-lg font-bold text-white">
              <i class="fas fa-folder-open mr-2"></i>${categoria}
            </h3>
          </div>
          <div class="p-6">
            <div class="space-y-3">
              ${categorias[categoria].map(topico => {
                const percentual = topico.nivel_dominio * 10;
                const cor = topico.vezes_estudado === 0 ? 'red' : 
                           topico.nivel_dominio < 5 ? 'yellow' : 
                           topico.nivel_dominio < 8 ? 'blue' : 'green';
                
                return `
                  <div class="border ${themes[currentTheme].text === 'text-white' ? 'border-gray-700' : '${themes[currentTheme].border}'} rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex items-start justify-between mb-3">
                      <div class="flex-1">
                        <h4 class="font-semibold ${themes[currentTheme].text} mb-1">
                          ${topico.nome}
                        </h4>
                        <div class="flex items-center gap-4 text-sm ${themes[currentTheme].textSecondary}">
                          <span>
                            <i class="fas fa-redo mr-1"></i>
                            ${topico.vezes_estudado || 0}x estudado
                          </span>
                          ${topico.ultima_vez ? `
                            <span>
                              <i class="far fa-clock mr-1"></i>
                              ${new Date(topico.ultima_vez).toLocaleDateString('pt-BR')}
                            </span>
                          ` : ''}
                          <span>
                            <i class="fas fa-weight-hanging mr-1"></i>
                            Peso ${topico.peso}
                          </span>
                        </div>
                      </div>
                      <div class="flex items-center gap-2">
                        <div class="text-center">
                          <div class="text-2xl font-bold text-${cor}-600">${topico.nivel_dominio}/10</div>
                          <div class="text-xs ${themes[currentTheme].textSecondary}">Dom√≠nio</div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Barra de Progresso do T√≥pico -->
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div class="bg-${cor}-500 h-2 rounded-full transition-all duration-300" 
                        style="width: ${percentual}%"></div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderTabConteudo(tipo, conteudos) {
  if (conteudos.length === 0) {
    return `
      <div class="${themes[currentTheme].card} p-12 rounded-lg text-center">
        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-bold ${themes[currentTheme].text} mb-2">Nenhum conte√∫do de ${tipo} ainda</h3>
        <p class="${themes[currentTheme].textSecondary}">Gere conte√∫dos pelo Dashboard para v√™-los aqui</p>
      </div>
    `;
  }
  
  return `
    <div class="space-y-4">
      ${conteudos.map(conteudo => {
        const topicos = JSON.parse(conteudo.topicos || '[]');
        const dataFormatada = new Date(conteudo.created_at).toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        });
        
        return `
          <div class="${themes[currentTheme].card} rounded-lg shadow hover:shadow-lg transition overflow-hidden">
            <div class="p-6">
              <!-- Header do Conte√∫do -->
              <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                  <h3 class="text-lg font-bold ${themes[currentTheme].text} mb-2">
                    ${topicos.slice(0, 2).join(' ‚Ä¢ ')}${topicos.length > 2 ? '...' : ''}
                  </h3>
                  <div class="flex items-center gap-4 text-sm ${themes[currentTheme].textSecondary}">
                    <span><i class="far fa-calendar mr-1"></i>${dataFormatada}</span>
                    <span><i class="fas fa-file mr-1"></i>${conteudo.tipo}</span>
                  </div>
                </div>
                <button 
                  onclick="visualizarConteudoPorId(${conteudo.id})"
                  class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition flex items-center gap-2">
                  <i class="fas fa-eye"></i>
                  Ver Material
                </button>
              </div>
              
              <!-- T√≥picos -->
              <div class="flex flex-wrap gap-2 mb-4">
                ${topicos.map(topico => `
                  <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">
                    ${topico}
                  </span>
                `).join('')}
              </div>
              
              <!-- Objetivos -->
              ${conteudo.objetivos ? `
                <div class="border-t ${themes[currentTheme].text === 'text-white' ? 'border-gray-700' : '${themes[currentTheme].border}'} pt-4">
                  <h4 class="font-semibold ${themes[currentTheme].text} mb-2">
                    <i class="fas fa-bullseye mr-2 text-orange-500"></i>Objetivos:
                  </h4>
                  <ul class="${themes[currentTheme].textSecondary} text-sm space-y-1">
                    ${JSON.parse(conteudo.objetivos).slice(0, 3).map(obj => `
                      <li><i class="fas fa-check text-blue-500 mr-2"></i>${obj}</li>
                    `).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// Visualizar conte√∫do por ID
async function visualizarConteudoPorId(conteudoId) {
  try {
    console.log('üîç Buscando conte√∫do ID:', conteudoId);
    const response = await axios.get(`/api/conteudos/${conteudoId}`);
    console.log('‚úÖ Conte√∫do recebido:', {
      id: response.data?.id,
      tipo: response.data?.tipo,
      disciplina: response.data?.disciplina_nome,
      temConteudo: !!response.data?.conteudo,
      temSecoes: !!response.data?.conteudo?.secoes
    });
    visualizarConteudo(response.data);
  } catch (error) {
    console.error('‚ùå Erro ao carregar conte√∫do:', error);
    console.error('‚ùå Detalhes do erro:', error.response?.data || error.message);
    alert(`‚ùå Erro ao carregar material de estudo\n\nID: ${conteudoId}\nErro: ${error.response?.statusText || error.message}`);
  }
}

function renderMateriais() {
  alert('M√≥dulo de Materiais em desenvolvimento');
}

function renderDesempenho() {
  alert('M√≥dulo de Desempenho em desenvolvimento');
}

function renderRevisoes() {
  alert('M√≥dulo de Revis√µes em desenvolvimento');
}

function renderPlano() {
  alert('M√≥dulo de Plano Semanal em desenvolvimento');
}

function logout() {
  // Limpar TODOS os dados da sess√£o
  localStorage.removeItem('userId');
  localStorage.removeItem('userEmail');
  localStorage.removeItem('userName');
  
  // Limpar objeto global
  currentUser = null;
  
  // Voltar para tela de login
  renderLogin();
}

window.changeTheme = (theme) => {
  applyTheme(theme);
  renderDashboard(); // Recarregar dashboard com novo tema
};

window.openCustomThemeModal = (themeToEdit) => {
  // Usar o tema passado como par√¢metro ou o atual
  const editTheme = themeToEdit || currentTheme;
  const isRgbTheme = editTheme === 'rgb';
  const currentColors = isRgbTheme ? rgbColors : customColors;
  const themeTitle = isRgbTheme ? 'Tema RGB' : 'Tema Personalizado';
  
  const modal = document.createElement('div');
  modal.id = 'customThemeModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="${themes[currentTheme].card} dark:bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold ${themes[currentTheme].text} dark:text-white">
          <i class="fas fa-paint-brush mr-2"></i>
          ${themeTitle}
        </h2>
        <button onclick="closeCustomThemeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
        ${isRgbTheme ? 'Personalize as cores do tema RGB' : 'Escolha 3 cores para criar seu tema personalizado em gradiente'}
      </p>
      
      <input type="hidden" id="editingTheme" value="${editTheme}">
      
      <div class="space-y-4 mb-6">
        <!-- Cor Prim√°ria -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-circle mr-2" style="color: ${currentColors.primary}"></i>
            Cor Prim√°ria
          </label>
          <div class="flex gap-3">
            <input type="color" id="colorPrimary" value="${currentColors.primary}" 
              class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer">
            <input type="text" id="colorPrimaryHex" value="${currentColors.primary}" 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
              placeholder="#8b5cf6">
          </div>
        </div>
        
        <!-- Cor Secund√°ria -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-circle mr-2" style="color: ${currentColors.secondary}"></i>
            Cor Secund√°ria
          </label>
          <div class="flex gap-3">
            <input type="color" id="colorSecondary" value="${currentColors.secondary}" 
              class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer">
            <input type="text" id="colorSecondaryHex" value="${currentColors.secondary}" 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
              placeholder="#ec4899">
          </div>
        </div>
        
        <!-- Cor de Destaque -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-circle mr-2" style="color: ${currentColors.accent}"></i>
            Cor de Destaque
          </label>
          <div class="flex gap-3">
            <input type="color" id="colorAccent" value="${currentColors.accent}" 
              class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer">
            <input type="text" id="colorAccentHex" value="${currentColors.accent}" 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
              placeholder="#3b82f6">
          </div>
        </div>
      </div>
      
      <!-- Preview -->
      <div class="mb-6">
        <button type="button" onclick="updatePreviewManually()" 
          class="w-full mb-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg font-semibold transition">
          <i class="fas fa-eye mr-2"></i>
          Atualizar Preview
        </button>
        <div class="p-6 rounded-lg" id="themePreview" 
          style="background: linear-gradient(135deg, ${currentColors.primary}, ${currentColors.secondary}, ${currentColors.accent})">
          <p class="text-white font-semibold text-center text-lg">Preview do Tema</p>
          <p class="text-white/80 text-sm text-center mt-2">Suas cores personalizadas</p>
        </div>
      </div>
      
      <!-- Presets R√°pidos -->
      <div class="mb-6">
        <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Presets R√°pidos:</p>
        <div class="grid grid-cols-4 gap-2">
          <button onclick="applyPreset('#8b5cf6', '#ec4899', '#3b82f6')" 
            class="h-10 rounded border-2 border-gray-300 hover:border-white transition"
            style="background: linear-gradient(135deg, #8b5cf6, #ec4899, #3b82f6)"
            title="Roxo + Rosa + Azul"></button>
          <button onclick="applyPreset('#f59e0b', '#ef4444', '#dc2626')" 
            class="h-10 rounded border-2 border-gray-300 hover:border-white transition"
            style="background: linear-gradient(135deg, #f59e0b, #ef4444, #dc2626)"
            title="Laranja + Vermelho"></button>
          <button onclick="applyPreset('#10b981', '#3b82f6', '#8b5cf6')" 
            class="h-10 rounded border-2 border-gray-300 hover:border-white transition"
            style="background: linear-gradient(135deg, #10b981, #3b82f6, #8b5cf6)"
            title="Verde + Azul + Roxo"></button>
          <button onclick="applyPreset('#f472b6', '#a855f7', '#6366f1')" 
            class="h-10 rounded border-2 border-gray-300 hover:border-white transition"
            style="background: linear-gradient(135deg, #f472b6, #a855f7, #6366f1)"
            title="Rosa + Roxo + Indigo"></button>
        </div>
      </div>
      
      <div class="flex gap-3">
        <button onclick="closeCustomThemeModal()" 
          class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-semibold transition">
          Cancelar
        </button>
        <button onclick="saveCustomTheme()" 
          class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition">
          <i class="fas fa-check mr-2"></i>
          Aplicar
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Sincronizar inputs
  ['Primary', 'Secondary', 'Accent'].forEach(type => {
    const colorPicker = document.getElementById(`color${type}`);
    const hexInput = document.getElementById(`color${type}Hex`);
    
    colorPicker.addEventListener('input', (e) => {
      hexInput.value = e.target.value;
      updatePreview();
    });
    
    hexInput.addEventListener('input', (e) => {
      if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
        colorPicker.value = e.target.value;
        updatePreview();
      }
    });
  });
  
  function updatePreview() {
    const primary = document.getElementById('colorPrimary').value;
    const secondary = document.getElementById('colorSecondary').value;
    const accent = document.getElementById('colorAccent').value;
    const preview = document.getElementById('themePreview');
    preview.style.background = `linear-gradient(135deg, ${primary}, ${secondary}, ${accent})`;
  }
  
  // Expor fun√ß√£o globalmente para bot√£o
  window.updatePreviewManually = updatePreview;
};

window.closeCustomThemeModal = () => {
  const modal = document.getElementById('customThemeModal');
  if (modal) modal.remove();
};

window.applyPreset = (primary, secondary, accent) => {
  document.getElementById('colorPrimary').value = primary;
  document.getElementById('colorPrimaryHex').value = primary;
  document.getElementById('colorSecondary').value = secondary;
  document.getElementById('colorSecondaryHex').value = secondary;
  document.getElementById('colorAccent').value = accent;
  document.getElementById('colorAccentHex').value = accent;
  
  const preview = document.getElementById('themePreview');
  preview.style.background = `linear-gradient(135deg, ${primary}, ${secondary}, ${accent})`;
};

window.saveCustomTheme = () => {
  const editingTheme = document.getElementById('editingTheme').value;
  const colors = {
    primary: document.getElementById('colorPrimary').value,
    secondary: document.getElementById('colorSecondary').value,
    accent: document.getElementById('colorAccent').value
  };
  
  // Salvar nas vari√°veis corretas baseado no tema sendo editado
  if (editingTheme === 'rgb') {
    rgbColors = colors;
    localStorage.setItem('rgbColors', JSON.stringify(rgbColors));
    closeCustomThemeModal();
    // Aplicar tema e re-renderizar dashboard
    applyTheme('rgb');
    renderDashboard();
  } else {
    customColors = colors;
    localStorage.setItem('customColors', JSON.stringify(customColors));
    closeCustomThemeModal();
    // Aplicar tema e re-renderizar dashboard
    applyTheme('custom');
    renderDashboard();
  }
};

// ============== GERA√á√ÉO AUTOM√ÅTICA DE METAS ==============
async function gerarMetasDia() {
  try {
    const response = await axios.post(`/api/metas/gerar/${currentUser.id}`);
    if (response.data.success) {
      alert(`‚úÖ ${response.data.metas_criadas} metas geradas para hoje!`);
      renderDashboard();
    } else {
      alert(response.data.message || 'Metas j√° existem para hoje');
    }
  } catch (error) {
    console.error('Erro ao gerar metas:', error);
    alert('Erro ao gerar metas do dia');
  }
}

// ============== CALEND√ÅRIO DE ESTUDOS ==============
async function renderCalendario() {
  const hoje = new Date();
  const mes = hoje.getMonth() + 1;
  const ano = hoje.getFullYear();

  try {
    const [calendarioRes, estatisticasRes] = await Promise.all([
      axios.get(`/api/calendario/${currentUser.id}?mes=${mes}&ano=${ano}`),
      axios.get(`/api/estatisticas/${currentUser.id}`)
    ]);

    const historico = calendarioRes.data;
    const stats = estatisticasRes.data;

    renderCalendarioUI(historico, stats, mes, ano);
  } catch (error) {
    console.error('Erro ao carregar calend√°rio:', error);
    alert('Erro ao carregar calend√°rio');
  }
}

function renderCalendarioUI(historico, stats, mes, ano) {
  const mesesNomes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  
  const primeiroDia = new Date(ano, mes - 1, 1);
  const ultimoDia = new Date(ano, mes, 0);
  const diasNoMes = ultimoDia.getDate();
  const diaSemanaInicio = primeiroDia.getDay();

  // Criar mapa de hist√≥rico por dia
  const historicoMap = {};
  historico.forEach(h => {
    const dia = new Date(h.data + 'T00:00:00').getDate();
    historicoMap[dia] = h;
  });

  // Gerar grade de dias
  let diasHTML = '';
  
  // Dias em branco antes do in√≠cio do m√™s
  for (let i = 0; i < diaSemanaInicio; i++) {
    diasHTML += '<div class="p-2"></div>';
  }

  // Dias do m√™s
  for (let dia = 1; dia <= diasNoMes; dia++) {
    const hist = historicoMap[dia];
    let corClasse = 'bg-gray-100 ${themes[currentTheme].border}';
    let icone = '';
    let titulo = 'N√£o estudou';

    if (hist) {
      if (hist.status === 'completo') {
        corClasse = 'bg-green-100 border-green-400';
        icone = '<i class="fas fa-check text-green-600"></i>';
        titulo = `${hist.percentual_conclusao}% - ${Math.round(hist.tempo_estudado_minutos / 60 * 10) / 10}h`;
      } else if (hist.status === 'parcial') {
        corClasse = 'bg-yellow-100 border-yellow-400';
        icone = '<i class="fas fa-clock text-blue-600"></i>';
        titulo = `${hist.percentual_conclusao}% - ${Math.round(hist.tempo_estudado_minutos / 60 * 10) / 10}h`;
      } else {
        corClasse = 'bg-red-100 border-red-300';
        icone = '<i class="fas fa-times text-blue-500"></i>';
        titulo = 'N√£o estudou';
      }
    }

    diasHTML += `
      <div class="p-3 border-2 rounded-lg ${corClasse} text-center cursor-pointer hover:shadow-md transition"
           title="${titulo}">
        <div class="text-sm font-semibold mb-1">${dia}</div>
        ${icone}
      </div>
    `;
  }

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg}">
      <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <button onclick="renderDashboard()" class="${themes[currentTheme].textSecondary} hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
          </button>
          <h1 class="text-2xl font-bold ${themes[currentTheme].text}">üìÖ Calend√°rio de Estudos</h1>
          <div></div>
        </div>
      </header>

      <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-sm">Streak Atual</p>
                <p class="text-3xl font-bold text-orange-600">${stats.streak_atual} üî•</p>
              </div>
              <i class="fas fa-fire text-4xl text-orange-200"></i>
            </div>
          </div>

          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-sm">Dias Estudados</p>
                <p class="text-3xl font-bold text-blue-600">${stats.dias_estudados}</p>
              </div>
              <i class="fas fa-calendar-check text-4xl text-blue-200"></i>
            </div>
          </div>

          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-sm">Horas Totais</p>
                <p class="text-3xl font-bold text-purple-600">${stats.horas_totais}h</p>
              </div>
              <i class="fas fa-clock text-4xl text-purple-200"></i>
            </div>
          </div>

          <div class="${themes[currentTheme].card} rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-sm">M√©dia de Conclus√£o</p>
                <p class="text-3xl font-bold text-green-600">${stats.media_conclusao}%</p>
              </div>
              <i class="fas fa-chart-line text-4xl text-green-200"></i>
            </div>
          </div>
        </div>

        <!-- Calend√°rio -->
        <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-bold mb-6 text-center">${mesesNomes[mes - 1]} ${ano}</h2>

          <!-- Legenda -->
          <div class="flex justify-center space-x-6 mb-6 text-sm">
            <div class="flex items-center">
              <div class="w-4 h-4 bg-green-100 border-2 border-green-400 rounded mr-2"></div>
              <span>Completo</span>
            </div>
            <div class="flex items-center">
              <div class="w-4 h-4 bg-yellow-100 border-2 border-yellow-400 rounded mr-2"></div>
              <span>Parcial</span>
            </div>
            <div class="flex items-center">
              <div class="w-4 h-4 bg-red-100 border-2 border-red-300 rounded mr-2"></div>
              <span>N√£o estudou</span>
            </div>
            <div class="flex items-center">
              <div class="w-4 h-4 bg-gray-100 border-2 ${themes[currentTheme].border} rounded mr-2"></div>
              <span>Sem dados</span>
            </div>
          </div>

          <!-- Grade do calend√°rio -->
          <div class="grid grid-cols-7 gap-2 mb-4">
            <div class="text-center font-semibold text-gray-600 p-2">Dom</div>
            <div class="text-center font-semibold text-gray-600 p-2">Seg</div>
            <div class="text-center font-semibold text-gray-600 p-2">Ter</div>
            <div class="text-center font-semibold text-gray-600 p-2">Qua</div>
            <div class="text-center font-semibold text-gray-600 p-2">Qui</div>
            <div class="text-center font-semibold text-gray-600 p-2">Sex</div>
            <div class="text-center font-semibold text-gray-600 p-2">S√°b</div>
          </div>

          <div class="grid grid-cols-7 gap-2">
            ${diasHTML}
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============== CONTE√öDO DE ESTUDO GERADO POR IA ==============
async function gerarConteudoMetaPorId(metaId) {
  try {
    // Buscar dados da meta
    const metasHoje = await axios.get(`/api/metas/hoje/${currentUser.id}`);
    const meta = metasHoje.data.find(m => m.id === metaId);
    
    if (!meta) {
      alert('Meta n√£o encontrada');
      return;
    }
    
    await gerarConteudoMeta(meta);
  } catch (error) {
    console.error('Erro ao buscar meta:', error);
    alert('Erro ao buscar informa√ß√µes da meta');
  }
}

async function gerarConteudoMeta(meta, forceRegenerate = false) {
  try {
    console.log('üéØ Iniciando gera√ß√£o de conte√∫do para meta:', meta);
    
    // Verificar se j√° existe conte√∫do gerado
    const conteudoExistente = await axios.get(`/api/conteudos/${meta.id}`).catch(() => null);
    
    if (conteudoExistente?.data && !forceRegenerate) {
      console.log('‚úÖ Conte√∫do j√° existe, exibindo...');
      visualizarConteudo(conteudoExistente.data, meta);
      return;
    }

    console.log('üìù Conte√∫do n√£o existe, gerando novo...');

    // Mostrar loading
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-conteudo';
    loadingDiv.innerHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="${themes[currentTheme].card} p-8 rounded-lg text-center shadow-2xl max-w-md">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p class="text-lg font-semibold text-gray-800">Gerando conte√∫do...</p>
          <p class="text-sm text-gray-600 mt-2">A IA est√° criando seu material de estudo personalizado</p>
          <p class="text-xs text-gray-500 mt-3">üìö ${meta.disciplina_nome}</p>
          <p class="text-xs text-gray-500">‚è±Ô∏è ${meta.tempo_minutos} minutos | ${meta.tipo}</p>
        </div>
      </div>
    `;
    document.body.appendChild(loadingDiv);
    
    // Gerar conte√∫do
    console.log('üì° Enviando requisi√ß√£o para API /api/conteudo/gerar...');
    const response = await axios.post('/api/conteudo/gerar', {
      meta_id: meta.id,
      user_id: currentUser.id,
      disciplina_id: meta.disciplina_id,
      tipo: meta.tipo,
      tempo_minutos: meta.tempo_minutos
    });

    console.log('‚úÖ Resposta da API recebida:', response.data);
    console.log('üìö T√≥picos gerados:', response.data.topicos);
    console.log('üìù N√∫mero de se√ß√µes:', response.data.conteudo?.secoes?.length || 0);
    
    // Contar quest√µes
    const totalQuestoes = (response.data.conteudo?.secoes || [])
      .reduce((sum, s) => sum + (s.conteudo?.questoes?.length || 0), 0);
    console.log('‚ùì Total de quest√µes geradas:', totalQuestoes);

    const loadingEl = document.getElementById('loading-conteudo');
    if (loadingEl) document.body.removeChild(loadingEl);
    
    console.log('üíª Chamando visualizarConteudo...');
    
    // TENTAR com try/catch dentro do visualizarConteudo
    try {
      visualizarConteudo(response.data, meta);
      console.log('‚úÖ visualizarConteudo executado sem erros aparentes');
    } catch (vizError) {
      console.error('‚ùå ERRO DENTRO DE visualizarConteudo:', vizError);
      console.error('Stack trace:', vizError.stack);
      alert('‚ùå Erro ao exibir conte√∫do:\n\n' + vizError.message + '\n\nVeja o console para detalhes.');
      renderDashboard();
    }
  } catch (error) {
    console.error('‚ùå Erro ao gerar conte√∫do:', error);
    console.error('Detalhes do erro:', error.response?.data);
    const loadingEl = document.getElementById('loading-conteudo');
    if (loadingEl) document.body.removeChild(loadingEl);
    alert('‚ùå Erro ao gerar conte√∫do de estudo:\n\n' + (error.response?.data?.error || error.message) + '\n\nAbra o console (F12) para mais detalhes.');
  }
}

// Fun√ß√£o para desmarcar conclus√£o de meta
async function desmarcarConclusao(metaId) {
  if (!confirm('Deseja realmente desmarcar esta meta como conclu√≠da?')) {
    return;
  }
  
  try {
    await axios.put(`/api/metas/${metaId}`, {
      concluida: false,
      tempo_estudado: 0
    });
    
    alert('‚úÖ Meta desmarcada com sucesso!');
    renderDashboard();
  } catch (error) {
    console.error('Erro ao desmarcar meta:', error);
    alert('‚ùå Erro ao desmarcar meta');
  }
}

// Fun√ß√£o para regerar conte√∫do
async function regenerarConteudo(metaId) {
  if (!confirm('Deseja realmente regerar o material de estudo? O conte√∫do atual ser√° substitu√≠do.')) {
    return;
  }
  
  try {
    const metasHoje = await axios.get(`/api/metas/hoje/${currentUser.id}`);
    const meta = metasHoje.data.find(m => m.id === metaId);
    
    if (!meta) {
      alert('Meta n√£o encontrada');
      return;
    }
    
    await gerarConteudoMeta(meta, true); // for√ßa regenera√ß√£o
  } catch (error) {
    console.error('Erro ao regerar conte√∫do:', error);
    alert('‚ùå Erro ao regerar conte√∫do');
  }
}

// Verificar se conte√∫do j√° foi gerado e atualizar bot√£o
async function verificarConteudoGerado(metaId) {
  try {
    const response = await axios.get(`/api/conteudos/${metaId}`).catch(() => null);
    
    if (response?.data) {
      // Conte√∫do existe - mostrar √≠cone de "gerado" + bot√£o regerar
      const btn = document.getElementById(`btn-gerar-${metaId}`);
      if (btn) {
        btn.outerHTML = `
          <div class="flex items-center gap-2">
            <button onclick="gerarConteudoMetaPorId(${metaId})" 
              class="bg-blue-700 text-white px-3 py-2 rounded-lg hover:bg-blue-800 transition text-sm flex items-center gap-2">
              <i class="fas fa-check-circle"></i>
              <span>Ver Material</span>
            </button>
            <button onclick="regenerarConteudo(${metaId})" 
              class="bg-amber-500 text-white px-3 py-2 rounded-lg hover:bg-amber-600 transition text-sm" title="Regerar material">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        `;
      }
    }
  } catch (error) {
    // Conte√∫do n√£o existe, mant√©m bot√£o original
    console.log('Conte√∫do n√£o gerado para meta', metaId);
  }
}

// Gerar Simulado para uma meta espec√≠fica
async function gerarSimuladoMeta(metaId, disciplinaNome) {
  const btn = document.getElementById(`btn-simulado-${metaId}`);
  if (!btn) return;
  
  // Desabilitar bot√£o e mostrar loading
  const btnOriginal = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando Simulado...';
  
  try {
    // Buscar meta com t√≥picos
    const metasHoje = await axios.get(`/api/metas/hoje/${currentUser.id}`);
    const meta = metasHoje.data.find(m => m.id === metaId);
    
    if (!meta) {
      alert('Meta n√£o encontrada');
      return;
    }
    
    // Gerar simulado (tipo = exercicios)
    const response = await axios.post('/api/conteudo/gerar', {
      user_id: currentUser.id,
      meta_id: metaId,
      disciplina_id: meta.disciplina_id,
      tipo: 'exercicios', // SEMPRE exerc√≠cios para simulado
      tempo_minutos: meta.tempo_minutos || 30,
      topicos: meta.topicos_sugeridos?.map(t => t.nome) || []
    });
    
    if (response.data.success) {
      alert('‚úÖ Simulado gerado com sucesso!');
      // Atualizar dashboard para mostrar o simulado
      renderDashboard();
    } else {
      alert('‚ùå Erro ao gerar simulado: ' + (response.data.error || 'Erro desconhecido'));
      btn.innerHTML = btnOriginal;
      btn.disabled = false;
    }
  } catch (error) {
    console.error('Erro ao gerar simulado:', error);
    alert('‚ùå Erro ao gerar simulado: ' + (error.response?.data?.error || error.message));
    btn.innerHTML = btnOriginal;
    btn.disabled = false;
  }
}

function visualizarConteudo(conteudo, meta = null) {
  console.log('üì∫ Visualizando conte√∫do:', { 
    id: conteudo?.id, 
    tipo: conteudo?.tipo,
    disciplina_nome: conteudo?.disciplina_nome,
    temConteudo: !!conteudo?.conteudo,
    temSecoes: !!conteudo?.conteudo?.secoes,
    numSecoes: conteudo?.conteudo?.secoes?.length || 0
  });
  
  // Validar estrutura do conte√∫do
  if (!conteudo || !conteudo.conteudo) {
    console.error('‚ùå Conte√∫do inv√°lido - estrutura:', Object.keys(conteudo || {}));
    console.error('‚ùå Objeto completo:', JSON.stringify(conteudo, null, 2));
    alert('‚ùå Erro ao carregar o conte√∫do.\n\nA estrutura do material n√£o est√° completa.\nTente gerar o conte√∫do novamente.');
    renderDashboard();
    return;
  }

  const { conteudo: detalhes, topicos = [], tipo, disciplina_id, disciplina_nome } = conteudo;
  const nomeDisciplina = disciplina_nome || meta?.disciplina_nome || 'Disciplina';
  const secoesValidas = Array.isArray(detalhes?.secoes) ? detalhes.secoes : [];
  
  console.log('‚úÖ Conte√∫do v√°lido:', { se√ß√µes: secoesValidas.length, tipo, disciplina: nomeDisciplina });

  // Estado do simulado
  window.respostasSimulado = {};
  window.simuladoFinalizado = false;

  // Coletar todas as teorias em um √∫nico bloco
  const todasTeorias = secoesValidas
    .map(secao => secao.conteudo?.teoria_completa || secao.teoria_completa || '')
    .filter(t => t.length > 0)
    .join('\n\n---\n\n');
  
  // Contar quest√µes
  const totalQuestoes = secoesValidas
    .reduce((sum, s) => sum + (s.conteudo?.questoes?.length || s.questoes?.length || 0), 0);
  
  console.log('üìä Material:', { teoria: todasTeorias.length + ' caracteres', quest√µes: totalQuestoes });
  
  // Verifica√ß√£o: para tipo "exercicios", teoria √© opcional
  const isExercicios = tipo === 'exercicios';
  const isRevisao = tipo === 'revisao';
  
  if (!isExercicios && !isRevisao && todasTeorias.length === 0) {
    console.error('‚ùå ERRO: Conte√∫do tipo "teoria" deve ter teoria_completa!');
    console.log('üîç Estrutura completa do conte√∫do:', JSON.stringify(conteudo, null, 2));
    alert('‚ö†Ô∏è Erro: O material de estudo n√£o foi gerado corretamente.\n\nTente gerar novamente ou recarregue a p√°gina.');
    renderDashboard();
    return;
  }
  
  if (totalQuestoes === 0 && isExercicios) {
    console.error('‚ùå ERRO: Conte√∫do tipo "exercicios" deve ter quest√µes!');
    alert('‚ö†Ô∏è Erro: Nenhuma quest√£o foi gerada.\n\nTente gerar novamente.');
    renderDashboard();
    return;
  }
  
  if (totalQuestoes === 0) {
    console.warn('‚ö†Ô∏è ATEN√á√ÉO: Nenhuma quest√£o foi encontrada nas se√ß√µes!');
    console.log('üîç Conte√∫do das se√ß√µes:', secoesValidas.map(s => ({
      titulo: s.titulo,
      temQuestoes: !!s.conteudo?.questoes,
      numQuestoes: s.conteudo?.questoes?.length || 0,
      temTeoria: !!s.conteudo?.teoria_completa
    })));
  }

  const app = document.getElementById('app');
  
  // Manter as classes do tema no app
  app.className = themes[currentTheme].bg + ' min-h-screen transition-colors duration-300';
  
  app.innerHTML = `
    <div class="min-h-screen">
      <header class="${themes[currentTheme].card} shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <button onclick="renderDashboard()" class="${themes[currentTheme].textSecondary} hover:${themes[currentTheme].text} flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <i class="fas fa-arrow-left"></i>
            <span>Voltar</span>
          </button>
          <h1 class="text-2xl font-bold ${themes[currentTheme].text} flex items-center gap-2">
            <i class="fas fa-book-open text-blue-500"></i>
            ${nomeDisciplina}
          </h1>
          <button onclick="recriarConteudo(${conteudo.id}, ${conteudo.meta_id || 'null'})" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition shadow-md">
            <i class="fas fa-redo-alt"></i>
            <span>Recriar</span>
          </button>
        </div>
      </header>

      <div class="max-w-5xl mx-auto px-4 py-8">
        ${tipo === 'exercicios' && todasTeorias.length === 0 ? `
        <!-- ALERTA: EXERC√çCIOS SEM TEORIA -->
        <div class="bg-blue-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-6 mb-6 rounded-lg">
          <div class="flex items-start gap-3">
            <i class="fas fa-info-circle text-blue-500 text-2xl mt-1"></i>
            <div>
              <h3 class="font-bold text-yellow-800 dark:text-yellow-300 mb-2">Sess√£o de Exerc√≠cios</h3>
              <p class="text-yellow-700 dark:text-blue-400 text-sm">
                Esta √© uma sess√£o pr√°tica de <strong>resolu√ß√£o de quest√µes</strong>. 
                ${detalhes.introducao || 'Teste seus conhecimentos e identifique pontos de melhoria.'}
              </p>
            </div>
          </div>
        </div>
        ` : ''}
        
        ${todasTeorias.length > 0 ? `
        <!-- CARD √öNICO: TEORIA COMPLETA -->
        <div class="${themes[currentTheme].card} rounded-xl shadow-lg p-8 mb-6 border-l-4 border-blue-500">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold ${themes[currentTheme].text} flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                <i class="fas fa-book text-white"></i>
              </div>
              <span>Material de Estudo</span>
            </h2>
            <div class="text-sm ${themes[currentTheme].textSecondary}">
              <i class="far fa-clock mr-1"></i>
              ${meta?.tempo_minutos || 0} minutos
            </div>
          </div>
          
          <div class="teoria-content ${themes[currentTheme].text} leading-relaxed" style="text-align: justify; white-space: pre-wrap; line-height: 1.8;">
            ${todasTeorias.split('\n').map(line => {
              // Processar markdown b√°sico
              const trimmed = line.trim();
              
              if (trimmed.startsWith('## ')) {
                return `<h2 style="font-size: 1.8em; font-weight: bold; margin-top: 1.5em; margin-bottom: 0.5em; color: #2563eb;">${trimmed.substring(3)}</h2>`;
              } else if (trimmed.startsWith('### ')) {
                return `<h3 style="font-size: 1.4em; font-weight: 600; margin-top: 1em; margin-bottom: 0.5em; color: #3b82f6;">${trimmed.substring(4)}</h3>`;
              } else if (trimmed.match(/^\d+\.\s+\*\*/)) {
                // Lista numerada com negrito
                const text = trimmed.replace(/\*\*/g, '<strong>').replace(/\*\*/g, '</strong>');
                return `<p style="margin-left: 1.5em; margin-top: 0.5em;">${text}</p>`;
              } else if (trimmed.startsWith('**') && trimmed.includes(':**')) {
                // T√≠tulo em negrito
                const text = trimmed.replace(/\*\*/g, '<strong>').replace(/\*\*/g, '</strong>');
                return `<p style="margin-top: 1em; font-weight: 600;">${text}</p>`;
              } else if (trimmed.startsWith('-')) {
                return `<p style="margin-left: 1.5em; margin-top: 0.3em;">${trimmed}</p>`;
              } else if (trimmed === '---') {
                return `<hr style="margin: 2em 0; border-top: 2px solid #e5e7eb;" />`;
              } else if (trimmed) {
                return `<p style="margin-top: 0.8em;">${trimmed}</p>`;
              }
              return '';
            }).join('')}
          </div>
        </div>
        ` : ''}

        <!-- CARD DE SIMULADO -->
        ${secoesValidas.some(s => s.conteudo?.questoes && s.conteudo.questoes.length > 0) ? `
          <div id="simuladoCard" class="${themes[currentTheme].card} rounded-xl shadow-lg p-8 mb-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold ${themes[currentTheme].text} flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                  <i class="fas fa-clipboard-check text-white"></i>
                </div>
                <span>Simulado - Teste seus conhecimentos</span>
              </h2>
            </div>
            
            <div id="questoesContainer">
              ${secoesValidas.map((secao, secIdx) => {
                const questoes = secao.conteudo?.questoes || [];
                return questoes.map((q, qIdx) => `
                  <div class="questao-card bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6 border-l-4 border-gray-300">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">
                        ${qIdx + 1}
                      </div>
                      <h3 class="font-bold ${themes[currentTheme].text} text-lg">
                        Quest√£o ${qIdx + 1}
                      </h3>
                    </div>
                    <p class="${themes[currentTheme].text} mb-4 leading-relaxed whitespace-pre-line">${q.enunciado}</p>
                    
                    <div class="space-y-3">
                      ${q.alternativas.map((alt, altIdx) => `
                        <label class="flex items-start p-3 rounded-lg cursor-pointer hover:bg-opacity-10 hover:bg-blue-500 transition">
                          <input type="radio" 
                            name="questao_${secIdx}_${qIdx}" 
                            value="${altIdx}"
                            onchange="salvarResposta(${secIdx}, ${qIdx}, ${altIdx})"
                            class="mt-1 mr-3">
                          <span class="${themes[currentTheme].text}">
                            <strong>${String.fromCharCode(65 + altIdx)})</strong> ${alt.replace(/^[A-E]\)\s*/, '')}
                          </span>
                        </label>
                      `).join('')}
                    </div>
                    
                    <div id="explicacao_${secIdx}_${qIdx}" class="hidden mt-4 p-4 rounded-lg bg-blue-50">
                      <p class="text-sm text-gray-800"><strong>Gabarito:</strong> ${String.fromCharCode(65 + q.gabarito)}</p>
                      <p class="text-sm text-gray-700 mt-2">${q.explicacao}</p>
                    </div>
                  </div>
                `).join('');
              }).join('')}
            </div>
            
            <div class="flex items-center justify-between mt-6">
              <button onclick="finalizarSimulado()" 
                class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transform hover:scale-105 transition">
                <i class="fas fa-check-circle mr-2"></i>
                Finalizar e Ver Resultado
              </button>
            </div>
          </div>
          
          <!-- CARD DE RESULTADO (inicialmente oculto) -->
          <div id="resultadoCard" class="hidden ${themes[currentTheme].card} rounded-xl shadow-lg p-8 border-l-4 border-yellow-500">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                <i class="fas fa-trophy text-white text-xl"></i>
              </div>
              <h2 class="text-2xl font-bold ${themes[currentTheme].text}">
                Resultado do Simulado
              </h2>
            </div>
            <div id="resultadoConteudo"></div>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  // Fun√ß√µes do simulado
  window.salvarResposta = (secIdx, qIdx, altIdx) => {
    if (!window.respostasSimulado) window.respostasSimulado = {};
    window.respostasSimulado[`${secIdx}_${qIdx}`] = altIdx;
  };
  
  window.finalizarSimulado = () => {
    if (window.simuladoFinalizado) {
      alert('Simulado j√° finalizado!');
      return;
    }
    
    // Coletar todas as quest√µes
    const todasQuestoes = [];
    secoesValidas.forEach((secao, secIdx) => {
      const questoes = secao.conteudo?.questoes || [];
      questoes.forEach((q, qIdx) => {
        todasQuestoes.push({ secIdx, qIdx, questao: q });
      });
    });
    
    if (todasQuestoes.length === 0) return;
    
    // Calcular acertos
    let acertos = 0;
    todasQuestoes.forEach(({ secIdx, qIdx, questao }) => {
      const respostaUsuario = window.respostasSimulado[`${secIdx}_${qIdx}`];
      if (respostaUsuario === questao.gabarito) {
        acertos++;
      }
      // Mostrar explica√ß√£o
      const explicacaoDiv = document.getElementById(`explicacao_${secIdx}_${qIdx}`);
      if (explicacaoDiv) {
        explicacaoDiv.classList.remove('hidden');
        if (respostaUsuario === questao.gabarito) {
          explicacaoDiv.classList.add('bg-blue-50');
          explicacaoDiv.classList.remove('bg-blue-50');
        } else {
          explicacaoDiv.classList.add('bg-red-50');
          explicacaoDiv.classList.remove('bg-blue-50');
        }
      }
    });
    
    const total = todasQuestoes.length;
    const percentual = Math.round((acertos / total) * 100);
    const nota = (acertos / total) * 10;
    
    // Determinar emoji e mensagem
    let emoji = 'üòê';
    let mensagem = 'Continue estudando!';
    let cor = 'text-blue-600';
    
    if (percentual >= 90) {
      emoji = 'üèÜ';
      mensagem = 'Excelente! Voc√™ domina o conte√∫do!';
      cor = 'text-green-600';
    } else if (percentual >= 70) {
      emoji = 'üòä';
      mensagem = 'Muito bom! Continue assim!';
      cor = 'text-blue-600';
    } else if (percentual >= 50) {
      emoji = 'üòê';
      mensagem = 'Razo√°vel. Revise os pontos fracos.';
      cor = 'text-blue-600';
    } else {
      emoji = 'üòï';
      mensagem = 'Estude mais este conte√∫do.';
      cor = 'text-blue-600';
    }
    
    // Mostrar resultado
    const resultadoCard = document.getElementById('resultadoCard');
    const resultadoConteudo = document.getElementById('resultadoConteudo');
    
    resultadoConteudo.innerHTML = `
      <div class="text-center mb-8">
        <div class="text-8xl mb-4">${emoji}</div>
        <h3 class="text-4xl font-bold ${cor} mb-2">${percentual}%</h3>
        <p class="text-xl ${themes[currentTheme].text} mb-2">Nota: ${nota.toFixed(1)}/10</p>
        <p class="${themes[currentTheme].textSecondary}">${mensagem}</p>
      </div>
      
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-green-100 rounded-lg p-4 text-center">
          <p class="text-3xl font-bold text-green-600">${acertos}</p>
          <p class="text-sm text-gray-600">Acertos</p>
        </div>
        <div class="bg-red-100 rounded-lg p-4 text-center">
          <p class="text-3xl font-bold text-blue-600">${total - acertos}</p>
          <p class="text-sm text-gray-600">Erros</p>
        </div>
        <div class="bg-blue-100 rounded-lg p-4 text-center">
          <p class="text-3xl font-bold text-blue-600">${total}</p>
          <p class="text-sm text-gray-600">Total</p>
        </div>
      </div>
      
      <div class="bg-gray-100 rounded-lg p-4">
        <h4 class="font-bold text-gray-800 mb-2">üìä An√°lise de Desempenho</h4>
        <div class="w-full bg-gray-300 rounded-full h-4 mb-2">
          <div class="bg-gradient-to-r from-blue-600 to-blue-700 h-4 rounded-full transition-all duration-1000" style="width: ${percentual}%"></div>
        </div>
        <p class="text-sm text-gray-600">
          ${percentual >= 70 ? 
            'Voc√™ est√° preparado para quest√µes deste n√≠vel. Continue praticando para manter o desempenho!' : 
            'Recomendamos revisar a teoria acima e refazer este simulado ap√≥s o estudo.'}
        </p>
      </div>
    `;
    
    resultadoCard.classList.remove('hidden');
    resultadoCard.scrollIntoView({ behavior: 'smooth' });
    window.simuladoFinalizado = true;
  };
}

function renderSecaoConteudo(conteudo, tipo) {
  if (!conteudo) return '<p class="text-gray-500">Conte√∫do n√£o dispon√≠vel</p>';
  
  if (tipo === 'teoria') {
    const textoIntro = conteudo.texto_introducao || '';
    const pontosChave = Array.isArray(conteudo.pontos_chave) ? conteudo.pontos_chave : [];
    const desenvolvimento = Array.isArray(conteudo.desenvolvimento) ? conteudo.desenvolvimento : [];
    const exemplos = Array.isArray(conteudo.exemplos) ? conteudo.exemplos : [];
    const dicas = Array.isArray(conteudo.dicas) ? conteudo.dicas : [];
    
    return `
      <div class="space-y-6">
        ${textoIntro ? `
          <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
            <p class="text-gray-800 leading-relaxed">${textoIntro}</p>
          </div>
        ` : ''}
        
        ${pontosChave.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-blue-700">üìö Conceitos Fundamentais</h4>
            <div class="space-y-3">
              ${pontosChave.map(p => `
                <div class="${themes[currentTheme].card} p-3 rounded border-l-4 border-blue-400">
                  <p class="text-gray-800 leading-relaxed">${p}</p>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${desenvolvimento.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-gray-800">üìñ Desenvolvimento do Conte√∫do</h4>
            <div class="prose max-w-none space-y-4">
              ${desenvolvimento.map(paragrafo => `
                <p class="${themes[currentTheme].text} leading-relaxed text-justify">${paragrafo}</p>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${exemplos.length > 0 ? `
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-bold text-lg mb-3 text-green-700">üí° Exemplos Pr√°ticos</h4>
            <div class="space-y-3">
              ${exemplos.map(e => `
                <div class="${themes[currentTheme].card} p-3 rounded">
                  <p class="text-gray-800 leading-relaxed">${e}</p>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${dicas.length > 0 ? `
          <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-yellow-500">
            <h4 class="font-bold text-lg mb-3 text-yellow-700">‚ö° Dicas Importantes</h4>
            <ul class="space-y-2">
              ${dicas.map(d => `
                <li class="flex items-start">
                  <i class="fas fa-star text-blue-500 mr-2 mt-1"></i>
                  <span class="text-gray-800">${d}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
    `;
  } else if (tipo === 'exercicios') {
    const questoes = conteudo.questoes_sugeridas || '';
    const orientacao = conteudo.orientacao_resolucao || '';
    const estrategia = Array.isArray(conteudo.estrategia) ? conteudo.estrategia : [];
    const tipoQuestoes = Array.isArray(conteudo.tipo_questoes) ? conteudo.tipo_questoes : [];
    const fontes = Array.isArray(conteudo.fontes) ? conteudo.fontes : [];
    const posResolucao = conteudo.pos_resolucao || '';
    
    return `
      <div class="space-y-6">
        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-purple-500">
          <p class="font-bold text-lg text-purple-700 mb-2">${questoes}</p>
          ${orientacao ? `<p class="${themes[currentTheme].text} mt-2">${orientacao}</p>` : ''}
        </div>
        
        ${estrategia.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-blue-700">üéØ Estrat√©gia de Resolu√ß√£o</h4>
            <ol class="space-y-2">
              ${estrategia.map(e => `
                <li class="flex items-start">
                  <span class="font-semibold text-blue-600 mr-2">${e.split(':')[0]}:</span>
                  <span class="text-gray-800">${e.split(':').slice(1).join(':')}</span>
                </li>
              `).join('')}
            </ol>
          </div>
        ` : ''}
        
        ${tipoQuestoes.length > 0 ? `
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-bold text-lg mb-3 text-blue-700">üìù Tipo de Quest√µes</h4>
            <ul class="space-y-2">
              ${tipoQuestoes.map(t => `<li class="text-gray-800">${t}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${fontes.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-purple-700">üìö Fontes Recomendadas</h4>
            <ul class="space-y-2">
              ${fontes.map(f => `
                <li class="flex items-start">
                  <i class="fas fa-book text-purple-600 mr-2 mt-1"></i>
                  <span class="text-gray-800">${f}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${posResolucao ? `
          <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-green-500">
            <h4 class="font-bold text-lg mb-2 text-green-700">‚úÖ P√≥s-Resolu√ß√£o</h4>
            <p class="text-gray-800 leading-relaxed">${posResolucao}</p>
          </div>
        ` : ''}
      </div>
    `;
  } else { // revisao
    const metodo = conteudo.metodo || '';
    const introducao = conteudo.introducao_revisao || '';
    const atividades = Array.isArray(conteudo.atividades) ? conteudo.atividades : [];
    const foco = Array.isArray(conteudo.foco) ? conteudo.foco : [];
    const tecnicas = Array.isArray(conteudo.tecnicas) ? conteudo.tecnicas : [];
    const objetivo = conteudo.objetivo_revisao || '';
    
    return `
      <div class="space-y-6">
        <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500">
          <p class="font-bold text-lg text-indigo-700 mb-2">${metodo}</p>
          ${introducao ? `<p class="${themes[currentTheme].text} mt-2">${introducao}</p>` : ''}
        </div>
        
        ${atividades.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-blue-700">üìã Roteiro de Revis√£o</h4>
            <ol class="space-y-3">
              ${atividades.map(a => `
                <li class="bg-white p-3 rounded border-l-4 border-blue-400">
                  <p class="text-gray-800 leading-relaxed">${a}</p>
                </li>
              `).join('')}
            </ol>
          </div>
        ` : ''}
        
        ${foco.length > 0 ? `
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-bold text-lg mb-3 text-green-700">üéØ Pontos de Foco</h4>
            <ul class="space-y-2">
              ${foco.map(f => `
                <li class="flex items-start">
                  <i class="fas fa-bullseye text-green-600 mr-2 mt-1"></i>
                  <span class="text-gray-800">${f}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${tecnicas.length > 0 ? `
          <div>
            <h4 class="font-bold text-lg mb-3 text-purple-700">üß† T√©cnicas de Memoriza√ß√£o</h4>
            <ul class="space-y-2">
              ${tecnicas.map(t => `
                <li class="text-gray-800">${t}</li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${objetivo ? `
          <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-yellow-500">
            <h4 class="font-bold text-lg mb-2 text-yellow-700">üèÜ Objetivo Final</h4>
            <p class="text-gray-800 leading-relaxed">${objetivo}</p>
          </div>
        ` : ''}
      </div>
    `;
  }
}

// ==========================
// GEST√ÉO DE PLANOS
// ==========================

async function carregarPlanos() {
  try {
    const response = await axios.get(`/api/planos/list/${currentUser.id}`);
    const planos = response.data;
    
    const planosList = document.getElementById('planos-list');
    if (!planosList) return;
    
    if (planos.length === 0) {
      planosList.innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-inbox text-6xl ${themes[currentTheme].textSecondary} mb-4"></i>
          <p class="${themes[currentTheme].textSecondary}">Nenhum plano encontrado</p>
          <p class="${themes[currentTheme].textSecondary} text-sm mt-2">Clique em "Novo Plano" para come√ßar</p>
        </div>
      `;
      return;
    }
    
    planosList.innerHTML = planos.map(plano => `
      <div class="${plano.ativo ? 'bg-gradient-to-r from-blue-50 to-blue-100 border-blue-600' : themes[currentTheme].card + ' ${themes[currentTheme].border}'} border-2 rounded-lg p-4 transition hover:shadow-md">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              ${plano.ativo ? '<span class="bg-blue-700 text-white text-xs px-2 py-1 rounded-full font-semibold">ATIVO</span>' : ''}
              <h3 class="font-bold ${themes[currentTheme].text} text-lg" id="plano-nome-${plano.id}">
                ${plano.nome || 'Sem nome'}
              </h3>
              <button onclick="editarNomePlano(${plano.id}, '${(plano.nome || '').replace(/'/g, "\\'")}')" 
                class="${themes[currentTheme].textSecondary} hover:text-blue-500 text-sm">
                <i class="fas fa-edit"></i>
              </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm ${themes[currentTheme].textSecondary}">
              <div>
                <i class="fas fa-book mr-1"></i>
                <span>${plano.total_disciplinas} disciplinas</span>
              </div>
              <div>
                <i class="fas fa-bullseye mr-1"></i>
                <span>${plano.total_metas} metas</span>
              </div>
              <div>
                <i class="fas fa-check-circle mr-1 text-blue-500"></i>
                <span>${plano.metas_concluidas} conclu√≠das</span>
              </div>
              <div>
                <i class="fas fa-calendar mr-1"></i>
                <span>${new Date(plano.created_at).toLocaleDateString('pt-BR')}</span>
              </div>
            </div>
            <p class="${themes[currentTheme].textSecondary} text-sm mt-2">
              ${plano.concurso_nome || 'Concurso n√£o especificado'}
            </p>
          </div>
          <div class="flex flex-col gap-2 ml-4">
            ${!plano.ativo ? `
              <button onclick="ativarPlano(${plano.id})" 
                class="bg-blue-700 text-white px-3 py-1 rounded text-sm hover:bg-blue-800 transition whitespace-nowrap">
                <i class="fas fa-check mr-1"></i>Ativar
              </button>
            ` : ''}
            <button onclick="excluirPlano(${plano.id}, '${(plano.nome || 'este plano').replace(/'/g, "\\'")}')" 
              class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition whitespace-nowrap">
              <i class="fas fa-trash mr-1"></i>Excluir
            </button>
          </div>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Erro ao carregar planos:', error);
    const planosList = document.getElementById('planos-list');
    if (planosList) {
      planosList.innerHTML = `
        <div class="text-center py-4">
          <p class="text-blue-500">Erro ao carregar planos</p>
        </div>
      `;
    }
  }
}

async function editarNomePlano(planoId, nomeAtual) {
  const novoNome = prompt('Digite o novo nome do plano:', nomeAtual);
  if (!novoNome || novoNome === nomeAtual) return;
  
  try {
    await axios.put(`/api/planos/${planoId}/nome`, { nome: novoNome });
    alert('‚úÖ Plano renomeado com sucesso!');
    await carregarPlanos();
  } catch (error) {
    console.error('Erro ao renomear plano:', error);
    alert('‚ùå Erro ao renomear plano: ' + (error.response?.data?.error || error.message));
  }
}

async function ativarPlano(planoId) {
  if (!confirm('Deseja ativar este plano? O plano ativo anterior ser√° desativado.')) return;
  
  try {
    await axios.post(`/api/planos/${planoId}/ativar`);
    alert('‚úÖ Plano ativado com sucesso!');
    await carregarPlanos();
    await renderDashboard(); // Recarregar dashboard com novo plano ativo
  } catch (error) {
    console.error('Erro ao ativar plano:', error);
    alert('‚ùå Erro ao ativar plano: ' + (error.response?.data?.error || error.message));
  }
}

async function excluirPlano(planoId, nomePlano) {
  // Mostrar modal de confirma√ß√£o
  mostrarModalConfirmarExclusao(planoId, nomePlano);
}

async function confirmarExclusaoPlano(planoId, nomePlano) {
  try {
    // Tentar excluir primeiro (sem force)
    await axios.delete(`/api/planos/${planoId}`);
    
    // Fechar modal
    const modal = document.getElementById('modalConfirmarExclusao');
    if (modal) modal.remove();
    
    showSuccess('‚úÖ Plano exclu√≠do com sucesso!');
    await carregarPlanos();
    await renderDashboard(); // Recarregar dashboard
  } catch (error) {
    console.error('Erro ao excluir plano:', error);
    
    // Fechar modal de confirma√ß√£o
    const modal = document.getElementById('modalConfirmarExclusao');
    if (modal) modal.remove();
    
    // Se for o √∫ltimo plano, mostrar modal especial
    if (error.response?.data?.code === 'ULTIMO_PLANO') {
      mostrarModalUltimoPlano(planoId, nomePlano);
    } else {
      showError('Erro ao excluir plano: ' + (error.response?.data?.error || error.message));
    }
  }
}

function mostrarModalConfirmarExclusao(planoId, nomePlano) {
  const modal = document.createElement('div');
  modal.id = 'modalConfirmarExclusao';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  modal.innerHTML = `
    <div class="${themes[currentTheme].card} rounded-lg shadow-2xl max-w-md w-full p-6">
      <div class="text-center mb-6">
        <div class="mx-auto w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center mb-4">
          <i class="fas fa-exclamation-triangle text-4xl text-white"></i>
        </div>
        <h2 class="text-2xl font-bold ${themes[currentTheme].text} mb-2">
          Confirmar Exclus√£o
        </h2>
        <p class="${themes[currentTheme].textSecondary} mb-4">
          Voc√™ est√° prestes a excluir o plano:
        </p>
        <p class="text-lg font-bold ${themes[currentTheme].text} mb-4 px-4 py-2 bg-red-50 dark:bg-red-900/20 rounded-lg">
          "${nomePlano}"
        </p>
        <p class="${themes[currentTheme].textSecondary} text-sm mb-4">
          <i class="fas fa-warning mr-1"></i>
          Esta a√ß√£o n√£o pode ser desfeita! Todas as metas e conte√∫dos associados ser√£o perdidos.
        </p>
      </div>
      
      <div class="mb-6">
        <label class="block text-sm font-medium ${themes[currentTheme].text} mb-2">
          Digite o nome do plano para confirmar:
        </label>
        <input 
          type="text" 
          id="inputConfirmacaoNome"
          placeholder="Digite: ${nomePlano}"
          class="w-full px-4 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-red-500 border-2 border-gray-300 dark:border-gray-600"
          autocomplete="off">
        <p class="text-xs ${themes[currentTheme].textSecondary} mt-1">
          Digite exatamente: <strong>"${nomePlano}"</strong>
        </p>
      </div>
      
      <div class="flex gap-3">
        <button 
          onclick="document.getElementById('modalConfirmarExclusao').remove()"
          class="flex-1 px-4 py-2 border-2 ${themes[currentTheme].border} rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 ${themes[currentTheme].text} font-semibold transition">
          Cancelar
        </button>
        <button 
          id="btnConfirmarExclusao"
          disabled
          class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold transition">
          Excluir Plano
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Focar no input
  const input = document.getElementById('inputConfirmacaoNome');
  const btn = document.getElementById('btnConfirmarExclusao');
  
  input.focus();
  
  // Validar nome em tempo real
  input.addEventListener('input', (e) => {
    if (e.target.value === nomePlano) {
      btn.disabled = false;
      btn.classList.remove('bg-gray-400');
      btn.classList.add('bg-red-600');
    } else {
      btn.disabled = true;
      btn.classList.add('bg-gray-400');
      btn.classList.remove('bg-red-600');
    }
  });
  
  // Confirmar ao clicar no bot√£o
  btn.addEventListener('click', () => {
    if (input.value === nomePlano) {
      confirmarExclusaoPlano(planoId, nomePlano);
    }
  });
  
  // Confirmar com Enter
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && input.value === nomePlano) {
      confirmarExclusaoPlano(planoId, nomePlano);
    }
  });
}

function mostrarModalUltimoPlano(planoId, nomePlano) {
  const modal = document.createElement('div');
  modal.id = 'modalUltimoPlano';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  modal.innerHTML = `
    <div class="${themes[currentTheme].card} rounded-lg shadow-2xl max-w-lg w-full p-6">
      <div class="text-center mb-6">
        <div class="mx-auto w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center mb-4">
          <i class="fas fa-sync-alt text-4xl text-white"></i>
        </div>
        <h2 class="text-2xl font-bold ${themes[currentTheme].text} mb-2">
          Deseja recome√ßar seu plano?
        </h2>
        <p class="${themes[currentTheme].textSecondary} text-lg mb-1">
          Plano atual: "${nomePlano}"
        </p>
        <p class="${themes[currentTheme].textSecondary} text-sm">
          <i class="fas fa-info-circle mr-1"></i>Este √© seu √∫nico plano de estudos
        </p>
      </div>
      
      <div class="${currentTheme === 'light' ? 'bg-blue-50 border-blue-200' : 'bg-blue-900/20 border-blue-700'} border-2 rounded-lg p-4 mb-6">
        <p class="${themes[currentTheme].text} font-semibold mb-3">
          <i class="fas fa-check-circle mr-2 text-blue-600"></i>
          O que vai acontecer:
        </p>
        <ul class="${themes[currentTheme].text} space-y-2 text-sm">
          <li class="flex items-start">
            <span class="text-blue-600 mr-2">1Ô∏è‚É£</span>
            <span>Seu plano atual ser√° <strong>deletado</strong> (ciclos, metas e hist√≥rico)</span>
          </li>
          <li class="flex items-start">
            <span class="text-blue-600 mr-2">2Ô∏è‚É£</span>
            <span>Voc√™ ser√° <strong>redirecionado para criar um novo plano</strong></span>
          </li>
          <li class="flex items-start">
            <span class="text-blue-600 mr-2">3Ô∏è‚É£</span>
            <span>Uma <strong>nova entrevista</strong> ser√° iniciada para definir suas disciplinas e metas</span>
          </li>
        </ul>
      </div>
      
      <div class="${currentTheme === 'light' ? 'bg-blue-50 border-green-200' : 'bg-green-900/20 border-green-700'} border-2 rounded-lg p-3 mb-6">
        <p class="${themes[currentTheme].text} text-sm">
          <i class="fas fa-lightbulb mr-2 text-green-600"></i>
          <strong>Dica:</strong> Isso √© √∫til quando voc√™ mudou de concurso ou quer reorganizar completamente seus estudos.
        </p>
      </div>
      
      <div class="flex flex-col gap-3">
        <button 
          onclick="confirmarExclusaoUltimoPlano(${planoId})" 
          class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg font-bold transition shadow-lg transform hover:scale-105">
          <i class="fas fa-sync-alt mr-2"></i>
          Sim, Deletar e Criar Novo Plano
        </button>
        <button 
          onclick="fecharModalUltimoPlano()" 
          class="w-full px-4 py-3 rounded-lg font-semibold transition ${currentTheme === 'light' ? 'bg-gray-200 hover:bg-gray-300 text-gray-700' : 'bg-gray-700 hover:bg-gray-600 text-gray-200'}">
          <i class="fas fa-times mr-2"></i>
          N√£o, Manter Plano Atual
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function fecharModalUltimoPlano() {
  const modal = document.getElementById('modalUltimoPlano');
  if (modal) {
    modal.remove();
  }
}

async function confirmarExclusaoUltimoPlano(planoId) {
  fecharModalUltimoPlano();
  
  // Mostrar loading
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen ${themes[currentTheme].bg} flex items-center justify-center">
      <div class="text-center">
        <i class="fas fa-spinner fa-spin text-6xl ${themes[currentTheme].text} mb-4"></i>
        <p class="${themes[currentTheme].text} text-xl mb-2">Deletando plano atual...</p>
        <p class="${themes[currentTheme].textSecondary}">Preparando nova entrevista...</p>
      </div>
    </div>
  `;
  
  try {
    // Excluir com force=true
    await axios.delete(`/api/planos/${planoId}?force=true`);
    
    console.log('‚úÖ Plano deletado, iniciando nova entrevista...');
    
    // Aguardar 500ms para dar feedback visual
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Redirecionar para criar novo plano (iniciar entrevista)
    iniciarEntrevista();
  } catch (error) {
    console.error('Erro ao excluir √∫ltimo plano:', error);
    alert('‚ùå Erro ao excluir plano: ' + (error.response?.data?.error || error.message));
    renderDashboard(); // Voltar ao dashboard em caso de erro
  }
}

// ==========================
// VISUALIZA√á√ÉO E DOWNLOAD DE CONTE√öDO
// ==========================

async function baixarConteudo(conteudoId, disciplinaNome, tipo) {
  try {
    const response = await axios.get(`/api/conteudos/${conteudoId}?format=txt`, {
      responseType: 'blob'
    });
    
    // Criar nome do arquivo
    const dataAtual = new Date().toISOString().split('T')[0];
    const nomeArquivo = `${disciplinaNome}_${tipo}_${dataAtual}.txt`;
    
    // Criar link de download
    const url = window.URL.createObjectURL(new Blob([response.data], { type: 'text/plain; charset=utf-8' }));
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', nomeArquivo);
    document.body.appendChild(link);
    link.click();
    link.remove();
    window.URL.revokeObjectURL(url);
    
    alert('‚úÖ Conte√∫do baixado como TXT com sucesso!');
  } catch (error) {
    console.error('Erro ao baixar conte√∫do:', error);
    alert('‚ùå Erro ao baixar conte√∫do: ' + (error.response?.data?.error || error.message));
  }
}

// Toggle User Menu Dropdown
function toggleUserMenu() {
  const menu = document.getElementById('userMenu');
  if (menu) {
    menu.classList.toggle('hidden');
  }
}

// Fechar menu ao clicar fora
document.addEventListener('click', function(event) {
  const menu = document.getElementById('userMenu');
  const button = event.target.closest('button[onclick="toggleUserMenu()"]');
  
  if (menu && !menu.contains(event.target) && !button) {
    menu.classList.add('hidden');
  }
});

// Abrir Modal de Editar Perfil
function abrirModalEditarPerfil() {
  // Fechar menu
  document.getElementById('userMenu')?.classList.add('hidden');
  
  // Criar modal
  const modal = document.createElement('div');
  modal.id = 'modalEditarPerfil';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  modal.innerHTML = `
    <div class="${themes[currentTheme].card} rounded-lg shadow-2xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold ${themes[currentTheme].text}">
          <i class="fas fa-user-edit mr-2 text-blue-600"></i>
          Editar Perfil
        </h2>
        <button onclick="fecharModalEditarPerfil()" class="${themes[currentTheme].textSecondary} hover:${themes[currentTheme].text}">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <form id="formEditarPerfil" class="space-y-4">
        <div>
          <label class="block text-sm font-medium ${themes[currentTheme].text} mb-2">
            <i class="fas fa-user mr-2"></i>Nome Completo
          </label>
          <input 
            type="text" 
            id="editNome" 
            value="${currentUser.name || ''}" 
            class="w-full px-4 py-2 border ${themes[currentTheme].border} rounded-lg focus:ring-2 focus:ring-blue-500 ${themes[currentTheme].card} ${themes[currentTheme].text}"
            placeholder="Seu nome completo"
            required
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium ${themes[currentTheme].text} mb-2">
            <i class="fas fa-envelope mr-2"></i>Email
          </label>
          <input 
            type="email" 
            id="editEmail" 
            value="${currentUser.email}" 
            class="w-full px-4 py-2 border ${themes[currentTheme].border} rounded-lg focus:ring-2 focus:ring-blue-500 ${themes[currentTheme].card} ${themes[currentTheme].text}"
            placeholder="seu@email.com"
            required
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium ${themes[currentTheme].text} mb-2">
            <i class="fas fa-lock mr-2"></i>Nova Senha (opcional)
          </label>
          <input 
            type="password" 
            id="editSenha" 
            class="w-full px-4 py-2 border ${themes[currentTheme].border} rounded-lg focus:ring-2 focus:ring-blue-500 ${themes[currentTheme].card} ${themes[currentTheme].text}"
            placeholder="Deixe em branco para manter a senha atual"
          />
        </div>
        
        <div class="flex gap-3 mt-6">
          <button 
            type="submit" 
            class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold"
          >
            <i class="fas fa-save mr-2"></i>Salvar Altera√ß√µes
          </button>
          <button 
            type="button" 
            onclick="fecharModalEditarPerfil()" 
            class="px-6 py-3 border ${themes[currentTheme].border} rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition ${themes[currentTheme].text}"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Adicionar evento de submit
  document.getElementById('formEditarPerfil').addEventListener('submit', async (e) => {
    e.preventDefault();
    await salvarPerfilEditado();
  });
}

// Fechar Modal de Editar Perfil
function fecharModalEditarPerfil() {
  const modal = document.getElementById('modalEditarPerfil');
  if (modal) {
    modal.remove();
  }
}

// Salvar Perfil Editado
async function salvarPerfilEditado() {
  const nome = document.getElementById('editNome').value.trim();
  const email = document.getElementById('editEmail').value.trim();
  const senha = document.getElementById('editSenha').value;
  
  if (!nome || !email) {
    alert('‚ùå Nome e email s√£o obrigat√≥rios!');
    return;
  }
  
  try {
    const payload = { name: nome, email: email };
    if (senha) {
      payload.password = senha;
    }
    
    const response = await axios.put(`/api/users/${currentUser.id}`, payload);
    
    // Atualizar currentUser
    currentUser.name = nome;
    currentUser.email = email;
    
    // Salvar no localStorage
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    alert('‚úÖ Perfil atualizado com sucesso!');
    fecharModalEditarPerfil();
    
    // Recarregar dashboard para mostrar novos dados
    renderDashboard();
  } catch (error) {
    console.error('Erro ao atualizar perfil:', error);
    alert('‚ùå Erro ao atualizar perfil: ' + (error.response?.data?.error || error.message));
  }
}

// ============== CHATBOT IA ==============
let chatOpen = false;
let chatHistory = [];

function toggleChat() {
  chatOpen = !chatOpen;
  const chatContainer = document.getElementById('chatContainer');
  const chatButton = document.getElementById('chatButton');
  
  if (chatOpen) {
    chatContainer.classList.remove('hidden');
    chatButton.innerHTML = '<i class="fas fa-times text-2xl"></i>';
  } else {
    chatContainer.classList.add('hidden');
    chatButton.innerHTML = '<i class="fas fa-comments text-2xl"></i>';
  }
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Adicionar mensagem do usu√°rio
  addChatMessage('user', message);
  input.value = '';
  
  // Mostrar loading
  const loadingId = 'loading-' + Date.now();
  addChatMessage('assistant', '<i class="fas fa-spinner fa-spin"></i> Pensando...', loadingId);
  
  try {
    const response = await axios.post('/api/chat', {
      message: message,
      user_id: currentUser.id
    });
    
    // Remover loading
    document.getElementById(loadingId)?.remove();
    
    // Adicionar resposta
    addChatMessage('assistant', response.data.reply);
    
  } catch (error) {
    console.error('Erro no chat:', error);
    document.getElementById(loadingId)?.remove();
    addChatMessage('assistant', 'üòÖ Desculpe, tive um problema. Tente novamente!');
  }
}

function addChatMessage(role, content, id = null) {
  const messagesDiv = document.getElementById('chatMessages');
  const messageId = id || 'msg-' + Date.now();
  
  const isUser = role === 'user';
  const bgColor = isUser ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800';
  const alignment = isUser ? 'ml-auto' : 'mr-auto';
  
  const messageHtml = `
    <div id="${messageId}" class="mb-3 ${alignment} max-w-[80%]">
      <div class="${bgColor} rounded-lg px-4 py-2 shadow">
        <p class="text-sm whitespace-pre-wrap">${content}</p>
      </div>
    </div>
  `;
  
  messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  chatHistory.push({ role, content });
}

function renderChatButton() {
  const chatHtml = `
    <!-- Bot√£o Flutuante -->
    <button 
      id="chatButton"
      onclick="toggleChat()"
      class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full shadow-2xl hover:shadow-3xl transform hover:scale-110 transition-all duration-300 z-50 flex items-center justify-center">
      <i class="fas fa-comments text-2xl"></i>
    </button>
    
    <!-- Container do Chat -->
    <div 
      id="chatContainer"
      class="hidden fixed bottom-24 right-6 w-96 h-[500px] bg-white rounded-2xl shadow-2xl z-50 flex flex-col overflow-hidden border-2 ${themes[currentTheme].border}">
      
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
            <i class="fas fa-robot text-xl"></i>
          </div>
          <div>
            <h3 class="font-bold text-lg">Assistente IA</h3>
            <p class="text-xs text-white/80">Tire suas d√∫vidas sobre o sistema</p>
          </div>
        </div>
        <button onclick="toggleChat()" class="hover:bg-white/20 rounded-full w-8 h-8">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Mensagens -->
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
        <div class="mr-auto max-w-[80%]">
          <div class="bg-gray-100 text-gray-800 rounded-lg px-4 py-2 shadow">
            <p class="text-sm">
              üëã Ol√°! Sou o assistente do IAprova. <br><br>
              Posso te ajudar com:<br>
              ‚Ä¢ Como usar o sistema<br>
              ‚Ä¢ Suas disciplinas e planos<br>
              ‚Ä¢ Dicas de estudo<br>
              ‚Ä¢ Qualquer d√∫vida!
            </p>
          </div>
        </div>
      </div>
      
      <!-- Input -->
      <div class="p-4 bg-white border-t ${themes[currentTheme].border}">
        <div class="flex gap-2">
          <input 
            id="chatInput"
            type="text" 
            placeholder="Digite sua mensagem..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
            onkeypress="if(event.key === 'Enter') sendChatMessage()"
          />
          <button 
            onclick="sendChatMessage()"
            class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:opacity-90 transition">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Adicionar ao body se n√£o existir
  if (!document.getElementById('chatButton')) {
    document.body.insertAdjacentHTML('beforeend', chatHtml);
  }
}

// Adicionar chatbot ao carregar dashboard
const originalRenderDashboard = renderDashboard;
renderDashboard = async function() {
  await originalRenderDashboard();
  renderChatButton();
};

// ============== SISTEMA DE METAS SEMANAIS ==============

// Vari√°vel global para armazenar a semana atual
let semanaAtual = null

// Nomes dos dias da semana
const diasSemana = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'S√ÅB']
const diasSemanaCompletos = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado']

// Cores por tipo de meta
const coresTipo = {
  teoria: { bg: 'bg-blue-100 dark:bg-blue-900/30', border: 'border-blue-300 dark:border-blue-700', text: 'text-blue-700 dark:text-blue-300', icon: 'üìñ' },
  exercicios: { bg: 'bg-green-100 dark:bg-green-900/30', border: 'border-green-300 dark:border-green-700', text: 'text-green-700 dark:text-green-300', icon: '‚úèÔ∏è' },
  revisao: { bg: 'bg-purple-100 dark:bg-purple-900/30', border: 'border-purple-300 dark:border-purple-700', text: 'text-purple-700 dark:text-purple-300', icon: 'üîÑ' }
}

// 1. Gerar metas semanais
async function gerarMetasSemana() {
  if (!currentUser) return

  try {
    // Verificar se j√° existe semana ativa
    const checkSemana = await axios.get(`/api/metas/semana-ativa/${currentUser.id}`)
    if (checkSemana.data.semana && checkSemana.data.metas && checkSemana.data.metas.length > 0) {
      // Modal de confirma√ß√£o moderno
      const confirmar = await mostrarModalConfirmacao(
        'Aten√ß√£o: J√° existe uma semana ativa!',
        `Voc√™ j√° tem ${checkSemana.data.metas.length} metas geradas para esta semana. Gerar novas metas pode afetar seu hist√≥rico de acompanhamento. Deseja continuar?`,
        'Gerar Nova Semana',
        'Cancelar'
      )
      if (!confirmar) return
    }

    showLoading('Gerando metas da semana...')

    // Buscar plano ativo
    const responsePlano = await axios.get(`/api/planos/ativo/${currentUser.id}`)
    if (!responsePlano.data) {
      alert('Voc√™ precisa ter um plano de estudos ativo para gerar metas semanais.')
      return
    }

    const plano = responsePlano.data

    // Calcular pr√≥xima segunda-feira
    const hoje = new Date()
    const diaSemana = hoje.getDay() // 0=Dom, 1=Seg, ...
    const diasAteSegunda = diaSemana === 0 ? 1 : (diaSemana === 1 ? 0 : 8 - diaSemana)
    
    const proximaSegunda = new Date(hoje)
    proximaSegunda.setDate(hoje.getDate() + diasAteSegunda)
    const dataInicio = proximaSegunda.toISOString().split('T')[0]

    // Gerar metas
    const response = await axios.post(`/api/metas/gerar-semana/${currentUser.id}`, {
      plano_id: plano.id,
      data_inicio: dataInicio
    })

    console.log('‚úÖ Metas semanais geradas:', response.data)
    
    // Sincronizar metas do dia atual
    await sincronizarMetasDia()
    
    hideLoading()
    showSuccess('Metas da semana geradas com sucesso!')
    
    // Recarregar dashboard
    await carregarSemanaAtiva()
    await renderDashboard() // Recarregar para mostrar metas di√°rias

  } catch (error) {
    console.error('Erro ao gerar metas semanais:', error)
    hideLoading()
    showError('Erro ao gerar metas da semana. Tente novamente.')
  }
}

// 2. Carregar semana ativa
async function carregarSemanaAtiva() {
  console.log('üîÑ [DEBUG] carregarSemanaAtiva() iniciou')
  
  if (!currentUser) {
    console.log('‚ùå [DEBUG] currentUser n√£o existe!')
    return
  }
  
  console.log('‚úÖ [DEBUG] currentUser:', currentUser)

  try {
    console.log(`üåê [DEBUG] Fazendo GET /api/metas/semana-ativa/${currentUser.id}`)
    const response = await axios.get(`/api/metas/semana-ativa/${currentUser.id}`)
    semanaAtual = response.data

    console.log('üìÖ [DEBUG] Response.data recebido:', response.data)
    console.log('üìÖ [DEBUG] semanaAtual atribu√≠do:', semanaAtual)
    console.log('üìÖ [DEBUG] semanaAtual.semana:', semanaAtual?.semana)
    console.log('üìÖ [DEBUG] semanaAtual.metas length:', semanaAtual?.metas?.length)

    // Renderizar calend√°rio semanal
    console.log('üé® [DEBUG] Chamando renderCalendarioSemanal()...')
    renderCalendarioSemanal()

  } catch (error) {
    console.error('‚ùå [DEBUG] Erro ao carregar semana ativa:', error)
  }
}

// 2b. Sincronizar metas semanais ‚Üí di√°rias (hoje)
async function sincronizarMetasDia() {
  if (!currentUser) return

  try {
    console.log('üîÑ Sincronizando metas do dia...')
    const response = await axios.post(`/api/metas/sincronizar-dia/${currentUser.id}`)
    
    if (response.data.criadas > 0) {
      console.log(`‚úÖ ${response.data.criadas} metas di√°rias criadas`)
    } else {
      console.log('‚ÑπÔ∏è  Metas di√°rias j√° existem para hoje')
    }
  } catch (error) {
    console.error('‚ùå Erro ao sincronizar metas:', error)
  }
}

// 3. Renderizar calend√°rio semanal
function renderCalendarioSemanal() {
  console.log('üé® [DEBUG] renderCalendarioSemanal() iniciou')
  console.log('üé® [DEBUG] semanaAtual:', semanaAtual)
  
  const container = document.getElementById('calendario-semanal')
  if (!container) {
    console.log('‚ùå [DEBUG] Container calendario-semanal N√ÉO encontrado!')
    return
  }
  console.log('‚úÖ [DEBUG] Container encontrado')

  if (!semanaAtual || !semanaAtual.semana) {
    console.log('‚ö†Ô∏è [DEBUG] Sem semana ativa, mostrando bot√£o de gerar')
    container.innerHTML = `
      <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-8 text-center">
        <i class="fas fa-calendar-week text-6xl ${themes[currentTheme].textSecondary} mb-4"></i>
        <h3 class="text-xl font-bold ${themes[currentTheme].text} mb-2">Nenhuma semana ativa</h3>
        <p class="${themes[currentTheme].textSecondary} mb-4">Gere suas metas semanais para come√ßar a estudar</p>
        <button onclick="gerarMetasSemana()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
          <i class="fas fa-calendar-plus mr-2"></i>Gerar Metas da Semana
        </button>
      </div>
    `
    return
  }

  const { semana, metas } = semanaAtual
  console.log('‚úÖ [DEBUG] Semana ativa encontrada:', semana)
  console.log('‚úÖ [DEBUG] Metas encontradas:', metas ? metas.length : 0)

  // Agrupar metas por disciplina e dia
  const estruturaPlanilha = {}
  
  metas.forEach(meta => {
    if (!estruturaPlanilha[meta.disciplina_nome]) {
      estruturaPlanilha[meta.disciplina_nome] = {
        disciplina_id: meta.disciplina_id,
        dias: {}
      }
    }
    
    if (!estruturaPlanilha[meta.disciplina_nome].dias[meta.dia_semana]) {
      estruturaPlanilha[meta.disciplina_nome].dias[meta.dia_semana] = []
    }
    
    estruturaPlanilha[meta.disciplina_nome].dias[meta.dia_semana].push(meta)
  })

  const disciplinasOrdenadas = Object.keys(estruturaPlanilha).sort()
  
  // ‚úÖ LOG DEBUG: Mostrar disciplinas exibidas no cronograma
  console.log(`üìä CRONOGRAMA - Disciplinas exibidas (${disciplinasOrdenadas.length}):`, disciplinasOrdenadas.join(', '))
  console.log(`üìä CRONOGRAMA - Total de metas:`, metas.length)
  
  const dataInicioFormatada = new Date(semana.data_inicio).toLocaleDateString('pt-BR')
  const dataFimFormatada = new Date(semana.data_fim).toLocaleDateString('pt-BR')
  const diasSemanaAbrev = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom']

  container.innerHTML = `
    <div class="bg-white rounded-lg shadow-md p-2 mb-2">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div>
          <h2 class="text-base font-bold ${themes[currentTheme].text}">
            üìÖ Semana ${semana.numero_semana} ‚Ä¢ ${dataInicioFormatada} a ${dataFimFormatada}
          </h2>
          <p class="${themes[currentTheme].textSecondary} text-xs mt-0.5">
            ${semana.metas_concluidas} de ${semana.metas_totais} metas conclu√≠das
          </p>
        </div>
      </div>
      <div class="mt-1.5">
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
          <div class="bg-blue-600 h-1.5 rounded-full transition-all" 
               style="width: ${semana.metas_totais > 0 ? (semana.metas_concluidas / semana.metas_totais * 100) : 0}%">
          </div>
        </div>
      </div>
    </div>

    <!-- Legenda ACIMA do calend√°rio -->
    <div class="${themes[currentTheme].card} rounded-lg shadow-lg p-4 mb-4">
      <h3 class="font-semibold ${themes[currentTheme].text} mb-3 text-sm">üìñ Legenda:</h3>
      <div class="flex flex-wrap gap-4 text-sm">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-gray-300"></span>
          <span class="${themes[currentTheme].textSecondary}">Pendente</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="${themes[currentTheme].textSecondary}">Conclu√≠da</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-blue-500"></span>
          <span class="${themes[currentTheme].textSecondary}">Com Conte√∫do</span>
        </div>
        <div class="flex items-center gap-2">
          <span>üìñ</span>
          <span class="${themes[currentTheme].textSecondary}">Teoria</span>
        </div>
        <div class="flex items-center gap-2">
          <span>üìù</span>
          <span class="${themes[currentTheme].textSecondary}">Exerc√≠cios</span>
        </div>
        <div class="flex items-center gap-2">
          <span>üéØ</span>
          <span class="${themes[currentTheme].textSecondary}">Revis√£o</span>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
      <div class="hidden md:block overflow-x-auto">
        <table class="w-full border-collapse bg-white">
          <thead>
            <tr class="bg-blue-600 text-white">
              <th class="p-2 text-left font-semibold border-r border-blue-500 sticky left-0 bg-blue-600 z-10 text-sm" style="min-width: 150px;">
                Disciplina
              </th>
              ${diasSemanaAbrev.map(dia => `
                <th class="p-2 text-center font-semibold border-r border-blue-500 last:border-r-0 text-sm" style="min-width: 110px;">
                  ${dia}
                </th>
              `).join('')}
            </tr>
          </thead>
          <tbody>
            ${disciplinasOrdenadas.map((disciplina, discIdx) => {
              const discData = estruturaPlanilha[disciplina]
              return `
                <tr class="hover:bg-blue-50 transition">
                  <td class="p-1 font-semibold text-gray-900 border-r border-gray-300 border-b border-gray-300 sticky left-0 bg-white text-[11px]">
                    ${disciplina}
                  </td>
                  ${[1, 2, 3, 4, 5, 6, 7].map(diaSemana => {
                    const metasDoDia = discData.dias[diaSemana] || []
                    return `
                      <td class="p-0.5 border-r border-gray-300 border-b border-gray-300 last:border-r-0 align-top bg-white hover:bg-blue-50 transition">
                        ${metasDoDia.length > 0 ? metasDoDia.map(meta => renderCelulaMeta(meta)).join('') : 
                          '<div class="text-center text-gray-400 text-[10px] py-2">-</div>'
                        }
                      </td>
                    `
                  }).join('')}
                </tr>
              `
            }).join('')}
          </tbody>
        </table>
      </div>

      <div class="md:hidden divide-y ${themes[currentTheme].border}">
        ${disciplinasOrdenadas.map(disciplina => {
          const discData = estruturaPlanilha[disciplina]
          const totalMetas = Object.values(discData.dias).flat().length
          const metasConcluidas = Object.values(discData.dias).flat().filter(m => m.concluida).length
          
          return `
            <div class="p-3">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold text-sm ${themes[currentTheme].text}">${disciplina}</h4>
                <span class="text-[10px] ${themes[currentTheme].textSecondary}">${metasConcluidas}/${totalMetas}</span>
              </div>
              
              <div class="grid grid-cols-7 gap-0.5">
                ${[1, 2, 3, 4, 5, 6, 7].map(diaSemana => {
                  const metasDoDia = discData.dias[diaSemana] || []
                  return `
                    <div class="text-center">
                      <div class="text-[9px] font-semibold ${themes[currentTheme].textSecondary} mb-0.5">
                        ${diasSemanaAbrev[diaSemana - 1]}
                      </div>
                      ${metasDoDia.length > 0 ? metasDoDia.map(meta => renderCelulaMeta(meta, true)).join('') : '<div class="text-gray-300 text-[10px]">-</div>'}
                    </div>
                  `
                }).join('')}
              </div>
            </div>
          `
        }).join('')}
      </div>
    </div>


  `
}
function renderGraficosProgresso() {
  if (!semanaAtual || !semanaAtual.semana || !semanaAtual.metas) return

  const { semana, metas } = semanaAtual

  // === GR√ÅFICO 1: Progresso Di√°rio ===
  const ctxDiario = document.getElementById('chart-progresso-diario')
  if (ctxDiario) {
    // Agrupar por dia da semana
    const metasPorDia = {}
    const metasConcluidasPorDia = {}
    
    for (let i = 1; i <= 7; i++) {
      metasPorDia[i] = 0
      metasConcluidasPorDia[i] = 0
    }

    metas.forEach(meta => {
      metasPorDia[meta.dia_semana]++
      if (meta.concluida) {
        metasConcluidasPorDia[meta.dia_semana]++
      }
    })

    const labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom']
    const dataTotal = [1, 2, 3, 4, 5, 6, 7].map(dia => metasPorDia[dia])
    const dataConcluidas = [1, 2, 3, 4, 5, 6, 7].map(dia => metasConcluidasPorDia[dia])

    // Destruir gr√°fico anterior se existir
    if (window.chartProgressoDiario) {
      window.chartProgressoDiario.destroy()
    }

    window.chartProgressoDiario = new Chart(ctxDiario, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Metas Totais',
            data: dataTotal,
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2
          },
          {
            label: 'Conclu√≠das',
            data: dataConcluidas,
            backgroundColor: 'rgba(34, 197, 94, 0.6)',
            borderColor: 'rgba(34, 197, 94, 1)',
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              boxWidth: 12,
              font: { size: 10 }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              font: { size: 10 }
            }
          },
          x: {
            ticks: {
              font: { size: 10 }
            }
          }
        }
      }
    })
  }

  // === GR√ÅFICO 2: Tempo por Disciplina ===
  const ctxDisciplina = document.getElementById('chart-tempo-disciplina')
  if (ctxDisciplina) {
    // Agrupar tempo por disciplina
    const tempoPorDisciplina = {}
    
    metas.forEach(meta => {
      if (!tempoPorDisciplina[meta.disciplina_nome]) {
        tempoPorDisciplina[meta.disciplina_nome] = 0
      }
      tempoPorDisciplina[meta.disciplina_nome] += meta.tempo_minutos
    })

    // Ordenar por tempo (top 5)
    const disciplinasOrdenadas = Object.entries(tempoPorDisciplina)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)

    const labels = disciplinasOrdenadas.map(d => {
      const nome = d[0]
      return nome.length > 20 ? nome.substring(0, 17) + '...' : nome
    })
    const data = disciplinasOrdenadas.map(d => d[1])

    // Cores variadas
    const cores = [
      'rgba(59, 130, 246, 0.7)',  // Azul
      'rgba(34, 197, 94, 0.7)',   // Verde
      'rgba(168, 85, 247, 0.7)',  // Roxo
      'rgba(251, 146, 60, 0.7)',  // Laranja
      'rgba(236, 72, 153, 0.7)'   // Rosa
    ]

    // Destruir gr√°fico anterior se existir
    if (window.chartTempoDisciplina) {
      window.chartTempoDisciplina.destroy()
    }

    window.chartTempoDisciplina = new Chart(ctxDisciplina, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: cores,
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              boxWidth: 12,
              font: { size: 9 },
              padding: 8
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || ''
                const value = context.parsed || 0
                const total = context.dataset.data.reduce((a, b) => a + b, 0)
                const percent = ((value / total) * 100).toFixed(1)
                return `\${label}: \${value}min (\${percent}%)`
              }
            }
          }
        }
      }
    })
  }
}

// ===== NOVA FUN√á√ÉO: Renderizar c√©lula da tabela semanal =====
function renderCelulaMeta(meta, mobile = false) {
  // √çcones e cores por tipo
  const tipoConfig = {
    teoria: { icone: 'üìñ', cor: 'blue', label: 'Teoria' },
    exercicios: { icone: 'üìù', cor: 'purple', label: 'Exerc√≠cios' },
    revisao: { icone: 'üéØ', cor: 'orange', label: 'Revis√£o' }
  }
  
  const config = tipoConfig[meta.tipo] || tipoConfig.teoria
  
  // Estados visuais - CORES HARMONIZADAS tema claro
  const estadoVisual = meta.concluida 
    ? {
        bg: 'bg-green-50',
        border: 'border-green-400',
        text: 'text-green-800',
        badge: 'bg-green-600',
        badgeIcon: 'fa-check-circle'
      }
    : meta.conteudo_gerado 
    ? {
        bg: 'bg-blue-50',
        border: 'border-blue-400',
        text: 'text-blue-800',
        badge: 'bg-blue-600',
        badgeIcon: 'fa-file-check'
      }
    : {
        bg: 'bg-white',
        border: 'border-blue-300',
        text: 'text-blue-800',
        badge: 'bg-blue-500',
        badgeIcon: 'fa-clock'
      }
  
  const tempoFormatado = meta.tempo_minutos >= 60 
    ? `${Math.floor(meta.tempo_minutos / 60)}h${meta.tempo_minutos % 60 > 0 ? meta.tempo_minutos % 60 : ''}`
    : `${meta.tempo_minutos}min`

  // T√≥picos para tooltip (j√° vem como array da API)
  let topicos = []
  if (meta.topicos_sugeridos) {
    // Se vier como string, parseia; se vier como array, usa direto
    topicos = typeof meta.topicos_sugeridos === 'string' 
      ? JSON.parse(meta.topicos_sugeridos) 
      : meta.topicos_sugeridos
  }
  const tituloTooltip = topicos.length > 0 
    ? `üìö ${topicos.map(t => t.nome).join(' | ')}`
    : 'Sem t√≥picos definidos'

  if (mobile) {
    // Vers√£o mobile: √≠cone compacto
    return `
      <div 
        class="relative w-8 h-8 rounded-lg ${estadoVisual.bg} ${estadoVisual.border} border flex items-center justify-center cursor-pointer active:scale-95 transition-all shadow-sm"
        onclick="abrirDetalhesMetaCelula(${meta.id})"
        title="${config.label} - ${tempoFormatado}">
        <span class="text-base">${config.icone}</span>
        ${meta.concluida || meta.conteudo_gerado ? `
          <div class="absolute -top-0.5 -right-0.5 w-3 h-3 ${estadoVisual.badge} rounded-full border border-white shadow-sm flex items-center justify-center">
            <i class="fas ${estadoVisual.badgeIcon} text-white text-[6px]"></i>
          </div>
        ` : ''}
      </div>
    `
  }

  // Vers√£o desktop: card SUPER COMPACTO com t√≥pico SEMPRE vis√≠vel
  return `
    <div 
      class="relative ${estadoVisual.bg} ${estadoVisual.border} border rounded-md p-1 hover:shadow-lg transition-all group cursor-pointer mb-0.5"
      onclick="abrirDetalhesMetaCelula(${meta.id})"
      style="min-height: 42px;">
      
      <!-- √çcone + Badge -->
      <div class="flex flex-col items-center justify-center mb-0.5">
        <span class="text-xl">${config.icone}</span>
        <span class="text-[7px] font-bold ${estadoVisual.text} mt-0.5">‚è±Ô∏è ${tempoFormatado}</span>
        ${topicos.length > 0 ? `
          <div class="absolute top-1 right-1 bg-blue-600 text-white rounded-full w-4 h-4 flex items-center justify-center shadow-sm" title="${tituloTooltip}">
            <i class="fas fa-book text-[8px]"></i>
          </div>
        ` : ''}
      </div>
      
      <!-- T√≥pico SEMPRE vis√≠vel -->
      ${topicos.length > 0 ? `
        <div class="text-[8px] ${estadoVisual.text} text-center font-medium px-0.5 leading-tight line-clamp-2" title="${tituloTooltip}">
          ${topicos.map(t => t.nome).join(', ')}
        </div>
      ` : `
        <div class="text-[8px] text-gray-400 dark:text-gray-500 text-center italic px-0.5">
          Sem t√≥pico
        </div>
      `}

      <!-- Bot√µes de a√ß√£o compactos (hover) -->
      <div class="opacity-0 group-hover:opacity-100 transition-opacity mt-1 space-y-1">
        ${!meta.concluida && !meta.conteudo_gerado ? `
          <button 
            onclick="event.stopPropagation(); gerarConteudoMetaSemanal(${meta.id})"
            class="w-full text-[10px] bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded flex items-center justify-center gap-1"
            title="Gerar conte√∫do">
            <i class="fas fa-magic text-[9px]"></i>
            <span>Gerar</span>
          </button>
        ` : ''}
        
        ${meta.conteudo_gerado && !meta.concluida ? `
          <button 
            onclick="event.stopPropagation(); visualizarConteudoPorId(${meta.conteudo_id})"
            class="w-full text-[10px] bg-emerald-600 hover:bg-emerald-700 text-white py-1 px-2 rounded flex items-center justify-center gap-1"
            title="Ver conte√∫do">
            <i class="fas fa-eye text-[9px]"></i>
            <span>Ver</span>
          </button>
        ` : ''}
        
        <button 
          onclick="event.stopPropagation(); toggleMetaSemanal(${meta.id})"
          class="w-full text-[10px] ${meta.concluida ? 'bg-amber-600 hover:bg-amber-700' : 'bg-green-600 hover:bg-green-700'} text-white py-1 px-2 rounded flex items-center justify-center gap-1">
          <i class="fas ${meta.concluida ? 'fa-undo' : 'fa-check-circle'} text-[9px]"></i>
          <span>${meta.concluida ? 'Reabrir' : 'OK'}</span>
        </button>
      </div>

      <!-- Badge de status compacto -->
      ${meta.concluida || meta.conteudo_gerado ? `
        <div class="absolute -top-1 -right-1 w-4 h-4 ${estadoVisual.badge} rounded-full border-2 border-white dark:border-gray-800 shadow-sm flex items-center justify-center">
          <i class="fas ${estadoVisual.badgeIcon} text-white text-[8px]"></i>
        </div>
      ` : ''}
    </div>
  `
}

// 4. Renderizar card individual de meta (draggable)
function renderCardMeta(meta) {
  const cores = coresTipo[meta.tipo] || coresTipo.teoria
  
  return `
    <div 
      class="${cores.bg} ${cores.border} border rounded-lg p-2 cursor-move transition hover:shadow-md"
      data-meta-id="${meta.id}"
      draggable="true"
      ondragstart="handleDragStart(event)"
      ondragend="handleDragEnd(event)">
      
      <!-- Checkbox e Disciplina -->
      <div class="flex items-start gap-2 mb-1">
        <input 
          type="checkbox" 
          ${meta.concluida ? 'checked' : ''}
          onchange="toggleMetaSemanal(${meta.id}, ${meta.tempo_minutos})"
          class="mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
          onclick="event.stopPropagation()">
        <div class="flex-1 min-w-0">
          <div class="font-semibold text-xs ${cores.text} truncate" title="${meta.disciplina_nome}">
            ${cores.icon} ${meta.disciplina_nome}
          </div>
          <div class="text-xs ${themes[currentTheme].textSecondary}">
            ${meta.tempo_minutos} min
          </div>
        </div>
      </div>

      <!-- A√ß√µes (mostrar no hover) -->
      <div class="flex gap-1 mt-2 pt-2 border-t ${cores.border} opacity-0 group-hover:opacity-100 transition">
        ${meta.conteudo_gerado ? `
          <button 
            onclick="visualizarConteudoPorId(${meta.conteudo_id}); event.stopPropagation()"
            class="flex-1 text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700"
            title="Ver conte√∫do">
            <i class="fas fa-eye"></i>
          </button>
        ` : `
          <button 
            onclick="gerarConteudoMetaSemanal(${meta.id}); event.stopPropagation()"
            class="flex-1 text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700"
            title="Gerar conte√∫do">
            <i class="fas fa-magic"></i>
          </button>
        `}
        <button 
          onclick="abrirModalEditar(${meta.id}); event.stopPropagation()"
          class="text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600"
          title="Editar">
          <i class="fas fa-edit"></i>
        </button>
        <button 
          onclick="excluirMetaSemanal(${meta.id}); event.stopPropagation()"
          class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
          title="Excluir">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `
}

// 4b. Renderizar card compacto para mobile
function renderCardMetaMobile(meta) {
  const cores = coresTipo[meta.tipo] || coresTipo.teoria
  
  return `
    <div 
      class="${cores.bg} ${cores.border} border rounded-lg p-2 transition"
      data-meta-id="${meta.id}">
      
      <!-- Header compacto -->
      <div class="flex items-center gap-2 mb-2">
        <input 
          type="checkbox" 
          ${meta.concluida ? 'checked' : ''}
          onchange="toggleMetaSemanal(${meta.id}, ${meta.tempo_minutos})"
          class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
        <div class="flex-1 min-w-0">
          <div class="font-semibold text-xs ${cores.text} truncate">
            ${cores.icon} ${meta.disciplina_nome}
          </div>
        </div>
        <div class="text-xs ${themes[currentTheme].textSecondary}">
          ${meta.tempo_minutos}m
        </div>
      </div>

      <!-- A√ß√µes sempre vis√≠veis em mobile -->
      <div class="flex gap-1">
        ${meta.conteudo_gerado ? `
          <button 
            onclick="visualizarConteudoPorId(${meta.conteudo_id})"
            class="flex-1 text-xs bg-blue-600 text-white px-2 py-1.5 rounded hover:bg-blue-700"
            title="Ver conte√∫do">
            <i class="fas fa-eye mr-1"></i>Ver
          </button>
        ` : `
          <button 
            onclick="gerarConteudoMetaSemanal(${meta.id})"
            class="flex-1 text-xs bg-green-600 text-white px-2 py-1.5 rounded hover:bg-green-700"
            title="Gerar conte√∫do">
            <i class="fas fa-magic mr-1"></i>Gerar
          </button>
        `}
        <button 
          onclick="abrirModalEditar(${meta.id})"
          class="text-xs bg-gray-500 text-white px-2 py-1.5 rounded hover:bg-gray-600">
          <i class="fas fa-edit"></i>
        </button>
        <button 
          onclick="excluirMetaSemanal(${meta.id})"
          class="text-xs bg-red-500 text-white px-2 py-1.5 rounded hover:bg-red-600">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `
}

// 5. Toggle meta semanal (concluir/desmarcar)
async function toggleMetaSemanal(metaId, tempoMinutos) {
  try {
    const meta = semanaAtual.metas.find(m => m.id === metaId)
    
    if (meta.concluida) {
      // Desmarcar
      await axios.put(`/api/metas/desmarcar/${metaId}`)
      showSuccess('Meta desmarcada')
    } else {
      // Marcar como conclu√≠da - Modal moderno
      const tempoReal = await mostrarModalTempoEstudo(meta.disciplina_nome, tempoMinutos)
      if (!tempoReal) return
      
      await axios.put(`/api/metas/concluir/${metaId}`, {
        tempo_real_minutos: parseInt(tempoReal)
      })
      showSuccess('Meta conclu√≠da! üéâ')
    }

    // Recarregar
    await carregarSemanaAtiva()

  } catch (error) {
    console.error('Erro ao toggle meta:', error)
    showError('Erro ao atualizar meta')
  }
}

// 6. Gerar conte√∫do para meta semanal
// Recriar conte√∫do (apaga o antigo e gera novo)
async function recriarConteudo(conteudoId, metaId) {
  if (!confirm('‚ö†Ô∏è Deseja recriar este conte√∫do?\n\nO material atual ser√° substitu√≠do por um novo.')) {
    return;
  }
  
  try {
    showLoading('Recriando conte√∫do...');
    
    // Buscar dados da meta
    const response = await axios.get(`/api/metas/semana-ativa/${currentUser.id}`);
    const meta = response.data.metas.find(m => m.id === metaId);
    
    if (!meta) {
      throw new Error('Meta n√£o encontrada');
    }
    
    // Deletar conte√∫do antigo
    await axios.delete(`/api/conteudos/${conteudoId}`);
    
    // Gerar novo conte√∫do
    const novoConteudo = await axios.post('/api/conteudo/gerar', {
      meta_id: metaId,
      user_id: currentUser.id,
      disciplina_id: meta.disciplina_id,
      tipo: meta.tipo,
      tempo_minutos: meta.tempo_minutos,
      topicos: meta.topicos_sugeridos || []
    });
    
    hideLoading();
    showSuccess('‚úÖ Conte√∫do recriado com sucesso!');
    
    // Recarregar o novo conte√∫do
    await visualizarConteudoPorId(novoConteudo.data.id);
    
  } catch (error) {
    console.error('Erro ao recriar conte√∫do:', error);
    hideLoading();
    showError('‚ùå Erro ao recriar conte√∫do: ' + (error.response?.data?.erro || error.message));
  }
}

async function gerarConteudoMetaSemanal(metaId) {
  try {
    showLoading('Gerando conte√∫do...')
    
    const meta = semanaAtual.metas.find(m => m.id === metaId)
    if (!meta) return

    const response = await axios.post('/api/conteudo/gerar', {
      meta_id: metaId,
      user_id: currentUser.id,
      disciplina_id: meta.disciplina_id,
      tipo: meta.tipo,
      tempo_minutos: meta.tempo_minutos,
      topicos: meta.topicos_sugeridos || []
    })

    hideLoading()
    showSuccess('Conte√∫do gerado com sucesso!')
    await carregarSemanaAtiva()

  } catch (error) {
    console.error('Erro ao gerar conte√∫do:', error)
    hideLoading()
    showError('Erro ao gerar conte√∫do')
  }
}

// 7. Excluir meta semanal
async function excluirMetaSemanal(metaId) {
  if (!confirm('Deseja realmente excluir esta meta?')) return

  try {
    await axios.delete(`/api/metas/excluir/${metaId}`)
    showSuccess('Meta exclu√≠da')
    await carregarSemanaAtiva()
  } catch (error) {
    console.error('Erro ao excluir meta:', error)
    showError('Erro ao excluir meta')
  }
}

// ============== DRAG AND DROP ==============

let metaArrastada = null

function handleDragStart(event) {
  metaArrastada = {
    id: event.target.dataset.metaId,
    diaOrigem: event.target.closest('[data-dia]').dataset.dia
  }
  event.target.style.opacity = '0.4'
  event.dataTransfer.effectAllowed = 'move'
}

function handleDragEnd(event) {
  event.target.style.opacity = '1'
}

function handleDragOver(event) {
  event.preventDefault()
  event.dataTransfer.dropEffect = 'move'
  
  const coluna = event.currentTarget
  coluna.classList.add('bg-blue-50', 'dark:bg-blue-900/20')
}

function handleDragLeave(event) {
  const coluna = event.currentTarget
  coluna.classList.remove('bg-blue-50', 'dark:bg-blue-900/20')
}

async function handleDrop(event) {
  event.preventDefault()
  
  const coluna = event.currentTarget
  coluna.classList.remove('bg-blue-50', 'dark:bg-blue-900/20')
  
  if (!metaArrastada) return
  
  const novoDia = parseInt(coluna.dataset.dia)
  const novaData = coluna.dataset.data
  const diaOrigem = parseInt(metaArrastada.diaOrigem)
  
  // Se n√£o mudou de dia, n√£o faz nada
  if (novoDia === diaOrigem) return
  
  try {
    // Remanejar meta no backend
    await axios.put(`/api/metas/remanejar/${metaArrastada.id}`, {
      novo_dia_semana: novoDia,
      nova_data: novaData,
      nova_ordem: 0
    })
    
    showSuccess(`Meta movida para ${diasSemanaCompletos[novoDia % 7]}`)
    
    // Recarregar calend√°rio
    await carregarSemanaAtiva()
    
  } catch (error) {
    console.error('Erro ao remanejar meta:', error)
    showError('Erro ao mover meta')
  }
  
  metaArrastada = null
}

// ============== MODAIS ==============

// Modal de Detalhes da Meta C√©lula
async function abrirDetalhesMetaCelula(metaId) {
  const modal = document.getElementById('modal-container')
  if (!modal) return

  // Buscar dados da meta
  const meta = semanaAtual.metas.find(m => m.id === metaId)
  if (!meta) {
    alert('Meta n√£o encontrada')
    return
  }

  const topicos = meta.topicos_sugeridos ? JSON.parse(meta.topicos_sugeridos) : []
  const tempoFormatado = meta.tempo_minutos >= 60 
    ? `${Math.floor(meta.tempo_minutos / 60)}h ${meta.tempo_minutos % 60 > 0 ? meta.tempo_minutos % 60 + 'min' : ''}`
    : `${meta.tempo_minutos} minutos`

  const iconesTipo = {
    teoria: 'üìñ Teoria',
    exercicios: 'üìù Exerc√≠cios',
    revisao: 'üéØ Revis√£o'
  }

  modal.innerHTML = `
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="fecharModal(event)">
      <div class="${themes[currentTheme].card} rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 rounded-t-lg">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold">üìã Detalhes da Meta</h3>
            <button onclick="fecharModal()" class="text-white hover:text-gray-200">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>

        <!-- Body -->
        <div class="p-6 space-y-4">
          
          <!-- Disciplina -->
          <div>
            <label class="text-sm font-semibold ${themes[currentTheme].textSecondary}">Disciplina</label>
            <div class="text-lg font-bold ${themes[currentTheme].text}">${meta.disciplina_nome}</div>
          </div>

          <!-- Tipo e Tempo -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-semibold ${themes[currentTheme].textSecondary}">Tipo</label>
              <div class="font-bold ${themes[currentTheme].text}">${iconesTipo[meta.tipo] || meta.tipo}</div>
            </div>
            <div>
              <label class="text-sm font-semibold ${themes[currentTheme].textSecondary}">Tempo</label>
              <div class="font-bold ${themes[currentTheme].text}">${tempoFormatado}</div>
            </div>
          </div>

          <!-- Data -->
          <div>
            <label class="text-sm font-semibold ${themes[currentTheme].textSecondary}">Data</label>
            <div class="font-bold ${themes[currentTheme].text}">${new Date(meta.data).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: '2-digit' })}</div>
          </div>

          <!-- T√≥picos -->
          ${topicos.length > 0 ? `
            <div>
              <label class="text-sm font-semibold ${themes[currentTheme].textSecondary} mb-2 block">T√≥picos Sugeridos</label>
              <ul class="space-y-1">
                ${topicos.map(t => `
                  <li class="flex items-start gap-2 ${themes[currentTheme].text}">
                    <i class="fas fa-book text-blue-600 mt-1"></i>
                    <span class="text-sm">${t.nome}</span>
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}

          <!-- Status -->
          <div>
            <label class="text-sm font-semibold ${themes[currentTheme].textSecondary}">Status</label>
            <div class="flex items-center gap-2 mt-1">
              ${meta.concluida ? `
                <span class="inline-flex items-center gap-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1 rounded-full text-sm font-semibold">
                  <i class="fas fa-check-circle"></i>
                  Conclu√≠da
                </span>
              ` : meta.conteudo_gerado ? `
                <span class="inline-flex items-center gap-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 px-3 py-1 rounded-full text-sm font-semibold">
                  <i class="fas fa-file-alt"></i>
                  Conte√∫do Gerado
                </span>
              ` : `
                <span class="inline-flex items-center gap-2 bg-gray-100 dark:bg-gray-800/30 text-gray-700 dark:text-gray-400 px-3 py-1 rounded-full text-sm font-semibold">
                  <i class="fas fa-clock"></i>
                  Pendente
                </span>
              `}
            </div>
          </div>

          <!-- A√ß√µes -->
          <div class="pt-4 border-t ${themes[currentTheme].border} space-y-2">
            ${!meta.concluida && !meta.conteudo_gerado ? `
              <button 
                onclick="gerarConteudoMetaSemanal(${meta.id}); fecharModal()"
                class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition font-semibold flex items-center justify-center gap-2">
                <i class="fas fa-magic"></i>
                Gerar Conte√∫do com IA
              </button>
            ` : ''}
            
            ${meta.conteudo_gerado && !meta.concluida ? `
              <button 
                onclick="visualizarConteudoPorId(${meta.conteudo_id}); fecharModal()"
                class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition font-semibold flex items-center justify-center gap-2">
                <i class="fas fa-eye"></i>
                Visualizar Conte√∫do
              </button>
            ` : ''}
            
            <button 
              onclick="toggleMetaSemanal(${meta.id}); fecharModal()"
              class="w-full ${meta.concluida ? 'bg-gray-500' : 'bg-green-600'} text-white py-3 px-4 rounded-lg hover:opacity-80 transition font-semibold flex items-center justify-center gap-2">
              <i class="fas ${meta.concluida ? 'fa-undo' : 'fa-check'}"></i>
              ${meta.concluida ? 'Marcar como Pendente' : 'Marcar como Conclu√≠da'}
            </button>

            <button 
              onclick="excluirMetaSemanal(${meta.id}); fecharModal()"
              class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition font-semibold flex items-center justify-center gap-2">
              <i class="fas fa-trash"></i>
              Excluir Meta
            </button>
          </div>

        </div>
      </div>
    </div>
  `

  modal.classList.remove('hidden')
}

// Fechar Modal
function fecharModal(event) {
  if (event && event.target !== event.currentTarget) return
  const modal = document.getElementById('modal-container')
  if (modal) {
    modal.classList.add('hidden')
    modal.innerHTML = ''
  }
}

// Modal de Adicionar Meta
function abrirModalAdicionar(semanaId, diaSemana, data) {
  const modal = document.getElementById('modal-container')
  if (!modal) return

  // Buscar disciplinas do usu√°rio
  axios.get(`/api/user_disciplinas/${currentUser.id}`)
    .then(response => {
      const disciplinas = response.data

      modal.innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="fecharModal()">
          <div class="${themes[currentTheme].card} rounded-lg shadow-2xl max-w-md w-full p-6" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold ${themes[currentTheme].text} mb-4">
              ‚ûï Adicionar Meta - ${diasSemanaCompletos[diaSemana % 7]}
            </h3>

            <form onsubmit="salvarNovaMeta(event, ${semanaId}, ${diaSemana}, '${data}')">
              <!-- Disciplina -->
              <div class="mb-4">
                <label class="block ${themes[currentTheme].text} text-sm font-semibold mb-2">Disciplina</label>
                <select id="nova-disciplina" required
                        class="w-full px-3 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="">Selecione...</option>
                  ${disciplinas.map(d => `<option value="${d.disciplina_id}">${d.disciplina_nome}</option>`).join('')}
                </select>
              </div>

              <!-- Tipo -->
              <div class="mb-4">
                <label class="block ${themes[currentTheme].text} text-sm font-semibold mb-2">Tipo</label>
                <select id="novo-tipo" required
                        class="w-full px-3 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
                  <option value="teoria">üìñ Teoria</option>
                  <option value="exercicios">‚úèÔ∏è Exerc√≠cios</option>
                  <option value="revisao">üîÑ Revis√£o</option>
                </select>
              </div>

              <!-- Tempo -->
              <div class="mb-4">
                <label class="block ${themes[currentTheme].text} text-sm font-semibold mb-2">Tempo (minutos)</label>
                <input type="number" id="novo-tempo" value="60" min="15" max="240" required
                       class="w-full px-3 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
              </div>

              <!-- Bot√µes -->
              <div class="flex gap-2 mt-6">
                <button type="button" onclick="fecharModal()" 
                        class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-700 ${themes[currentTheme].text} rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition">
                  Cancelar
                </button>
                <button type="submit" 
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                  <i class="fas fa-plus mr-2"></i>Adicionar
                </button>
              </div>
            </form>
          </div>
        </div>
      `
      modal.classList.remove('hidden')
    })
    .catch(error => {
      console.error('Erro ao buscar disciplinas:', error)
      showError('Erro ao carregar disciplinas')
    })
}

async function salvarNovaMeta(event, semanaId, diaSemana, data) {
  event.preventDefault()

  const disciplinaId = document.getElementById('nova-disciplina').value
  const tipo = document.getElementById('novo-tipo').value
  const tempoMinutos = document.getElementById('novo-tempo').value

  try {
    await axios.post('/api/metas/adicionar', {
      semana_id: semanaId,
      user_id: currentUser.id,
      disciplina_id: parseInt(disciplinaId),
      dia_semana: diaSemana,
      data: data,
      tipo: tipo,
      tempo_minutos: parseInt(tempoMinutos),
      topicos_sugeridos: []
    })

    showSuccess('Meta adicionada com sucesso!')
    fecharModal()
    await carregarSemanaAtiva()

  } catch (error) {
    console.error('Erro ao adicionar meta:', error)
    showError('Erro ao adicionar meta')
  }
}

// Modal de Editar Meta
function abrirModalEditar(metaId) {
  const meta = semanaAtual.metas.find(m => m.id === metaId)
  if (!meta) return

  const modal = document.getElementById('modal-container')
  if (!modal) return

  modal.innerHTML = `
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="fecharModal()">
      <div class="${themes[currentTheme].card} rounded-lg shadow-2xl max-w-md w-full p-6" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold ${themes[currentTheme].text} mb-4">
          ‚úèÔ∏è Editar Meta
        </h3>

        <form onsubmit="salvarEdicaoMeta(event, ${metaId})">
          <!-- Disciplina (readonly) -->
          <div class="mb-4">
            <label class="block ${themes[currentTheme].text} text-sm font-semibold mb-2">Disciplina</label>
            <input type="text" value="${meta.disciplina_nome}" readonly
                   class="w-full px-3 py-2 ${themes[currentTheme].input} rounded-lg bg-gray-100 dark:bg-gray-800 cursor-not-allowed">
          </div>

          <!-- Tipo -->
          <div class="mb-4">
            <label class="block ${themes[currentTheme].text} text-sm font-semibold mb-2">Tipo</label>
            <select id="editar-tipo" required
                    class="w-full px-3 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="teoria" ${meta.tipo === 'teoria' ? 'selected' : ''}>üìñ Teoria</option>
              <option value="exercicios" ${meta.tipo === 'exercicios' ? 'selected' : ''}>‚úèÔ∏è Exerc√≠cios</option>
              <option value="revisao" ${meta.tipo === 'revisao' ? 'selected' : ''}>üîÑ Revis√£o</option>
            </select>
          </div>

          <!-- Tempo -->
          <div class="mb-4">
            <label class="block ${themes[currentTheme].text} text-sm font-semibold mb-2">Tempo (minutos)</label>
            <input type="number" id="editar-tempo" value="${meta.tempo_minutos}" min="15" max="240" required
                   class="w-full px-3 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <!-- Observa√ß√µes -->
          <div class="mb-4">
            <label class="block ${themes[currentTheme].text} text-sm font-semibold mb-2">Observa√ß√µes (opcional)</label>
            <textarea id="editar-obs" rows="2"
                      class="w-full px-3 py-2 ${themes[currentTheme].input} rounded-lg focus:ring-2 focus:ring-blue-500"
                      placeholder="Adicione notas ou lembretes...">${meta.observacoes || ''}</textarea>
          </div>

          <!-- Bot√µes -->
          <div class="flex gap-2 mt-6">
            <button type="button" onclick="fecharModal()" 
                    class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-700 ${themes[currentTheme].text} rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition">
              Cancelar
            </button>
            <button type="submit" 
                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
              <i class="fas fa-save mr-2"></i>Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
  `
  modal.classList.remove('hidden')
}

async function salvarEdicaoMeta(event, metaId) {
  event.preventDefault()

  const tipo = document.getElementById('editar-tipo').value
  const tempoMinutos = document.getElementById('editar-tempo').value
  const observacoes = document.getElementById('editar-obs').value

  try {
    await axios.put(`/api/metas/editar/${metaId}`, {
      tipo: tipo,
      tempo_minutos: parseInt(tempoMinutos),
      observacoes: observacoes
    })

    showSuccess('Meta atualizada com sucesso!')
    fecharModal()
    await carregarSemanaAtiva()

  } catch (error) {
    console.error('Erro ao editar meta:', error)
    showError('Erro ao editar meta')
  }
}

// ============== FUN√á√ïES AUXILIARES ==============

function showSuccess(message) {
  // Implementa√ß√£o simples de toast
  const toast = document.createElement('div')
  toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50'
  toast.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`
  document.body.appendChild(toast)
  setTimeout(() => toast.remove(), 3000)
}

function showError(message) {
  const toast = document.createElement('div')
  toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50'
  toast.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`
  document.body.appendChild(toast)
  setTimeout(() => toast.remove(), 3000)
}

function showLoading(message) {
  const loading = document.createElement('div')
  loading.id = 'loading-overlay'
  loading.className = 'fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center'
  loading.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-800 dark:text-gray-200">${message}</p>
    </div>
  `
  document.body.appendChild(loading)
}

function mostrarModalConfirmacao(titulo, mensagem, textoConfirmar = 'Confirmar', textoCancelar = 'Cancelar') {
  return new Promise((resolve) => {
    const modal = document.createElement('div')
    modal.className = 'fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4'
    modal.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
        <div class="text-center mb-6">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 dark:bg-yellow-900/30 mb-4">
            <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 text-2xl"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2">${titulo}</h3>
          <p class="text-gray-600 dark:text-gray-300 text-sm">${mensagem}</p>
        </div>
        <div class="flex gap-3">
          <button id="btn-cancelar" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            ${textoCancelar}
          </button>
          <button id="btn-confirmar" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
            ${textoConfirmar}
          </button>
        </div>
      </div>
    `
    document.body.appendChild(modal)
    
    document.getElementById('btn-confirmar').onclick = () => {
      modal.remove()
      resolve(true)
    }
    document.getElementById('btn-cancelar').onclick = () => {
      modal.remove()
      resolve(false)
    }
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.remove()
        resolve(false)
      }
    }
  })
}

function mostrarModalTempoEstudo(disciplina, tempoSugerido) {
  return new Promise((resolve) => {
    const modal = document.createElement('div')
    modal.className = 'fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4'
    modal.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6">
        <div class="text-center mb-6">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 dark:bg-green-900/30 mb-4">
            <i class="fas fa-clock text-green-600 dark:text-green-400 text-3xl"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2">Parab√©ns! üéâ</h3>
          <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">${disciplina}</p>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
            Quanto tempo voc√™ estudou? (minutos)
          </label>
          <input 
            type="number" 
            id="input-tempo" 
            value="${tempoSugerido}"
            min="1"
            class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white text-lg text-center font-bold"
          />
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
            Tempo sugerido: ${tempoSugerido} minutos
          </p>
        </div>
        
        <div class="flex gap-3">
          <button id="btn-cancelar-tempo" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            Cancelar
          </button>
          <button id="btn-confirmar-tempo" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
            <i class="fas fa-check mr-2"></i>Concluir
          </button>
        </div>
      </div>
    `
    document.body.appendChild(modal)
    
    const input = document.getElementById('input-tempo')
    input.focus()
    input.select()
    
    const confirmar = () => {
      const tempo = input.value
      if (tempo && tempo > 0) {
        modal.remove()
        resolve(tempo)
      }
    }
    
    document.getElementById('btn-confirmar-tempo').onclick = confirmar
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') confirmar()
    })
    
    document.getElementById('btn-cancelar-tempo').onclick = () => {
      modal.remove()
      resolve(null)
    }
    
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.remove()
        resolve(null)
      }
    }
  })
}

function hideLoading() {
  const loading = document.getElementById('loading-overlay')
  if (loading) loading.remove()
}

// Version: 1764607006
