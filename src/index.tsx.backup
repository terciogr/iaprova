import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { serveStatic } from 'hono/cloudflare-workers'
import type { Bindings } from './types'
import OpenAI from 'openai'

const app = new Hono<{ Bindings: Bindings }>()

// Middleware
app.use('/api/*', cors())
app.use('/static/*', serveStatic({ root: './public' }))

// ============== ROTAS DE USU√ÅRIOS ==============
app.post('/api/users', async (c) => {
  const { DB } = c.env
  const { name, email, password } = await c.req.json()

  try {
    // Verificar se email j√° existe
    const existingUser = await DB.prepare(
      'SELECT id FROM users WHERE email = ?'
    ).bind(email).first()

    if (existingUser) {
      return c.json({ error: 'Email j√° cadastrado' }, 400)
    }

    // Senha padr√£o se n√£o fornecida
    const userPassword = password || 'senha123'

    const result = await DB.prepare(
      'INSERT INTO users (name, email, password) VALUES (?, ?, ?)'
    ).bind(name, email, userPassword).run()

    return c.json({ 
      id: result.meta.last_row_id, 
      name, 
      email,
      message: 'Usu√°rio criado com sucesso'
    })
  } catch (error) {
    console.error('Erro ao criar usu√°rio:', error)
    return c.json({ error: 'Erro ao criar usu√°rio' }, 500)
  }
})

// Login
app.post('/api/login', async (c) => {
  const { DB } = c.env
  const { email, password } = await c.req.json()

  try {
    const user = await DB.prepare(
      'SELECT id, name, email, password FROM users WHERE email = ?'
    ).bind(email).first()

    if (!user) {
      return c.json({ error: 'Usu√°rio n√£o encontrado' }, 404)
    }

    // Verifica√ß√£o simples de senha (em produ√ß√£o, usar bcrypt)
    if (user.password !== password) {
      return c.json({ error: 'Senha incorreta' }, 401)
    }

    // Retornar usu√°rio sem a senha
    return c.json({ 
      id: user.id, 
      name: user.name, 
      email: user.email,
      message: 'Login realizado com sucesso'
    })
  } catch (error) {
    console.error('Erro ao fazer login:', error)
    return c.json({ error: 'Erro ao fazer login' }, 500)
  }
})

app.get('/api/users/:id', async (c) => {
  const { DB } = c.env
  const id = c.req.param('id')

  const user = await DB.prepare(
    'SELECT id, name, email FROM users WHERE id = ?'
  ).bind(id).first()

  if (!user) {
    return c.json({ error: 'Usu√°rio n√£o encontrado' }, 404)
  }

  return c.json(user)
})

// ============== ROTAS DE DISCIPLINAS ==============
app.get('/api/disciplinas', async (c) => {
  const { DB } = c.env
  const area = c.req.query('area')

  let query = 'SELECT * FROM disciplinas'
  if (area) {
    query += ' WHERE area = ? OR area = "geral"'
    const { results } = await DB.prepare(query).bind(area).all()
    return c.json(results)
  }

  const { results } = await DB.prepare(query).all()
  return c.json(results)
})

app.get('/api/disciplinas/:id', async (c) => {
  const { DB } = c.env
  const id = c.req.param('id')

  const disciplina = await DB.prepare(
    'SELECT * FROM disciplinas WHERE id = ?'
  ).bind(id).first()

  if (!disciplina) {
    return c.json({ error: 'Disciplina n√£o encontrada' }, 404)
  }

  return c.json(disciplina)
})

// Buscar disciplinas de um usu√°rio
app.get('/api/user-disciplinas/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  try {
    const { results } = await DB.prepare(`
      SELECT 
        ud.id,
        ud.user_id,
        ud.disciplina_id,
        ud.ja_estudou,
        ud.nivel_atual,
        ud.dificuldade,
        d.nome,
        d.area
      FROM user_disciplinas ud
      JOIN disciplinas d ON ud.disciplina_id = d.id
      WHERE ud.user_id = ?
      ORDER BY d.nome
    `).bind(user_id).all()

    return c.json(results)
  } catch (error) {
    console.error('Erro ao buscar disciplinas do usu√°rio:', error)
    return c.json({ error: 'Erro ao buscar disciplinas' }, 500)
  }
})

// Buscar t√≥picos do edital de uma disciplina
app.get('/api/topicos/:disciplina_id', async (c) => {
  const { DB } = c.env
  const disciplina_id = c.req.param('disciplina_id')

  const { results: topicos } = await DB.prepare(`
    SELECT * FROM topicos_edital
    WHERE disciplina_id = ?
    ORDER BY ordem, nome
  `).bind(disciplina_id).all()

  return c.json(topicos)
})

// Criar/atualizar t√≥picos para uma disciplina (baseado no edital/√°rea)
app.post('/api/topicos/gerar/:disciplina_id', async (c) => {
  const { DB } = c.env
  const disciplina_id = c.req.param('disciplina_id')
  const { topicos } = await c.req.json() // Array de { nome, categoria, ordem, peso }
  
  try {
    // Limpar t√≥picos existentes
    await DB.prepare('DELETE FROM topicos_edital WHERE disciplina_id = ?').bind(disciplina_id).run()
    
    // Inserir novos t√≥picos
    for (const topico of topicos) {
      await DB.prepare(`
        INSERT INTO topicos_edital (disciplina_id, nome, categoria, ordem, peso)
        VALUES (?, ?, ?, ?, ?)
      `).bind(
        disciplina_id,
        topico.nome,
        topico.categoria || 'Geral',
        topico.ordem || 0,
        topico.peso || 1
      ).run()
    }
    
    return c.json({ success: true, total: topicos.length })
  } catch (error) {
    console.error('Erro ao gerar t√≥picos:', error)
    return c.json({ error: 'Erro ao gerar t√≥picos' }, 500)
  }
})

// Popular t√≥picos para todas as disciplinas de um usu√°rio
app.post('/api/topicos/popular-usuario/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')
  
  try {
    // Buscar todas as disciplinas do usu√°rio
    const { results: disciplinas } = await DB.prepare(`
      SELECT ud.disciplina_id, d.nome
      FROM user_disciplinas ud
      JOIN disciplinas d ON ud.disciplina_id = d.id
      WHERE ud.user_id = ?
    `).bind(user_id).all()
    
    let totalPopulado = 0
    
    for (const disc of disciplinas) {
      await popularTopicosEdital(DB, disc.disciplina_id)
      
      // Verificar quantos foram inseridos
      const { results: topicos } = await DB.prepare(
        'SELECT id FROM topicos_edital WHERE disciplina_id = ?'
      ).bind(disc.disciplina_id).all()
      
      if (topicos && topicos.length > 0) {
        totalPopulado++
      }
    }
    
    return c.json({ 
      success: true, 
      disciplinas_processadas: disciplinas.length,
      disciplinas_com_topicos: totalPopulado
    })
  } catch (error) {
    console.error('Erro ao popular t√≥picos do usu√°rio:', error)
    return c.json({ error: 'Erro ao popular t√≥picos' }, 500)
  }
})

// Buscar progresso do usu√°rio nos t√≥picos de uma disciplina
app.get('/api/user-topicos/:user_id/:disciplina_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')
  const disciplina_id = c.req.param('disciplina_id')

  const { results } = await DB.prepare(`
    SELECT 
      te.*,
      COALESCE(utp.vezes_estudado, 0) as vezes_estudado,
      COALESCE(utp.nivel_dominio, 0) as nivel_dominio,
      utp.ultima_vez
    FROM topicos_edital te
    LEFT JOIN user_topicos_progresso utp ON te.id = utp.topico_id AND utp.user_id = ?
    WHERE te.disciplina_id = ?
    ORDER BY te.ordem, te.nome
  `).bind(user_id, disciplina_id).all()

  return c.json(results)
})

// Fun√ß√£o auxiliar para popular t√≥picos do edital baseado na disciplina
async function popularTopicosEdital(DB: any, disciplina_id: number) {
  try {
    // Buscar nome da disciplina
    const disciplina = await DB.prepare('SELECT nome FROM disciplinas WHERE id = ?').bind(disciplina_id).first()
    if (!disciplina) return
    
    const nomeDisciplina = disciplina.nome
    const topicos = TOPICOS_POR_DISCIPLINA[nomeDisciplina]
    
    if (!topicos || topicos.length === 0) {
      console.log(`‚ö†Ô∏è N√£o h√° t√≥picos pr√©-definidos para: ${nomeDisciplina}`)
      return
    }
    
    // Verificar se j√° existem t√≥picos para essa disciplina
    const { results: topicosExistentes } = await DB.prepare(
      'SELECT id FROM topicos_edital WHERE disciplina_id = ?'
    ).bind(disciplina_id).all()
    
    if (topicosExistentes && topicosExistentes.length > 0) {
      console.log(`‚úÖ Disciplina ${nomeDisciplina} j√° possui ${topicosExistentes.length} t√≥picos`)
      return
    }
    
    // Inserir t√≥picos
    for (const topico of topicos) {
      await DB.prepare(`
        INSERT INTO topicos_edital (disciplina_id, nome, categoria, ordem, peso)
        VALUES (?, ?, ?, ?, ?)
      `).bind(
        disciplina_id,
        topico.nome,
        topico.categoria,
        topico.ordem,
        topico.peso
      ).run()
    }
    
    console.log(`‚úÖ Inseridos ${topicos.length} t√≥picos para: ${nomeDisciplina}`)
  } catch (error) {
    console.error('‚ùå Erro ao popular t√≥picos do edital:', error)
  }
}

// Algoritmo de dist√¢ncia de Levenshtein para similaridade de strings
function levenshteinDistance(str1: string, str2: string): number {
  const len1 = str1.length
  const len2 = str2.length
  const matrix: number[][] = []

  // Inicializar matriz
  for (let i = 0; i <= len1; i++) {
    matrix[i] = [i]
  }
  for (let j = 0; j <= len2; j++) {
    matrix[0][j] = j
  }

  // Calcular dist√¢ncias
  for (let i = 1; i <= len1; i++) {
    for (let j = 1; j <= len2; j++) {
      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1
      matrix[i][j] = Math.min(
        matrix[i - 1][j] + 1,     // Dele√ß√£o
        matrix[i][j - 1] + 1,     // Inser√ß√£o
        matrix[i - 1][j - 1] + cost // Substitui√ß√£o
      )
    }
  }

  return matrix[len1][len2]
}

// Calcular similaridade entre duas strings (0 a 1, onde 1 = id√™nticas)
function calcularSimilaridade(str1: string, str2: string): number {
  const maxLen = Math.max(str1.length, str2.length)
  if (maxLen === 0) return 1.0
  
  const distance = levenshteinDistance(str1.toLowerCase(), str2.toLowerCase())
  return 1 - (distance / maxLen)
}

// ============== FUN√á√ïES DE EXPORTA√á√ÉO DE CONTE√öDO ==============

function gerarMarkdown(conteudo: any): string {
  let md = `# ${conteudo.disciplina_nome} - ${conteudo.tipo.toUpperCase()}\n\n`
  md += `**Data:** ${new Date(conteudo.created_at).toLocaleDateString('pt-BR')}\n\n`
  
  // T√≥picos
  md += `## üìö T√≥picos\n\n`
  conteudo.topicos.forEach((topico: string) => {
    md += `- ${topico}\n`
  })
  md += `\n`
  
  // Objetivos
  md += `## üéØ Objetivos\n\n`
  conteudo.objetivos.forEach((obj: string) => {
    md += `- ${obj}\n`
  })
  md += `\n`
  
  // Conte√∫do
  const cont = conteudo.conteudo
  if (cont.introducao) {
    md += `## üìñ Introdu√ß√£o\n\n${cont.introducao}\n\n`
  }
  
  if (cont.orientacoes && cont.orientacoes.length > 0) {
    md += `## üí° Orienta√ß√µes\n\n`
    cont.orientacoes.forEach((orient: string) => {
      md += `- ${orient}\n`
    })
    md += `\n`
  }
  
  // Se√ß√µes
  if (cont.secoes && cont.secoes.length > 0) {
    cont.secoes.forEach((secao: any, idx: number) => {
      md += `---\n\n`
      md += `## ${idx + 1}. ${secao.titulo}\n\n`
      
      if (secao.tempo_estimado) {
        md += `‚è±Ô∏è **Tempo estimado:** ${secao.tempo_estimado} minutos\n\n`
      }
      
      if (secao.conteudo && secao.conteudo.teoria_completa) {
        md += `${secao.conteudo.teoria_completa}\n\n`
      }
      
      // Quest√µes
      if (secao.conteudo && secao.conteudo.questoes && secao.conteudo.questoes.length > 0) {
        md += `### üìù Quest√µes\n\n`
        secao.conteudo.questoes.forEach((q: any, qIdx: number) => {
          md += `**Quest√£o ${qIdx + 1}**\n\n`
          md += `${q.enunciado}\n\n`
          
          if (q.alternativas && q.alternativas.length > 0) {
            q.alternativas.forEach((alt: string, altIdx: number) => {
              const letra = String.fromCharCode(65 + altIdx) // A, B, C, D, E
              const isCorreta = altIdx === q.gabarito
              md += `${letra}) ${alt}${isCorreta ? ' ‚úÖ' : ''}\n\n`
            })
          }
          
          if (q.explicacao) {
            md += `**Explica√ß√£o:** ${q.explicacao}\n\n`
          }
          
          md += `---\n\n`
        })
      }
    })
  }
  
  // Pr√≥ximos passos
  if (cont.proximos_passos) {
    md += `## üöÄ Pr√≥ximos Passos\n\n${cont.proximos_passos}\n\n`
  }
  
  md += `\n---\n\n`
  md += `*Gerado por IAprova - ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}*\n`
  
  return md
}

function gerarHTML(conteudo: any): string {
  return `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${conteudo.disciplina_nome} - ${conteudo.tipo}</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px; }
    h2 { color: #1e40af; margin-top: 30px; }
    h3 { color: #3b82f6; }
    .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
    .badge { 
      display: inline-block; 
      padding: 4px 12px; 
      background: #dbeafe; 
      color: #1e40af; 
      border-radius: 12px; 
      font-size: 0.85em;
      margin-right: 10px;
    }
    ul { padding-left: 20px; }
    li { margin: 8px 0; }
    .questao {
      background: #f9fafb;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #3b82f6;
      border-radius: 4px;
    }
    .alternativa { 
      padding: 10px; 
      margin: 8px 0; 
      background: white; 
      border-radius: 4px;
      border: 1px solid #e5e7eb;
    }
    .alternativa.correta { 
      background: #d1fae5; 
      border-color: #10b981;
      font-weight: 600;
    }
    .explicacao {
      background: #fef3c7;
      padding: 15px;
      margin-top: 15px;
      border-radius: 4px;
      border-left: 4px solid #f59e0b;
    }
    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
      color: #666;
      font-size: 0.85em;
    }
    @media print {
      body { background: white; }
      .container { box-shadow: none; padding: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>${conteudo.disciplina_nome} - ${conteudo.tipo.toUpperCase()}</h1>
    <div class="meta">
      <span class="badge">üìÖ ${new Date(conteudo.created_at).toLocaleDateString('pt-BR')}</span>
      <span class="badge">‚è±Ô∏è ${conteudo.tempo_minutos || 30} minutos</span>
    </div>

    <h2>üìö T√≥picos</h2>
    <ul>
      ${conteudo.topicos.map((t: string) => `<li>${t}</li>`).join('')}
    </ul>

    <h2>üéØ Objetivos</h2>
    <ul>
      ${conteudo.objetivos.map((o: string) => `<li>${o}</li>`).join('')}
    </ul>

    ${conteudo.conteudo.introducao ? `
      <h2>üìñ Introdu√ß√£o</h2>
      <p>${conteudo.conteudo.introducao}</p>
    ` : ''}

    ${conteudo.conteudo.secoes && conteudo.conteudo.secoes.length > 0 ? conteudo.conteudo.secoes.map((secao: any, idx: number) => `
      <h2>${idx + 1}. ${secao.titulo}</h2>
      ${secao.tempo_estimado ? `<p><strong>‚è±Ô∏è Tempo estimado:</strong> ${secao.tempo_estimado} minutos</p>` : ''}
      ${secao.conteudo && secao.conteudo.teoria_completa ? `<div>${secao.conteudo.teoria_completa.replace(/\n/g, '<br>')}</div>` : ''}
      
      ${secao.conteudo && secao.conteudo.questoes && secao.conteudo.questoes.length > 0 ? `
        <h3>üìù Quest√µes</h3>
        ${secao.conteudo.questoes.map((q: any, qIdx: number) => `
          <div class="questao">
            <h4>Quest√£o ${qIdx + 1}</h4>
            <p>${q.enunciado}</p>
            ${q.alternativas && q.alternativas.length > 0 ? q.alternativas.map((alt: string, altIdx: number) => {
              const letra = String.fromCharCode(65 + altIdx)
              const isCorreta = altIdx === q.gabarito
              return `<div class="alternativa ${isCorreta ? 'correta' : ''}">${letra}) ${alt}</div>`
            }).join('') : ''}
            ${q.explicacao ? `<div class="explicacao"><strong>üí° Explica√ß√£o:</strong> ${q.explicacao}</div>` : ''}
          </div>
        `).join('')}
      ` : ''}
    `).join('') : ''}

    ${conteudo.conteudo.proximos_passos ? `
      <h2>üöÄ Pr√≥ximos Passos</h2>
      <p>${conteudo.conteudo.proximos_passos}</p>
    ` : ''}

    <div class="footer">
      Gerado por IAprova em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}
    </div>
  </div>
</body>
</html>
  `
}

// Fun√ß√£o auxiliar para vincular conte√∫do gerado aos t√≥picos do edital
async function vincularConteudoTopicos(DB: any, conteudo_id: number, disciplina_id: number, topicosGerados: string[]) {
  try {
    // Buscar t√≥picos do edital para essa disciplina
    const { results: topicosEdital } = await DB.prepare(
      'SELECT id, nome FROM topicos_edital WHERE disciplina_id = ?'
    ).bind(disciplina_id).all()
    
    if (!topicosEdital || topicosEdital.length === 0) {
      console.log(`‚ö†Ô∏è Nenhum t√≥pico do edital encontrado para disciplina ${disciplina_id}`)
      return
    }
    
    // Para cada t√≥pico gerado, encontrar o melhor match no edital
    for (const topicoGerado of topicosGerados) {
      let melhorMatch = null
      let melhorSimilaridade = 0
      
      const topicoGeradoNorm = topicoGerado.toLowerCase().trim()
      
      for (const topicoEdital of topicosEdital) {
        const topicoEditalNorm = topicoEdital.nome.toLowerCase().trim()
        
        // Estrat√©gia 1: Match exato ou por inclus√£o (prioridade m√°xima)
        if (topicoGeradoNorm === topicoEditalNorm) {
          melhorMatch = topicoEdital
          melhorSimilaridade = 1.0
          break
        } else if (topicoGeradoNorm.includes(topicoEditalNorm) || 
                   topicoEditalNorm.includes(topicoGeradoNorm)) {
          const similaridade = 0.9 // Alta similaridade por inclus√£o
          if (similaridade > melhorSimilaridade) {
            melhorMatch = topicoEdital
            melhorSimilaridade = similaridade
          }
        } else {
          // Estrat√©gia 2: Similaridade por Levenshtein
          const similaridade = calcularSimilaridade(topicoGeradoNorm, topicoEditalNorm)
          if (similaridade > melhorSimilaridade) {
            melhorMatch = topicoEdital
            melhorSimilaridade = similaridade
          }
        }
      }
      
      // Vincular apenas se similaridade >= 60%
      if (melhorMatch && melhorSimilaridade >= 0.6) {
        await DB.prepare(`
          INSERT OR IGNORE INTO conteudo_topicos (conteudo_id, topico_id)
          VALUES (?, ?)
        `).bind(conteudo_id, melhorMatch.id).run()
        
        const percentual = Math.round(melhorSimilaridade * 100)
        console.log(`‚úÖ Vinculado (${percentual}%): "${topicoGerado}" ‚Üí "${melhorMatch.nome}"`)
      } else {
        console.log(`‚ö†Ô∏è Sem match suficiente para: "${topicoGerado}" (melhor: ${Math.round(melhorSimilaridade * 100)}%)`)
      }
    }
  } catch (error) {
    console.error('‚ùå Erro ao vincular conte√∫do aos t√≥picos:', error)
  }
}

// ============== BIBLIOTECA EXPANDIDA DE T√ìPICOS POR DISCIPLINA ==============
// üÜï Base completa com 82+ disciplinas e 820+ t√≥picos
const TOPICOS_POR_DISCIPLINA: Record<string, Array<{nome: string, categoria: string, ordem: number, peso: number}>> = {
  'Direito Tribut√°rio': [
    { nome: 'Sistema Tribut√°rio Nacional', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Princ√≠pios do Direito Tribut√°rio', categoria: 'Fundamentos', ordem: 2, peso: 3 },
    { nome: 'Compet√™ncia Tribut√°ria', categoria: 'Fundamentos', ordem: 3, peso: 3 },
    { nome: 'Impostos', categoria: 'Esp√©cies Tribut√°rias', ordem: 4, peso: 3 },
    { nome: 'Taxas e Contribui√ß√µes', categoria: 'Esp√©cies Tribut√°rias', ordem: 5, peso: 2 },
    { nome: 'Obriga√ß√£o Tribut√°ria', categoria: 'Rela√ß√£o Jur√≠dica', ordem: 6, peso: 3 },
    { nome: 'Cr√©dito Tribut√°rio', categoria: 'Rela√ß√£o Jur√≠dica', ordem: 7, peso: 3 },
    { nome: 'Lan√ßamento Tribut√°rio', categoria: 'Procedimentos', ordem: 8, peso: 2 },
    { nome: 'Suspens√£o e Extin√ß√£o do Cr√©dito', categoria: 'Procedimentos', ordem: 9, peso: 2 },
    { nome: 'Exclus√£o do Cr√©dito Tribut√°rio', categoria: 'Procedimentos', ordem: 10, peso: 2 }
  ],
  'Direito Constitucional': [
    { nome: 'Princ√≠pios Fundamentais da Rep√∫blica', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Direitos e Garantias Fundamentais', categoria: 'Direitos Fundamentais', ordem: 2, peso: 3 },
    { nome: 'Organiza√ß√£o do Estado', categoria: 'Organiza√ß√£o', ordem: 3, peso: 2 },
    { nome: 'Organiza√ß√£o dos Poderes', categoria: 'Organiza√ß√£o', ordem: 4, peso: 3 },
    { nome: 'Controle de Constitucionalidade', categoria: 'Controle', ordem: 5, peso: 3 },
    { nome: 'Poder Legislativo', categoria: 'Poderes', ordem: 6, peso: 2 },
    { nome: 'Poder Executivo', categoria: 'Poderes', ordem: 7, peso: 2 },
    { nome: 'Poder Judici√°rio', categoria: 'Poderes', ordem: 8, peso: 2 },
    { nome: 'Defesa do Estado e Institui√ß√µes', categoria: 'Defesa', ordem: 9, peso: 2 },
    { nome: 'Ordem Econ√¥mica e Financeira', categoria: 'Ordem Econ√¥mica', ordem: 10, peso: 2 }
  ],
  'Direito Administrativo': [
    { nome: 'Princ√≠pios da Administra√ß√£o P√∫blica', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Atos Administrativos', categoria: 'Atos', ordem: 2, peso: 3 },
    { nome: 'Poderes da Administra√ß√£o', categoria: 'Poderes', ordem: 3, peso: 2 },
    { nome: 'Organiza√ß√£o Administrativa', categoria: 'Organiza√ß√£o', ordem: 4, peso: 2 },
    { nome: 'Agentes P√∫blicos', categoria: 'Pessoal', ordem: 5, peso: 3 },
    { nome: 'Licita√ß√µes e Contratos', categoria: 'Contrata√ß√µes', ordem: 6, peso: 3 },
    { nome: 'Servi√ßos P√∫blicos', categoria: 'Servi√ßos', ordem: 7, peso: 2 },
    { nome: 'Bens P√∫blicos', categoria: 'Patrim√¥nio', ordem: 8, peso: 2 },
    { nome: 'Interven√ß√£o do Estado', categoria: 'Interven√ß√£o', ordem: 9, peso: 2 },
    { nome: 'Responsabilidade Civil do Estado', categoria: 'Responsabilidade', ordem: 10, peso: 3 }
  ],
  'Portugu√™s': [
    { nome: 'Interpreta√ß√£o de Textos', categoria: 'Compreens√£o', ordem: 1, peso: 3 },
    { nome: 'Ortografia', categoria: 'Norma Culta', ordem: 2, peso: 2 },
    { nome: 'Acentua√ß√£o Gr√°fica', categoria: 'Norma Culta', ordem: 3, peso: 2 },
    { nome: 'Concord√¢ncia Verbal e Nominal', categoria: 'Sintaxe', ordem: 4, peso: 3 },
    { nome: 'Reg√™ncia Verbal e Nominal', categoria: 'Sintaxe', ordem: 5, peso: 3 },
    { nome: 'Crase', categoria: 'Sintaxe', ordem: 6, peso: 2 },
    { nome: 'Pronomes e Coloca√ß√£o Pronominal', categoria: 'Morfologia', ordem: 7, peso: 2 },
    { nome: 'Pontua√ß√£o', categoria: 'Sintaxe', ordem: 8, peso: 2 },
    { nome: 'Sem√¢ntica e Coes√£o', categoria: 'Sentido', ordem: 9, peso: 2 },
    { nome: 'Reda√ß√£o Oficial', categoria: 'Pr√°tica', ordem: 10, peso: 2 }
  ],
  'Racioc√≠nio L√≥gico': [
    { nome: 'L√≥gica Proposicional', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Equival√™ncias L√≥gicas', categoria: 'Fundamentos', ordem: 2, peso: 3 },
    { nome: 'Diagramas L√≥gicos', categoria: 'L√≥gica de Argumenta√ß√£o', ordem: 3, peso: 2 },
    { nome: 'Sequ√™ncias e Padr√µes', categoria: 'Racioc√≠nio', ordem: 4, peso: 2 },
    { nome: 'An√°lise Combinat√≥ria', categoria: 'Contagem', ordem: 5, peso: 2 },
    { nome: 'Probabilidade', categoria: 'Contagem', ordem: 6, peso: 2 },
    { nome: 'Racioc√≠nio Quantitativo', categoria: 'Matem√°tica', ordem: 7, peso: 2 },
    { nome: 'Opera√ß√µes com Conjuntos', categoria: 'Conjuntos', ordem: 8, peso: 2 },
    { nome: 'Racioc√≠nio Anal√≠tico', categoria: 'Racioc√≠nio', ordem: 9, peso: 2 },
    { nome: 'Verdades e Mentiras', categoria: 'L√≥gica de Argumenta√ß√£o', ordem: 10, peso: 2 }
  ],
  'Matem√°tica': [
    { nome: 'N√∫meros e Opera√ß√µes', categoria: 'Aritm√©tica', ordem: 1, peso: 2 },
    { nome: 'Fra√ß√µes e Decimais', categoria: 'Aritm√©tica', ordem: 2, peso: 2 },
    { nome: 'Porcentagem', categoria: 'Matem√°tica Financeira', ordem: 3, peso: 3 },
    { nome: 'Raz√£o e Propor√ß√£o', categoria: 'Matem√°tica B√°sica', ordem: 4, peso: 2 },
    { nome: 'Regra de Tr√™s', categoria: 'Matem√°tica B√°sica', ordem: 5, peso: 2 },
    { nome: 'Equa√ß√µes de 1¬∫ e 2¬∫ grau', categoria: '√Ålgebra', ordem: 6, peso: 2 },
    { nome: 'Sistemas de Equa√ß√µes', categoria: '√Ålgebra', ordem: 7, peso: 2 },
    { nome: 'Geometria Plana', categoria: 'Geometria', ordem: 8, peso: 2 },
    { nome: 'Matem√°tica Financeira', categoria: 'Financeira', ordem: 9, peso: 3 },
    { nome: 'Estat√≠stica B√°sica', categoria: 'Estat√≠stica', ordem: 10, peso: 2 }
  ],
  'Direito Civil': [
    { nome: 'Lei de Introdu√ß√£o √†s Normas', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Pessoa Natural e Jur√≠dica', categoria: 'Parte Geral', ordem: 2, peso: 2 },
    { nome: 'Fatos Jur√≠dicos', categoria: 'Parte Geral', ordem: 3, peso: 2 },
    { nome: 'Neg√≥cio Jur√≠dico', categoria: 'Parte Geral', ordem: 4, peso: 3 },
    { nome: 'Prescri√ß√£o e Decad√™ncia', categoria: 'Parte Geral', ordem: 5, peso: 3 },
    { nome: 'Obriga√ß√µes', categoria: 'Direito das Obriga√ß√µes', ordem: 6, peso: 3 },
    { nome: 'Contratos', categoria: 'Direito das Obriga√ß√µes', ordem: 7, peso: 3 },
    { nome: 'Responsabilidade Civil', categoria: 'Direito das Obriga√ß√µes', ordem: 8, peso: 3 },
    { nome: 'Direito das Coisas', categoria: 'Direitos Reais', ordem: 9, peso: 2 },
    { nome: 'Direito de Fam√≠lia e Sucess√µes', categoria: 'Fam√≠lia', ordem: 10, peso: 2 }
  ],
  'Direito Penal': [
    { nome: 'Aplica√ß√£o da Lei Penal', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Crime: Conceito e Elementos', categoria: 'Teoria do Crime', ordem: 2, peso: 3 },
    { nome: 'Tipicidade', categoria: 'Teoria do Crime', ordem: 3, peso: 3 },
    { nome: 'Ilicitude', categoria: 'Teoria do Crime', ordem: 4, peso: 2 },
    { nome: 'Culpabilidade', categoria: 'Teoria do Crime', ordem: 5, peso: 3 },
    { nome: 'Tentativa e Consuma√ß√£o', categoria: 'Iter Criminis', ordem: 6, peso: 2 },
    { nome: 'Concurso de Pessoas', categoria: 'Concurso', ordem: 7, peso: 2 },
    { nome: 'Penas e Medidas de Seguran√ßa', categoria: 'Penas', ordem: 8, peso: 3 },
    { nome: 'Crimes contra a Pessoa', categoria: 'Parte Especial', ordem: 9, peso: 3 },
    { nome: 'Crimes contra o Patrim√¥nio', categoria: 'Parte Especial', ordem: 10, peso: 3 }
  ],
  'Direito Processual Civil': [
    { nome: 'Normas Processuais', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Jurisdi√ß√£o e Compet√™ncia', categoria: 'Fundamentos', ordem: 2, peso: 3 },
    { nome: 'Atos Processuais', categoria: 'Processo', ordem: 3, peso: 2 },
    { nome: 'Sujeitos do Processo', categoria: 'Sujeitos', ordem: 4, peso: 2 },
    { nome: 'Peti√ß√£o Inicial', categoria: 'Procedimento', ordem: 5, peso: 3 },
    { nome: 'Resposta do R√©u', categoria: 'Procedimento', ordem: 6, peso: 3 },
    { nome: 'Provas', categoria: 'Instru√ß√£o', ordem: 7, peso: 3 },
    { nome: 'Senten√ßa', categoria: 'Decis√£o', ordem: 8, peso: 3 },
    { nome: 'Recursos', categoria: 'Impugna√ß√£o', ordem: 9, peso: 3 },
    { nome: 'Execu√ß√£o', categoria: 'Execu√ß√£o', ordem: 10, peso: 2 }
  ],
  'Direito Processual Penal': [
    { nome: 'Princ√≠pios do Processo Penal', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Inqu√©rito Policial', categoria: 'Investiga√ß√£o', ordem: 2, peso: 2 },
    { nome: 'A√ß√£o Penal', categoria: 'A√ß√£o', ordem: 3, peso: 3 },
    { nome: 'Jurisdi√ß√£o e Compet√™ncia', categoria: 'Fundamentos', ordem: 4, peso: 3 },
    { nome: 'Provas', categoria: 'Instru√ß√£o', ordem: 5, peso: 3 },
    { nome: 'Pris√£o e Liberdade Provis√≥ria', categoria: 'Medidas Cautelares', ordem: 6, peso: 3 },
    { nome: 'Procedimentos', categoria: 'Procedimentos', ordem: 7, peso: 2 },
    { nome: 'Tribunal do J√∫ri', categoria: 'Procedimentos Especiais', ordem: 8, peso: 3 },
    { nome: 'Recursos', categoria: 'Impugna√ß√£o', ordem: 9, peso: 3 },
    { nome: 'Execu√ß√£o Penal', categoria: 'Execu√ß√£o', ordem: 10, peso: 2 }
  ],
  'Legisla√ß√£o Tribut√°ria': [
    { nome: 'ICMS: Conceito e Incid√™ncia', categoria: 'ICMS', ordem: 1, peso: 3 },
    { nome: 'ICMS: Base de C√°lculo e Al√≠quotas', categoria: 'ICMS', ordem: 2, peso: 3 },
    { nome: 'ISS: Conceito e Fato Gerador', categoria: 'ISS', ordem: 3, peso: 2 },
    { nome: 'IPTU e ITBI', categoria: 'Impostos Municipais', ordem: 4, peso: 2 },
    { nome: 'Simples Nacional', categoria: 'Regimes Especiais', ordem: 5, peso: 2 },
    { nome: 'Substitui√ß√£o Tribut√°ria', categoria: 'Regimes Especiais', ordem: 6, peso: 3 },
    { nome: 'Obriga√ß√µes Acess√≥rias', categoria: 'Obriga√ß√µes', ordem: 7, peso: 2 },
    { nome: 'Infra√ß√µes e Penalidades', categoria: 'Fiscaliza√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Processo Administrativo Fiscal', categoria: 'Processo', ordem: 9, peso: 2 },
    { nome: 'Legisla√ß√£o Espec√≠fica do Ente', categoria: 'Legisla√ß√£o Local', ordem: 10, peso: 2 }
  ],
  'Contabilidade Geral': [
    { nome: 'Princ√≠pios Cont√°beis', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Patrim√¥nio e Equa√ß√£o Patrimonial', categoria: 'Patrim√¥nio', ordem: 2, peso: 3 },
    { nome: 'Contas Patrimoniais e de Resultado', categoria: 'Contas', ordem: 3, peso: 3 },
    { nome: 'Escritura√ß√£o Cont√°bil', categoria: 'Pr√°tica', ordem: 4, peso: 2 },
    { nome: 'Opera√ß√µes com Mercadorias', categoria: 'Opera√ß√µes', ordem: 5, peso: 2 },
    { nome: 'Balan√ßo Patrimonial', categoria: 'Demonstra√ß√µes', ordem: 6, peso: 3 },
    { nome: 'DRE - Demonstra√ß√£o do Resultado', categoria: 'Demonstra√ß√µes', ordem: 7, peso: 3 },
    { nome: 'DLPA e DMPL', categoria: 'Demonstra√ß√µes', ordem: 8, peso: 2 },
    { nome: 'An√°lise das Demonstra√ß√µes', categoria: 'An√°lise', ordem: 9, peso: 2 },
    { nome: 'Deprecia√ß√£o e Amortiza√ß√£o', categoria: 'Ativo Imobilizado', ordem: 10, peso: 2 }
  ],
  'Contabilidade P√∫blica': [
    { nome: 'Conceitos e Campo de Aplica√ß√£o', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Or√ßamento P√∫blico', categoria: 'Or√ßamento', ordem: 2, peso: 3 },
    { nome: 'Receita P√∫blica', categoria: 'Receita', ordem: 3, peso: 3 },
    { nome: 'Despesa P√∫blica', categoria: 'Despesa', ordem: 4, peso: 3 },
    { nome: 'Restos a Pagar', categoria: 'Despesa', ordem: 5, peso: 2 },
    { nome: 'D√≠vida Ativa', categoria: 'Receita', ordem: 6, peso: 2 },
    { nome: 'Patrim√¥nio P√∫blico', categoria: 'Patrim√¥nio', ordem: 7, peso: 2 },
    { nome: 'NBCASP - Normas Brasileiras', categoria: 'Normas', ordem: 8, peso: 3 },
    { nome: 'Demonstra√ß√µes Cont√°beis P√∫blicas', categoria: 'Demonstra√ß√µes', ordem: 9, peso: 3 },
    { nome: 'LRF - Lei de Responsabilidade Fiscal', categoria: 'LRF', ordem: 10, peso: 3 }
  ],
  'Auditoria': [
    { nome: 'Conceitos e Tipos de Auditoria', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Normas de Auditoria', categoria: 'Normas', ordem: 2, peso: 3 },
    { nome: 'Planejamento de Auditoria', categoria: 'Planejamento', ordem: 3, peso: 2 },
    { nome: 'Procedimentos de Auditoria', categoria: 'Procedimentos', ordem: 4, peso: 3 },
    { nome: 'Testes de Observ√¢ncia e Substantivos', categoria: 'Testes', ordem: 5, peso: 2 },
    { nome: 'Amostragem em Auditoria', categoria: 'T√©cnicas', ordem: 6, peso: 2 },
    { nome: 'Pap√©is de Trabalho', categoria: 'Documenta√ß√£o', ordem: 7, peso: 2 },
    { nome: 'Controle Interno', categoria: 'Controle', ordem: 8, peso: 3 },
    { nome: 'Relat√≥rio de Auditoria', categoria: 'Relat√≥rio', ordem: 9, peso: 3 },
    { nome: 'Auditoria Governamental', categoria: 'Setor P√∫blico', ordem: 10, peso: 2 }
  ],
  'Legisla√ß√£o Especial': [
    { nome: 'Lei de Drogas - Lei 11.343/06', categoria: 'Drogas', ordem: 1, peso: 3 },
    { nome: 'Crimes Hediondos - Lei 8.072/90', categoria: 'Crimes Graves', ordem: 2, peso: 3 },
    { nome: 'Estatuto do Desarmamento', categoria: 'Armas', ordem: 3, peso: 2 },
    { nome: 'Viol√™ncia Dom√©stica - Lei Maria da Penha', categoria: 'Viol√™ncia', ordem: 4, peso: 3 },
    { nome: 'Crimes de Tr√¢nsito', categoria: 'Tr√¢nsito', ordem: 5, peso: 2 },
    { nome: 'Juizados Especiais Criminais', categoria: 'JECRIM', ordem: 6, peso: 2 },
    { nome: 'Organiza√ß√µes Criminosas', categoria: 'Crime Organizado', ordem: 7, peso: 2 },
    { nome: 'Intercepta√ß√£o Telef√¥nica', categoria: 'Investiga√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Abuso de Autoridade', categoria: 'Abusos', ordem: 9, peso: 2 },
    { nome: 'Crimes contra a Ordem Tribut√°ria', categoria: 'Fiscal', ordem: 10, peso: 2 }
  ],
  'Direitos Humanos': [
    { nome: 'Evolu√ß√£o Hist√≥rica', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Gera√ß√µes de Direitos', categoria: 'Teoria', ordem: 2, peso: 2 },
    { nome: 'Sistema Global de Prote√ß√£o', categoria: 'ONU', ordem: 3, peso: 2 },
    { nome: 'Declara√ß√£o Universal - 1948', categoria: 'Documentos', ordem: 4, peso: 3 },
    { nome: 'Pactos Internacionais', categoria: 'Tratados', ordem: 5, peso: 2 },
    { nome: 'Sistema Interamericano', categoria: 'Regional', ordem: 6, peso: 3 },
    { nome: 'Conven√ß√£o Americana - Pacto de San Jos√©', categoria: 'Documentos', ordem: 7, peso: 3 },
    { nome: 'Direitos das Crian√ßas e Adolescentes', categoria: 'Especiais', ordem: 8, peso: 2 },
    { nome: 'Direitos das Mulheres', categoria: 'Especiais', ordem: 9, peso: 2 },
    { nome: 'Direitos dos Refugiados', categoria: 'Especiais', ordem: 10, peso: 2 }
  ],
  'Inform√°tica': [
    { nome: 'Hardware: Componentes', categoria: 'Hardware', ordem: 1, peso: 2 },
    { nome: 'Sistemas Operacionais', categoria: 'Software', ordem: 2, peso: 2 },
    { nome: 'Windows: B√°sico', categoria: 'Windows', ordem: 3, peso: 2 },
    { nome: 'Linux: Fundamentos', categoria: 'Linux', ordem: 4, peso: 2 },
    { nome: 'Editor de Textos', categoria: 'Aplicativos', ordem: 5, peso: 3 },
    { nome: 'Planilhas Eletr√¥nicas', categoria: 'Aplicativos', ordem: 6, peso: 3 },
    { nome: 'Redes de Computadores', categoria: 'Redes', ordem: 7, peso: 2 },
    { nome: 'Internet e Navegadores', categoria: 'Internet', ordem: 8, peso: 2 },
    { nome: 'Seguran√ßa da Informa√ß√£o', categoria: 'Seguran√ßa', ordem: 9, peso: 3 },
    { nome: 'Backup e Armazenamento', categoria: 'Seguran√ßa', ordem: 10, peso: 2 }
  ],
  'Atualidades': [
    { nome: 'Pol√≠tica Nacional', categoria: 'Pol√≠tica', ordem: 1, peso: 3 },
    { nome: 'Pol√≠tica Internacional', categoria: 'Pol√≠tica', ordem: 2, peso: 2 },
    { nome: 'Economia Brasileira', categoria: 'Economia', ordem: 3, peso: 3 },
    { nome: 'Economia Mundial', categoria: 'Economia', ordem: 4, peso: 2 },
    { nome: 'Meio Ambiente', categoria: 'Sociedade', ordem: 5, peso: 2 },
    { nome: 'Ci√™ncia e Tecnologia', categoria: 'Ci√™ncia', ordem: 6, peso: 2 },
    { nome: 'Cultura e Esportes', categoria: 'Cultura', ordem: 7, peso: 1 },
    { nome: 'Quest√µes Sociais', categoria: 'Sociedade', ordem: 8, peso: 2 },
    { nome: 'Sa√∫de P√∫blica', categoria: 'Sa√∫de', ordem: 9, peso: 2 },
    { nome: 'Educa√ß√£o', categoria: 'Educa√ß√£o', ordem: 10, peso: 2 }
  ],
  'Ingl√™s': [
    { nome: 'Interpreta√ß√£o de Textos', categoria: 'Reading', ordem: 1, peso: 3 },
    { nome: 'Vocabul√°rio', categoria: 'Vocabulary', ordem: 2, peso: 2 },
    { nome: 'Verb Tenses', categoria: 'Grammar', ordem: 3, peso: 3 },
    { nome: 'Pronouns', categoria: 'Grammar', ordem: 4, peso: 2 },
    { nome: 'Prepositions', categoria: 'Grammar', ordem: 5, peso: 2 },
    { nome: 'Conditionals', categoria: 'Grammar', ordem: 6, peso: 2 },
    { nome: 'Passive Voice', categoria: 'Grammar', ordem: 7, peso: 2 },
    { nome: 'Reported Speech', categoria: 'Grammar', ordem: 8, peso: 2 },
    { nome: 'Phrasal Verbs', categoria: 'Vocabulary', ordem: 9, peso: 2 },
    { nome: 'False Cognates', categoria: 'Vocabulary', ordem: 10, peso: 2 }
  ],
  'Reda√ß√£o': [
    { nome: 'Estrutura Textual', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Tipos Textuais', categoria: 'Tipologia', ordem: 2, peso: 2 },
    { nome: 'Texto Dissertativo-Argumentativo', categoria: 'Disserta√ß√£o', ordem: 3, peso: 3 },
    { nome: 'Tese e Argumenta√ß√£o', categoria: 'Disserta√ß√£o', ordem: 4, peso: 3 },
    { nome: 'Coes√£o e Coer√™ncia', categoria: 'Coes√£o', ordem: 5, peso: 3 },
    { nome: 'Conectivos', categoria: 'Coes√£o', ordem: 6, peso: 2 },
    { nome: 'Introdu√ß√£o e Conclus√£o', categoria: 'Estrutura', ordem: 7, peso: 2 },
    { nome: 'Desenvolvimento de Par√°grafos', categoria: 'Estrutura', ordem: 8, peso: 2 },
    { nome: 'Proposta de Interven√ß√£o', categoria: 'Disserta√ß√£o', ordem: 9, peso: 3 },
    { nome: 'Erros Comuns', categoria: 'Pr√°tica', ordem: 10, peso: 2 }
  ],
  // üÜï NOVAS DISCIPLINAS EXPANDIDAS
  'Matem√°tica Financeira': [
    { nome: 'Juros Simples', categoria: 'Juros', ordem: 1, peso: 3 },
    { nome: 'Juros Compostos', categoria: 'Juros', ordem: 2, peso: 3 },
    { nome: 'Descontos Simples e Compostos', categoria: 'Descontos', ordem: 3, peso: 2 },
    { nome: 'Taxas de Juros', categoria: 'Taxas', ordem: 4, peso: 2 },
    { nome: 'S√©ries de Pagamentos', categoria: 'Amortiza√ß√£o', ordem: 5, peso: 2 },
    { nome: 'Sistema Price', categoria: 'Amortiza√ß√£o', ordem: 6, peso: 2 },
    { nome: 'Sistema SAC', categoria: 'Amortiza√ß√£o', ordem: 7, peso: 2 },
    { nome: 'Valor Presente e Futuro', categoria: 'Valor do Dinheiro', ordem: 8, peso: 3 },
    { nome: 'Taxa Interna de Retorno', categoria: 'An√°lise', ordem: 9, peso: 2 },
    { nome: 'An√°lise de Investimentos', categoria: 'An√°lise', ordem: 10, peso: 2 }
  ],
  'Estat√≠stica': [
    { nome: 'Estat√≠stica Descritiva', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Medidas de Posi√ß√£o', categoria: 'Medidas', ordem: 2, peso: 3 },
    { nome: 'Medidas de Dispers√£o', categoria: 'Medidas', ordem: 3, peso: 3 },
    { nome: 'Distribui√ß√£o de Frequ√™ncias', categoria: 'Distribui√ß√µes', ordem: 4, peso: 2 },
    { nome: 'Probabilidade B√°sica', categoria: 'Probabilidade', ordem: 5, peso: 3 },
    { nome: 'Probabilidade Condicional', categoria: 'Probabilidade', ordem: 6, peso: 2 },
    { nome: 'Distribui√ß√£o Normal', categoria: 'Distribui√ß√µes', ordem: 7, peso: 3 },
    { nome: 'Amostragem', categoria: 'Infer√™ncia', ordem: 8, peso: 2 },
    { nome: 'Testes de Hip√≥teses', categoria: 'Infer√™ncia', ordem: 9, peso: 2 },
    { nome: 'Correla√ß√£o e Regress√£o', categoria: 'An√°lise', ordem: 10, peso: 2 }
  ],
  '√âtica no Servi√ßo P√∫blico': [
    { nome: 'Princ√≠pios √âticos', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'C√≥digo de √âtica Profissional', categoria: 'Normas', ordem: 2, peso: 3 },
    { nome: 'Probidade Administrativa', categoria: 'Integridade', ordem: 3, peso: 3 },
    { nome: 'Conflito de Interesses', categoria: 'Integridade', ordem: 4, peso: 3 },
    { nome: 'Veda√ß√µes ao Servidor', categoria: 'Deveres', ordem: 5, peso: 2 },
    { nome: 'Nepotismo', categoria: 'Veda√ß√µes', ordem: 6, peso: 2 },
    { nome: 'Transpar√™ncia P√∫blica', categoria: 'Princ√≠pios', ordem: 7, peso: 2 },
    { nome: 'Improbidade Administrativa', categoria: 'Responsabilidade', ordem: 8, peso: 3 },
    { nome: 'Responsabiliza√ß√£o do Servidor', categoria: 'Responsabilidade', ordem: 9, peso: 2 },
    { nome: 'Compliance no Setor P√∫blico', categoria: 'Integridade', ordem: 10, peso: 2 }
  ],
  'Administra√ß√£o Geral': [
    { nome: 'Teorias Administrativas', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Fun√ß√µes Administrativas', categoria: 'Processo', ordem: 2, peso: 3 },
    { nome: 'Planejamento Estrat√©gico', categoria: 'Planejamento', ordem: 3, peso: 3 },
    { nome: 'Estruturas Organizacionais', categoria: 'Organiza√ß√£o', ordem: 4, peso: 2 },
    { nome: 'Cultura Organizacional', categoria: 'Comportamento', ordem: 5, peso: 2 },
    { nome: 'Lideran√ßa', categoria: 'Dire√ß√£o', ordem: 6, peso: 3 },
    { nome: 'Motiva√ß√£o', categoria: 'Comportamento', ordem: 7, peso: 2 },
    { nome: 'Comunica√ß√£o Organizacional', categoria: 'Dire√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Controle Gerencial', categoria: 'Controle', ordem: 9, peso: 2 },
    { nome: 'Tomada de Decis√£o', categoria: 'Processo', ordem: 10, peso: 3 }
  ],
  'Administra√ß√£o P√∫blica': [
    { nome: 'Evolu√ß√£o da Administra√ß√£o P√∫blica', categoria: 'Hist√≥ria', ordem: 1, peso: 2 },
    { nome: 'Modelos de Gest√£o P√∫blica', categoria: 'Modelos', ordem: 3, peso: 3 },
    { nome: 'Governan√ßa P√∫blica', categoria: 'Governan√ßa', ordem: 3, peso: 3 },
    { nome: 'Gest√£o por Resultados', categoria: 'Gest√£o', ordem: 4, peso: 3 },
    { nome: 'Excel√™ncia no Servi√ßo P√∫blico', categoria: 'Qualidade', ordem: 5, peso: 2 },
    { nome: 'Inova√ß√£o no Setor P√∫blico', categoria: 'Inova√ß√£o', ordem: 6, peso: 2 },
    { nome: 'Gest√£o de Projetos P√∫blicos', categoria: 'Projetos', ordem: 7, peso: 2 },
    { nome: 'Contratos de Gest√£o', categoria: 'Contratos', ordem: 8, peso: 2 },
    { nome: 'Ag√™ncias Reguladoras', categoria: 'Organiza√ß√£o', ordem: 9, peso: 2 },
    { nome: 'Parceria P√∫blico-Privada', categoria: 'Parcerias', ordem: 10, peso: 2 }
  ],
  'Gest√£o de Pessoas': [
    { nome: 'Planejamento de RH', categoria: 'Planejamento', ordem: 1, peso: 2 },
    { nome: 'Recrutamento e Sele√ß√£o', categoria: 'Provis√£o', ordem: 2, peso: 3 },
    { nome: 'Treinamento e Desenvolvimento', categoria: 'Desenvolvimento', ordem: 3, peso: 3 },
    { nome: 'Avalia√ß√£o de Desempenho', categoria: 'Monitoramento', ordem: 4, peso: 3 },
    { nome: 'Gest√£o por Compet√™ncias', categoria: 'Compet√™ncias', ordem: 5, peso: 3 },
    { nome: 'Remunera√ß√£o e Benef√≠cios', categoria: 'Compensa√ß√£o', ordem: 6, peso: 2 },
    { nome: 'Qualidade de Vida no Trabalho', categoria: 'Bem-estar', ordem: 7, peso: 2 },
    { nome: 'Clima Organizacional', categoria: 'Comportamento', ordem: 8, peso: 2 },
    { nome: 'Gest√£o de Conflitos', categoria: 'Rela√ß√µes', ordem: 9, peso: 2 },
    { nome: 'Lideran√ßa de Equipes', categoria: 'Lideran√ßa', ordem: 10, peso: 3 }
  ],
  'AFO - Administra√ß√£o Financeira e Or√ßament√°ria': [
    { nome: 'Or√ßamento P√∫blico: Conceito', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Princ√≠pios Or√ßament√°rios', categoria: 'Princ√≠pios', ordem: 2, peso: 3 },
    { nome: 'Ciclo Or√ßament√°rio', categoria: 'Processo', ordem: 3, peso: 3 },
    { nome: 'PPA - Plano Plurianual', categoria: 'Planejamento', ordem: 4, peso: 3 },
    { nome: 'LDO - Lei de Diretrizes Or√ßament√°rias', categoria: 'Planejamento', ordem: 5, peso: 3 },
    { nome: 'LOA - Lei Or√ßament√°ria Anual', categoria: 'Execu√ß√£o', ordem: 6, peso: 3 },
    { nome: 'Cr√©ditos Adicionais', categoria: 'Execu√ß√£o', ordem: 7, peso: 2 },
    { nome: 'Receita P√∫blica', categoria: 'Receita', ordem: 8, peso: 3 },
    { nome: 'Despesa P√∫blica', categoria: 'Despesa', ordem: 9, peso: 3 },
    { nome: 'LRF e Controle', categoria: 'LRF', ordem: 10, peso: 3 }
  ],
  'Direito Financeiro': [
    { nome: 'Finan√ßas P√∫blicas', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Receitas P√∫blicas', categoria: 'Receita', ordem: 2, peso: 3 },
    { nome: 'Despesas P√∫blicas', categoria: 'Despesa', ordem: 3, peso: 3 },
    { nome: 'Or√ßamento P√∫blico', categoria: 'Or√ßamento', ordem: 4, peso: 3 },
    { nome: 'D√≠vida P√∫blica', categoria: 'D√≠vida', ordem: 5, peso: 2 },
    { nome: 'Cr√©dito P√∫blico', categoria: 'Cr√©dito', ordem: 6, peso: 2 },
    { nome: 'LRF - Limites e Controles', categoria: 'LRF', ordem: 7, peso: 3 },
    { nome: 'Responsabilidade Fiscal', categoria: 'LRF', ordem: 8, peso: 3 },
    { nome: 'Precat√≥rios', categoria: 'D√≠vida', ordem: 9, peso: 2 },
    { nome: 'Fiscaliza√ß√£o Or√ßament√°ria', categoria: 'Controle', ordem: 10, peso: 2 }
  ],
  'Direito Previdenci√°rio': [
    { nome: 'Seguridade Social', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Princ√≠pios Previdenci√°rios', categoria: 'Princ√≠pios', ordem: 2, peso: 2 },
    { nome: 'Regime Geral - RGPS', categoria: 'RGPS', ordem: 3, peso: 3 },
    { nome: 'Segurados do RGPS', categoria: 'Filia√ß√£o', ordem: 4, peso: 3 },
    { nome: 'Dependentes', categoria: 'Filia√ß√£o', ordem: 5, peso: 2 },
    { nome: 'Benef√≠cios Previdenci√°rios', categoria: 'Benef√≠cios', ordem: 6, peso: 3 },
    { nome: 'Aposentadorias', categoria: 'Benef√≠cios', ordem: 7, peso: 3 },
    { nome: 'Custeio da Seguridade', categoria: 'Custeio', ordem: 8, peso: 3 },
    { nome: 'Sal√°rio-de-Contribui√ß√£o', categoria: 'Custeio', ordem: 9, peso: 2 },
    { nome: 'Regimes Pr√≥prios - RPPS', categoria: 'RPPS', ordem: 10, peso: 2 }
  ],
  'Direito Empresarial': [
    { nome: 'Empres√°rio e Empresa', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Estabelecimento Empresarial', categoria: 'Estabelecimento', ordem: 2, peso: 2 },
    { nome: 'Registro de Empresas', categoria: 'Registro', ordem: 3, peso: 2 },
    { nome: 'Nome Empresarial', categoria: 'Registro', ordem: 4, peso: 2 },
    { nome: 'Sociedades Empres√°rias', categoria: 'Sociedades', ordem: 5, peso: 3 },
    { nome: 'Sociedade Limitada', categoria: 'Sociedades', ordem: 6, peso: 3 },
    { nome: 'Sociedade An√¥nima', categoria: 'Sociedades', ordem: 7, peso: 3 },
    { nome: 'T√≠tulos de Cr√©dito', categoria: 'T√≠tulos', ordem: 8, peso: 3 },
    { nome: 'Fal√™ncia e Recupera√ß√£o', categoria: 'Crise', ordem: 9, peso: 2 },
    { nome: 'Contratos Empresariais', categoria: 'Contratos', ordem: 10, peso: 2 }
  ],
  'Direito Ambiental': [
    { nome: 'Princ√≠pios do Direito Ambiental', categoria: 'Princ√≠pios', ordem: 1, peso: 3 },
    { nome: 'Pol√≠tica Nacional do Meio Ambiente', categoria: 'Legisla√ß√£o', ordem: 2, peso: 3 },
    { nome: 'Compet√™ncias Ambientais', categoria: 'Compet√™ncia', ordem: 3, peso: 2 },
    { nome: 'Licenciamento Ambiental', categoria: 'Controle', ordem: 4, peso: 3 },
    { nome: 'Estudos Ambientais', categoria: 'Controle', ordem: 5, peso: 2 },
    { nome: '√Åreas Protegidas', categoria: 'Prote√ß√£o', ordem: 6, peso: 2 },
    { nome: 'C√≥digo Florestal', categoria: 'Legisla√ß√£o', ordem: 7, peso: 3 },
    { nome: 'Recursos H√≠dricos', categoria: 'Recursos', ordem: 8, peso: 2 },
    { nome: 'Responsabilidade Ambiental', categoria: 'Responsabilidade', ordem: 9, peso: 3 },
    { nome: 'Crimes Ambientais', categoria: 'San√ß√µes', ordem: 10, peso: 3 }
  ],
  'Direito do Consumidor': [
    { nome: 'Rela√ß√£o de Consumo', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Consumidor e Fornecedor', categoria: 'Sujeitos', ordem: 2, peso: 3 },
    { nome: 'Princ√≠pios do CDC', categoria: 'Princ√≠pios', ordem: 3, peso: 2 },
    { nome: 'Direitos B√°sicos do Consumidor', categoria: 'Direitos', ordem: 4, peso: 3 },
    { nome: 'Qualidade de Produtos e Servi√ßos', categoria: 'Qualidade', ordem: 5, peso: 2 },
    { nome: 'V√≠cios e Defeitos', categoria: 'Responsabilidade', ordem: 6, peso: 3 },
    { nome: 'Responsabilidade do Fornecedor', categoria: 'Responsabilidade', ordem: 7, peso: 3 },
    { nome: 'Pr√°ticas Comerciais', categoria: 'Pr√°ticas', ordem: 8, peso: 2 },
    { nome: 'Prote√ß√£o Contratual', categoria: 'Contratos', ordem: 9, peso: 2 },
    { nome: 'San√ß√µes Administrativas', categoria: 'San√ß√µes', ordem: 10, peso: 2 }
  ],
  'LGPD - Prote√ß√£o de Dados': [
    { nome: 'Fundamentos da LGPD', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Princ√≠pios de Prote√ß√£o de Dados', categoria: 'Princ√≠pios', ordem: 2, peso: 3 },
    { nome: 'Dados Pessoais e Sens√≠veis', categoria: 'Dados', ordem: 3, peso: 3 },
    { nome: 'Bases Legais', categoria: 'Tratamento', ordem: 4, peso: 3 },
    { nome: 'Direitos do Titular', categoria: 'Direitos', ordem: 5, peso: 3 },
    { nome: 'Agentes de Tratamento', categoria: 'Agentes', ordem: 6, peso: 2 },
    { nome: 'Seguran√ßa da Informa√ß√£o', categoria: 'Seguran√ßa', ordem: 7, peso: 3 },
    { nome: 'Incidentes de Seguran√ßa', categoria: 'Seguran√ßa', ordem: 8, peso: 2 },
    { nome: 'ANPD - Autoridade Nacional', categoria: 'Fiscaliza√ß√£o', ordem: 9, peso: 2 },
    { nome: 'San√ß√µes Administrativas', categoria: 'San√ß√µes', ordem: 10, peso: 2 }
  ],
  'Conhecimentos Banc√°rios': [
    { nome: 'Sistema Financeiro Nacional', categoria: 'Sistema', ordem: 1, peso: 3 },
    { nome: 'Banco Central do Brasil', categoria: 'Institui√ß√µes', ordem: 2, peso: 3 },
    { nome: 'Produtos Banc√°rios', categoria: 'Produtos', ordem: 3, peso: 3 },
    { nome: 'Opera√ß√µes de Cr√©dito', categoria: 'Cr√©dito', ordem: 4, peso: 3 },
    { nome: 'Garantias Banc√°rias', categoria: 'Cr√©dito', ordem: 5, peso: 2 },
    { nome: 'Mercado de Capitais', categoria: 'Mercado', ordem: 6, peso: 2 },
    { nome: 'Fundos de Investimento', categoria: 'Investimento', ordem: 7, peso: 2 },
    { nome: 'T√≠tulos P√∫blicos e Privados', categoria: 'Investimento', ordem: 8, peso: 2 },
    { nome: 'Preven√ß√£o √† Lavagem de Dinheiro', categoria: 'Compliance', ordem: 9, peso: 3 },
    { nome: 'Autorregula√ß√£o Banc√°ria', categoria: 'Regula√ß√£o', ordem: 10, peso: 2 }
  ],
  'Arquivologia': [
    { nome: 'Conceitos Fundamentais', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Princ√≠pios Arquiv√≠sticos', categoria: 'Princ√≠pios', ordem: 2, peso: 3 },
    { nome: 'Classifica√ß√£o de Documentos', categoria: 'Classifica√ß√£o', ordem: 3, peso: 3 },
    { nome: 'Protocolo e Controle', categoria: 'Protocolo', ordem: 4, peso: 2 },
    { nome: 'Gest√£o Documental', categoria: 'Gest√£o', ordem: 5, peso: 3 },
    { nome: 'Tabela de Temporalidade', categoria: 'Avalia√ß√£o', ordem: 6, peso: 3 },
    { nome: 'Arquivos Correntes', categoria: 'Ciclo', ordem: 7, peso: 2 },
    { nome: 'Arquivos Intermedi√°rios', categoria: 'Ciclo', ordem: 8, peso: 2 },
    { nome: 'Arquivos Permanentes', categoria: 'Ciclo', ordem: 9, peso: 2 },
    { nome: 'Documentos Digitais', categoria: 'Digital', ordem: 10, peso: 3 }
  ],
  'Legisla√ß√£o do SUS': [
    { nome: 'Princ√≠pios do SUS', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Diretrizes do SUS', categoria: 'Fundamentos', ordem: 2, peso: 3 },
    { nome: 'Organiza√ß√£o do SUS', categoria: 'Organiza√ß√£o', ordem: 3, peso: 3 },
    { nome: 'Compet√™ncias dos Entes', categoria: 'Compet√™ncias', ordem: 4, peso: 2 },
    { nome: 'Participa√ß√£o Popular', categoria: 'Participa√ß√£o', ordem: 5, peso: 2 },
    { nome: 'Financiamento do SUS', categoria: 'Financiamento', ordem: 6, peso: 2 },
    { nome: 'Aten√ß√£o B√°sica', categoria: 'Aten√ß√£o', ordem: 7, peso: 3 },
    { nome: 'Vigil√¢ncia em Sa√∫de', categoria: 'Vigil√¢ncia', ordem: 8, peso: 2 },
    { nome: 'Programas de Sa√∫de', categoria: 'Programas', ordem: 9, peso: 2 },
    { nome: 'Pol√≠ticas de Sa√∫de', categoria: 'Pol√≠ticas', ordem: 10, peso: 2 }
  ],
  
  // ============== üÜï NOVAS DISCIPLINAS DO DATASET (82 TOTAL) ==============
  'Direito Eleitoral': [
    { nome: 'C√≥digo Eleitoral', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Direitos Pol√≠ticos', categoria: 'Direitos', ordem: 2, peso: 3 },
    { nome: 'Partidos Pol√≠ticos', categoria: 'Partidos', ordem: 3, peso: 2 },
    { nome: 'Alistamento e Elegibilidade', categoria: 'Elegibilidade', ordem: 4, peso: 3 },
    { nome: 'Inelegibilidades', categoria: 'Elegibilidade', ordem: 5, peso: 3 },
    { nome: 'Registro de Candidatura', categoria: 'Processo', ordem: 6, peso: 2 },
    { nome: 'Propaganda Eleitoral', categoria: 'Processo', ordem: 7, peso: 2 },
    { nome: 'Crimes Eleitorais', categoria: 'Penal', ordem: 8, peso: 2 },
    { nome: 'Justi√ßa Eleitoral', categoria: 'Organiza√ß√£o', ordem: 9, peso: 2 },
    { nome: 'Processo Eleitoral', categoria: 'Processo', ordem: 10, peso: 2 }
  ],
  'Direito do Trabalho': [
    { nome: 'Fontes do Direito do Trabalho', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Contrato de Trabalho', categoria: 'Contratos', ordem: 2, peso: 3 },
    { nome: 'Rela√ß√£o de Emprego', categoria: 'Rela√ß√£o', ordem: 3, peso: 3 },
    { nome: 'Direitos Trabalhistas', categoria: 'Direitos', ordem: 4, peso: 3 },
    { nome: 'Jornada de Trabalho', categoria: 'Jornada', ordem: 5, peso: 3 },
    { nome: 'F√©rias e Descanso', categoria: 'Direitos', ordem: 6, peso: 2 },
    { nome: 'Remunera√ß√£o e Sal√°rio', categoria: 'Remunera√ß√£o', ordem: 7, peso: 3 },
    { nome: 'FGTS', categoria: 'Verbas', ordem: 8, peso: 2 },
    { nome: 'Extin√ß√£o do Contrato', categoria: 'Extin√ß√£o', ordem: 9, peso: 3 },
    { nome: 'Estabilidades', categoria: 'Prote√ß√£o', ordem: 10, peso: 2 }
  ],
  'Direito Processual do Trabalho': [
    { nome: 'Organiza√ß√£o da Justi√ßa do Trabalho', categoria: 'Organiza√ß√£o', ordem: 1, peso: 2 },
    { nome: 'Compet√™ncia Trabalhista', categoria: 'Compet√™ncia', ordem: 2, peso: 3 },
    { nome: 'Reclama√ß√£o Trabalhista', categoria: 'Procedimento', ordem: 3, peso: 3 },
    { nome: 'Provas no Processo Trabalhista', categoria: 'Provas', ordem: 4, peso: 2 },
    { nome: 'Audi√™ncia Trabalhista', categoria: 'Audi√™ncia', ordem: 5, peso: 3 },
    { nome: 'Recursos Trabalhistas', categoria: 'Recursos', ordem: 6, peso: 3 },
    { nome: 'Execu√ß√£o Trabalhista', categoria: 'Execu√ß√£o', ordem: 7, peso: 3 },
    { nome: 'Processo Sumar√≠ssimo', categoria: 'Procedimentos', ordem: 8, peso: 2 },
    { nome: 'Diss√≠dio Coletivo', categoria: 'Coletivo', ordem: 9, peso: 2 },
    { nome: 'S√∫mulas do TST', categoria: 'Jurisprud√™ncia', ordem: 10, peso: 3 }
  ],
  'Direito Urban√≠stico': [
    { nome: 'Estatuto da Cidade', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Pol√≠tica Urbana', categoria: 'Pol√≠tica', ordem: 2, peso: 3 },
    { nome: 'Plano Diretor', categoria: 'Planejamento', ordem: 3, peso: 3 },
    { nome: 'Parcelamento do Solo', categoria: 'Urbaniza√ß√£o', ordem: 4, peso: 2 },
    { nome: 'Zoneamento', categoria: 'Ordenamento', ordem: 5, peso: 2 },
    { nome: 'Uso e Ocupa√ß√£o do Solo', categoria: 'Ordenamento', ordem: 6, peso: 2 },
    { nome: 'Instrumentos Urban√≠sticos', categoria: 'Instrumentos', ordem: 7, peso: 2 },
    { nome: 'Regulariza√ß√£o Fundi√°ria', categoria: 'Regulariza√ß√£o', ordem: 8, peso: 2 },
    { nome: 'IPTU Progressivo', categoria: 'Tributa√ß√£o', ordem: 9, peso: 2 },
    { nome: 'Desapropria√ß√£o Urban√≠stica', categoria: 'Interven√ß√£o', ordem: 10, peso: 2 }
  ],
  'Direito Internacional P√∫blico': [
    { nome: 'Fontes do Direito Internacional', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Tratados Internacionais', categoria: 'Tratados', ordem: 2, peso: 3 },
    { nome: 'Sujeitos de Direito Internacional', categoria: 'Sujeitos', ordem: 3, peso: 2 },
    { nome: 'ONU e Organismos Internacionais', categoria: 'Organiza√ß√µes', ordem: 4, peso: 3 },
    { nome: 'Jurisdi√ß√£o Internacional', categoria: 'Jurisdi√ß√£o', ordem: 5, peso: 2 },
    { nome: 'Conflitos Armados', categoria: 'Conflitos', ordem: 6, peso: 2 },
    { nome: 'Direitos Humanos Internacionais', categoria: 'Direitos', ordem: 7, peso: 3 },
    { nome: 'Asilo e Ref√∫gio', categoria: 'Prote√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Extradi√ß√£o', categoria: 'Coopera√ß√£o', ordem: 9, peso: 2 },
    { nome: 'Responsabilidade Internacional', categoria: 'Responsabilidade', ordem: 10, peso: 2 }
  ],
  'Sociologia': [
    { nome: 'Cl√°ssicos da Sociologia', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Fato Social', categoria: 'Conceitos', ordem: 2, peso: 2 },
    { nome: 'Estratifica√ß√£o Social', categoria: 'Estrutura', ordem: 3, peso: 2 },
    { nome: 'Cultura e Sociedade', categoria: 'Cultura', ordem: 4, peso: 2 },
    { nome: 'Movimentos Sociais', categoria: 'Movimentos', ordem: 5, peso: 3 },
    { nome: 'Institui√ß√µes Sociais', categoria: 'Institui√ß√µes', ordem: 6, peso: 2 },
    { nome: 'Trabalho e Sociedade', categoria: 'Trabalho', ordem: 7, peso: 2 },
    { nome: 'Globaliza√ß√£o', categoria: 'Contempor√¢neo', ordem: 8, peso: 2 },
    { nome: 'Ideologia', categoria: 'Conceitos', ordem: 9, peso: 2 },
    { nome: 'Sociologia Brasileira', categoria: 'Brasil', ordem: 10, peso: 2 }
  ],
  'Filosofia': [
    { nome: 'Hist√≥ria da Filosofia', categoria: 'Hist√≥ria', ordem: 1, peso: 2 },
    { nome: 'Filosofia Antiga', categoria: 'Per√≠odos', ordem: 2, peso: 2 },
    { nome: 'Filosofia Medieval', categoria: 'Per√≠odos', ordem: 3, peso: 2 },
    { nome: 'Filosofia Moderna', categoria: 'Per√≠odos', ordem: 4, peso: 2 },
    { nome: 'Filosofia Contempor√¢nea', categoria: 'Per√≠odos', ordem: 5, peso: 2 },
    { nome: '√âtica e Moral', categoria: '√âtica', ordem: 6, peso: 3 },
    { nome: 'Epistemologia', categoria: 'Conhecimento', ordem: 7, peso: 2 },
    { nome: 'L√≥gica Filos√≥fica', categoria: 'L√≥gica', ordem: 8, peso: 2 },
    { nome: 'Pol√≠tica e Sociedade', categoria: 'Pol√≠tica', ordem: 9, peso: 2 },
    { nome: 'Est√©tica', categoria: 'Arte', ordem: 10, peso: 1 }
  ],
  'Hist√≥ria do Brasil': [
    { nome: 'Brasil Col√¥nia', categoria: 'Colonial', ordem: 1, peso: 3 },
    { nome: 'Independ√™ncia do Brasil', categoria: 'Imperial', ordem: 2, peso: 3 },
    { nome: 'Primeiro Reinado', categoria: 'Imperial', ordem: 3, peso: 2 },
    { nome: 'Per√≠odo Regencial', categoria: 'Imperial', ordem: 4, peso: 2 },
    { nome: 'Segundo Reinado', categoria: 'Imperial', ordem: 5, peso: 2 },
    { nome: 'Proclama√ß√£o da Rep√∫blica', categoria: 'Rep√∫blica', ordem: 6, peso: 3 },
    { nome: 'Era Vargas', categoria: 'Rep√∫blica', ordem: 7, peso: 3 },
    { nome: 'Ditadura Militar', categoria: 'Rep√∫blica', ordem: 8, peso: 3 },
    { nome: 'Redemocratiza√ß√£o', categoria: 'Contempor√¢nea', ordem: 9, peso: 2 },
    { nome: 'Brasil Contempor√¢neo', categoria: 'Contempor√¢nea', ordem: 10, peso: 2 }
  ],
  'Geografia': [
    { nome: 'Geografia F√≠sica', categoria: 'F√≠sica', ordem: 1, peso: 2 },
    { nome: 'Cartografia', categoria: 'T√©cnicas', ordem: 2, peso: 2 },
    { nome: 'Clima e Vegeta√ß√£o', categoria: 'F√≠sica', ordem: 3, peso: 2 },
    { nome: 'Relevo e Hidrografia', categoria: 'F√≠sica', ordem: 4, peso: 2 },
    { nome: 'Geografia Humana', categoria: 'Humana', ordem: 5, peso: 2 },
    { nome: 'Popula√ß√£o', categoria: 'Humana', ordem: 6, peso: 2 },
    { nome: 'Urbaniza√ß√£o', categoria: 'Urbana', ordem: 7, peso: 2 },
    { nome: 'Geografia do Brasil', categoria: 'Brasil', ordem: 8, peso: 3 },
    { nome: 'Geografia Econ√¥mica', categoria: 'Economia', ordem: 9, peso: 2 },
    { nome: 'Geopol√≠tica', categoria: 'Pol√≠tica', ordem: 10, peso: 2 }
  ],
  'Biologia': [
    { nome: 'Citologia', categoria: 'C√©lula', ordem: 1, peso: 2 },
    { nome: 'Bioqu√≠mica', categoria: 'Molecular', ordem: 2, peso: 2 },
    { nome: 'Gen√©tica', categoria: 'Hereditariedade', ordem: 3, peso: 3 },
    { nome: 'Evolu√ß√£o', categoria: 'Evolu√ß√£o', ordem: 4, peso: 2 },
    { nome: 'Ecologia', categoria: 'Ecologia', ordem: 5, peso: 3 },
    { nome: 'Fisiologia Humana', categoria: 'Humana', ordem: 6, peso: 2 },
    { nome: 'Bot√¢nica', categoria: 'Vegetal', ordem: 7, peso: 2 },
    { nome: 'Zoologia', categoria: 'Animal', ordem: 8, peso: 2 },
    { nome: 'Microbiologia', categoria: 'Microrganismos', ordem: 9, peso: 2 },
    { nome: 'Biotecnologia', categoria: 'Aplicada', ordem: 10, peso: 2 }
  ],
  'F√≠sica': [
    { nome: 'Mec√¢nica', categoria: 'Cl√°ssica', ordem: 1, peso: 3 },
    { nome: 'Cinem√°tica', categoria: 'Movimento', ordem: 2, peso: 3 },
    { nome: 'Din√¢mica', categoria: 'For√ßas', ordem: 3, peso: 3 },
    { nome: 'Energia e Trabalho', categoria: 'Energia', ordem: 4, peso: 2 },
    { nome: 'Termodin√¢mica', categoria: 'T√©rmica', ordem: 5, peso: 2 },
    { nome: '√ìptica', categoria: 'Luz', ordem: 6, peso: 2 },
    { nome: 'Eletricidade', categoria: 'El√©trica', ordem: 7, peso: 3 },
    { nome: 'Magnetismo', categoria: 'Magnetismo', ordem: 8, peso: 2 },
    { nome: 'Ondulat√≥ria', categoria: 'Ondas', ordem: 9, peso: 2 },
    { nome: 'F√≠sica Moderna', categoria: 'Moderna', ordem: 10, peso: 2 }
  ],
  'Qu√≠mica': [
    { nome: 'Atom√≠stica', categoria: 'Geral', ordem: 1, peso: 2 },
    { nome: 'Tabela Peri√≥dica', categoria: 'Geral', ordem: 2, peso: 3 },
    { nome: 'Liga√ß√µes Qu√≠micas', categoria: 'Geral', ordem: 3, peso: 3 },
    { nome: 'Fun√ß√µes Inorg√¢nicas', categoria: 'Inorg√¢nica', ordem: 4, peso: 2 },
    { nome: 'Rea√ß√µes Qu√≠micas', categoria: 'Geral', ordem: 5, peso: 3 },
    { nome: 'Estequiometria', categoria: 'Quantitativa', ordem: 6, peso: 2 },
    { nome: 'Solu√ß√µes', categoria: 'F√≠sico-Qu√≠mica', ordem: 7, peso: 2 },
    { nome: 'Termoqu√≠mica', categoria: 'F√≠sico-Qu√≠mica', ordem: 8, peso: 2 },
    { nome: 'Qu√≠mica Org√¢nica', categoria: 'Org√¢nica', ordem: 9, peso: 3 },
    { nome: 'Equil√≠brio Qu√≠mico', categoria: 'F√≠sico-Qu√≠mica', ordem: 10, peso: 2 }
  ],
  'Economia': [
    { nome: 'Introdu√ß√£o √† Economia', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Microeconomia', categoria: 'Micro', ordem: 2, peso: 3 },
    { nome: 'Macroeconomia', categoria: 'Macro', ordem: 3, peso: 3 },
    { nome: 'Oferta e Demanda', categoria: 'Mercados', ordem: 4, peso: 3 },
    { nome: 'Estruturas de Mercado', categoria: 'Mercados', ordem: 5, peso: 2 },
    { nome: 'PIB e Contas Nacionais', categoria: 'Macro', ordem: 6, peso: 2 },
    { nome: 'Infla√ß√£o', categoria: 'Macro', ordem: 7, peso: 3 },
    { nome: 'Pol√≠tica Monet√°ria', categoria: 'Pol√≠tica', ordem: 8, peso: 2 },
    { nome: 'Pol√≠tica Fiscal', categoria: 'Pol√≠tica', ordem: 9, peso: 2 },
    { nome: 'Com√©rcio Internacional', categoria: 'Internacional', ordem: 10, peso: 2 }
  ],
  'Psicologia': [
    { nome: 'Introdu√ß√£o √† Psicologia', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Psicologia do Desenvolvimento', categoria: 'Desenvolvimento', ordem: 2, peso: 2 },
    { nome: 'Psicologia Social', categoria: 'Social', ordem: 3, peso: 2 },
    { nome: 'Psicologia Organizacional', categoria: 'Organizacional', ordem: 4, peso: 3 },
    { nome: 'Teorias da Personalidade', categoria: 'Personalidade', ordem: 5, peso: 2 },
    { nome: 'Psicopatologia', categoria: 'Cl√≠nica', ordem: 6, peso: 2 },
    { nome: 'Avalia√ß√£o Psicol√≥gica', categoria: 'T√©cnicas', ordem: 7, peso: 2 },
    { nome: 'Psicologia da Aprendizagem', categoria: 'Educacional', ordem: 8, peso: 2 },
    { nome: '√âtica Profissional', categoria: '√âtica', ordem: 9, peso: 2 },
    { nome: 'Recrutamento e Sele√ß√£o', categoria: 'RH', ordem: 10, peso: 3 }
  ],
  'Pedagogia': [
    { nome: 'Hist√≥ria da Educa√ß√£o', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Filosofia da Educa√ß√£o', categoria: 'Fundamentos', ordem: 2, peso: 2 },
    { nome: 'Teorias da Aprendizagem', categoria: 'Aprendizagem', ordem: 3, peso: 3 },
    { nome: 'Did√°tica', categoria: 'Pr√°tica', ordem: 4, peso: 3 },
    { nome: 'Curr√≠culo Escolar', categoria: 'Curr√≠culo', ordem: 5, peso: 2 },
    { nome: 'Avalia√ß√£o Educacional', categoria: 'Avalia√ß√£o', ordem: 6, peso: 3 },
    { nome: 'Gest√£o Escolar', categoria: 'Gest√£o', ordem: 7, peso: 2 },
    { nome: 'Educa√ß√£o Inclusiva', categoria: 'Inclus√£o', ordem: 8, peso: 2 },
    { nome: 'LDB - Lei de Diretrizes e Bases', categoria: 'Legisla√ß√£o', ordem: 9, peso: 3 },
    { nome: 'ECA na Educa√ß√£o', categoria: 'Legisla√ß√£o', ordem: 10, peso: 2 }
  ],
  'Pol√≠ticas P√∫blicas': [
    { nome: 'Conceitos de Pol√≠ticas P√∫blicas', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Ciclo de Pol√≠ticas P√∫blicas', categoria: 'Ciclo', ordem: 2, peso: 3 },
    { nome: 'Formula√ß√£o de Pol√≠ticas', categoria: 'Formula√ß√£o', ordem: 3, peso: 2 },
    { nome: 'Implementa√ß√£o', categoria: 'Implementa√ß√£o', ordem: 4, peso: 2 },
    { nome: 'Avalia√ß√£o de Pol√≠ticas', categoria: 'Avalia√ß√£o', ordem: 5, peso: 3 },
    { nome: 'Atores e Redes', categoria: 'Atores', ordem: 6, peso: 2 },
    { nome: 'Pol√≠ticas Sociais', categoria: 'Setoriais', ordem: 7, peso: 2 },
    { nome: 'Pol√≠ticas de Sa√∫de', categoria: 'Setoriais', ordem: 8, peso: 2 },
    { nome: 'Pol√≠ticas Educacionais', categoria: 'Setoriais', ordem: 9, peso: 2 },
    { nome: 'Participa√ß√£o Social', categoria: 'Participa√ß√£o', ordem: 10, peso: 2 }
  ],
  'Tecnologia da Informa√ß√£o': [
    { nome: 'Banco de Dados', categoria: 'Dados', ordem: 1, peso: 3 },
    { nome: 'SQL e NoSQL', categoria: 'Dados', ordem: 2, peso: 3 },
    { nome: 'Programa√ß√£o', categoria: 'Desenvolvimento', ordem: 3, peso: 2 },
    { nome: 'Estruturas de Dados', categoria: 'Algoritmos', ordem: 4, peso: 2 },
    { nome: 'Engenharia de Software', categoria: 'Desenvolvimento', ordem: 5, peso: 2 },
    { nome: 'Redes de Computadores', categoria: 'Redes', ordem: 6, peso: 2 },
    { nome: 'Seguran√ßa da Informa√ß√£o', categoria: 'Seguran√ßa', ordem: 7, peso: 3 },
    { nome: 'Cloud Computing', categoria: 'Infraestrutura', ordem: 8, peso: 2 },
    { nome: 'DevOps', categoria: 'Opera√ß√µes', ordem: 9, peso: 2 },
    { nome: 'Governan√ßa de TI', categoria: 'Governan√ßa', ordem: 10, peso: 3 }
  ],
  'Sistemas Operacionais': [
    { nome: 'Fundamentos de SO', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Gerenciamento de Processos', categoria: 'Processos', ordem: 2, peso: 3 },
    { nome: 'Gerenciamento de Mem√≥ria', categoria: 'Mem√≥ria', ordem: 3, peso: 2 },
    { nome: 'Sistema de Arquivos', categoria: 'Arquivos', ordem: 4, peso: 2 },
    { nome: 'Entrada e Sa√≠da', categoria: 'Hardware', ordem: 5, peso: 2 },
    { nome: 'Concorr√™ncia', categoria: 'Processos', ordem: 6, peso: 2 },
    { nome: 'Escalonamento', categoria: 'Processos', ordem: 7, peso: 2 },
    { nome: 'Linux', categoria: 'Pr√°tica', ordem: 8, peso: 3 },
    { nome: 'Windows', categoria: 'Pr√°tica', ordem: 9, peso: 2 },
    { nome: 'Virtualiza√ß√£o', categoria: 'Avan√ßado', ordem: 10, peso: 2 }
  ],
  'An√°lise de Sistemas': [
    { nome: 'An√°lise de Requisitos', categoria: 'Requisitos', ordem: 1, peso: 3 },
    { nome: 'Modelagem de Dados', categoria: 'Modelagem', ordem: 2, peso: 3 },
    { nome: 'UML', categoria: 'Modelagem', ordem: 3, peso: 2 },
    { nome: 'Casos de Uso', categoria: 'Requisitos', ordem: 4, peso: 2 },
    { nome: 'Diagrama de Classes', categoria: 'Modelagem', ordem: 5, peso: 2 },
    { nome: 'Projeto de Software', categoria: 'Projeto', ordem: 6, peso: 2 },
    { nome: 'Padr√µes de Projeto', categoria: 'Projeto', ordem: 7, peso: 2 },
    { nome: 'Teste de Software', categoria: 'Qualidade', ordem: 8, peso: 3 },
    { nome: 'Metodologias √Ågeis', categoria: 'Gest√£o', ordem: 9, peso: 3 },
    { nome: 'SCRUM', categoria: 'Gest√£o', ordem: 10, peso: 2 }
  ],
  'Gest√£o de Projetos': [
    { nome: 'PMBoK', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Ciclo de Vida do Projeto', categoria: 'Fundamentos', ordem: 2, peso: 2 },
    { nome: 'Escopo', categoria: '√Åreas', ordem: 3, peso: 3 },
    { nome: 'Cronograma', categoria: '√Åreas', ordem: 4, peso: 3 },
    { nome: 'Custos', categoria: '√Åreas', ordem: 5, peso: 2 },
    { nome: 'Qualidade', categoria: '√Åreas', ordem: 6, peso: 2 },
    { nome: 'Riscos', categoria: '√Åreas', ordem: 7, peso: 3 },
    { nome: 'Recursos Humanos', categoria: '√Åreas', ordem: 8, peso: 2 },
    { nome: 'Comunica√ß√£o', categoria: '√Åreas', ordem: 9, peso: 2 },
    { nome: 'Stakeholders', categoria: '√Åreas', ordem: 10, peso: 2 }
  ],
  'Log√≠stica': [
    { nome: 'Introdu√ß√£o √† Log√≠stica', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Gest√£o de Estoques', categoria: 'Estoques', ordem: 2, peso: 3 },
    { nome: 'Armazenagem', categoria: 'Armazenagem', ordem: 3, peso: 2 },
    { nome: 'Transporte', categoria: 'Transporte', ordem: 4, peso: 3 },
    { nome: 'Distribui√ß√£o', categoria: 'Distribui√ß√£o', ordem: 5, peso: 2 },
    { nome: 'Supply Chain', categoria: 'Cadeia', ordem: 6, peso: 3 },
    { nome: 'Log√≠stica Reversa', categoria: 'Sustentabilidade', ordem: 7, peso: 2 },
    { nome: 'Custos Log√≠sticos', categoria: 'Custos', ordem: 8, peso: 2 },
    { nome: 'Indicadores Log√≠sticos', categoria: 'Gest√£o', ordem: 9, peso: 2 },
    { nome: 'Tecnologia na Log√≠stica', categoria: 'Tecnologia', ordem: 10, peso: 2 }
  ],
  'Gest√£o de Qualidade': [
    { nome: 'Fundamentos da Qualidade', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Ferramentas da Qualidade', categoria: 'Ferramentas', ordem: 2, peso: 3 },
    { nome: 'Controle Estat√≠stico', categoria: 'Estat√≠stica', ordem: 3, peso: 2 },
    { nome: 'ISO 9001', categoria: 'Normas', ordem: 4, peso: 3 },
    { nome: 'Melhoria Cont√≠nua', categoria: 'Melhoria', ordem: 5, peso: 2 },
    { nome: 'Six Sigma', categoria: 'Metodologias', ordem: 6, peso: 2 },
    { nome: 'Kaizen', categoria: 'Metodologias', ordem: 7, peso: 2 },
    { nome: '5S', categoria: 'Ferramentas', ordem: 8, peso: 2 },
    { nome: 'Auditoria de Qualidade', categoria: 'Auditoria', ordem: 9, peso: 2 },
    { nome: 'Gest√£o de N√£o Conformidades', categoria: 'Gest√£o', ordem: 10, peso: 2 }
  ],
  'Direito Sanit√°rio': [
    { nome: 'Fundamentos do Direito Sanit√°rio', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Direito √† Sa√∫de', categoria: 'Direitos', ordem: 2, peso: 3 },
    { nome: 'Lei 8.080/90', categoria: 'Legisla√ß√£o', ordem: 3, peso: 3 },
    { nome: 'Lei 8.142/90', categoria: 'Legisla√ß√£o', ordem: 4, peso: 2 },
    { nome: 'Vigil√¢ncia Sanit√°ria', categoria: 'Vigil√¢ncia', ordem: 5, peso: 3 },
    { nome: 'Anvisa', categoria: '√ìrg√£os', ordem: 6, peso: 2 },
    { nome: 'Regula√ß√£o em Sa√∫de', categoria: 'Regula√ß√£o', ordem: 7, peso: 2 },
    { nome: 'Sa√∫de Suplementar', categoria: 'Sa√∫de Suplementar', ordem: 8, peso: 2 },
    { nome: 'ANS', categoria: '√ìrg√£os', ordem: 9, peso: 2 },
    { nome: 'Responsabilidade em Sa√∫de', categoria: 'Responsabilidade', ordem: 10, peso: 2 }
  ],
  'Engenharia de Seguran√ßa do Trabalho': [
    { nome: 'NR-1 Disposi√ß√µes Gerais', categoria: 'NRs', ordem: 1, peso: 2 },
    { nome: 'NR-5 CIPA', categoria: 'NRs', ordem: 2, peso: 3 },
    { nome: 'NR-6 EPI', categoria: 'NRs', ordem: 3, peso: 3 },
    { nome: 'NR-7 PCMSO', categoria: 'NRs', ordem: 4, peso: 2 },
    { nome: 'NR-9 PPRA', categoria: 'NRs', ordem: 5, peso: 3 },
    { nome: 'NR-10 Eletricidade', categoria: 'NRs', ordem: 6, peso: 2 },
    { nome: 'NR-12 M√°quinas e Equipamentos', categoria: 'NRs', ordem: 7, peso: 2 },
    { nome: 'NR-15 Insalubridade', categoria: 'NRs', ordem: 8, peso: 3 },
    { nome: 'NR-16 Periculosidade', categoria: 'NRs', ordem: 9, peso: 2 },
    { nome: 'Acidentes de Trabalho', categoria: 'Preven√ß√£o', ordem: 10, peso: 3 }
  ],
  'Metrologia': [
    { nome: 'Conceitos de Metrologia', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Sistema Internacional de Unidades', categoria: 'SI', ordem: 2, peso: 3 },
    { nome: 'Instrumentos de Medi√ß√£o', categoria: 'Instrumentos', ordem: 3, peso: 2 },
    { nome: 'Paqu√≠metro', categoria: 'Instrumentos', ordem: 4, peso: 2 },
    { nome: 'Micr√¥metro', categoria: 'Instrumentos', ordem: 5, peso: 2 },
    { nome: 'Calibra√ß√£o', categoria: 'Calibra√ß√£o', ordem: 6, peso: 3 },
    { nome: 'Incerteza de Medi√ß√£o', categoria: 'An√°lise', ordem: 7, peso: 2 },
    { nome: 'Toler√¢ncias e Ajustes', categoria: 'Especifica√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Inmetro', categoria: '√ìrg√£os', ordem: 9, peso: 2 },
    { nome: 'Normas ISO de Metrologia', categoria: 'Normas', ordem: 10, peso: 2 }
  ],
  'Gest√£o Ambiental': [
    { nome: 'Introdu√ß√£o √† Gest√£o Ambiental', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Pol√≠tica Nacional do Meio Ambiente', categoria: 'Legisla√ß√£o', ordem: 2, peso: 3 },
    { nome: 'Licenciamento Ambiental', categoria: 'Instrumentos', ordem: 3, peso: 3 },
    { nome: 'Estudo de Impacto Ambiental', categoria: 'Avalia√ß√£o', ordem: 4, peso: 2 },
    { nome: 'ISO 14001', categoria: 'Normas', ordem: 5, peso: 3 },
    { nome: 'Recursos H√≠dricos', categoria: 'Recursos', ordem: 6, peso: 2 },
    { nome: 'Res√≠duos S√≥lidos', categoria: 'Res√≠duos', ordem: 7, peso: 2 },
    { nome: 'Mudan√ßas Clim√°ticas', categoria: 'Clima', ordem: 8, peso: 2 },
    { nome: 'Desenvolvimento Sustent√°vel', categoria: 'Sustentabilidade', ordem: 9, peso: 2 },
    { nome: 'Educa√ß√£o Ambiental', categoria: 'Educa√ß√£o', ordem: 10, peso: 2 }
  ],
  'Agricultura': [
    { nome: 'Solos', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Climatologia Agr√≠cola', categoria: 'Clima', ordem: 2, peso: 2 },
    { nome: 'Culturas Anuais', categoria: 'Culturas', ordem: 3, peso: 2 },
    { nome: 'Culturas Perenes', categoria: 'Culturas', ordem: 4, peso: 2 },
    { nome: 'Fertiliza√ß√£o', categoria: 'Manejo', ordem: 5, peso: 2 },
    { nome: 'Irriga√ß√£o e Drenagem', categoria: '√Ågua', ordem: 6, peso: 2 },
    { nome: 'Fitossanidade', categoria: 'Prote√ß√£o', ordem: 7, peso: 3 },
    { nome: 'Mecaniza√ß√£o Agr√≠cola', categoria: 'Tecnologia', ordem: 8, peso: 2 },
    { nome: 'Agroneg√≥cio', categoria: 'Economia', ordem: 9, peso: 2 },
    { nome: 'Agricultura Sustent√°vel', categoria: 'Sustentabilidade', ordem: 10, peso: 2 }
  ],
  'Zootecnia': [
    { nome: 'Nutri√ß√£o Animal', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Reprodu√ß√£o Animal', categoria: 'Reprodu√ß√£o', ordem: 2, peso: 2 },
    { nome: 'Gen√©tica Animal', categoria: 'Gen√©tica', ordem: 3, peso: 2 },
    { nome: 'Bovinocultura de Leite', categoria: 'Bovinos', ordem: 4, peso: 2 },
    { nome: 'Bovinocultura de Corte', categoria: 'Bovinos', ordem: 5, peso: 2 },
    { nome: 'Suinocultura', categoria: 'Su√≠nos', ordem: 6, peso: 2 },
    { nome: 'Avicultura', categoria: 'Aves', ordem: 7, peso: 2 },
    { nome: 'Pastagens', categoria: 'Forrageiras', ordem: 8, peso: 2 },
    { nome: 'Sanidade Animal', categoria: 'Sanidade', ordem: 9, peso: 3 },
    { nome: 'Bem-estar Animal', categoria: '√âtica', ordem: 10, peso: 2 }
  ],
  'Medicina Veterin√°ria': [
    { nome: 'Anatomia Veterin√°ria', categoria: 'B√°sicas', ordem: 1, peso: 2 },
    { nome: 'Fisiologia Veterin√°ria', categoria: 'B√°sicas', ordem: 2, peso: 2 },
    { nome: 'Patologia Veterin√°ria', categoria: 'Patologia', ordem: 3, peso: 3 },
    { nome: 'Cl√≠nica Veterin√°ria', categoria: 'Cl√≠nica', ordem: 4, peso: 3 },
    { nome: 'Cirurgia Veterin√°ria', categoria: 'Cirurgia', ordem: 5, peso: 2 },
    { nome: 'Doen√ßas Infecciosas', categoria: 'Doen√ßas', ordem: 6, peso: 3 },
    { nome: 'Parasitologia Veterin√°ria', categoria: 'Parasitologia', ordem: 7, peso: 2 },
    { nome: 'Farmacologia Veterin√°ria', categoria: 'Farmacologia', ordem: 8, peso: 2 },
    { nome: 'Inspe√ß√£o Sanit√°ria', categoria: 'Sa√∫de P√∫blica', ordem: 9, peso: 2 },
    { nome: 'Defesa Sanit√°ria', categoria: 'Sa√∫de P√∫blica', ordem: 10, peso: 2 }
  ],
  'Enfermagem': [
    { nome: 'Fundamentos de Enfermagem', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Semiologia', categoria: 'Semiologia', ordem: 2, peso: 3 },
    { nome: 'Processo de Enfermagem', categoria: 'Processo', ordem: 3, peso: 2 },
    { nome: 'Administra√ß√£o em Enfermagem', categoria: 'Gest√£o', ordem: 4, peso: 2 },
    { nome: 'Enfermagem Cl√≠nica', categoria: 'Cl√≠nica', ordem: 5, peso: 3 },
    { nome: 'Enfermagem Cir√∫rgica', categoria: 'Cir√∫rgica', ordem: 6, peso: 2 },
    { nome: 'Urg√™ncia e Emerg√™ncia', categoria: 'Emerg√™ncia', ordem: 7, peso: 3 },
    { nome: 'Sa√∫de Coletiva', categoria: 'Coletiva', ordem: 8, peso: 2 },
    { nome: 'Enfermagem Obst√©trica', categoria: 'Obst√©trica', ordem: 9, peso: 2 },
    { nome: '√âtica em Enfermagem', categoria: '√âtica', ordem: 10, peso: 2 }
  ],
  'Fisioterapia': [
    { nome: 'Anatomia do Movimento', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Cinesiologia', categoria: 'Fundamentos', ordem: 2, peso: 3 },
    { nome: 'Avalia√ß√£o Fisioterap√™utica', categoria: 'Avalia√ß√£o', ordem: 3, peso: 3 },
    { nome: 'Fisioterapia Ortop√©dica', categoria: 'Ortopedia', ordem: 4, peso: 3 },
    { nome: 'Fisioterapia Neurol√≥gica', categoria: 'Neurologia', ordem: 5, peso: 2 },
    { nome: 'Fisioterapia Respirat√≥ria', categoria: 'Respirat√≥ria', ordem: 6, peso: 3 },
    { nome: 'Fisioterapia Desportiva', categoria: 'Desportiva', ordem: 7, peso: 2 },
    { nome: 'Recursos Terap√™uticos', categoria: 'Recursos', ordem: 8, peso: 2 },
    { nome: 'Eletroterapia', categoria: 'Recursos', ordem: 9, peso: 2 },
    { nome: 'Reabilita√ß√£o', categoria: 'Reabilita√ß√£o', ordem: 10, peso: 2 }
  ],
  'Odontologia': [
    { nome: 'Anatomia Dent√°ria', categoria: 'B√°sicas', ordem: 1, peso: 2 },
    { nome: 'Histologia Oral', categoria: 'B√°sicas', ordem: 2, peso: 2 },
    { nome: 'Radiologia Odontol√≥gica', categoria: 'Diagn√≥stico', ordem: 3, peso: 2 },
    { nome: 'Dent√≠stica', categoria: 'Restauradora', ordem: 4, peso: 3 },
    { nome: 'Endodontia', categoria: 'Especialidades', ordem: 5, peso: 3 },
    { nome: 'Periodontia', categoria: 'Especialidades', ordem: 6, peso: 2 },
    { nome: 'Cirurgia Oral', categoria: 'Cirurgia', ordem: 7, peso: 2 },
    { nome: 'Pr√≥tese Dent√°ria', categoria: 'Reabilita√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Ortodontia', categoria: 'Especialidades', ordem: 9, peso: 2 },
    { nome: 'Odontopediatria', categoria: 'Especialidades', ordem: 10, peso: 2 }
  ],
  'Nutri√ß√£o': [
    { nome: 'Bioqu√≠mica da Nutri√ß√£o', categoria: 'B√°sicas', ordem: 1, peso: 2 },
    { nome: 'Fisiologia da Nutri√ß√£o', categoria: 'B√°sicas', ordem: 2, peso: 2 },
    { nome: 'Avalia√ß√£o Nutricional', categoria: 'Avalia√ß√£o', ordem: 3, peso: 3 },
    { nome: 'Dietoterapia', categoria: 'Cl√≠nica', ordem: 4, peso: 3 },
    { nome: 'Nutri√ß√£o Cl√≠nica', categoria: 'Cl√≠nica', ordem: 5, peso: 3 },
    { nome: 'Nutri√ß√£o Esportiva', categoria: 'Esportiva', ordem: 6, peso: 2 },
    { nome: 'Alimenta√ß√£o Coletiva', categoria: 'Coletiva', ordem: 7, peso: 2 },
    { nome: 'Seguran√ßa Alimentar', categoria: 'Sa√∫de P√∫blica', ordem: 8, peso: 2 },
    { nome: 'Tecnologia de Alimentos', categoria: 'Tecnologia', ordem: 9, peso: 2 },
    { nome: 'Nutri√ß√£o Materno-Infantil', categoria: 'Materno-Infantil', ordem: 10, peso: 2 }
  ],
  'Farm√°cia': [
    { nome: 'Farmacologia Geral', categoria: 'Farmacologia', ordem: 1, peso: 3 },
    { nome: 'Farmacocin√©tica', categoria: 'Farmacologia', ordem: 2, peso: 2 },
    { nome: 'Farmacot√©cnica', categoria: 'Tecnologia', ordem: 3, peso: 3 },
    { nome: 'Qu√≠mica Farmac√™utica', categoria: 'Qu√≠mica', ordem: 4, peso: 2 },
    { nome: 'Controle de Qualidade', categoria: 'Qualidade', ordem: 5, peso: 2 },
    { nome: 'Farm√°cia Cl√≠nica', categoria: 'Cl√≠nica', ordem: 6, peso: 3 },
    { nome: 'Aten√ß√£o Farmac√™utica', categoria: 'Cl√≠nica', ordem: 7, peso: 2 },
    { nome: 'Farm√°cia Hospitalar', categoria: 'Hospitalar', ordem: 8, peso: 2 },
    { nome: 'An√°lises Cl√≠nicas', categoria: 'An√°lises', ordem: 9, peso: 2 },
    { nome: 'Legisla√ß√£o Farmac√™utica', categoria: 'Legisla√ß√£o', ordem: 10, peso: 2 }
  ],
  'Servi√ßo Social': [
    { nome: 'Fundamentos do Servi√ßo Social', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Quest√£o Social', categoria: 'Teoria', ordem: 2, peso: 3 },
    { nome: 'Pol√≠ticas Sociais', categoria: 'Pol√≠ticas', ordem: 3, peso: 3 },
    { nome: 'SUAS - Sistema √önico de Assist√™ncia', categoria: 'SUAS', ordem: 4, peso: 3 },
    { nome: 'CRAS e CREAS', categoria: 'SUAS', ordem: 5, peso: 2 },
    { nome: 'Legisla√ß√£o da Assist√™ncia Social', categoria: 'Legisla√ß√£o', ordem: 6, peso: 2 },
    { nome: 'Instrumentos e T√©cnicas', categoria: 'Pr√°tica', ordem: 7, peso: 2 },
    { nome: 'Trabalho com Fam√≠lias', categoria: 'Interven√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Direitos Sociais', categoria: 'Direitos', ordem: 9, peso: 2 },
    { nome: '√âtica Profissional', categoria: '√âtica', ordem: 10, peso: 2 }
  ],
  'Ci√™ncias Cont√°beis': [
    { nome: 'Teoria da Contabilidade', categoria: 'Teoria', ordem: 1, peso: 2 },
    { nome: 'Contabilidade Comercial', categoria: 'Comercial', ordem: 2, peso: 3 },
    { nome: 'Contabilidade de Custos', categoria: 'Custos', ordem: 3, peso: 3 },
    { nome: 'Contabilidade Gerencial', categoria: 'Gerencial', ordem: 4, peso: 2 },
    { nome: 'Contabilidade Tribut√°ria', categoria: 'Tribut√°ria', ordem: 5, peso: 3 },
    { nome: 'Per√≠cia Cont√°bil', categoria: 'Per√≠cia', ordem: 6, peso: 2 },
    { nome: 'Controladoria', categoria: 'Controladoria', ordem: 7, peso: 2 },
    { nome: 'Normas Brasileiras de Contabilidade', categoria: 'Normas', ordem: 8, peso: 2 },
    { nome: 'Contabilidade Avan√ßada', categoria: 'Avan√ßada', ordem: 9, peso: 2 },
    { nome: 'Legisla√ß√£o Societ√°ria', categoria: 'Legisla√ß√£o', ordem: 10, peso: 2 }
  ],
  'Arquitetura e Urbanismo': [
    { nome: 'Hist√≥ria da Arquitetura', categoria: 'Hist√≥ria', ordem: 1, peso: 2 },
    { nome: 'Projeto Arquitet√¥nico', categoria: 'Projeto', ordem: 3, peso: 3 },
    { nome: 'Desenho T√©cnico', categoria: 'Representa√ß√£o', ordem: 3, peso: 2 },
    { nome: 'Urbanismo', categoria: 'Urbanismo', ordem: 4, peso: 3 },
    { nome: 'Planejamento Urbano', categoria: 'Planejamento', ordem: 5, peso: 2 },
    { nome: 'Conforto Ambiental', categoria: 'Conforto', ordem: 6, peso: 2 },
    { nome: 'Estruturas', categoria: 'T√©cnicas', ordem: 7, peso: 2 },
    { nome: 'Instala√ß√µes Prediais', categoria: 'T√©cnicas', ordem: 8, peso: 2 },
    { nome: 'Legisla√ß√£o Urban√≠stica', categoria: 'Legisla√ß√£o', ordem: 9, peso: 2 },
    { nome: 'Sustentabilidade na Arquitetura', categoria: 'Sustentabilidade', ordem: 10, peso: 2 }
  ],
  'Engenharia Civil': [
    { nome: 'Mec√¢nica dos Solos', categoria: 'Geotecnia', ordem: 1, peso: 2 },
    { nome: 'Funda√ß√µes', categoria: 'Geotecnia', ordem: 2, peso: 2 },
    { nome: 'Resist√™ncia dos Materiais', categoria: 'Estruturas', ordem: 3, peso: 3 },
    { nome: 'Estruturas de Concreto', categoria: 'Estruturas', ordem: 4, peso: 3 },
    { nome: 'Estruturas de A√ßo', categoria: 'Estruturas', ordem: 5, peso: 2 },
    { nome: 'Instala√ß√µes Hidr√°ulicas', categoria: 'Instala√ß√µes', ordem: 6, peso: 2 },
    { nome: 'Instala√ß√µes El√©tricas', categoria: 'Instala√ß√µes', ordem: 7, peso: 2 },
    { nome: 'Constru√ß√£o Civil', categoria: 'Constru√ß√£o', ordem: 8, peso: 3 },
    { nome: 'Gerenciamento de Obras', categoria: 'Gest√£o', ordem: 9, peso: 2 },
    { nome: 'Or√ßamento e Custos', categoria: 'Gest√£o', ordem: 10, peso: 2 }
  ],
  'Engenharia El√©trica': [
    { nome: 'Circuitos El√©tricos', categoria: 'Fundamentos', ordem: 1, peso: 3 },
    { nome: 'Eletromagnetismo', categoria: 'Fundamentos', ordem: 2, peso: 2 },
    { nome: 'Eletr√¥nica Anal√≥gica', categoria: 'Eletr√¥nica', ordem: 3, peso: 2 },
    { nome: 'Eletr√¥nica Digital', categoria: 'Eletr√¥nica', ordem: 4, peso: 3 },
    { nome: 'M√°quinas El√©tricas', categoria: 'M√°quinas', ordem: 5, peso: 2 },
    { nome: 'Sistemas de Pot√™ncia', categoria: 'Pot√™ncia', ordem: 6, peso: 3 },
    { nome: 'Instala√ß√µes El√©tricas', categoria: 'Instala√ß√µes', ordem: 7, peso: 2 },
    { nome: 'Controle e Automa√ß√£o', categoria: 'Automa√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Telecomunica√ß√µes', categoria: 'Telecomunica√ß√µes', ordem: 9, peso: 2 },
    { nome: 'Efici√™ncia Energ√©tica', categoria: 'Energia', ordem: 10, peso: 2 }
  ],
  'Engenharia Mec√¢nica': [
    { nome: 'Termodin√¢mica', categoria: 'T√©rmica', ordem: 1, peso: 3 },
    { nome: 'Mec√¢nica dos Fluidos', categoria: 'Fluidos', ordem: 2, peso: 2 },
    { nome: 'Transfer√™ncia de Calor', categoria: 'T√©rmica', ordem: 3, peso: 2 },
    { nome: 'Elementos de M√°quinas', categoria: 'M√°quinas', ordem: 4, peso: 3 },
    { nome: 'Processos de Fabrica√ß√£o', categoria: 'Fabrica√ß√£o', ordem: 5, peso: 2 },
    { nome: 'M√°quinas T√©rmicas', categoria: 'T√©rmica', ordem: 6, peso: 2 },
    { nome: 'Sistemas Hidr√°ulicos', categoria: 'Hidr√°ulica', ordem: 7, peso: 2 },
    { nome: 'Manuten√ß√£o Industrial', categoria: 'Manuten√ß√£o', ordem: 8, peso: 2 },
    { nome: 'Projetos Mec√¢nicos', categoria: 'Projetos', ordem: 9, peso: 3 },
    { nome: 'Automa√ß√£o Industrial', categoria: 'Automa√ß√£o', ordem: 10, peso: 2 }
  ],
  'Direito Internacional Privado': [
    { nome: 'Fontes do DIP', categoria: 'Fundamentos', ordem: 1, peso: 2 },
    { nome: 'Conflito de Leis', categoria: 'Conflitos', ordem: 2, peso: 3 },
    { nome: 'Nacionalidade', categoria: 'Nacionalidade', ordem: 3, peso: 2 },
    { nome: 'Domic√≠lio Internacional', categoria: 'Domic√≠lio', ordem: 4, peso: 2 },
    { nome: 'Contratos Internacionais', categoria: 'Obriga√ß√µes', ordem: 5, peso: 3 },
    { nome: 'Arbitragem Internacional', categoria: 'Solu√ß√£o de Conflitos', ordem: 6, peso: 2 },
    { nome: 'Reconhecimento de Senten√ßas', categoria: 'Coopera√ß√£o', ordem: 7, peso: 2 },
    { nome: 'Fam√≠lia Internacional', categoria: 'Fam√≠lia', ordem: 8, peso: 2 },
    { nome: 'Sucess√µes Internacionais', categoria: 'Sucess√µes', ordem: 9, peso: 2 },
    { nome: 'Com√©rcio Internacional', categoria: 'Com√©rcio', ordem: 10, peso: 2 }
  ]
}

// ============== ROTAS DE ENTREVISTA ==============
app.post('/api/interviews', async (c) => {
  const { DB } = c.env
  const data = await c.req.json()

  try {
    // Validar que h√° disciplinas
    if (!data.disciplinas || data.disciplinas.length === 0) {
      return c.json({ 
        error: 'Voc√™ precisa selecionar pelo menos uma disciplina para continuar',
        code: 'NO_DISCIPLINES'
      }, 400)
    }

    // Inserir entrevista
    const interview = await DB.prepare(`
      INSERT INTO interviews (
        user_id, objetivo_tipo, concurso_nome, cargo, area_geral,
        tempo_disponivel_dia, experiencia, ja_estudou_antes,
        prazo_prova, reprovacoes
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.user_id,
      data.objetivo_tipo,
      data.concurso_nome || null,
      data.cargo || null,
      data.area_geral || null,
      data.tempo_disponivel_dia,
      data.experiencia,
      data.ja_estudou_antes ? 1 : 0,
      data.prazo_prova || null,
      data.reprovacoes
    ).run()

    const interview_id = interview.meta.last_row_id

    // Inserir ou atualizar disciplinas do usu√°rio
    if (data.disciplinas && data.disciplinas.length > 0) {
      for (const disc of data.disciplinas) {
        // Usar INSERT OR REPLACE para evitar erro de duplicidade
        await DB.prepare(`
          INSERT OR REPLACE INTO user_disciplinas (
            user_id, disciplina_id, ja_estudou, nivel_atual, dificuldade, updated_at
          ) VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(
          data.user_id,
          disc.disciplina_id,
          disc.ja_estudou ? 1 : 0,
          disc.nivel_atual || 0,
          disc.dificuldade ? 1 : 0
        ).run()
        
        // Popular t√≥picos do edital para essa disciplina
        await popularTopicosEdital(DB, disc.disciplina_id)
      }
    }

    // Gerar diagn√≥stico
    const diagnostico = await gerarDiagnostico(DB, data.user_id, interview_id)

    // üÜï CRIAR PLANO AUTOMATICAMENTE
    try {
      console.log('üéØ Criando plano automaticamente para entrevista', interview_id)
      
      // Buscar disciplinas do usu√°rio rec√©m-inseridas
      const { results: userDisciplinas } = await DB.prepare(`
        SELECT ud.*, d.nome, d.area 
        FROM user_disciplinas ud
        JOIN disciplinas d ON ud.disciplina_id = d.id
        WHERE ud.user_id = ?
      `).bind(data.user_id).all()
      
      // Buscar entrevista completa
      const interview = await DB.prepare('SELECT * FROM interviews WHERE id = ?').bind(interview_id).first()
      
      // Gerar diagn√≥stico completo e mapa de prioridades
      const diagnosticoCompleto = gerarDiagnosticoCompleto(interview, userDisciplinas)
      const mapaPrioridades = gerarMapaPrioridades(userDisciplinas)
      
      // Desativar planos antigos
      await DB.prepare('UPDATE planos_estudo SET ativo = 0 WHERE user_id = ?').bind(data.user_id).run()
      
      // Criar novo plano
      const planoResult = await DB.prepare(`
        INSERT INTO planos_estudo (
          user_id, interview_id, diagnostico, mapa_prioridades, ativo, nome
        ) VALUES (?, ?, ?, ?, 1, ?)
      `).bind(
        data.user_id,
        interview_id,
        JSON.stringify(diagnosticoCompleto),
        JSON.stringify(mapaPrioridades),
        `Plano ${data.concurso_nome || data.area_geral || 'Novo'}`
      ).run()
      
      const plano_id = planoResult.meta.last_row_id
      console.log(`‚úÖ Plano ${plano_id} criado com sucesso!`)
      
      // Gerar ciclos de estudo
      await gerarCiclosEstudo(DB, plano_id, userDisciplinas, interview.tempo_disponivel_dia)
      console.log('‚úÖ Ciclos de estudo gerados!')
      
      return c.json({ 
        interview_id,
        plano_id,
        diagnostico,
        message: 'Entrevista e plano criados com sucesso!'
      })
    } catch (planError) {
      console.error('‚ùå Erro ao criar plano autom√°tico:', planError)
      // Retorna a entrevista mesmo se o plano falhar
      return c.json({ 
        interview_id, 
        diagnostico,
        warning: 'Entrevista criada, mas houve erro ao criar o plano. Use POST /api/planos para criar manualmente.'
      })
    }
  } catch (error) {
    console.error('Erro ao salvar entrevista:', error)
    return c.json({ error: 'Erro ao salvar entrevista' }, 500)
  }
})

app.get('/api/interviews/user/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  const { results } = await DB.prepare(
    'SELECT * FROM interviews WHERE user_id = ? ORDER BY created_at DESC'
  ).bind(user_id).all()

  return c.json(results)
})

// ============== ROTAS DE PLANO DE ESTUDOS ==============
app.post('/api/planos', async (c) => {
  const { DB } = c.env
  const { user_id, interview_id } = await c.req.json()

  try {
    // Buscar dados da entrevista
    const interview = await DB.prepare(
      'SELECT * FROM interviews WHERE id = ?'
    ).bind(interview_id).first()

    if (!interview) {
      return c.json({ error: 'Entrevista n√£o encontrada' }, 404)
    }

    // Buscar disciplinas do usu√°rio
    const { results: userDisciplinas } = await DB.prepare(`
      SELECT ud.*, d.nome, d.area 
      FROM user_disciplinas ud
      JOIN disciplinas d ON ud.disciplina_id = d.id
      WHERE ud.user_id = ?
    `).bind(user_id).all()

    // Gerar diagn√≥stico e plano
    const diagnostico = gerarDiagnosticoCompleto(interview, userDisciplinas)
    const mapaPrioridades = gerarMapaPrioridades(userDisciplinas)

    // üÜï Desativar planos antigos
    await DB.prepare('UPDATE planos_estudo SET ativo = 0 WHERE user_id = ?').bind(user_id).run()

    // Salvar plano com nome autom√°tico
    const plano = await DB.prepare(`
      INSERT INTO planos_estudo (
        user_id, interview_id, diagnostico, mapa_prioridades, ativo, nome
      ) VALUES (?, ?, ?, ?, 1, ?)
    `).bind(
      user_id,
      interview_id,
      JSON.stringify(diagnostico),
      JSON.stringify(mapaPrioridades),
      `Plano ${interview.concurso_nome || interview.area_geral || 'Novo'}`
    ).run()

    const plano_id = plano.meta.last_row_id

    // Gerar ciclos de estudo
    await gerarCiclosEstudo(DB, plano_id, userDisciplinas, interview.tempo_disponivel_dia)

    return c.json({ 
      plano_id,
      diagnostico,
      mapa_prioridades: mapaPrioridades,
      message: 'Plano criado com sucesso!'
    })
  } catch (error) {
    console.error('Erro ao gerar plano:', error)
    return c.json({ error: 'Erro ao gerar plano de estudos' }, 500)
  }
})

// Listar TODOS os planos do usu√°rio (ativos e inativos)
app.get('/api/planos/list/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  const { results: planos } = await DB.prepare(`
    SELECT 
      p.*,
      i.objetivo_tipo,
      i.concurso_nome,
      i.area_geral,
      i.tempo_disponivel_dia,
      COUNT(DISTINCT ce.disciplina_id) as total_disciplinas,
      COUNT(DISTINCT md.id) as total_metas,
      SUM(CASE WHEN md.concluida = 1 THEN 1 ELSE 0 END) as metas_concluidas
    FROM planos_estudo p
    LEFT JOIN interviews i ON p.interview_id = i.id
    LEFT JOIN ciclos_estudo ce ON p.id = ce.plano_id
    LEFT JOIN metas_diarias md ON p.id = md.plano_id
    WHERE p.user_id = ?
    GROUP BY p.id
    ORDER BY p.created_at DESC
  `).bind(user_id).all()

  return c.json(planos.map(p => ({
    ...p,
    diagnostico: p.diagnostico ? JSON.parse(p.diagnostico) : null,
    mapa_prioridades: p.mapa_prioridades ? JSON.parse(p.mapa_prioridades) : null
  })))
})

// Ativar um plano espec√≠fico (desativa os outros)
app.post('/api/planos/:plano_id/ativar', async (c) => {
  const { DB } = c.env
  const plano_id = c.req.param('plano_id')
  
  try {
    // Buscar o plano
    const plano = await DB.prepare('SELECT * FROM planos_estudo WHERE id = ?').bind(plano_id).first()
    if (!plano) {
      return c.json({ error: 'Plano n√£o encontrado' }, 404)
    }
    
    // Desativar todos os planos do usu√°rio
    await DB.prepare('UPDATE planos_estudo SET ativo = 0 WHERE user_id = ?').bind(plano.user_id).run()
    
    // Ativar o plano selecionado
    await DB.prepare('UPDATE planos_estudo SET ativo = 1 WHERE id = ?').bind(plano_id).run()
    
    return c.json({ success: true, message: 'Plano ativado com sucesso' })
  } catch (error) {
    console.error('Erro ao ativar plano:', error)
    return c.json({ error: 'Erro ao ativar plano' }, 500)
  }
})

// Buscar plano ativo do usu√°rio
app.get('/api/planos/user/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  const plano = await DB.prepare(
    'SELECT * FROM planos_estudo WHERE user_id = ? AND ativo = 1 ORDER BY created_at DESC LIMIT 1'
  ).bind(user_id).first()

  if (!plano) {
    return c.json({ error: 'Nenhum plano ativo encontrado' }, 404)
  }

  // Buscar ciclos do plano
  const { results: ciclos } = await DB.prepare(`
    SELECT c.*, d.nome as disciplina_nome
    FROM ciclos_estudo c
    JOIN disciplinas d ON c.disciplina_id = d.id
    WHERE c.plano_id = ?
    ORDER BY c.dia_semana, c.ordem
  `).bind(plano.id).all()

  return c.json({
    ...plano,
    diagnostico: JSON.parse(plano.diagnostico),
    mapa_prioridades: JSON.parse(plano.mapa_prioridades),
    ciclos
  })
})

// Recriar ciclos de um plano (√∫til para aplicar novas regras)
app.post('/api/planos/:plano_id/recriar-ciclos', async (c) => {
  const { DB } = c.env
  const plano_id = c.req.param('plano_id')
  
  try {
    // Buscar plano
    const plano = await DB.prepare('SELECT * FROM planos_estudo WHERE id = ?').bind(plano_id).first()
    if (!plano) {
      return c.json({ error: 'Plano n√£o encontrado' }, 404)
    }
    
    // Buscar interview para pegar tempo dispon√≠vel
    const interview = await DB.prepare('SELECT * FROM interviews WHERE id = ?').bind(plano.interview_id).first()
    if (!interview) {
      return c.json({ error: 'Entrevista n√£o encontrada' }, 404)
    }
    
    // Buscar disciplinas do usu√°rio
    const { results: userDisciplinas } = await DB.prepare(`
      SELECT ud.*, d.nome, d.area 
      FROM user_disciplinas ud
      JOIN disciplinas d ON ud.disciplina_id = d.id
      WHERE ud.user_id = ?
    `).bind(plano.user_id).all()
    
    // Ordem de dele√ß√£o (respeitando foreign keys):
    // 1. conteudo_estudo (referencia metas_diarias)
    // 2. metas_diarias (referencia ciclos_estudo)
    // 3. ciclos_estudo (referencia plano)
    
    console.log('üóëÔ∏è Deletando conte√∫dos vinculados √†s metas...')
    const conteudoResult = await DB.prepare(`
      DELETE FROM conteudo_estudo 
      WHERE meta_id IN (SELECT id FROM metas_diarias WHERE plano_id = ?)
    `).bind(plano_id).run()
    console.log(`‚úÖ ${conteudoResult.meta.changes} conte√∫dos deletados`)
    
    console.log('üóëÔ∏è Deletando metas antigas...')
    const metasResult = await DB.prepare('DELETE FROM metas_diarias WHERE plano_id = ?').bind(plano_id).run()
    console.log(`‚úÖ ${metasResult.meta.changes} metas deletadas`)
    
    console.log('üóëÔ∏è Deletando ciclos antigos...')
    const ciclosResult = await DB.prepare('DELETE FROM ciclos_estudo WHERE plano_id = ?').bind(plano_id).run()
    console.log(`‚úÖ ${ciclosResult.meta.changes} ciclos deletados`)
    
    console.log('üîÑ Gerando novos ciclos...')
    // Recriar ciclos com nova l√≥gica
    await gerarCiclosEstudo(DB, plano_id, userDisciplinas, interview.tempo_disponivel_dia)
    console.log('‚úÖ Ciclos recriados com sucesso!')
    
    return c.json({ success: true, message: 'Ciclos recriados com sucesso' })
  } catch (error) {
    console.error('Erro ao recriar ciclos:', error)
    return c.json({ error: 'Erro ao recriar ciclos' }, 500)
  }
})

// ============== GEST√ÉO DE PLANOS ==============

// Renomear plano
app.put('/api/planos/:plano_id/nome', async (c) => {
  const { DB } = c.env
  const plano_id = c.req.param('plano_id')
  const { nome } = await c.req.json()
  
  try {
    if (!nome || nome.trim().length === 0) {
      return c.json({ error: 'Nome n√£o pode ser vazio' }, 400)
    }
    
    if (nome.length > 100) {
      return c.json({ error: 'Nome muito longo (m√°ximo 100 caracteres)' }, 400)
    }
    
    // Verificar se o plano existe
    const plano = await DB.prepare('SELECT * FROM planos_estudo WHERE id = ?').bind(plano_id).first()
    if (!plano) {
      return c.json({ error: 'Plano n√£o encontrado' }, 404)
    }
    
    // Atualizar nome
    await DB.prepare('UPDATE planos_estudo SET nome = ? WHERE id = ?').bind(nome.trim(), plano_id).run()
    
    return c.json({ 
      success: true, 
      message: 'Plano renomeado com sucesso',
      nome: nome.trim()
    })
  } catch (error) {
    console.error('Erro ao renomear plano:', error)
    return c.json({ error: 'Erro ao renomear plano' }, 500)
  }
})

// Excluir plano (com cascata manual)
app.delete('/api/planos/:plano_id', async (c) => {
  const { DB } = c.env
  const plano_id = c.req.param('plano_id')
  
  try {
    // Verificar se o plano existe
    const plano = await DB.prepare('SELECT * FROM planos_estudo WHERE id = ?').bind(plano_id).first()
    if (!plano) {
      return c.json({ error: 'Plano n√£o encontrado' }, 404)
    }
    
    // Verificar se n√£o √© o √∫nico plano do usu√°rio
    const { results: planosUsuario } = await DB.prepare(
      'SELECT id FROM planos_estudo WHERE user_id = ?'
    ).bind(plano.user_id).all()
    
    if (planosUsuario.length === 1) {
      return c.json({ 
        error: 'N√£o √© poss√≠vel excluir o √∫nico plano. Crie um novo plano antes de excluir este.',
        code: 'ULTIMO_PLANO'
      }, 400)
    }
    
    console.log(`üóëÔ∏è Iniciando exclus√£o do plano ${plano_id}...`)
    
    // Exclus√£o em cascata manual (ordem correta para respeitar FKs)
    
    // 1. Deletar conte√∫dos gerados (refer√™ncia em metas_diarias via meta_id)
    console.log('üóëÔ∏è Deletando conte√∫dos vinculados a metas...')
    await DB.prepare(`
      DELETE FROM conteudo_estudo 
      WHERE meta_id IN (SELECT id FROM metas_diarias WHERE plano_id = ?)
    `).bind(plano_id).run()
    
    // 2. Deletar metas di√°rias
    console.log('üóëÔ∏è Deletando metas di√°rias...')
    const metasResult = await DB.prepare('DELETE FROM metas_diarias WHERE plano_id = ?').bind(plano_id).run()
    console.log(`‚úÖ ${metasResult.meta.changes} metas deletadas`)
    
    // 3. Deletar ciclos
    console.log('üóëÔ∏è Deletando ciclos de estudo...')
    const ciclosResult = await DB.prepare('DELETE FROM ciclos_estudo WHERE plano_id = ?').bind(plano_id).run()
    console.log(`‚úÖ ${ciclosResult.meta.changes} ciclos deletados`)
    
    // 4. Deletar o plano
    console.log('üóëÔ∏è Deletando plano...')
    await DB.prepare('DELETE FROM planos_estudo WHERE id = ?').bind(plano_id).run()
    console.log(`‚úÖ Plano ${plano_id} deletado com sucesso!`)
    
    // 5. Se o plano deletado era o ativo, ativar o mais recente
    if (plano.ativo === 1) {
      console.log('üîÑ Ativando plano mais recente...')
      const planoMaisRecente = await DB.prepare(
        'SELECT id FROM planos_estudo WHERE user_id = ? ORDER BY created_at DESC LIMIT 1'
      ).bind(plano.user_id).first()
      
      if (planoMaisRecente) {
        await DB.prepare('UPDATE planos_estudo SET ativo = 0 WHERE user_id = ?').bind(plano.user_id).run()
        await DB.prepare('UPDATE planos_estudo SET ativo = 1 WHERE id = ?').bind(planoMaisRecente.id).run()
        console.log(`‚úÖ Plano ${planoMaisRecente.id} ativado automaticamente`)
      }
    }
    
    return c.json({ 
      success: true, 
      message: 'Plano exclu√≠do com sucesso',
      plano_id: parseInt(plano_id)
    })
  } catch (error) {
    console.error('Erro ao excluir plano:', error)
    return c.json({ error: 'Erro ao excluir plano', details: error.message }, 500)
  }
})

// Obter detalhes de um plano espec√≠fico
app.get('/api/planos/:plano_id', async (c) => {
  const { DB } = c.env
  const plano_id = c.req.param('plano_id')
  
  try {
    // Buscar plano com informa√ß√µes da entrevista
    const plano = await DB.prepare(`
      SELECT 
        p.*,
        i.objetivo_tipo,
        i.concurso_nome,
        i.cargo,
        i.area_geral,
        i.tempo_disponivel_dia,
        i.experiencia,
        i.ja_estudou_antes,
        i.prazo_prova
      FROM planos_estudo p
      LEFT JOIN interviews i ON p.interview_id = i.id
      WHERE p.id = ?
    `).bind(plano_id).first()
    
    if (!plano) {
      return c.json({ error: 'Plano n√£o encontrado' }, 404)
    }
    
    // Buscar ciclos
    const { results: ciclos } = await DB.prepare(`
      SELECT c.*, d.nome as disciplina_nome
      FROM ciclos_estudo c
      JOIN disciplinas d ON c.disciplina_id = d.id
      WHERE c.plano_id = ?
      ORDER BY c.dia_semana, c.ordem
    `).bind(plano_id).all()
    
    // Buscar estat√≠sticas
    const stats = await DB.prepare(`
      SELECT 
        COUNT(DISTINCT ce.disciplina_id) as total_disciplinas,
        COUNT(DISTINCT md.id) as total_metas,
        SUM(CASE WHEN md.concluida = 1 THEN 1 ELSE 0 END) as metas_concluidas,
        SUM(md.tempo_real_minutos) as tempo_total_estudado
      FROM planos_estudo p
      LEFT JOIN ciclos_estudo ce ON p.id = ce.plano_id
      LEFT JOIN metas_diarias md ON p.id = md.plano_id
      WHERE p.id = ?
    `).bind(plano_id).first()
    
    return c.json({
      ...plano,
      diagnostico: plano.diagnostico ? JSON.parse(plano.diagnostico) : null,
      mapa_prioridades: plano.mapa_prioridades ? JSON.parse(plano.mapa_prioridades) : null,
      ciclos,
      estatisticas: stats
    })
  } catch (error) {
    console.error('Erro ao buscar plano:', error)
    return c.json({ error: 'Erro ao buscar plano' }, 500)
  }
})

// Alias para compatibilidade
app.get('/api/plano/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  const plano = await DB.prepare(
    'SELECT * FROM planos_estudo WHERE user_id = ? AND ativo = 1 ORDER BY created_at DESC LIMIT 1'
  ).bind(user_id).first()

  if (!plano) {
    return c.json({ error: 'Nenhum plano ativo encontrado' }, 404)
  }

  // Buscar ciclos do plano
  const { results: ciclos } = await DB.prepare(`
    SELECT c.*, d.nome as disciplina_nome
    FROM ciclos_estudo c
    JOIN disciplinas d ON c.disciplina_id = d.id
    WHERE c.plano_id = ?
    ORDER BY c.dia_semana, c.ordem
  `).bind(plano.id).all()

  return c.json({
    ...plano,
    diagnostico: JSON.parse(plano.diagnostico),
    mapa_prioridades: JSON.parse(plano.mapa_prioridades),
    ciclos
  })
})

// ============== ROTAS DE METAS DI√ÅRIAS ==============
app.get('/api/metas/hoje/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')
  const hoje = new Date().toISOString().split('T')[0]

  const { results: metas } = await DB.prepare(`
    SELECT 
      m.*, 
      c.tipo, 
      c.tempo_minutos, 
      c.disciplina_id, 
      d.nome as disciplina_nome,
      CASE 
        WHEN EXISTS (
          SELECT 1 FROM conteudo_estudo ce WHERE ce.meta_id = m.id
        ) THEN 1 
        ELSE 0 
      END as conteudo_gerado,
      (SELECT ce.id FROM conteudo_estudo ce WHERE ce.meta_id = m.id LIMIT 1) as conteudo_id
    FROM metas_diarias m
    JOIN ciclos_estudo c ON m.ciclo_id = c.id
    JOIN disciplinas d ON c.disciplina_id = d.id
    WHERE m.user_id = ? AND m.data = ?
    ORDER BY c.ordem
  `).bind(user_id, hoje).all()

  return c.json(metas)
})

app.post('/api/metas/concluir', async (c) => {
  const { DB } = c.env
  const { meta_id, tempo_real_minutos } = await c.req.json()

  await DB.prepare(`
    UPDATE metas_diarias 
    SET concluida = 1, tempo_real_minutos = ?
    WHERE id = ?
  `).bind(tempo_real_minutos, meta_id).run()

  // Atualizar hist√≥rico do dia
  const meta = await DB.prepare('SELECT user_id, data FROM metas_diarias WHERE id = ?').bind(meta_id).first()
  if (meta) {
    await atualizarHistoricoDia(DB, meta.user_id, meta.data)
  }

  return c.json({ success: true })
})

// Atualizar meta (desmarcar conclus√£o ou editar)
app.put('/api/metas/:meta_id', async (c) => {
  const { DB } = c.env
  const meta_id = c.req.param('meta_id')
  const { concluida, tempo_estudado } = await c.req.json()

  await DB.prepare(`
    UPDATE metas_diarias 
    SET concluida = ?, tempo_real_minutos = ?
    WHERE id = ?
  `).bind(concluida ? 1 : 0, tempo_estudado || 0, meta_id).run()

  // Atualizar hist√≥rico do dia
  const meta = await DB.prepare('SELECT user_id, data FROM metas_diarias WHERE id = ?').bind(meta_id).first()
  if (meta) {
    await atualizarHistoricoDia(DB, meta.user_id, meta.data)
  }

  return c.json({ success: true })
})

// ============== ENDPOINTS DE CONTE√öDO GERADO ==============

// Visualizar conte√∫do gerado (com op√ß√£o de download)
app.get('/api/conteudo/:conteudo_id', async (c) => {
  const { DB } = c.env
  const conteudo_id = c.req.param('conteudo_id')
  const format = c.req.query('format') || 'json' // json, markdown, html

  try {
    const conteudo = await DB.prepare(`
      SELECT c.*, d.nome as disciplina_nome
      FROM conteudo_estudo c
      JOIN disciplinas d ON c.disciplina_id = d.id
      WHERE c.id = ?
    `).bind(conteudo_id).first()

    if (!conteudo) {
      return c.json({ error: 'Conte√∫do n√£o encontrado' }, 404)
    }

    const conteudoObj = {
      ...conteudo,
      topicos: JSON.parse(conteudo.topicos),
      objetivos: JSON.parse(conteudo.objetivos),
      conteudo: JSON.parse(conteudo.conteudo)
    }

    // Formato JSON (padr√£o)
    if (format === 'json') {
      return c.json(conteudoObj)
    }

    // Formato Markdown para download
    if (format === 'markdown' || format === 'md') {
      const markdown = gerarMarkdown(conteudoObj)
      return c.text(markdown, 200, {
        'Content-Type': 'text/markdown; charset=utf-8',
        'Content-Disposition': `attachment; filename="conteudo_${conteudo_id}_${conteudoObj.disciplina_nome.replace(/\s+/g, '_')}.md"`
      })
    }

    // Formato HTML para visualiza√ß√£o
    if (format === 'html') {
      const html = gerarHTML(conteudoObj)
      return c.html(html)
    }

    return c.json(conteudoObj)
  } catch (error) {
    console.error('Erro ao buscar conte√∫do:', error)
    return c.json({ error: 'Erro ao buscar conte√∫do' }, 500)
  }
})

// Listar todos os conte√∫dos gerados do usu√°rio
app.get('/api/conteudos/usuario/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')
  const limit = parseInt(c.req.query('limit') || '50')
  const offset = parseInt(c.req.query('offset') || '0')

  try {
    const { results: conteudos } = await DB.prepare(`
      SELECT 
        c.id,
        c.tipo,
        c.disciplina_id,
        c.topicos,
        c.created_at,
        d.nome as disciplina_nome,
        m.data as data_estudo
      FROM conteudo_estudo c
      JOIN disciplinas d ON c.disciplina_id = d.id
      LEFT JOIN metas_diarias m ON c.meta_id = m.id
      WHERE c.user_id = ?
      ORDER BY c.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(user_id, limit, offset).all()

    const conteudosFormatados = conteudos.map(c => ({
      ...c,
      topicos: JSON.parse(c.topicos)
    }))

    return c.json({
      conteudos: conteudosFormatados,
      total: conteudos.length,
      limit,
      offset
    })
  } catch (error) {
    console.error('Erro ao listar conte√∫dos:', error)
    return c.json({ error: 'Erro ao listar conte√∫dos' }, 500)
  }
})

// Gerar metas do dia automaticamente
app.post('/api/metas/gerar/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')
  const hoje = new Date().toISOString().split('T')[0]
  const diaSemana = new Date().getDay()

  try {
    // Buscar plano ativo
    const plano = await DB.prepare(
      'SELECT * FROM planos_estudo WHERE user_id = ? AND ativo = 1 ORDER BY created_at DESC LIMIT 1'
    ).bind(user_id).first()

    if (!plano) {
      return c.json({ error: 'Nenhum plano ativo encontrado' }, 404)
    }

    // Verificar se j√° existem metas para hoje
    const { results: metasExistentes } = await DB.prepare(
      'SELECT * FROM metas_diarias WHERE user_id = ? AND data = ?'
    ).bind(user_id, hoje).all()

    if (metasExistentes.length > 0) {
      return c.json({ message: 'Metas j√° geradas para hoje', metas: metasExistentes })
    }

    // Buscar ciclos do dia
    const { results: ciclos } = await DB.prepare(`
      SELECT * FROM ciclos_estudo 
      WHERE plano_id = ? AND dia_semana = ?
      ORDER BY ordem
    `).bind(plano.id, diaSemana).all()

    if (ciclos.length === 0) {
      return c.json({ message: 'Nenhum ciclo programado para hoje' })
    }

    // Criar metas
    const metas = []
    for (const ciclo of ciclos) {
      const result = await DB.prepare(`
        INSERT INTO metas_diarias (user_id, plano_id, data, ciclo_id, concluida, tempo_real_minutos)
        VALUES (?, ?, ?, ?, 0, 0)
      `).bind(user_id, plano.id, hoje, ciclo.id).run()

      metas.push({
        id: result.meta.last_row_id,
        ciclo_id: ciclo.id,
        data: hoje
      })
    }

    // Criar registro no hist√≥rico
    await DB.prepare(`
      INSERT OR REPLACE INTO historico_estudos 
      (user_id, data, metas_total, metas_concluidas, tempo_total_minutos, tempo_estudado_minutos, percentual_conclusao, status)
      VALUES (?, ?, ?, 0, ?, 0, 0, 'nao_estudou')
    `).bind(
      user_id, 
      hoje, 
      ciclos.length,
      ciclos.reduce((sum: number, c: any) => sum + c.tempo_minutos, 0)
    ).run()

    return c.json({ success: true, metas_criadas: metas.length, metas })
  } catch (error) {
    console.error('Erro ao gerar metas:', error)
    return c.json({ error: 'Erro ao gerar metas do dia' }, 500)
  }
})

// Obter calend√°rio de estudos
app.get('/api/calendario/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')
  const mes = c.req.query('mes') || new Date().getMonth() + 1
  const ano = c.req.query('ano') || new Date().getFullYear()

  const { results: historico } = await DB.prepare(`
    SELECT * FROM historico_estudos
    WHERE user_id = ? 
    AND strftime('%m', data) = ?
    AND strftime('%Y', data) = ?
    ORDER BY data
  `).bind(user_id, String(mes).padStart(2, '0'), String(ano)).all()

  return c.json(historico)
})

// Obter estat√≠sticas gerais
app.get('/api/estatisticas/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  // Total de dias estudados
  const diasEstudados = await DB.prepare(`
    SELECT COUNT(*) as total FROM historico_estudos
    WHERE user_id = ? AND status != 'nao_estudou'
  `).bind(user_id).first()

  // Streak atual
  const streak = await calcularStreak(DB, user_id)

  // Total de horas estudadas
  const horasTotal = await DB.prepare(`
    SELECT SUM(tempo_estudado_minutos) as total FROM historico_estudos
    WHERE user_id = ?
  `).bind(user_id).first()

  // M√©dia de conclus√£o
  const mediaConlusao = await DB.prepare(`
    SELECT AVG(percentual_conclusao) as media FROM historico_estudos
    WHERE user_id = ? AND status != 'nao_estudou'
  `).bind(user_id).first()

  return c.json({
    dias_estudados: diasEstudados?.total || 0,
    streak_atual: streak,
    horas_totais: Math.round((horasTotal?.total || 0) / 60 * 10) / 10,
    media_conclusao: Math.round(mediaConlusao?.media || 0)
  })
})

// ============== ROTAS DE MATERIAIS ==============
app.post('/api/materiais', async (c) => {
  const { DB } = c.env
  const { user_id, disciplina_id, titulo, arquivo_url, paginas_total } = await c.req.json()

  const result = await DB.prepare(`
    INSERT INTO materiais (user_id, disciplina_id, titulo, arquivo_url, paginas_total)
    VALUES (?, ?, ?, ?, ?)
  `).bind(user_id, disciplina_id, titulo, arquivo_url, paginas_total).run()

  return c.json({ id: result.meta.last_row_id })
})

app.get('/api/materiais/user/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  const { results } = await DB.prepare(`
    SELECT m.*, d.nome as disciplina_nome
    FROM materiais m
    JOIN disciplinas d ON m.disciplina_id = d.id
    WHERE m.user_id = ?
    ORDER BY m.created_at DESC
  `).bind(user_id).all()

  return c.json(results)
})

// ============== ROTAS DE DESEMPENHO ==============
app.get('/api/desempenho/user/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  const { results } = await DB.prepare(`
    SELECT d.*, disc.nome as disciplina_nome
    FROM desempenho d
    JOIN disciplinas disc ON d.disciplina_id = disc.id
    WHERE d.user_id = ?
    ORDER BY d.data_avaliacao DESC
  `).bind(user_id).all()

  return c.json(results)
})

app.post('/api/desempenho', async (c) => {
  const { DB } = c.env
  const { user_id, disciplina_id, nivel, tipo_avaliacao } = await c.req.json()
  const hoje = new Date().toISOString().split('T')[0]

  await DB.prepare(`
    INSERT INTO desempenho (user_id, disciplina_id, nivel, data_avaliacao, tipo_avaliacao)
    VALUES (?, ?, ?, ?, ?)
  `).bind(user_id, disciplina_id, nivel, hoje, tipo_avaliacao).run()

  // Atualizar n√≠vel na tabela user_disciplinas
  await DB.prepare(`
    UPDATE user_disciplinas
    SET nivel_atual = ?, updated_at = CURRENT_TIMESTAMP
    WHERE user_id = ? AND disciplina_id = ?
  `).bind(nivel, user_id, disciplina_id).run()

  return c.json({ success: true })
})

// ============== ROTAS DE CONTE√öDO GERADO POR IA ==============
app.post('/api/conteudo/gerar', async (c) => {
  const { DB } = c.env
  const requestData = await c.req.json()
  const { meta_id, user_id, disciplina_id, tipo, tempo_minutos } = requestData

  console.log('üì• /api/conteudo/gerar - Dados recebidos:', { meta_id, user_id, disciplina_id, tipo, tempo_minutos })

  try {
    // Verificar se a meta existe ANTES de tentar inserir
    const metaExiste = await DB.prepare('SELECT id FROM metas_diarias WHERE id = ?').bind(meta_id).first()
    if (!metaExiste) {
      console.error(`‚ùå Meta ${meta_id} n√£o encontrada na tabela metas_diarias`)
      return c.json({ error: `Meta ${meta_id} n√£o encontrada` }, 404)
    }
    console.log(`‚úÖ Meta ${meta_id} existe`)
    
    // Buscar informa√ß√µes da disciplina
    const disciplina = await DB.prepare('SELECT * FROM disciplinas WHERE id = ?').bind(disciplina_id).first()
    const userDisc = await DB.prepare(
      'SELECT * FROM user_disciplinas WHERE user_id = ? AND disciplina_id = ?'
    ).bind(user_id, disciplina_id).first()

    if (!disciplina) {
      return c.json({ error: 'Disciplina n√£o encontrada' }, 404)
    }

    // Buscar contexto da entrevista (concurso/cargo/√°rea)
    const interview = await DB.prepare(`
      SELECT * FROM interviews WHERE user_id = ? ORDER BY created_at DESC LIMIT 1
    `).bind(user_id).first()

    // Gerar conte√∫do baseado no tipo, tempo e contexto
    console.log('ü§ñ Gerando conte√∫do IA...')
    const conteudo = await gerarConteudoIA(disciplina, userDisc, tipo, tempo_minutos, interview, c.env)
    console.log('‚úÖ Conte√∫do IA gerado:', { 
      topicos: conteudo.topicos, 
      objetivos: conteudo.objetivos,
      numSecoes: conteudo.conteudo?.secoes?.length 
    })

    // Salvar no banco
    console.log('üíæ Tentando salvar no banco:', { user_id, meta_id, disciplina_id, tipo, tempo_minutos })
    
    let result;
    try {
      result = await DB.prepare(`
        INSERT INTO conteudo_estudo (user_id, meta_id, disciplina_id, tipo, tempo_minutos, conteudo, topicos, objetivos, status)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pendente')
      `).bind(
        user_id,
        meta_id,
        disciplina_id,
        tipo,
        tempo_minutos,
        JSON.stringify(conteudo.conteudo),
        JSON.stringify(conteudo.topicos),
        JSON.stringify(conteudo.objetivos)
      ).run()
      
      console.log('‚úÖ Conte√∫do salvo com ID:', result.meta.last_row_id)
    } catch (insertError) {
      console.error('‚ùå Erro no INSERT:', insertError)
      console.error('Valores sendo inseridos:', { 
        user_id, 
        meta_id, 
        disciplina_id, 
        tipo, 
        tempo_minutos,
        conteudo_length: JSON.stringify(conteudo.conteudo).length,
        topicos_length: JSON.stringify(conteudo.topicos).length
      })
      throw insertError
    }

    // Marcar meta como tendo conte√∫do gerado
    await DB.prepare('UPDATE metas_diarias SET conteudo_gerado = 1 WHERE id = ?').bind(meta_id).run()
    
    // Vincular conte√∫do aos t√≥picos do edital
    const conteudo_id = result.meta.last_row_id
    await vincularConteudoTopicos(DB, conteudo_id, disciplina_id, conteudo.topicos)

    return c.json({
      id: conteudo_id,
      tipo,
      disciplina_id,
      topicos: conteudo.topicos,
      objetivos: conteudo.objetivos,
      conteudo: conteudo.conteudo
    })
  } catch (error) {
    console.error('Erro ao gerar conte√∫do:', error)
    return c.json({ error: 'Erro ao gerar conte√∫do de estudo' }, 500)
  }
})

app.get('/api/conteudo/:meta_id', async (c) => {
  const { DB } = c.env
  const meta_id = c.req.param('meta_id')

  // Buscar conte√∫do mais recente para essa meta
  const conteudo = await DB.prepare(
    'SELECT * FROM conteudo_estudo WHERE meta_id = ? ORDER BY created_at DESC LIMIT 1'
  ).bind(meta_id).first()

  if (!conteudo) {
    return c.json({ error: 'Conte√∫do n√£o encontrado' }, 404)
  }

  return c.json({
    ...conteudo,
    conteudo: JSON.parse(conteudo.conteudo),
    topicos: JSON.parse(conteudo.topicos),
    objetivos: JSON.parse(conteudo.objetivos)
  })
})

// Buscar todos os conte√∫dos de um usu√°rio
app.get('/api/conteudos/usuario/:user_id', async (c) => {
  const { DB } = c.env
  const user_id = c.req.param('user_id')

  const { results: conteudos } = await DB.prepare(`
    SELECT c.*, d.nome as disciplina_nome
    FROM conteudo_estudo c
    LEFT JOIN disciplinas d ON c.disciplina_id = d.id
    WHERE c.user_id = ?
    ORDER BY c.created_at DESC
  `).bind(user_id).all()

  return c.json(conteudos)
})

// Buscar conte√∫do por ID (com t√≥picos do edital vinculados)
app.get('/api/conteudos/:id', async (c) => {
  const { DB } = c.env
  const id = c.req.param('id')
  const format = c.req.query('format') || 'json'

  const conteudo = await DB.prepare(
    'SELECT * FROM conteudo_estudo WHERE id = ?'
  ).bind(id).first()

  if (!conteudo) {
    return c.json({ error: 'Conte√∫do n√£o encontrado' }, 404)
  }

  // üÜï Buscar t√≥picos do edital vinculados
  const { results: topicosVinculados } = await DB.prepare(`
    SELECT te.id, te.nome, te.categoria, te.peso, te.ordem
    FROM conteudo_topicos ct
    JOIN topicos_edital te ON ct.topico_id = te.id
    WHERE ct.conteudo_id = ?
    ORDER BY te.ordem
  `).bind(id).all()

  const resultado = {
    ...conteudo,
    conteudo: JSON.parse(conteudo.conteudo),
    topicos: JSON.parse(conteudo.topicos),
    objetivos: JSON.parse(conteudo.objetivos),
    topicos_edital: topicosVinculados || []
  }

  // Suporte a diferentes formatos
  if (format === 'markdown') {
    const md = gerarMarkdown(resultado)
    return new Response(md, {
      headers: {
        'Content-Type': 'text/markdown; charset=utf-8',
        'Content-Disposition': `attachment; filename="${conteudo.disciplina_nome || 'conteudo'}_${conteudo.tipo}_${conteudo.id}.md"`
      }
    })
  }
  
  if (format === 'html') {
    const html = gerarHTML(resultado)
    return c.html(html)
  }

  return c.json(resultado)
})

// ============== FUN√á√ïES AUXILIARES ==============
async function atualizarHistoricoDia(DB: D1Database, user_id: number, data: string) {
  const { results: metas } = await DB.prepare(
    'SELECT * FROM metas_diarias WHERE user_id = ? AND data = ?'
  ).bind(user_id, data).all()

  if (metas.length === 0) return

  const metasConcluidas = metas.filter((m: any) => m.concluida).length
  const tempoTotal = metas.reduce((sum: number, m: any) => {
    const ciclo = m.tempo_minutos || 0
    return sum + ciclo
  }, 0)
  const tempoEstudado = metas.reduce((sum: number, m: any) => sum + (m.tempo_real_minutos || 0), 0)
  const percentual = Math.round((metasConcluidas / metas.length) * 100)
  
  let status = 'nao_estudou'
  if (percentual === 100) status = 'completo'
  else if (percentual > 0) status = 'parcial'

  await DB.prepare(`
    INSERT OR REPLACE INTO historico_estudos 
    (user_id, data, metas_total, metas_concluidas, tempo_total_minutos, tempo_estudado_minutos, percentual_conclusao, status, updated_at)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
  `).bind(user_id, data, metas.length, metasConcluidas, tempoTotal, tempoEstudado, percentual, status).run()
}

async function calcularStreak(DB: D1Database, user_id: number): Promise<number> {
  const { results: historico } = await DB.prepare(`
    SELECT data, status FROM historico_estudos
    WHERE user_id = ? AND status != 'nao_estudou'
    ORDER BY data DESC
    LIMIT 365
  `).bind(user_id).all()

  if (historico.length === 0) return 0

  let streak = 0
  const hoje = new Date()
  hoje.setHours(0, 0, 0, 0)

  for (const dia of historico) {
    const dataDia = new Date(dia.data + 'T00:00:00')
    const diffDays = Math.floor((hoje.getTime() - dataDia.getTime()) / (1000 * 60 * 60 * 24))
    
    if (diffDays === streak) {
      streak++
    } else {
      break
    }
  }

  return streak
}

// Fun√ß√£o auxiliar para inicializar OpenAI client
function getOpenAIClient(env: any) {
  try {
    return new OpenAI({
      apiKey: env.OPENAI_API_KEY || process.env.OPENAI_API_KEY,
      baseURL: env.OPENAI_BASE_URL || process.env.OPENAI_BASE_URL || 'https://www.genspark.ai/api/llm_proxy/v1'
    })
  } catch (error) {
    console.error('‚ùå Erro ao inicializar OpenAI:', error)
    return null
  }
}

// üÜï Gerar conte√∫do usando Groq (FALLBACK GRATUITO)
async function gerarConteudoComGroq(disciplina: string, tipo: string, tempo_minutos: number, dificuldade: string, contexto: any, env: any, userDisc: any = null, topicos: string[] = []) {
  const GROQ_API_KEY = env.GROQ_API_KEY || process.env.GROQ_API_KEY
  
  if (!GROQ_API_KEY) {
    console.log('‚ö†Ô∏è GROQ_API_KEY n√£o configurada')
    return null
  }

  try {
    console.log('üöÄ Gerando conte√∫do com Groq API (Llama 3.3 70B - 840 tokens/s)...')
    
    const nivelAluno = userDisc?.nivel_atual || 5
    const prompt = `Voc√™ √© um Professor Especialista em Concursos P√∫blicos do Brasil. Gere material de estudo DETALHADO para ${disciplina}.

DADOS DO ALUNO:
- Disciplina: ${disciplina}
- T√≥pico: ${topicos[0] || 'Conte√∫do Geral'}
- N√≠vel: ${nivelAluno}/10 (${dificuldade})
- Concurso: ${contexto.concurso || contexto.area || 'Concursos Gerais'}
- Tempo: ${tempo_minutos} minutos

${tipo === 'teoria' ? `
GERE TEORIA COMPLETA (m√≠nimo 3000 palavras):
- Conceitos fundamentais detalhados
- Exemplos pr√°ticos extensos
- Jurisprud√™ncia relevante
- Tabelas comparativas
- Dicas de prova
` : tipo === 'exercicios' ? `
GERE 10+ QUEST√ïES DE M√öLTIPLA ESCOLHA:
- Estilo CESPE/FCC/FGV
- 5 alternativas por quest√£o
- Enunciados contextualizados (100+ palavras)
- Explica√ß√£o detalhada (200+ palavras) para cada
- Fundamenta√ß√£o legal completa
` : `
GERE MATERIAL DE REVIS√ÉO:
- Resumo executivo (800+ palavras)
- 5+ mnem√¥nicos criativos
- 5-8 quest√µes de fixa√ß√£o
`}

**CR√çTICO: Retorne APENAS JSON v√°lido no formato:**
{
  "topicos": ["${topicos[0] || 'T√≥pico Principal'}"],
  "objetivos": ["Objetivo 1", "Objetivo 2"],
  "conteudo": {
    "introducao": "Introdu√ß√£o contextualizada",
    "secoes": [
      {
        "titulo": "${topicos[0] || 'Se√ß√£o Principal'}",
        "tempo_estimado": ${tempo_minutos},
        "ordem": 1,
        "conteudo": {
          "teoria_completa": "# Conte√∫do em Markdown\\n\\n...",
          "questoes": [
            {
              "enunciado": "Enunciado completo da quest√£o...",
              "alternativas": ["Alternativa 1", "Alternativa 2", "Alternativa 3", "Alternativa 4", "Alternativa 5"],
              "gabarito": 0,
              "explicacao": "Explica√ß√£o detalhada..."
            }
          ]
        }
      }
    ],
    "proximos_passos": "Pr√≥ximos passos recomendados"
  }
}`

    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${GROQ_API_KEY}`
      },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile', // Modelo gratuito, r√°pido e poderoso
        messages: [{
          role: 'system',
          content: 'Voc√™ √© um professor especialista em concursos p√∫blicos. Sempre retorne JSON v√°lido.'
        }, {
          role: 'user',
          content: prompt
        }],
        temperature: 0.7,
        max_tokens: 8000,
        response_format: { type: 'json_object' }
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      console.error('‚ùå Erro na API do Groq:', response.status, errorText)
      return null
    }

    const data = await response.json()
    const resposta = data.choices?.[0]?.message?.content || ''
    
    if (!resposta) {
      console.error('‚ùå Groq n√£o retornou conte√∫do')
      return null
    }
    
    console.log('‚úÖ Groq respondeu, parseando JSON...')
    const resultado = JSON.parse(resposta)
    
    if (!resultado.topicos || !resultado.objetivos || !resultado.conteudo?.secoes) {
      console.error('‚ùå JSON do Groq inv√°lido: faltam campos obrigat√≥rios')
      return null
    }
    
    console.log('‚úÖ Conte√∫do gerado com Groq com sucesso!')
    return resultado
  } catch (error) {
    console.error('‚ùå Erro ao gerar conte√∫do com Groq:', error)
    return null
  }
}

// Gerar conte√∫do usando Gemini GEM (Professor de Concurso P√∫blico)
async function gerarConteudoComGPT(disciplina: string, tipo: string, tempo_minutos: number, dificuldade: string, contexto: any, env: any, userDisc: any = null, topicos: string[] = []) {
  const GEMINI_API_KEY = env.GEMINI_API_KEY || process.env.GEMINI_API_KEY
  
  if (!GEMINI_API_KEY) {
    console.log('‚ö†Ô∏è GEMINI_API_KEY n√£o configurada')
    return null
  }

  try {
    console.log('ü§ñ Chamando API Gemini diretamente...')
    
    // Converter n√≠vel (0-10) para b√°sico/intermedi√°rio/avan√ßado
    const nivelAluno = userDisc?.nivel_atual || 5
    const jaEstudou = userDisc?.ja_estudou ? topicos.filter((_, i) => i % 2 === 0) : [] // Simular o que j√° estudou
    const naoEstudou = topicos.filter(t => !jaEstudou.includes(t))
    
    // Determinar tamanho do material
    let tamanhoMaterial = 'm√©dio'
    if (tempo_minutos <= 20) tamanhoMaterial = 'curto'
    else if (tempo_minutos >= 40) tamanhoMaterial = 'longo'
    
    // Estrutura JSON para o GEM
    const dadosGEM = {
      disciplina: disciplina,
      tema: topicos[0] || 'Fundamentos',
      nivel_aluno: nivelAluno,
      ja_estudou: jaEstudou,
      nao_estudou: naoEstudou,
      complexidade_edital: dificuldade === 'b√°sico' ? 'baixa' : dificuldade === 'intermedi√°rio' ? 'm√©dia' : 'alta',
      tipo_de_estudo: contexto.tipo === 'concurso_especifico' ? 'concurso' : '√°rea',
      concurso: contexto.concurso || contexto.area || 'Concursos Gerais',
      prazo: '45 dias',
      tamanho_material: tamanhoMaterial,
      tempo_minutos: tempo_minutos,
      complexidade: dificuldade === 'b√°sico' ? 'baixa' : dificuldade === 'intermedi√°rio' ? 'm√©dia' : 'alta'
    }
    
    // Prompt COMPLETO focado em material EXTENSO e PROFUNDO
    const prompt = `ATEN√á√ÉO: Voc√™ √© um Professor Especialista de Concursos P√∫blicos. Sua miss√£o √© gerar material de estudo EXTREMAMENTE DETALHADO.

üö®üö®üö® REGRA CR√çTICA DE TAMANHO üö®üö®üö®
‚Üí Gere NO M√çNIMO 20.000 palavras (100.000 caracteres)
‚Üí Cada se√ß√£o deve ter NO M√çNIMO 10.000 palavras (50.000 caracteres)
‚Üí NUNCA gere menos de 10.000 palavras por se√ß√£o
‚Üí Material curto ou resumido ser√° REJEITADO
‚Üí Desenvolva CADA PONTO em profundidade EXTREMA

DADOS DO ALUNO:
- Disciplina: ${dadosGEM.disciplina}
- Tema priorit√°rio: ${dadosGEM.tema}
- N√≠vel: ${nivelAluno}/10 (${dificuldade})
- Concurso: ${dadosGEM.concurso}
- Prazo: ${dadosGEM.prazo}
- O que N√ÉO estudou (PRIORIDADE): ${dadosGEM.nao_estudou.join(', ')}
- O que J√Å estudou: ${dadosGEM.ja_estudou.join(', ') || 'Nada'}

LEMBRE-SE: Cada se√ß√£o DEVE ter 10.000+ palavras (50.000+ caracteres). Desenvolva EXTENSIVAMENTE cada ponto.

üéØ SUA MISS√ÉO:
Gere um material de estudo de **${dadosGEM.tema}** para concurso **${dadosGEM.concurso}**.

üìè TAMANHO M√çNIMO OBRIGAT√ìRIO (LEIA COM ATEN√á√ÉO):
‚Ä¢ teoria_completa: NO M√çNIMO 10.000 palavras (50.000 caracteres) por se√ß√£o
‚Ä¢ NUNCA gere menos de 10.000 palavras - conte√∫do ser√° rejeitado se for menor
‚Ä¢ Desenvolva EXTENSIVAMENTE cada conceito, autor, jurisprud√™ncia, exemplo

${tipo === 'teoria' ? `
üìö CONTE\u00daDO OBRIGAT\u00d3RIO PARA TEORIA (DESENVOLVA EXTENSIVAMENTE):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìö ESTRUTURA OBRIGAT√ìRIA DO MATERIAL (TEORIA)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**1. INTRODU√á√ÉO PERSONALIZADA E CONTEXTUALIZADA (m√≠nimo 500 palavras):**
   - Sauda√ß√£o adaptada ao n√≠vel ${nivelAluno}/10 e objetivo (${dadosGEM.concurso})
   - Contextualiza√ß√£o hist√≥rica do tema
   - Evolu√ß√£o no direito/legisla√ß√£o brasileira
   - Import√¢ncia para o concurso ${dadosGEM.concurso}
   - Estat√≠sticas de incid√™ncia em provas anteriores (se dispon√≠vel)
   - Por que estudar AGORA (conex√£o com ${dadosGEM.prazo})
   - Como o tema se conecta com o que ser√° aprendido: ${dadosGEM.nao_estudou.join(', ')}
   - Previs√£o legal completa (CF, leis, decretos relevantes)

**2. ESQUEMA: O QUE O ALUNO J√Å SABE X O QUE FALTA APRENDER:**
   - Mapeamento claro dos t√≥picos j√° dominados: ${dadosGEM.ja_estudou.join(', ') || 'Iniciando do zero'}
   - Lista detalhada do que ser√° aprendido AGORA: ${dadosGEM.nao_estudou.join(', ')}
   - Conex√µes entre o que j√° sabe e o que vai aprender
   - Gaps de conhecimento identificados (lacunas a preencher)
   - Prioriza√ß√£o: O que focar PRIMEIRO nesta sess√£o de ${dadosGEM.tempo_minutos} minutos

**3. CONTE√öDO TE√ìRICO EXTREMAMENTE DETALHADO:**
   ${nivelAluno <= 3 ? `
   [N√çVEL INICIANTE - Simplificar linguagem mas manter conte√∫do completo]
   - Use analogias do dia a dia
   - Evite termos t√©cnicos excessivos (mas explique quando necess√°rio)
   - D√™ exemplos pr√°ticos e cotidianos
   - Construa o conhecimento gradualmente
   - MAS: Conte√∫do deve permanecer COMPLETO e PROFUNDO
   ` : nivelAluno <= 7 ? `
   [N√çVEL INTERMEDI√ÅRIO - Aprofundar com comparativos e esquemas]
   - Use linguagem t√©cnica adequada
   - Compare institutos similares
   - Apresente jurisprud√™ncia simplificada
   - Crie mapas mentais textuais
   - Aprofundamento moderado mas COMPLETO
   ` : `
   [N√çVEL AVAN√áADO - Profundidade m√°xima]
   - Linguagem t√©cnica completa
   - Debates doutrin√°rios profundos (m√≠nimo 3 autores por tema)
   - Jurisprud√™ncia complexa e atualizada (STF, STJ, TRFs)
   - Quest√µes controversas e diverg√™ncias
   - An√°lise cr√≠tica e comparativa EXTENSA
   `}
   
   **IMPORTANTE: Cada se√ß√£o deve ter NO M√çNIMO 8.000 caracteres (cerca de 1.500 palavras).**
   
   Para CADA t√≥pico em ${dadosGEM.nao_estudou.join(', ')}, desenvolva EM PROFUNDIDADE:
   
   **A) CONCEITO COMPLETO (m√≠nimo 800 palavras):**
      - Defini√ß√£o legal COMPLETA (cite artigos da CF, leis, decretos)
      - Defini√ß√£o doutrin√°ria de NO M√çNIMO 5 autores renomados:
        * Autor 1: [nome] - [obra] - [conceito detalhado]
        * Autor 2: [nome] - [obra] - [conceito detalhado]
        * Autor 3: [nome] - [obra] - [conceito detalhado]
        * Autor 4: [nome] - [obra] - [conceito detalhado]
        * Autor 5: [nome] - [obra] - [conceito detalhado]
      - Etimologia do termo e origem hist√≥rica
      - Evolu√ß√£o no ordenamento brasileiro (linha do tempo)
      - Diferen√ßa entre conceitos similares
   
   **B) ELEMENTOS, REQUISITOS E CARACTER√çSTICAS (m√≠nimo 1.000 palavras):**
      - Liste TODOS os elementos/requisitos/caracter√≠sticas
      - Para CADA elemento, desenvolva:
        * Conceito detalhado (m√≠nimo 300 palavras)
        * Base legal espec√≠fica
        * Posi√ß√£o doutrin√°ria (cite 2-3 autores)
        * 3-5 exemplos pr√°ticos EXTENSOS
        * 2-3 contraexemplos (o que N√ÉO √©)
        * Como √© cobrado em provas (padr√£o CESPE/FCC/FGV)
   
   **C) CLASSIFICA√á√ïES E ESP√âCIES (m√≠nimo 600 palavras):**
      - TODAS as classifica√ß√µes doutrin√°rias existentes
      - Tabela comparativa EXTENSA entre esp√©cies
      - Diferen√ßas sutis destacadas
      - Crit√©rios de classifica√ß√£o
      - Exemplos para cada esp√©cie

**4. EXPLICA√á√ïES CLARAS ADAPTADAS AO N√çVEL DO ALUNO (m√≠nimo 500 palavras):**
   - Use linguagem compat√≠vel com n√≠vel ${nivelAluno}/10
   - Explique TODOS os termos t√©cnicos que aparecerem
   - Construa racioc√≠nio passo a passo DETALHADO
   - Antecipe d√∫vidas comuns (liste 5-10 d√∫vidas frequentes)
   - Responda cada d√∫vida com 100-200 palavras

**5. QUADROS-RESUMO E TABELAS COMPARATIVAS (m√≠nimo 5 tabelas):**
   - M√≠nimo 5 tabelas POR SE√á√ÉO
   - Compare institutos similares (tabela com m√≠nimo 5 colunas)
   - Tabela de diferen√ßas doutrin√°rias (m√≠nimo 3 autores)
   - Quadro de evolu√ß√£o legislativa (cronol√≥gica)
   - Tabela de aplica√ß√£o pr√°tica
   - Tabela de pegadinhas comuns em provas
   - Use formato Markdown para tabelas:
     | Coluna 1 | Coluna 2 | Coluna 3 |
     |----------|----------|----------|
     | Dado 1   | Dado 2   | Dado 3   |

**6. JURISPRUD√äNCIA RELEVANTE (COMENTADA) (m√≠nimo 1.500 palavras):**
   - NO M√çNIMO 10 s√∫mulas do STF/STJ com coment√°rios EXTENSOS
   - NO M√çNIMO 8 julgados paradigm√°ticos recentes (2020-2024)
   - Para CADA julgado, forne√ßa:
     * N√∫mero do processo completo (ex: RE 123.456/SP)
     * Tribunal e relator
     * Data do julgamento
     * Tese fixada
     * Contexto f√°tico DETALHADO (m√≠nimo 300 palavras)
     * Fundamentos da decis√£o
     * Votos divergentes (se houver)
     * Aplica√ß√£o pr√°tica nos casos concretos
     * Como a jurisprud√™ncia √© cobrada em provas (cite quest√µes reais)
     * Impacto no ordenamento jur√≠dico

**7. EXEMPLOS PR√ÅTICOS (m√≠nimo 1.000 palavras):**
   - NO M√çNIMO 8 exemplos EXTENSOS por se√ß√£o
   - Para CADA exemplo:
     * Situa√ß√£o f√°tica detalhada (200+ palavras)
     * An√°lise jur√≠dica passo a passo
     * Legisla√ß√£o aplic√°vel
     * Jurisprud√™ncia relacionada
     * Solu√ß√£o fundamentada
   - Situa√ß√µes do dia a dia
   - Casos que caem em prova
   - Aplica√ß√£o pr√°tica do instituto

**8. ESTUDOS DE CASO (m√≠nimo 1.200 palavras):**
   - NO M√çNIMO 4 casos complexos POR SE√á√ÉO
   - Para CADA caso:
     * Descri√ß√£o completa da situa√ß√£o (m√≠nimo 300 palavras)
     * Problema jur√≠dico identificado
     * An√°lise jur√≠dica PROFUNDA (m√≠nimo 400 palavras)
     * Posi√ß√µes doutrin√°rias divergentes
     * Jurisprud√™ncia aplic√°vel
     * Solu√ß√£o passo a passo DETALHADA
     * Fundamenta√ß√£o legal completa (artigos, leis, CF)
     * Fundamenta√ß√£o jurisprudencial (s√∫mulas e julgados)
     * Alternativas de solu√ß√£o
     * Consequ√™ncias pr√°ticas

**9. QUEST√ïES ESTILO FGV, CESPE, FCC (COMENTADAS) (m√≠nimo 2.000 palavras):**
   - NO M√çNIMO 12 quest√µes de bancas REAIS por se√ß√£o
   - Distribui√ß√£o: 30% f√°cil (4 quest√µes), 50% m√©dia (6 quest√µes), 20% dif√≠cil (2 quest√µes)
   - Para CADA quest√£o, forne√ßa:
     * Enunciado COMPLETO e CONTEXTUALIZADO (m√≠nimo 150 palavras)
     * Cite situa√ß√£o pr√°tica ou jurisprud√™ncia real
     * Use linguagem de bancas reais (CESPE/CEBRASPE, FCC, FGV, VUNESP)
     * 5 alternativas bem elaboradas (cada uma com 80-150 palavras)
     * Gabarito oficial
     * Explica√ß√£o EXTENSA (M√çNIMO 500 palavras) contendo:
       ‚Üí Por que a CORRETA est√° correta (100+ palavras)
       ‚Üí Por que a alternativa A est√° errada (se n√£o for a correta) (80+ palavras)
       ‚Üí Por que a alternativa B est√° errada (se n√£o for a correta) (80+ palavras)
       ‚Üí Por que a alternativa C est√° errada (se n√£o for a correta) (80+ palavras)
       ‚Üí Por que a alternativa D est√° errada (se n√£o for a correta) (80+ palavras)
       ‚Üí Por que a alternativa E est√° errada (se n√£o for a correta) (80+ palavras)
       ‚Üí Fundamenta√ß√£o legal COMPLETA (artigos espec√≠ficos)
       ‚Üí Fundamenta√ß√£o doutrin√°ria (cite 2-3 autores)
       ‚Üí Fundamenta√ß√£o jurisprudencial (cite s√∫mulas/julgados)
       ‚Üí Pegadinhas identificadas (pelo menos 3)
       ‚Üí Dica de resolu√ß√£o para quest√µes similares
       ‚Üí Estat√≠stica de acertos (se dispon√≠vel)

**10. ERROS QUE DERRUBAM CANDIDATOS (m√≠nimo 1.000 palavras):**
   - Liste os 15 erros MAIS COMUNS no tema
   - Para CADA erro:
     * Descri√ß√£o do erro (m√≠nimo 80 palavras)
     * Por que os candidatos erram (an√°lise psicol√≥gica)
     * Como evitar este erro espec√≠fico (passo a passo)
     * Exemplo de quest√£o que explora este erro
     * Dica de memoriza√ß√£o para n√£o errar
   - Pegadinhas CL√ÅSSICAS das bancas (m√≠nimo 10)
   - Padr√µes de quest√µes que confundem
   - Termos "pegadinha" mais usados

**11. MAPA MENTAL ESCRITO EM TEXTO (m√≠nimo 600 palavras):**
   - Estrutura hier√°rquica COMPLETA do conte√∫do
   - TODOS os conceitos principais e secund√°rios
   - Conex√µes entre conceitos (use ‚Üí para indicar rela√ß√£o)
   - Palavra-chave PRINCIPAL ‚Üí Ramifica√ß√µes de 1¬∫ n√≠vel ‚Üí Ramifica√ß√µes de 2¬∫ n√≠vel ‚Üí Ramifica√ß√µes de 3¬∫ n√≠vel
   - Visual em formato texto estruturado
   - Use indenta√ß√£o para hierarquia:
     * CONCEITO CENTRAL
       ‚Üí Ramifica√ß√£o 1
         ‚Üí Sub-ramifica√ß√£o 1.1
         ‚Üí Sub-ramifica√ß√£o 1.2
       ‚Üí Ramifica√ß√£o 2
         ‚Üí Sub-ramifica√ß√£o 2.1

**12. CHECKLIST FINAL DE MEMORIZA√á√ÉO (m√≠nimo 800 palavras):**
   - NO M√çNIMO 15 mnem√¥nicos criativos (ex: siglas, frases, acr√¥nimos)
   - Para CADA mnem√¥nico:
     * Explica√ß√£o de como funciona
     * Conceitos que ele ajuda a memorizar
     * Exemplo de aplica√ß√£o
   - NO M√çNIMO 10 t√©cnicas de associa√ß√£o (visual, auditiva, cinest√©sica)
   - NO M√çNIMO 20 "macetes" de memoriza√ß√£o pr√°ticos
   - Lista de verifica√ß√£o completa antes da prova (m√≠nimo 30 itens)
   - Estrat√©gias de memoriza√ß√£o de longo prazo
   - Como revisar este conte√∫do (t√©cnica de repeti√ß√£o espa√ßada)
   - Flashcards mentais sugeridos (pelo menos 15)

**13. SUGEST√ÉO DE REVIS√ÉO PERSONALIZADA (m√≠nimo 1.000 palavras):**
   Considere que o aluno tem ${dadosGEM.prazo} at√© a prova de ${dadosGEM.concurso}.
   
   **A) CURTO PRAZO (pr√≥ximos 7 dias):**
      - O que revisar PRIORITARIAMENTE (lista de 10+ t√≥picos)
      - Quanto tempo dedicar a cada t√≥pico
      - Quais quest√µes resolver (quantidade e tipo)
      - Materiais complementares a consultar
      - Cronograma dia a dia detalhado
      - Metas di√°rias espec√≠ficas
   
   **B) M√âDIO PRAZO (pr√≥ximas 2-4 semanas):**
      - Aprofundamento em temas complexos (liste 8+ temas)
      - Jurisprud√™ncia a revisar
      - Quest√µes a resolver (quantidade semanal)
      - Simulados recomendados
      - Cronograma semanal
      - Marcos de progresso
   
   **C) LONGO PRAZO (at√© ${dadosGEM.prazo}):**
      - Estrat√©gia COMPLETA de prepara√ß√£o
      - Todos os t√≥picos a dominar (ordem de prioridade)
      - Ciclos de revis√£o espa√ßada (algoritmo Anki-style)
      - Simulados mensais
      - Ajustes conforme desempenho
      - Plano B para temas de maior dificuldade
   
   **D) REVIS√ïES ESPA√áADAS (T√©cnica baseada em ci√™ncia):**
      - 1¬™ revis√£o: 24 horas ap√≥s estudo inicial
      - 2¬™ revis√£o: 7 dias ap√≥s 1¬™ revis√£o
      - 3¬™ revis√£o: 15 dias ap√≥s 2¬™ revis√£o
      - 4¬™ revis√£o: 30 dias ap√≥s 3¬™ revis√£o
      - 5¬™ revis√£o: 60 dias ap√≥s 4¬™ revis√£o (se houver tempo)
      - Revis√£o final: 3 dias antes da prova

**FORMATO MARKDOWN:**
   - ## T√≠tulo Principal
   - ### Subt√≠tulo
   - #### Subitem
   - **Negrito** para termos-chave
   - *It√°lico* para √™nfase
   - \`Art. X\` para artigos de lei
   - > Cita√ß√µes doutrin√°rias
   - Listas e tabelas

**‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê**
**üö® REGRAS DE GERA√á√ÉO CR√çTICAS E OBRIGAT√ìRIAS üö®**
**‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê**

1. **PRIORIDADE ABSOLUTA:** Gere conte√∫do sobre ${dadosGEM.nao_estudou.join(', ')}
   - O aluno J√Å estudou: ${dadosGEM.ja_estudou.join(', ') || 'Nada'}
   - Foque 90% do conte√∫do no que ele N√ÉO estudou

2. **N√çVEL DO ALUNO:** ${nivelAluno}/10
   ${nivelAluno <= 3 ? '‚Üí Simplificar linguagem, usar analogias, construir gradualmente. MAS manter conte√∫do COMPLETO e PROFUNDO.' : nivelAluno <= 7 ? '‚Üí Linguagem t√©cnica intermedi√°ria, aprofundar com comparativos, jurisprud√™ncia detalhada.' : '‚Üí M√ÅXIMA profundidade t√©cnica, debates doutrin√°rios com 5+ autores, jurisprud√™ncia complexa e recente, quest√µes controversas.'}

3. **COMPLEXIDADE DO EDITAL:** ${dadosGEM.complexidade_edital}
   - Adapte a profundidade t√©cnica ao n√≠vel de cobran√ßa esperado

4. **CONCURSO:** ${dadosGEM.concurso}
   - SEMPRE relacione o conte√∫do com este concurso espec√≠fico
   - Cite quest√µes anteriores deste concurso (se dispon√≠vel)
   - Indique frequ√™ncia de cobran√ßa dos t√≥picos

5. **PRAZO:** ${dadosGEM.prazo} at√© a prova
   - Priorize temas de maior incid√™ncia
   - Adapte estrat√©gia de revis√£o ao prazo dispon√≠vel

6. **TAMANHO M√çNIMO OBRIGAT√ìRIO:**
   ‚ö†Ô∏è CR√çTICO: Cada se√ß√£o de teoria_completa deve ter NO M√çNIMO 8.000 caracteres (cerca de 1.500 palavras)
   ‚ö†Ô∏è Se uma se√ß√£o tiver menos de 8.000 caracteres, ser√° considerada INCOMPLETA
   ‚ö†Ô∏è Inclua TODOS os 13 itens obrigat√≥rios em CADA se√ß√£o

7. **PROFUNDIDADE OBRIGAT√ìRIA:**
   - NUNCA seja superficial
   - SEMPRE inclua 5+ autores doutrin√°rios
   - SEMPRE inclua 10+ s√∫mulas/julgados
   - SEMPRE inclua 8+ exemplos pr√°ticos
   - SEMPRE inclua 4+ estudos de caso
   - SEMPRE inclua 12+ quest√µes comentadas
   - Conte√∫do deve ser EXTENSO, COMPLETO, PROFUNDO

8. **ESTRUTURA DOS 13 ITENS:**
   Cada se√ß√£o DEVE conter TODOS os 13 itens listados acima:
   ‚úÖ 1. Introdu√ß√£o (500+ palavras)
   ‚úÖ 2. Esquema j√° sabe x falta aprender (300+ palavras)
   ‚úÖ 3. Conte√∫do te√≥rico detalhado (2.500+ palavras)
   ‚úÖ 4. Explica√ß√µes claras (500+ palavras)
   ‚úÖ 5. Quadros e tabelas (5+ tabelas)
   ‚úÖ 6. Jurisprud√™ncia comentada (1.500+ palavras)
   ‚úÖ 7. Exemplos pr√°ticos (1.000+ palavras)
   ‚úÖ 8. Estudos de caso (1.200+ palavras)
   ‚úÖ 9. Quest√µes comentadas (2.000+ palavras)
   ‚úÖ 10. Erros que derrubam (1.000+ palavras)
   ‚úÖ 11. Mapa mental textual (600+ palavras)
   ‚úÖ 12. Checklist de memoriza√ß√£o (800+ palavras)
   ‚úÖ 13. Revis√£o personalizada (1.000+ palavras)
   
   **TOTAL M√çNIMO POR SE√á√ÉO: 12.400 palavras = 62.000 caracteres**

` : tipo === 'exercicios' ? `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù REQUISITOS PARA EXERC√çCIOS (QUEST√ïES DE ALTA QUALIDADE)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**1. QUANTIDADE:**
   - Gere 8-12 quest√µes de m√∫ltipla escolha
   - Distribua entre f√°cil (30%), m√©dia (50%), dif√≠cil (20%)

**2. FORMATO DAS QUEST√ïES:**
   - Enunciado COMPLETO e contextualizado (m√≠nimo 100 palavras)
   - Cite situa√ß√£o pr√°tica ou jurisprud√™ncia real
   - Use linguagem de bancas reais (CESPE, FCC, FGV)
   
**3. ALTERNATIVAS (CR√çTICO - N√ÉO REPITA LETRAS):**
   - Gere exatamente 5 alternativas
   - Formato: ["Alternativa 1 sem letra", "Alternativa 2 sem letra", ...]
   - N√ÉO inclua "A)", "B)", "C)" no texto - ser√£o adicionadas automaticamente
   - Cada alternativa deve ter 50-150 palavras
   - Alternativas erradas devem ser plaus√≠veis (pegadinhas inteligentes)
   
**4. EXPLICA√á√ÉO (CR√çTICO - SEJA EXTREMAMENTE DETALHADO):**
   - Explica√ß√£o com NO M√çNIMO 300 palavras
   - Explique POR QUE a correta est√° correta
   - Explique POR QUE CADA alternativa errada est√° errada
   - Cite fundamenta√ß√£o legal (artigos espec√≠ficos)
   - Cite jurisprud√™ncia se aplic√°vel
   - Identifique pegadinhas comuns
   - D√™ dica de como resolver quest√µes similares

` : `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîÑ REQUISITOS PARA REVIS√ÉO ATIVA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**1. RESUMO EXECUTIVO:**
   - Condensar os pontos principais em t√≥picos
   - M√≠nimo 800 palavras no total

**2. MNEM√îNICOS E MACETES:**
   - Criar pelo menos 5 mnem√¥nicos criativos
   - T√©cnicas de associa√ß√£o visual

**3. QUEST√ïES DE FIXA√á√ÉO:**
   - 5-8 quest√µes no estilo simulado
   - Foco em pegadinhas comuns
`}

**CR√çTICO: Retorne APENAS JSON v√°lido. Use \\n para quebras de linha no texto. Formato:**

{
  "topicos": ["T√≥pico 1", "T√≥pico 2", "T√≥pico 3"],
  "objetivos": ["Objetivo 1", "Objetivo 2"],
  "conteudo": {
    "introducao": "Texto introdut√≥rio",
    "orientacoes": ["Orienta√ß√£o 1", "Orienta√ß√£o 2"],
    "secoes": [
      {
        "titulo": "Nome do t√≥pico",
        "tempo_estimado": 10,
        "ordem": 1,
        "conteudo": {
          "teoria_completa": "## T√≠tulo\\n\\nTexto da teoria em Markdown com quebras de linha escapadas...",
          "questoes": [
            {
              "enunciado": "Pergunta da quest√£o?",
              "alternativas": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."],
              "gabarito": 0,
              "explicacao": "Explica√ß√£o detalhada."
            }
          ]
        }
      }
    ],
    "proximos_passos": "Recomenda√ß√£o"
  }
}`

    // Chamar a API do Google Gemini
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: prompt
          }]
        }],
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 65000,  // M√ÅXIMO PERMITIDO - Para conte√∫do EXTREMAMENTE detalhado (12.400+ palavras por se√ß√£o)
          responseMimeType: 'application/json',  // FOR√áAR JSON V√ÅLIDO
          responseSchema: {
            type: 'object',
            properties: {
              topicos: {
                type: 'array',
                items: { type: 'string' }
              },
              objetivos: {
                type: 'array',
                items: { type: 'string' }
              },
              conteudo: {
                type: 'object',
                properties: {
                  secoes: {
                    type: 'array',
                    items: {
                      type: 'object',
                      properties: {
                        titulo: { type: 'string' },
                        teoria_completa: { type: 'string' },
                        questoes: {
                          type: 'array',
                          items: {
                            type: 'object',
                            properties: {
                              enunciado: { type: 'string' },
                              alternativas: {
                                type: 'array',
                                items: { type: 'string' }
                              },
                              gabarito: { type: 'integer' },
                              explicacao: { type: 'string' }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            required: ['topicos', 'objetivos', 'conteudo']
          }
        }
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      console.error('‚ùå Erro na API do Gemini:', response.status, errorText)
      return null
    }

    const data = await response.json()
    const resposta = data.candidates?.[0]?.content?.parts?.[0]?.text || ''
    
    if (!resposta) {
      console.error('‚ùå Gemini n√£o retornou conte√∫do')
      return null
    }
    
    console.log('‚úÖ Gemini GEM respondeu, parseando JSON...')
    console.log(`üìè Tamanho da resposta: ${resposta.length} caracteres`)
    
    // Com responseMimeType: 'application/json', o Gemini j√° retorna JSON v√°lido
    // N√£o precisa de limpeza de ``` ou sanitiza√ß√£o
    try {
      const resultado = JSON.parse(resposta)
      console.log('‚úÖ JSON parseado com sucesso!')
      console.log('üìä Estrutura:', {
        topicos: resultado.topicos?.length || 0,
        objetivos: resultado.objetivos?.length || 0,
        secoes: resultado.conteudo?.secoes?.length || 0
      })
      
      // Validar que tem conte√∫do m√≠nimo
      if (!resultado.topicos || !resultado.objetivos || !resultado.conteudo?.secoes) {
        console.error('‚ùå JSON inv√°lido: faltam campos obrigat√≥rios')
        return null
      }
      
      return resultado
    } catch (parseError) {
      console.error('‚ùå Erro ao gerar conte√∫do com Gemini GEM:', parseError.message)
      console.error('Detalhes:', parseError.message)
      
      // FALLBACK: Tentar recuperar JSON parcial
      try {
        // Estrat√©gia 1: Tentar extrair at√© o √∫ltimo } v√°lido
        const lastClosingBrace = resposta.lastIndexOf('}')
        if (lastClosingBrace > 0) {
          const jsonParcial = resposta.substring(0, lastClosingBrace + 1)
          console.log('‚ö†Ô∏è Tentando parse com JSON parcial...')
          
          const resultado = JSON.parse(jsonParcial)
          console.log('‚úÖ JSON parcial parseado com sucesso!')
          console.log('üìä Estrutura:', {
            topicos: resultado.topicos?.length || 0,
            secoes: resultado.conteudo?.secoes?.length || 0
          })
          
          return resultado
        }
      } catch (fallbackError) {
        console.error('‚ùå Fallback tamb√©m falhou:', fallbackError.message)
      }
      
      // Estrat√©gia final: retornar null e usar conte√∫do est√°tico
      console.error('‚ùå Imposs√≠vel parsear JSON do Gemini, usando conte√∫do est√°tico')
      return null
    }
    
  } catch (error) {
    console.error('‚ùå Erro ao gerar conte√∫do com Gemini GEM:', error)
    console.error('Detalhes:', error.message)
    return null
  }
}

async function gerarConteudoIA(disciplina: any, userDisc: any, tipo: string, tempo_minutos: number, interview: any = null, env: any = null) {
  const nivel = userDisc?.nivel_atual || 0
  const jaEstudou = userDisc?.ja_estudou || false
  
  let dificuldade = 'b√°sico'
  if (nivel >= 7) dificuldade = 'avan√ßado'
  else if (nivel >= 4) dificuldade = 'intermedi√°rio'

  // Contexto do concurso/cargo para personaliza√ß√£o
  const contexto = {
    tipo: interview?.objetivo_tipo || 'area_geral',
    concurso: interview?.concurso_nome,
    cargo: interview?.cargo,
    area: interview?.area_geral,
    experiencia: interview?.experiencia || 'iniciante'
  }

  // Gerar t√≥picos primeiro (necess√°rio para o GEM)
  const topicos = gerarTopicos(disciplina.nome, tipo, tempo_minutos, dificuldade, jaEstudou, contexto)
  
  // ESTRAT√âGIA DE FALLBACK EM CASCATA:
  // 1¬∫) Google Gemini (CONFIGURADO e FUNCIONAL)
  // 2¬∫) Groq (backup se Gemini falhar)
  // 3¬∫) Conte√∫do est√°tico (fallback final)
  
  if (env) {
    console.log('üöÄ Tentando gerar conte√∫do com Google Gemini (Gemini 2.0 Flash)...')
    const conteudoGemini = await gerarConteudoComGPT(disciplina.nome, tipo, tempo_minutos, dificuldade, contexto, env, userDisc, topicos)
    
    if (conteudoGemini) {
      console.log('‚úÖ Conte√∫do gerado com Gemini!')
      return conteudoGemini
    }
    
    console.log('‚ö†Ô∏è Gemini falhou, tentando Groq...')
    const conteudoGroq = await gerarConteudoComGroq(disciplina.nome, tipo, tempo_minutos, dificuldade, contexto, env, userDisc, topicos)
    
    if (conteudoGroq) {
      console.log('‚úÖ Conte√∫do gerado com Groq!')
      return conteudoGroq
    }
    
    console.log('‚ö†Ô∏è Groq tamb√©m falhou')
  }

  // FALLBACK FINAL: usar conte√∫do est√°tico
  console.log('‚ö†Ô∏è Todas LLMs falharam, usando conte√∫do est√°tico (fallback final)')
  const objetivos = gerarObjetivos(disciplina.nome, tipo, dificuldade, contexto)
  const conteudo = gerarConteudoDetalhado(disciplina.nome, tipo, tempo_minutos, topicos, dificuldade, contexto)

  return {
    topicos,
    objetivos,
    conteudo
  }
}

function gerarTopicos(disciplina: string, tipo: string, tempo: number, dificuldade: string, jaEstudou: boolean, contexto: any = {}): string[] {
  // MUDAN√áA: Reduzir para 1-2 t√≥picos MUITO aprofundados ao inv√©s de 3+ superficiais
  const quantidadeTopicos = tempo >= 45 ? 2 : 1  // 1 t√≥pico EXTREMAMENTE detalhado (ou 2 se tempo >= 45min)
  
  const topicosBase: any = {
    'Direito Constitucional': {
      teoria: ['Princ√≠pios Fundamentais da Rep√∫blica', 'Direitos e Garantias Fundamentais', 'Organiza√ß√£o do Estado Brasileiro', 'Poder Legislativo e Processo Legislativo', 'Poder Executivo e Atribui√ß√µes', 'Poder Judici√°rio e Fun√ß√µes Essenciais', 'Controle de Constitucionalidade', 'Defesa do Estado e Institui√ß√µes Democr√°ticas'],
      exercicios: ['Quest√µes de Direitos Fundamentais', 'Casos pr√°ticos sobre compet√™ncias constitucionais', 'An√°lise de jurisprud√™ncia do STF', 'Quest√µes sobre princ√≠pios', 'Controle de constitucionalidade em provas'],
      revisao: ['Revis√£o de princ√≠pios constitucionais', 'S√∫mulas vinculantes importantes', 'Esquemas de direitos fundamentais', 'Mapas mentais de compet√™ncias']
    },
    'Direito Administrativo': {
      teoria: ['Princ√≠pios da Administra√ß√£o P√∫blica', 'Atos Administrativos: conceito e atributos', 'Contratos Administrativos', 'Licita√ß√µes e Lei 14.133/2021', 'Servidores P√∫blicos e Regime Jur√≠dico', 'Responsabilidade Civil do Estado', 'Processo Administrativo', 'Improbidade Administrativa'],
      exercicios: ['Quest√µes sobre licita√ß√µes', 'Casos de v√≠cios em atos administrativos', 'An√°lise de contratos p√∫blicos', 'Responsabilidade civil em situa√ß√µes pr√°ticas'],
      revisao: ['Revis√£o de princ√≠pios administrativos', 'Lei 8.666/93 vs Lei 14.133/21', 'Atos administrativos: esquemas', 'Servidores: regime e direitos']
    },
    'Direito Tribut√°rio': {
      teoria: ['Sistema Tribut√°rio Nacional', 'Princ√≠pios do Direito Tribut√°rio', 'Compet√™ncia Tribut√°ria', 'Impostos Federais', 'Impostos Estaduais', 'Impostos Municipais', 'Obriga√ß√£o Tribut√°ria', 'Cr√©dito Tribut√°rio e Lan√ßamento'],
      exercicios: ['Quest√µes de compet√™ncia tribut√°ria', 'C√°lculos de impostos', 'Casos de lan√ßamento tribut√°rio', 'An√°lise de isen√ß√µes e imunidades'],
      revisao: ['Revis√£o de impostos por ente', 'Princ√≠pios tribut√°rios essenciais', 'CTN: principais artigos', 'Jurisprud√™ncia tribut√°ria']
    },
    'Portugu√™s': {
      teoria: ['Sintaxe: termos da ora√ß√£o', 'Morfologia: classes gramaticais', 'Sem√¢ntica e significa√ß√£o', 'Interpreta√ß√£o de Textos', 'Reda√ß√£o Oficial e Correspond√™ncias', 'Concord√¢ncia Verbal e Nominal', 'Reg√™ncia Verbal e Nominal', 'Crase: regras e exce√ß√µes'],
      exercicios: ['Quest√µes de gram√°tica contextualizada', 'Interpreta√ß√£o de textos diversos', 'Reescrita e par√°frase', 'Quest√µes de ortografia e acentua√ß√£o'],
      revisao: ['Regras de concord√¢ncia', 'Reg√™ncia: principais casos', 'Crase: quando usar', 'Interpreta√ß√£o: t√©cnicas']
    },
    'Racioc√≠nio L√≥gico': {
      teoria: ['L√≥gica Proposicional', 'Tabelas-Verdade', 'Equival√™ncias L√≥gicas', 'Diagramas L√≥gicos', 'Argumentos V√°lidos', 'Sequ√™ncias e Padr√µes', 'An√°lise Combinat√≥ria', 'Probabilidade B√°sica'],
      exercicios: ['Quest√µes de proposi√ß√µes', 'Tabelas-verdade aplicadas', 'Diagramas de Venn', 'Problemas de contagem', 'Quest√µes de probabilidade'],
      revisao: ['Revis√£o de conectivos l√≥gicos', 'Equival√™ncias mais cobradas', 'Diagramas: casos especiais', 'F√≥rmulas de combinat√≥ria']
    },
    'Matem√°tica': {
      teoria: ['Conjuntos Num√©ricos', 'Opera√ß√µes B√°sicas e Propriedades', 'Porcentagem e Juros', 'Regra de Tr√™s', 'Equa√ß√µes e Sistemas', 'Geometria Plana', 'Matem√°tica Financeira'],
      exercicios: ['Quest√µes de porcentagem', 'Problemas de juros', 'Regra de tr√™s composta', 'Equa√ß√µes do 1¬∫ e 2¬∫ grau', 'Geometria: √°reas e per√≠metros'],
      revisao: ['F√≥rmulas essenciais', 'Porcentagem: casos cl√°ssicos', 'Juros simples vs compostos', 'Geometria: principais f√≥rmulas']
    }
  }

  let topicos = topicosBase[disciplina]?.[tipo] || [
    `Fundamentos de ${disciplina}`,
    `Conceitos essenciais`,
    `Teoria aprofundada`,
    `Aplica√ß√µes pr√°ticas`,
    `Quest√µes frequentes em provas`,
    `Pontos de aten√ß√£o`,
    `Jurisprud√™ncia relevante`,
    `Dicas para a prova`
  ]

  // Ajustar complexidade SEM prefixos
  if (!jaEstudou) {
    topicos = topicos.slice(0, Math.min(topicos.length, 4)) // Menos t√≥picos para iniciantes
  } else if (dificuldade === 'avan√ßado') {
    // Manter todos os t√≥picos dispon√≠veis para avan√ßados
  }

  return topicos.slice(0, quantidadeTopicos)
}

function gerarObjetivos(disciplina: string, tipo: string, dificuldade: string, contexto: any = {}): string[] {
  if (tipo === 'teoria') {
    return [`Dominar ${disciplina}`, 'Entender aplica√ß√µes pr√°ticas']
  } else if (tipo === 'exercicios') {
    return ['Resolver quest√µes corretamente', 'Identificar pegadinhas']
  } else {
    return ['Consolidar conhecimento', 'Fixar conceitos principais']
  }
}

function gerarConteudoDetalhado(disciplina: string, tipo: string, tempo: number, topicos: string[], dificuldade: string, contexto: any = {}) {
  // Criar introdu√ß√£o simples e direta
  let introducao = `Sess√£o de ${tipo === 'teoria' ? 'estudo te√≥rico' : tipo === 'exercicios' ? 'pr√°tica de quest√µes' : 'revis√£o'} de ${disciplina} - ${tempo} minutos.`
  
  if (contexto.tipo === 'concurso_especifico' && contexto.concurso) {
    introducao += ` Adaptado para ${contexto.concurso}.`
  }
  
  const conteudoBase = {
    introducao,
    orientacoes: tipo === 'teoria' ? [
      'Fa√ßa anota√ß√µes dos pontos principais',
      'Marque d√∫vidas para revisar depois'
    ] : tipo === 'exercicios' ? [
      'Analise cada erro cometido',
      'Anote as quest√µes erradas'
    ] : [
      'Teste sua mem√≥ria antes de reler',
      'Foque nos pontos de dificuldade'
    ],
    secoes: topicos.map((topico, index) => {
      const tempoSecao = Math.round(tempo / topicos.length)
      return {
        titulo: topico,
        tempo_estimado: tempoSecao,
        ordem: index + 1,
        conteudo: gerarConteudoSecao(topico, tipo, dificuldade, disciplina, tempoSecao)
      }
    }),
    recursos_adicionais: [],
    proximos_passos: tipo === 'teoria' ? `Fa√ßa um resumo e resolva quest√µes sobre o tema.` : tipo === 'exercicios' ? `Revise os erros e estude a teoria correspondente.` : `Revise novamente em 3 dias.`
  }

  return conteudoBase
}

function gerarQuestoesSimulado(topico: string, disciplina: string, dificuldade: string): any[] {
  // Base de quest√µes por t√≥pico
  const questoesBase: any = {
    // DIREITO TRIBUT√ÅRIO
    'Sistema Tribut√°rio Nacional': [
      {
        enunciado: 'Sobre o Sistema Tribut√°rio Nacional, assinale a alternativa CORRETA:',
        alternativas: [
          'A Uni√£o, os Estados, o Distrito Federal e os Munic√≠pios podem instituir taxas em raz√£o do exerc√≠cio do poder de pol√≠cia ou pela utiliza√ß√£o de servi√ßos p√∫blicos espec√≠ficos e divis√≠veis.',
          'Os impostos s√£o tributos vinculados a uma contrapresta√ß√£o estatal espec√≠fica.',
          'As contribui√ß√µes de melhoria podem ser cobradas independentemente de obra p√∫blica.',
          'O empr√©stimo compuls√≥rio √© tributo de compet√™ncia concorrente de todos os entes.',
          'As taxas podem ter base de c√°lculo pr√≥pria de impostos.'
        ],
        gabarito: 0,
        explicacao: 'Correta a alternativa A. Conforme art. 145, II da CF/88, a Uni√£o, Estados, DF e Munic√≠pios podem instituir taxas em raz√£o do poder de pol√≠cia ou servi√ßos p√∫blicos espec√≠ficos e divis√≠veis. Impostos s√£o n√£o vinculados (alternativa B errada), contribui√ß√µes de melhoria dependem de obra p√∫blica (C errada), empr√©stimo compuls√≥rio √© s√≥ da Uni√£o (D errada), e taxas n√£o podem ter base de c√°lculo de impostos (E errada, art. 145, ¬ß2¬∫).'
      },
      {
        enunciado: 'Quantas s√£o as esp√©cies tribut√°rias reconhecidas pela doutrina majorit√°ria e pelo STF?',
        alternativas: [
          'Tr√™s: impostos, taxas e contribui√ß√µes',
          'Quatro: impostos, taxas, contribui√ß√µes e empr√©stimos compuls√≥rios',
          'Cinco: impostos, taxas, contribui√ß√µes de melhoria, empr√©stimos compuls√≥rios e contribui√ß√µes especiais',
          'Duas: impostos e taxas',
          'Seis: impostos, taxas, contribui√ß√µes de melhoria, empr√©stimos compuls√≥rios, contribui√ß√µes sociais e CIDE'
        ],
        gabarito: 2,
        explicacao: 'Correta a alternativa C. O STF adota a teoria pentapartite (5 esp√©cies): impostos, taxas, contribui√ß√µes de melhoria, empr√©stimos compuls√≥rios e contribui√ß√µes especiais (estas subdivididas em sociais, CIDE e corporativas).'
      }
    ],
    'Princ√≠pios do Direito Tribut√°rio': [
      {
        enunciado: 'Sobre o princ√≠pio da anterioridade tribut√°ria, analise as afirmativas:\n\nI. O IPI e o IOF s√£o exce√ß√µes ao princ√≠pio da anterioridade anual.\nII. O princ√≠pio da anterioridade nonagesimal exige 90 dias entre a publica√ß√£o da lei e a cobran√ßa do tributo.\nIII. O ICMS-combust√≠vel respeita ambas as anterioridades.\n\nEst√° CORRETO o que se afirma em:',
        alternativas: [
          'I, apenas',
          'II, apenas',
          'I e II, apenas',
          'II e III, apenas',
          'I, II e III'
        ],
        gabarito: 2,
        explicacao: 'Correta a alternativa C (I e II). Item I correto: IPI e IOF s√£o exce√ß√µes √† anterioridade anual (art. 150, ¬ß1¬∫, CF/88). Item II correto: anterioridade nonagesimal √© de 90 dias (art. 150, III, "c"). Item III INCORRETO: ICMS-combust√≠vel √© exce√ß√£o √†s duas anterioridades conforme EC 33/2001.'
      }
    ],
    'Compet√™ncia Tribut√°ria': [
      {
        enunciado: 'Sobre compet√™ncia tribut√°ria, assinale a alternativa INCORRETA:',
        alternativas: [
          'A compet√™ncia tribut√°ria √© indeleg√°vel.',
          'A compet√™ncia tribut√°ria √© irrenunci√°vel.',
          'A capacidade tribut√°ria ativa pode ser delegada por lei.',
          'O n√£o exerc√≠cio da compet√™ncia tribut√°ria por determinado ente n√£o a defere a outro ente.',
          'A Uni√£o pode delegar sua compet√™ncia para instituir impostos aos Estados.'
        ],
        gabarito: 4,
        explicacao: 'Incorreta a alternativa E. A compet√™ncia tribut√°ria √© INDELEG√ÅVEL (art. 7¬∫, CTN). O que pode ser delegado √© a capacidade tribut√°ria ativa (fun√ß√µes de arrecadar e fiscalizar). Todas as demais est√£o corretas.'
      }
    ],
    
    // DIREITO CONSTITUCIONAL
    'Direitos e Garantias Fundamentais': [
      {
        enunciado: 'S√£o direitos sociais previstos no art. 6¬∫ da Constitui√ß√£o Federal, EXCETO:',
        alternativas: [
          'Educa√ß√£o e sa√∫de',
          'Alimenta√ß√£o e moradia',
          'Transporte e lazer',
          'Seguran√ßa e previd√™ncia social',
          'Liberdade de express√£o e reuni√£o'
        ],
        gabarito: 4,
        explicacao: 'Correta a alternativa E. Liberdade de express√£o e reuni√£o s√£o direitos individuais (art. 5¬∫), n√£o direitos sociais. O art. 6¬∫ lista: educa√ß√£o, sa√∫de, alimenta√ß√£o, trabalho, moradia, transporte, lazer, seguran√ßa, previd√™ncia social, prote√ß√£o √† maternidade e √† inf√¢ncia, assist√™ncia aos desamparados.'
      }
    ],
    'Princ√≠pios Fundamentais da Rep√∫blica': [
      {
        enunciado: 'Constituem fundamentos da Rep√∫blica Federativa do Brasil, EXCETO:',
        alternativas: [
          'Soberania',
          'Cidadania',
          'Dignidade da pessoa humana',
          'Valores sociais do trabalho e da livre iniciativa',
          'Independ√™ncia nacional'
        ],
        gabarito: 4,
        explicacao: 'Correta a alternativa E. Independ√™ncia nacional √© OBJETIVO fundamental (art. 3¬∫), n√£o fundamento. Os fundamentos (art. 1¬∫) s√£o: SO-CI-DI-VA-PLU (Soberania, Cidadania, Dignidade da pessoa humana, Valores sociais do trabalho e livre iniciativa, Pluralismo pol√≠tico).'
      }
    ],
    
    // DIREITO ADMINISTRATIVO
    'Princ√≠pios da Administra√ß√£o P√∫blica': [
      {
        enunciado: 'Sobre os princ√≠pios administrativos, analise:\n\nI. O princ√≠pio da legalidade permite ao administrador fazer tudo que a lei n√£o pro√≠be.\nII. O princ√≠pio da impessoalidade veda o uso da m√°quina p√∫blica para promo√ß√£o pessoal.\nIII. O princ√≠pio da efici√™ncia exige resultado com menor custo poss√≠vel.\n\nEst√° CORRETO:',
        alternativas: [
          'Apenas I',
          'Apenas II',
          'Apenas III',
          'Apenas II e III',
          'I, II e III'
        ],
        gabarito: 3,
        explicacao: 'Correta D (II e III). I est√° ERRADO: para o administrador vale a legalidade ESTRITA (s√≥ pode fazer o que a lei permite). II CORRETO: impessoalidade pro√≠be promo√ß√£o pessoal (art. 37, ¬ß1¬∫). III CORRETO: efici√™ncia busca melhor resultado com menor custo.'
      }
    ],
    'Atos Administrativos: conceito e atributos': [
      {
        enunciado: 'S√£o atributos dos atos administrativos, EXCETO:',
        alternativas: [
          'Presun√ß√£o de legitimidade',
          'Imperatividade',
          'Autoexecutoriedade',
          'Tipicidade',
          'Imutabilidade'
        ],
        gabarito: 4,
        explicacao: 'Correta E. IMUTABILIDADE n√£o √© atributo do ato administrativo (atos podem ser revogados ou anulados). Os atributos s√£o: presun√ß√£o de legitimidade, imperatividade, autoexecutoriedade e tipicidade.'
      }
    ],
    
    // PORTUGU√äS
    'Interpreta√ß√£o de Textos': [
      {
        enunciado: 'Em "O ministro afirmou que as medidas seriam tomadas", o pronome "as" retoma:',
        alternativas: [
          'O ministro',
          'As medidas',
          'Elemento n√£o presente no enunciado',
          'O verbo afirmar',
          'O substantivo medidas, mas com fun√ß√£o de sujeito'
        ],
        gabarito: 1,
        explicacao: 'Correta B. O pronome "as" (artigo definido feminino plural) retoma "as medidas". √â um caso de coes√£o referencial anaf√≥rica, onde "as" evita repeti√ß√£o do termo.'
      }
    ],
    'Concord√¢ncia Verbal e Nominal': [
      {
        enunciado: 'Assinale a alternativa com ERRO de concord√¢ncia verbal:',
        alternativas: [
          'Faz dois anos que ele partiu.',
          'Deve haver problemas na reuni√£o.',
          'Haviam muitos candidatos na sala.',
          'Faltam tr√™s dias para a prova.',
          'Existe solu√ß√£o para o problema.'
        ],
        gabarito: 2,
        explicacao: 'Correta C. O correto √© "HAVIA muitos candidatos" (singular). O verbo HAVER no sentido de EXISTIR √© impessoal (n√£o tem sujeito) e fica sempre no singular. "Haviam" est√° ERRADO.'
      }
    ],
    
    // RACIOC√çNIO L√ìGICO
    'L√≥gica Proposicional': [
      {
        enunciado: 'A nega√ß√£o de "Se estudo, ent√£o passo no concurso" √©:',
        alternativas: [
          'Se n√£o estudo, ent√£o n√£o passo no concurso',
          'Estudo e n√£o passo no concurso',
          'N√£o estudo ou passo no concurso',
          'Se passo no concurso, ent√£o estudo',
          'Estudo ou n√£o passo no concurso'
        ],
        gabarito: 1,
        explicacao: 'Correta B. A nega√ß√£o de "p ‚Üí q" √© "p ‚àß ~q". Portanto, a nega√ß√£o de "Se estudo, ent√£o passo" √© "Estudo E n√£o passo".'
      }
    ],
    'Equival√™ncias L√≥gicas': [
      {
        enunciado: 'A proposi√ß√£o "Se chove, ent√£o a rua fica molhada" √© logicamente equivalente a:',
        alternativas: [
          'Se a rua n√£o fica molhada, ent√£o n√£o chove',
          'Se a rua fica molhada, ent√£o chove',
          'Chove e a rua fica molhada',
          'N√£o chove ou a rua n√£o fica molhada',
          'Chove se e somente se a rua fica molhada'
        ],
        gabarito: 0,
        explicacao: 'Correta A. A contrapositiva de "p ‚Üí q" √© "~q ‚Üí ~p" e s√£o logicamente equivalentes. Portanto, "Se chove ‚Üí rua molhada" ‚â° "Se rua n√£o molhada ‚Üí n√£o chove".'
      }
    ]
  };

  const questoesTopico = questoesBase[topico] || [];
  
  // Se n√£o houver quest√µes espec√≠ficas, gerar quest√µes gen√©ricas
  if (questoesTopico.length === 0) {
    return [
      {
        enunciado: `Sobre ${topico} em ${disciplina}, assinale a alternativa CORRETA:`,
        alternativas: [
          'Alternativa A - Primeira op√ß√£o sobre o tema',
          'Alternativa B - Segunda op√ß√£o sobre o tema',
          'Alternativa C - Terceira op√ß√£o sobre o tema',
          'Alternativa D - Quarta op√ß√£o sobre o tema',
          'Alternativa E - Quinta op√ß√£o sobre o tema'
        ],
        gabarito: 0,
        explicacao: `Esta √© uma quest√£o modelo sobre ${topico}. Consulte a teoria acima para entender o conceito.`
      }
    ];
  }
  
  // Ajustar quantidade baseado na dificuldade
  // üÜï GARANTIR M√çNIMO DE 10 QUEST√ïES PARA EXERC√çCIOS
  let quantidade = 1
  if (tipo === 'exercicios') {
    // Para exerc√≠cios, M√çNIMO 10 quest√µes (ou todas dispon√≠veis)
    quantidade = Math.max(10, questoesTopico.length)
  } else {
    // Para teoria/revis√£o, quantidade menor
    quantidade = dificuldade === 'avan√ßado' ? questoesTopico.length : dificuldade === 'intermedi√°rio' ? Math.min(2, questoesTopico.length) : 1
  }
  
  // Se n√£o tiver quest√µes suficientes, repetir/duplicar
  const questoesFinais = []
  for (let i = 0; i < quantidade; i++) {
    questoesFinais.push(questoesTopico[i % questoesTopico.length])
  }
  
  return questoesFinais;
}

function obterConteudoReal(topico: string, disciplina: string): any {
  // Base de conhecimento real por t√≥pico
  const conteudos: any = {
    'Sistema Tribut√°rio Nacional': {
      intro: 'O Sistema Tribut√°rio Nacional est√° previsto nos artigos 145 a 162 da Constitui√ß√£o Federal e define a estrutura de arrecada√ß√£o de tributos no Brasil.',
      pontos: [
        'Uni√£o, Estados, DF e Munic√≠pios possuem compet√™ncia para instituir tributos',
        'Cinco esp√©cies tribut√°rias: impostos, taxas, contribui√ß√µes de melhoria, empr√©stimos compuls√≥rios e contribui√ß√µes especiais',
        'Impostos n√£o t√™m vincula√ß√£o a atividade estatal espec√≠fica',
        'Taxas s√£o vinculadas ao exerc√≠cio do poder de pol√≠cia ou servi√ßo p√∫blico',
        'CTN (Lei 5.172/66) √© a lei complementar que regulamenta normas gerais'
      ],
      exemplos: [
        'Uni√£o: IR, IPI, IOF, II, IE, ITR, IGF',
        'Estados: ICMS, IPVA, ITCMD',
        'Munic√≠pios: IPTU, ISS, ITBI'
      ]
    },
    'Princ√≠pios do Direito Tribut√°rio': {
      intro: 'Os princ√≠pios tribut√°rios limitam o poder de tributar e protegem o contribuinte contra arb√≠trios.',
      pontos: [
        'Legalidade: tributo s√≥ pode ser criado ou majorado por lei',
        'Anterioridade anual: n√£o se pode cobrar tributo no mesmo exerc√≠cio financeiro',
        'Anterioridade nonagesimal: espera de 90 dias ap√≥s publica√ß√£o da lei',
        'Irretroatividade: lei tribut√°ria n√£o retroage',
        'Isonomia: tratamento igual aos contribuintes em situa√ß√£o equivalente',
        'Capacidade contributiva: quem pode mais, paga mais',
        'Veda√ß√£o ao confisco: tributo n√£o pode ter efeito confiscat√≥rio'
      ],
      exemplos: [
        'IR, IPTU e IPVA respeitam anterioridade anual e nonagesimal',
        'IPI e IOF s√£o exce√ß√µes √† anterioridade',
        'ITCMD progressivo aplica capacidade contributiva'
      ]
    },
    'Compet√™ncia Tribut√°ria': {
      intro: 'Compet√™ncia tribut√°ria √© o poder constitucionalmente atribu√≠do aos entes federados para instituir tributos.',
      pontos: [
        'Indeleg√°vel: n√£o pode ser transferida',
        'Facultativa: o ente pode ou n√£o instituir o tributo',
        'Irrenunci√°vel: n√£o pode ser abandonada',
        'Privativa: exclusiva de cada ente',
        'Residual da Uni√£o: criar novos impostos por lei complementar',
        'Extraordin√°ria: imposto extraordin√°rio de guerra'
      ],
      exemplos: [
        'Uni√£o cria IR, Estados criam ICMS, Munic√≠pios criam IPTU',
        'Se munic√≠pio n√£o instituir ISS, n√£o perde compet√™ncia',
        'CF/88 define taxativamente os tributos de cada ente'
      ]
    },
    'Princ√≠pios Fundamentais da Rep√∫blica': {
      intro: 'Os princ√≠pios fundamentais (arts. 1¬∫ a 4¬∫ da CF/88) estabelecem os fundamentos e objetivos do Estado Brasileiro.',
      pontos: [
        'Fundamentos: soberania, cidadania, dignidade, valores sociais do trabalho, pluralismo pol√≠tico (art. 1¬∫)',
        'Forma de governo: Rep√∫blica',
        'Sistema de governo: Presidencialismo',
        'Forma de Estado: Federa√ß√£o',
        'Regime pol√≠tico: Democr√°tico',
        'Objetivos: construir sociedade justa, garantir desenvolvimento, erradicar pobreza, promover bem de todos (art. 3¬∫)',
        'Rela√ß√µes internacionais: autodetermina√ß√£o, n√£o-interven√ß√£o, igualdade, solu√ß√£o pac√≠fica, asilo pol√≠tico (art. 4¬∫)'
      ],
      exemplos: [
        'SO-CI-DI-VAL-PLU: mnem√¥nico para fundamentos',
        'Brasil √© Rep√∫blica Federativa Presidencialista',
        'Princ√≠pio da n√£o-interven√ß√£o rege rela√ß√µes com outros pa√≠ses'
      ]
    },
    'Direitos e Garantias Fundamentais': {
      intro: 'Direitos fundamentais (arts. 5¬∫ a 17) s√£o essenciais e irrenunci√°veis, protegendo a pessoa contra arb√≠trio do Estado.',
      pontos: [
        'Direitos individuais (art. 5¬∫): vida, liberdade, igualdade, seguran√ßa, propriedade',
        'Direitos sociais (art. 6¬∫): educa√ß√£o, sa√∫de, trabalho, moradia, lazer',
        'Direitos de nacionalidade (arts. 12-13): brasileiro nato e naturalizado',
        'Direitos pol√≠ticos (arts. 14-16): votar e ser votado',
        'Rem√©dios constitucionais: HC, MS, MI, HD, AP',
        'Caracter√≠sticas: universalidade, imprescritibilidade, inalienabilidade, irrenunciabilidade'
      ],
      exemplos: [
        'Habeas Corpus: protege liberdade de locomo√ß√£o',
        'Mandado de Seguran√ßa: protege direito l√≠quido e certo',
        'Direito √† vida √© absoluto, mas leg√≠tima defesa √© exce√ß√£o'
      ]
    },
    'Princ√≠pios da Administra√ß√£o P√∫blica': {
      intro: 'Os princ√≠pios administrativos (art. 37, CF/88) orientam toda atividade da Administra√ß√£o P√∫blica e s√£o de observ√¢ncia obrigat√≥ria.',
      pontos: [
        'Legalidade: administrador s√≥ pode fazer o que a lei permite (legalidade estrita)',
        'Impessoalidade: veda√ß√£o √† promo√ß√£o pessoal e tratamento imparcial',
        'Moralidade: atua√ß√£o com √©tica e boa-f√©',
        'Publicidade: divulga√ß√£o oficial dos atos (transpar√™ncia)',
        'Efici√™ncia: melhor resultado com menor custo (EC 19/98)'
      ],
      exemplos: [
        'LIMPE: mnem√¥nico para lembrar os 5 princ√≠pios constitucionais expressos',
        'Ato praticado sem lei √© nulo (legalidade)',
        'Propaganda oficial com nome/imagem do agente p√∫blico √© vedada (impessoalidade)'
      ]
    },
    'Atos Administrativos: conceito e atributos': {
      intro: 'Ato administrativo √© manifesta√ß√£o unilateral de vontade da Administra√ß√£o que cria, modifica ou extingue direitos.',
      pontos: [
        'Presun√ß√£o de legitimidade: presume-se que o ato √© legal (n√£o absoluta)',
        'Imperatividade: pode impor obriga√ß√µes independente de concord√¢ncia',
        'Autoexecutoriedade: pode executar seus pr√≥prios atos sem ordem judicial',
        'Tipicidade: deve corresponder a figura definida em lei'
      ],
      exemplos: [
        'Multa de tr√¢nsito: presume-se v√°lida, cabe ao multado provar erro',
        'Interdi√ß√£o de restaurante insalubre: autoexecutoriedade',
        'Demoli√ß√£o de constru√ß√£o irregular: imperatividade'
      ]
    },
    'Interpreta√ß√£o de Textos': {
      intro: 'Interpreta√ß√£o de textos envolve compreens√£o literal, inferencial e cr√≠tica do conte√∫do, identificando tema, tese e argumentos.',
      pontos: [
        'Tema: assunto geral do texto',
        'Tese: posi√ß√£o defendida pelo autor',
        'Argumentos: provas e racioc√≠nios que sustentam a tese',
        'Coes√£o: conex√£o entre palavras, ora√ß√µes e par√°grafos',
        'Coer√™ncia: l√≥gica interna das ideias',
        'Tipos textuais: narrativo, descritivo, dissertativo, injuntivo, expositivo'
      ],
      exemplos: [
        'An√°fora: retomada de elemento anterior (ex: pronome)',
        'Cat√°fora: antecipa√ß√£o de elemento posterior',
        'Ambiguidade deve ser evitada na reda√ß√£o oficial'
      ]
    },
    'Concord√¢ncia Verbal e Nominal': {
      intro: 'Concord√¢ncia √© a adapta√ß√£o entre elementos (sujeito-verbo, nome-adjetivo) para expressar harmonia gramatical.',
      pontos: [
        'Concord√¢ncia verbal: verbo concorda com sujeito em n√∫mero e pessoa',
        'Sujeito composto: verbo no plural',
        'Sujeito simples: verbo concorda com o n√∫cleo',
        'Verbos impessoais (haver, fazer): sempre singular',
        'Concord√¢ncia nominal: adjetivo concorda com substantivo'
      ],
      exemplos: [
        '"Faz dois anos" (verbo fazer impessoal = singular)',
        '"Havia muitos candidatos" (verbo haver = existir = impessoal = singular)',
        '"A casa e o carro s√£o novos" (sujeito composto = verbo plural)'
      ]
    },
    'L√≥gica Proposicional': {
      intro: 'L√≥gica proposicional estuda proposi√ß√µes (afirma√ß√µes verdadeiras ou falsas) e conectivos l√≥gicos.',
      pontos: [
        'Conectivos: nega√ß√£o (~), conjun√ß√£o (‚àß), disjun√ß√£o (‚à®), condicional (‚Üí), bicondicional (‚Üî)',
        'Nega√ß√£o de "p": ~p',
        'Nega√ß√£o de "p ‚àß q": ~p ‚à® ~q (Lei de De Morgan)',
        'Nega√ß√£o de "p ‚à® q": ~p ‚àß ~q (Lei de De Morgan)',
        'Nega√ß√£o de "p ‚Üí q": p ‚àß ~q'
      ],
      exemplos: [
        'Nega√ß√£o de "Jo√£o √© alto E Maria √© baixa" = "Jo√£o n√£o √© alto OU Maria n√£o √© baixa"',
        'Nega√ß√£o de "Se chove, ent√£o a rua fica molhada" = "Chove E a rua n√£o fica molhada"',
        'p ‚Üí q tem 3 casos verdadeiros e 1 falso (VV=V, VF=F, FV=V, FF=V)'
      ]
    },
    'Equival√™ncias L√≥gicas': {
      intro: 'Duas proposi√ß√µes s√£o equivalentes quando t√™m os mesmos valores l√≥gicos (V/F) em todas as situa√ß√µes.',
      pontos: [
        'Contrapositiva: p ‚Üí q ‚â° ~q ‚Üí ~p',
        'Condicional em disjun√ß√£o: p ‚Üí q ‚â° ~p ‚à® q',
        'Dupla nega√ß√£o: ~~p ‚â° p',
        'Leis de De Morgan: ~(p ‚àß q) ‚â° ~p ‚à® ~q e ~(p ‚à® q) ‚â° ~p ‚àß ~q',
        'Bicondicional: p ‚Üî q ‚â° (p ‚Üí q) ‚àß (q ‚Üí p)'
      ],
      exemplos: [
        '"Se estudo, passo" ‚â° "Se n√£o passo, n√£o estudo" (contrapositiva)',
        '"Se chove, molha" ‚â° "N√£o chove OU molha"',
        '"Jo√£o √© m√©dico E advogado" - nega√ß√£o = "Jo√£o N√ÉO √© m√©dico OU N√ÉO √© advogado"'
      ]
    }
  }
  
  return conteudos[topico] || null
}

function gerarConteudoSecao(topico: string, tipo: string, dificuldade: string, disciplina: string, tempoMinutos: number) {
  if (tipo === 'teoria') {
    const conteudoReal = obterConteudoReal(topico, disciplina)
    
    if (conteudoReal) {
      // Gerar teoria completa e extensa
      const teoriaCompleta = `
## ${topico}

${conteudoReal.intro}

### Conceitos Fundamentais

${conteudoReal.pontos.map((p: string, i: number) => `${i + 1}. **${p}**`).join('\n\n')}

### Aplica√ß√£o Pr√°tica

Este tema √© fundamental para ${disciplina} e frequentemente cobrado em concursos p√∫blicos. ${dificuldade === 'b√°sico' ? 'Para iniciantes, √© essencial memorizar as defini√ß√µes b√°sicas e compreender a estrutura geral do tema.' : dificuldade === 'intermedi√°rio' ? 'Com conhecimento intermedi√°rio, o foco deve ser na resolu√ß√£o de quest√µes e an√°lise de casos pr√°ticos.' : 'Em n√≠vel avan√ßado, √© necess√°rio dominar as controv√©rsias doutrin√°rias e jurisprud√™ncia divergente.'}

As bancas organizadoras como CESPE, FCC e FGV frequentemente exploram ${topico} atrav√©s de quest√µes que ${dificuldade === 'avan√ßado' ? 'mesclam jurisprud√™ncia recente com legisla√ß√£o, exigindo an√°lise aprofundada' : 'testam a literalidade da norma e conceitos b√°sicos'}. ${dificuldade === 'b√°sico' ? 'Aten√ß√£o para palavras-chave como "exceto", "incorreto" ou "n√£o".' : 'Analise cuidadosamente o enunciado identificando pegadinhas comuns.'}

### Exemplos

${conteudoReal.exemplos.map((e: string, i: number) => `**Exemplo ${i + 1}:** ${e}`).join('\n\n')}

### Dicas de Memoriza√ß√£o

- **Mnem√¥nicos:** Crie acr√¥nimos com as primeiras letras dos conceitos principais
- **Mapas Mentais:** Visualize as conex√µes entre ${topico} e outros temas de ${disciplina}
- **Repeti√ß√£o Espa√ßada:** Revise em 3, 7, 15 e 30 dias para fixa√ß√£o de longo prazo
- **Quest√µes:** Resolva ao menos 10 quest√µes sobre este tema ap√≥s o estudo
      `.trim();
      
      return {
        teoria_completa: teoriaCompleta,
        questoes: gerarQuestoesSimulado(topico, disciplina, dificuldade)
      }
    }
    
    // Fallback para t√≥picos sem conte√∫do espec√≠fico
    return {
      teoria_completa: `## ${topico}\n\n${topico} √© um tema importante em ${disciplina}.`,
      questoes: []
    }
  } else if (tipo === 'exercicios') {
    return {
      questoes: gerarQuestoesSimulado(topico, disciplina, dificuldade)
    }
  } else {
    // Revis√£o
    return {
      teoria_completa: `### Revis√£o: ${topico}\n\nRevis√£o ativa dos conceitos de ${topico}.`,
      
      pontos_chave: [
        `üìå Conceito: ${topico} refere-se aos elementos centrais que fundamentam a compreens√£o desta mat√©ria. √â essencial dominar a defini√ß√£o legal e doutrin√°ria do tema.`,
        `üìå Caracter√≠sticas: Os aspectos distintivos incluem suas particularidades t√©cnicas, requisitos legais e forma de aplica√ß√£o pr√°tica no contexto do servi√ßo p√∫blico.`,
        `üìå Base Legal: A fundamenta√ß√£o jur√≠dica encontra-se na legisla√ß√£o espec√≠fica, jurisprud√™ncia consolidada e entendimento doutrin√°rio predominante.`,
        `üìå Aplica√ß√£o Pr√°tica: Na rotina do cargo, este conhecimento √© aplicado em situa√ß√µes de ${dificuldade === 'avan√ßado' ? 'alta complexidade e casos excepcionais' : 'rotina administrativa e casos usuais'}.`,
        `üìå Rela√ß√£o com outros temas: ${topico} se conecta diretamente com outros institutos de ${disciplina}, formando um sistema integrado de conhecimento.`
      ],
      
      desenvolvimento: [
        `O estudo de ${topico} exige compreens√£o dos fundamentos te√≥ricos e capacidade de aplica√ß√£o pr√°tica. Os concursos p√∫blicos frequentemente exploram tanto a literalidade da lei quanto situa√ß√µes hipot√©ticas que exigem racioc√≠nio jur√≠dico.`,
        
        dificuldade === 'b√°sico' ? 
          `Para iniciantes, √© fundamental memorizar as defini√ß√µes b√°sicas e compreender a estrutura geral do tema. Utilize mnem√¥nicos e resumos para facilitar a memoriza√ß√£o dos pontos principais.` :
        dificuldade === 'intermedi√°rio' ?
          `Com conhecimento intermedi√°rio, o foco deve ser na resolu√ß√£o de quest√µes e an√°lise de casos pr√°ticos. Procure entender as pegadinhas comuns e os erros mais frequentes cometidos pelos candidatos.` :
          `Em n√≠vel avan√ßado, √© necess√°rio dominar as controv√©rsias doutrin√°rias, jurisprud√™ncia divergente e casos complexos. Estude posicionamentos minorit√°rios e saiba quando cada corrente √© aplic√°vel.`,
        
        `A jurisprud√™ncia dos tribunais superiores √© fonte essencial para compreender a aplica√ß√£o pr√°tica de ${topico}. S√∫mulas, informativos e decis√µes recentes devem ser consultados regularmente.`,
        
        `Em provas de concurso, este tema costuma ser cobrado atrav√©s de quest√µes que mesclam conhecimento te√≥rico com situa√ß√µes pr√°ticas. ${dificuldade === 'avan√ßado' ? 'Quest√µes de alto n√≠vel podem envolver m√∫ltiplos institutos combinados.' : 'As quest√µes geralmente seguem o padr√£o das bancas organizadoras.'}`,
        
        tempoMinutos >= 20 ? 
          `Dedique tempo para criar esquemas visuais e mapas mentais conectando ${topico} com outros temas de ${disciplina}. Esta t√©cnica facilita a memoriza√ß√£o e compreens√£o sistem√°tica da mat√©ria.` : '',
        
        tempoMinutos >= 25 ?
          `Quest√µes discursivas podem exigir desenvolvimento argumentativo sobre ${topico}. Pratique a elabora√ß√£o de respostas estruturadas, com introdu√ß√£o, desenvolvimento e conclus√£o, sempre fundamentadas na legisla√ß√£o e doutrina.` : ''
      ].filter(p => p.length > 0),
      
      exemplos: [
        `üìñ Exemplo 1: Em situa√ß√£o t√≠pica de concurso, considere que ${dificuldade === 'b√°sico' ? 'uma quest√£o solicita a defini√ß√£o literal do conceito' : dificuldade === 'intermedi√°rio' ? 'um caso pr√°tico exige aplica√ß√£o da norma' : 'um caso complexo envolve conflito entre princ√≠pios'}. A resposta correta demanda ${dificuldade === 'avan√ßado' ? 'an√°lise aprofundada e pondera√ß√£o de interesses' : 'conhecimento da lei e sua aplica√ß√£o direta'}.`,
        
        `üìñ Exemplo 2: Bancas como CESPE, FCC e FGV frequentemente exploram ${topico} atrav√©s de quest√µes que ${dificuldade === 'avan√ßado' ? 'mesclam jurisprud√™ncia recente com legisla√ß√£o' : 'testam a literalidade da norma'}. √â essencial ${dificuldade === 'b√°sico' ? 'conhecer a reda√ß√£o legal' : 'analisar o contexto da quest√£o'}.`,
        
        tempoMinutos >= 15 ?
          `üìñ Exemplo 3: Na pr√°tica profissional do cargo, ${topico} √© relevante em situa√ß√µes de ${dificuldade === 'avan√ßado' ? 'decis√µes estrat√©gicas e casos omissos' : 'rotina administrativa'}. O servidor deve saber aplicar o conhecimento te√≥rico nas atividades di√°rias.` : ''
      ].filter(e => e.length > 0),
      
      dicas: [
        `üí° Aten√ß√£o: N√£o confunda ${topico} com institutos similares. As bancas adoram explorar essas diferen√ßas sutis.`,
        `üí° Memoriza√ß√£o: Crie acr√¥nimos ou frases para memorizar os elementos essenciais (ex: primeira letra de cada requisito).`,
        `üí° Jurisprud√™ncia: Acompanhe as decis√µes recentes do STF e STJ que envolvam ${topico}. S√∫mulas s√£o frequentemente cobradas.`,
        `üí° Pegadinhas: ${dificuldade === 'avan√ßado' ? 'Cuidado com quest√µes que invertem conceitos ou misturam posi√ß√µes doutrin√°rias conflitantes' : 'Leia atentamente o enunciado, procurando palavras como "exceto", "incorreto" ou "n√£o"'}`,
        tempoMinutos >= 20 ? `üí° Revis√£o: Agende revis√µes peri√≥dicas de ${topico} usando a t√©cnica de repeti√ß√£o espa√ßada (3 dias, 7 dias, 15 dias, 30 dias).` : ''
      ].filter(d => d.length > 0)
    }
  }
}

async function gerarDiagnostico(DB: D1Database, user_id: number, interview_id: number) {
  const { results: disciplinas } = await DB.prepare(`
    SELECT ud.*, d.nome, d.area
    FROM user_disciplinas ud
    JOIN disciplinas d ON ud.disciplina_id = d.id
    WHERE ud.user_id = ?
  `).bind(user_id).all()

  const interview = await DB.prepare(
    'SELECT * FROM interviews WHERE id = ?'
  ).bind(interview_id).first()

  // Calcular n√≠vel geral
  const nivelMedio = disciplinas.reduce((sum: number, d: any) => sum + d.nivel_atual, 0) / disciplinas.length
  let nivelGeral = 'Iniciante'
  if (nivelMedio >= 7) nivelGeral = 'Avan√ßado'
  else if (nivelMedio >= 4) nivelGeral = 'Intermedi√°rio'

  // Identificar prioridades
  const prioridades = disciplinas
    .filter((d: any) => !d.ja_estudou || d.nivel_atual < 6 || d.dificuldade)
    .map((d: any) => ({
      disciplina_id: d.disciplina_id,
      nome: d.nome,
      peso: calcularPeso(d),
      razao: gerarRazaoPrioridade(d)
    }))
    .sort((a, b) => b.peso - a.peso)

  // Identificar lacunas
  const lacunas = disciplinas
    .filter((d: any) => !d.ja_estudou)
    .map((d: any) => d.nome)

  return {
    nivel_geral: nivelGeral,
    prioridades: prioridades.slice(0, 5),
    lacunas,
    recomendacao: gerarRecomendacao(interview, disciplinas, nivelGeral)
  }
}

function calcularPeso(disciplina: any): number {
  let peso = 0
  if (!disciplina.ja_estudou) peso += 10
  if (disciplina.nivel_atual < 4) peso += 8
  if (disciplina.dificuldade) peso += 6
  peso += (10 - disciplina.nivel_atual)
  return peso
}

function gerarRazaoPrioridade(disciplina: any): string {
  if (!disciplina.ja_estudou) return 'Conte√∫do nunca estudado'
  if (disciplina.nivel_atual < 4) return 'N√≠vel muito baixo'
  if (disciplina.dificuldade) return 'Disciplina com dificuldade hist√≥rica'
  return 'Necessita refor√ßo'
}

function gerarRecomendacao(interview: any, disciplinas: any[], nivelGeral: string): string {
  const tempoDia = interview.tempo_disponivel_dia
  const nuncaEstudou = disciplinas.filter((d: any) => !d.ja_estudou).length

  if (nivelGeral === 'Iniciante' && nuncaEstudou > 5) {
    return `Com ${tempoDia} minutos por dia, foque em construir uma base s√≥lida. Comece pelas disciplinas que nunca estudou, dedicando 70% do tempo √† teoria e 30% a exerc√≠cios b√°sicos.`
  }
  
  if (nivelGeral === 'Intermedi√°rio') {
    return `Voc√™ j√° tem uma base. Distribua seu tempo: 40% teoria (focando nas lacunas), 40% exerc√≠cios e 20% revis√£o. Mantenha consist√™ncia di√°ria.`
  }
  
  return `N√≠vel avan√ßado! Foque em: 20% revis√£o de conceitos, 50% resolu√ß√£o intensiva de quest√µes e 30% em pontos fracos identificados.`
}

function gerarDiagnosticoCompleto(interview: any, disciplinas: any[]) {
  const nivelMedio = disciplinas.reduce((sum, d: any) => sum + d.nivel_atual, 0) / disciplinas.length
  return {
    nivel_medio: Math.round(nivelMedio * 10) / 10,
    total_disciplinas: disciplinas.length,
    nunca_estudadas: disciplinas.filter((d: any) => !d.ja_estudou).length,
    com_dificuldade: disciplinas.filter((d: any) => d.dificuldade).length,
    experiencia: interview.experiencia
  }
}

function gerarMapaPrioridades(disciplinas: any[]) {
  return disciplinas
    .map((d: any) => ({
      disciplina_id: d.disciplina_id,
      nome: d.nome,
      peso: calcularPeso(d),
      percentual_tempo: 0 // ser√° calculado na distribui√ß√£o de ciclos
    }))
    .sort((a, b) => b.peso - a.peso)
}

async function gerarCiclosEstudo(
  DB: D1Database, 
  plano_id: number, 
  disciplinas: any[], 
  tempoDiario: number
) {
  const diasSemana = [0, 1, 2, 3, 4, 5, 6] // Domingo a S√°bado
  const prioridades = gerarMapaPrioridades(disciplinas)
  
  // üéØ NOVAS REGRAS: M√°ximo 5 mat√©rias por dia + M√≠nimo 30 minutos
  const MAX_MATERIAS_DIA = 5
  const TEMPO_MINIMO_MATERIA = 30
  
  // Distribuir tempo proporcionalmente ao peso
  const pesoTotal = prioridades.reduce((sum, p) => sum + p.peso, 0)
  
  for (const dia of diasSemana) {
    let ordemDia = 0
    let tempoRestante = tempoDiario
    let materiasAdicionadas = 0

    // Primeira passagem: calcular tempos e filtrar disciplinas vi√°veis
    const disciplinasViavels = []
    for (const disc of prioridades) {
      if (materiasAdicionadas >= MAX_MATERIAS_DIA) break
      if (tempoRestante < TEMPO_MINIMO_MATERIA) break

      const percentual = disc.peso / pesoTotal
      let tempoDisc = Math.round(tempoDiario * percentual)
      
      // Garantir m√≠nimo de 30 minutos
      if (tempoDisc < TEMPO_MINIMO_MATERIA) {
        tempoDisc = TEMPO_MINIMO_MATERIA
      }
      
      // N√£o adicionar se n√£o couber no tempo restante
      if (tempoDisc > tempoRestante) {
        continue
      }

      disciplinasViavels.push({ ...disc, tempoDisc })
      tempoRestante -= tempoDisc
      materiasAdicionadas++
    }

    // Segunda passagem: inserir no banco
    for (const disc of disciplinasViavels) {
      // Definir tipo de atividade baseado no n√≠vel
      const disciplinaCompleta = disciplinas.find((d: any) => d.disciplina_id === disc.disciplina_id)
      let tipo = 'teoria'
      
      if (disciplinaCompleta.ja_estudou && disciplinaCompleta.nivel_atual >= 6) {
        tipo = dia % 3 === 0 ? 'revisao' : 'exercicios'
      } else if (disciplinaCompleta.ja_estudou) {
        tipo = dia % 2 === 0 ? 'teoria' : 'exercicios'
      }

      await DB.prepare(`
        INSERT INTO ciclos_estudo (plano_id, disciplina_id, tipo, dia_semana, tempo_minutos, ordem)
        VALUES (?, ?, ?, ?, ?, ?)
      `).bind(plano_id, disc.disciplina_id, tipo, dia, disc.tempoDisc, ordemDia).run()

      ordemDia++
    }
    
    console.log(`üìÖ Dia ${dia}: ${materiasAdicionadas} mat√©rias (${tempoDiario - tempoRestante}min de ${tempoDiario}min)`)
  }
}

// ============== ROTA PRINCIPAL (FRONTEND) ==============
app.get('/', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>IAprova - Prepara√ß√£o Inteligente para Concursos P√∫blicos</title>
        <meta name="description" content="Plataforma de estudos com IA para concursos p√∫blicos. Planos personalizados, conte√∫do adaptado ao seu cargo e acompanhamento inteligente.">
        <meta name="keywords" content="concursos p√∫blicos, estudos, IA, prepara√ß√£o, edital, cargo">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
          body { font-family: 'Inter', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <div id="app"></div>
        
        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
        <script src="/static/app.js?v=3.0"></script>
    </body>
    </html>
  `)
})

export default app
